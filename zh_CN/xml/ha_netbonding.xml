<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="ha_netbonding.xml" version="5.0" xml:id="cha.ha.netbonding">


 <title>网络设备绑定</title>
 <info>
  <abstract>
   <para>
   对于许多系统，需要实施高于典型以太网设备的标准数据安全性或可用性要求的网络连接。在这些情况下，可以将多个以太网设备聚合到单个绑定设备。
   </para>
  </abstract>
      <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
        <dm:maintainer/>
        <dm:status>编辑</dm:status>
        <dm:deadline/>
        <dm:priority/>
        <dm:translation>yes</dm:translation>
        <dm:languages/>
        <dm:release/>
        <dm:repository/>
      </dm:docmanager>
    </info>
 <para>
  联接设备的配置通过联接模块选项来完成。其行为取决于联接设备的模式。默认情况下是 <systemitem>mode=active-backup</systemitem>，即如果活动从属设备发生故障，则其他从属设备将变成为活动设备。
 </para>
 <para>
  使用 Corosync 时，绑定设备不受群集软件的管理。因此，必须在每个可能需要访问联接设备的群集节点上配置联接设备。
 </para>

 <sect1 xml:id="sec.ha.netbond.yast">
  <title>使用 YaST 配置联接设备</title>

  <para>
   要配置联接设备，您必须有多个可以聚合到单独一个联接设备的以太网设备。按如下所示继续：
  </para>

  <procedure>
   <step>
    <para>
     以 <systemitem class="username">root</systemitem> 身份启动 YaST 并选择<menuchoice>
     <guimenu>系统</guimenu> <guimenu>网络设置</guimenu>
     </menuchoice>。
    </para>
   </step>
   <step>
    <para>
     在<guimenu>网络设置</guimenu>中，切换到<guimenu>概述</guimenu>选项卡以显示可用的设备。
    </para>
   </step>
   <step>
    <para>
     检查要聚合到联接设备的以太网设备是否有指定的 IP 地址。如果有，更改此地址：
    </para>
    <substeps performance="required">
     <step>
      <para>
       选择要更改的设备，然后单击<guimenu>编辑</guimenu>。
      </para>
     </step>
     <step xml:id="step.bond.slave">
      <para>
       在打开的<guimenu>网卡设置</guimenu>对话框的<guimenu>地址</guimenu>选项卡中，选择<guimenu>无链接和 IP 设置（绑定从属）</guimenu>选项。
      </para>
      <informalfigure>
       <mediaobject>
        <imageobject role="fo">
         <imagedata fileref="yast2_netw_bond.png" width="90%" format="PNG"/>
        </imageobject>
        <imageobject role="html">
         <imagedata fileref="yast2_netw_bond.png" width="75%" format="PNG"/>
        </imageobject>
       </mediaobject>
      </informalfigure>
     </step>
     <step>
      <para>
       单击<guimenu>下一步</guimenu>，返回到<guimenu>网络设置</guimenu>对话框中的<guimenu>概述</guimenu>选项卡。
      </para>
     </step>
    </substeps>
   </step>
   <step>
    <para>
     添加新联接设备：
    </para>
    <substeps performance="required">
     <step>
      <para>
       单击<guimenu>添加</guimenu>并将<guimenu>设备类型</guimenu>更改为<guimenu>绑定</guimenu>。单击<guimenu>下一步</guimenu>继续。
      </para>
     </step>
     <step>
      <para>
       选择如何为绑定设备指派 IP 地址。有三种方法可供选择：
      </para>
      <itemizedlist>
       <listitem>
        <para>
         无链接和 IP 设置（绑定从属）
        </para>
       </listitem>
       <listitem>
        <para>
         动态地址（使用 DHCP 或 Zeroconf）
        </para>
       </listitem>
       <listitem>
        <para>
         静态指派的 IP 地址
        </para>
       </listitem>
      </itemizedlist>
      <para>
       使用最适合您环境的方法。如果 Corosync 管理虚拟 IP 地址，请选择<guimenu>静态指派 IP 地址</guimenu>，并为接口指派一个 IP 地址。
      </para>
     </step>
     <step>
      <para>
       切换到<guimenu>绑定从属</guimenu>选项卡。
      </para>
     </step>
     <step>
      <para>
       它会显示在<xref linkend="step.bond.slave" xrefstyle="select:label nopage"/> 中已配置为绑定从属的所有以太网设备。要选择您想包含到绑定中的以太网设备，请在<guimenu>绑定从属和顺序</guimenu>下方激活相应设备前面的复选框。
      </para>
      <informalfigure>
       <mediaobject>
        <imageobject role="fo">
         <imagedata fileref="yast2_netw_bond_slaves.png" width="90%" format="PNG"/>
        </imageobject>
        <imageobject role="html">
         <imagedata fileref="yast2_netw_bond_slaves.png" width="75%" format="PNG"/>
        </imageobject>
       </mediaobject>
      </informalfigure>
     </step>
     <step>
      <para>
       编辑<guimenu>联接驱动程序选项</guimenu>。可以使用以下模式：
      </para>
      <variablelist>
       <varlistentry>
        <term><literal>balance-rr</literal>
        </term>
        <listitem>
         <para>
          提供负载平衡和容错，但会使包传输变得混乱无序。这可能会导致 TCP 重组等操作出现延迟。
         </para>
        </listitem>
       </varlistentry>
       <varlistentry>
        <term><literal>active-backup</literal>
        </term>
        <listitem>
         <para>
          提供容错。
         </para>
        </listitem>
       </varlistentry>
       <varlistentry>
        <term><literal>balance-xor</literal>
        </term>
        <listitem>
         <para>
          提供负载平衡和容错。
         </para>
        </listitem>
       </varlistentry>
       <varlistentry>
        <term><literal>broadcast</literal>
        </term>
        <listitem>
         <para>
          提供容错。
         </para>
        </listitem>
       </varlistentry>
       <varlistentry>
        <term><literal>802.3ad</literal>
        </term>
        <listitem>
         <para>
          提供动态链接集合（如果连接的交换机支持动态链接集合）。
         </para>
        </listitem>
       </varlistentry>
       <varlistentry>
        <term><literal>balance-tlb</literal>
        </term>
        <listitem>
         <para>
          为外发的通讯量提供负载平衡。
         </para>
        </listitem>
       </varlistentry>
       <varlistentry>
        <term><literal>balance-alb</literal>
        </term>
        <listitem>
         <para>
          为进来的和外发的通讯量提供负载平衡（如果使用的网络设备允许在使用中修改网络设备的硬件地址）。
         </para>
        </listitem>
       </varlistentry>
      </variablelist>
     </step>
     <step>
      <para>
       务必向<guimenu>联接驱动程序选项</guimenu>添加参数 <literal>miimon=100</literal>。如果不指定此参数，则不会定期检查链路，因此，绑定驱动程序可能会持续在有故障的链路上丢包。
      </para>
     </step>
    </substeps>
   </step>
   <step>
    <para>
     单击<guimenu>下一步</guimenu>，将 YaST 保留为<guimenu>确定</guimenu>，完成联接设备的配置。YaST 将配置写入 <filename>/etc/sysconfig/network/ifcfg-bond<replaceable>DEVICENUMBER</replaceable></filename>。
    </para>
   </step>
  </procedure>
 </sect1>

 <sect1 xml:id="sec.ha.netbond.hotpug.yast">
  <title>联接从属的热插拔</title>

  <para>
   在某些情况下，例如相应的网络设备不断出现故障时，必须使用另一个接口来取代绑定的从属接口。解决方案是为联接从属设置热插拔，此外还需要更改 <systemitem>udev</systemitem> 规则，以便按总线 ID（而非 MAC 地址）匹配该设备。这样，有缺陷的硬件（同一槽内具有不同 MAC 地址的网卡）允许更换的话，您便可以更换该硬件。
  </para>

  <procedure>
   <title>使用 YaST 为绑定从属配置热插拔</title>

   <para>
    如果您想改用手动配置，请参见《<phrase role="productname"><phrase os="sles">SUSE Linux Enterprise High Availability Extension</phrase></phrase> 管理指南》的“<citetitle>基本联网知识</citetitle>”一章中的“<citetitle>绑定从属的热插拔</citetitle>”一节。
   </para>
   <step>
    <para>
     以 <systemitem class="username">root</systemitem> 身份启动 YaST 并选择<menuchoice>
     <guimenu>系统</guimenu> <guimenu>网络设置</guimenu>
     </menuchoice>。
    </para>
   </step>
   <step>
    <para>
     在<guimenu>网络设置</guimenu>中，切换到<guimenu>概述</guimenu>选项卡以显示已配置的设备。如果已配置绑定从属，则会显示在<guimenu>备注</guimenu>栏中。
    </para>
    <informalfigure>
     <mediaobject>
      <imageobject role="fo">
       <imagedata fileref="yast2_netw_bond_slaves_oview.png" width="90%" format="PNG"/>
      </imageobject>
      <imageobject role="html">
       <imagedata fileref="yast2_netw_bond_slaves_oview.png" width="75%" format="PNG"/>
      </imageobject>
     </mediaobject>
    </informalfigure>
   </step>
   <step>
    <para>
     对于已经聚合到联接设备的每个以太网设备，请执行以下步骤：
    </para>
    <substeps performance="required">
     <step>
      <para>
       选择要更改的设备，然后单击<guimenu>编辑</guimenu>。<guimenu>网卡设置</guimenu>对话框随即打开。
      </para>
     </step>
     <step>
      <para>
       切换到<guimenu>常规</guimenu>选项卡，确保将<guimenu>激活设备</guimenu>设置为<literal>在热插拔时</literal>。
      </para>
     </step>
     <step>
      <para>
       切换到<guimenu>硬件</guimenu>选项卡。
      </para>
     </step>
     <step>
      <para>
       针对 <guimenu>Udev 规则</guimenu>，单击<guimenu>更改</guimenu>并选择 <guimenu>BusID</guimenu> 选项。
      </para>
     </step>
     <step>
      <para>
       单击<guimenu>确定</guimenu>和<guimenu>下一步</guimenu>，返回到<guimenu>网络设置</guimenu>对话框中的<guimenu>概述</guimenu>选项卡。如果您现在单击以太网设备项，底部窗格会显示设备的详细信息，包括总线 ID。
      </para>
     </step>
    </substeps>
   </step>
   <step>
    <para>
     单击<guimenu>确定</guimenu>确认您的更改，并退出网络设置。
    </para>
   </step>
  </procedure>

  <para>
   在引导时，网络设置不会等待热插拔从属接口就绪，而是等待绑定就绪，而这至少需要有一个从属接口可用。当从系统中去除一个从属接口时（从 NIC 驱动程序拆开绑定、执行 NIC 驱动程序的 <command>rmmod</command> 命令或 PCI 热插拔去除为 true），内核会自动从绑定中将其去除。当向系统添加新网卡时（替换插槽中的硬件），<systemitem>udev</systemitem> 会应用基于总线的永久名称规则对新网卡进行重命名，并为其调用 <command>ifup</command>。<command>ifup</command> 命令会自动调用以将新网卡加入联接。
  </para>
 </sect1>
 <sect1 xml:id="sec.ha.netbonding.more">
  <title>更多信息</title>

  <para>
   《<guimenu>Linux Ethernet Bonding Driver HOWTO</guimenu>》（Linux 以太网绑定驱动程序操作指南）中详细介绍了所有模式和许多选项。安装包 <systemitem>kernel-source</systemitem> 后，您可以在 <filename>/usr/src/linux/Documentation/networking/bonding.txt</filename> 下找到该文件。
  </para>

  <para>
   对于高可用性设置，本指南中所述的以下选项特别重要：<option>miimon</option> 和 <option>use_carrier</option>。
  </para>


 </sect1>
</chapter>
