<?xml version="1.0" encoding="UTF-8"?>
<sect1 xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="geo_booth_i.xml" version="5.0" xml:id="sec.ha.geo.booth">
 <title>设置 booth 服务</title>

 <info>
      <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
        <dm:maintainer/>
        <dm:status>编辑</dm:status>
        <dm:deadline/>
        <dm:priority/>
        <dm:translation>yes</dm:translation>
        <dm:languages/>
        <dm:release/>
        <dm:repository/>
      </dm:docmanager>
    </info>
    <para>
  默认的 booth 配置为 <filename>/etc/booth/booth.conf</filename>。此文件必须在地域群集的所有站点（包括仲裁方）上相同。要使 booth 配置在所有站点和仲裁方上同步，请根据<xref linkend="sec.ha.geo.booth.sync"/>中所述使用 Csync2。
 </para>

 <note xml:id="note.ha.geo.booth.ownership">
  <title><filename class="directory">/etc/booth</filename> 和文件的所有权</title>
  <para>
   目录 <filename class="directory">/etc/booth</filename> 及其包含的所有文件需属于用户 <systemitem class="username">hacluster</systemitem> 和组 <systemitem class="groupname">haclient</systemitem>。每当从此目录复制新文件时，请使用 <command>cp</command> 命令的 <option>-p</option> 选项来保留所有权。或者，在创建新文件时，请随后使用 <command>chown</command> <option>hacluster:haclient <replaceable>文件</replaceable></option> 设置用户和组。
  </para>
 </note>

 <para>
   对于包含多个地域群集的设置，可以<quote>共享</quote>同一个仲裁方（从 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise High Availability Extension</phrase></phrase> 12 开始）。通过提供多个 booth 配置文件，可以在同一个仲裁方上启动多个 booth 实例，其中每个 booth 实例在不同的端口上运行。这样，便可以使用<emphasis>一台</emphasis>计算机充当<emphasis>不同</emphasis>地域群集的仲裁方。有关如何为多个地域群集配置 booth 的细节，请参见<xref linkend="sec.ha.geo.booth.multi"/>。
 </para>
 
 
 <para>为了防止恶意方中断 booth 服务，可以基于共享密钥配置身份验证来与 booth 通讯。有关细节，请参见<xref linkend="ex.ha.booth.conf.default"/>中的<xref linkend="co.ha.geo.booth.config.auth"/>。与不同 booth 服务器通讯的所有主机都需要此密钥。因此，请确保在 Csync2 配置中包含密钥文件，或者在所有参与方中手动同步此文件。</para>

 <sect2 xml:id="sec.ha.geo.booth.default">
  <title>默认 Booth 设置</title>
  <para>
   要配置 booth 所需的全部参数，请手动或者使用 YaST <guimenu>地域群集</guimenu>模块编辑 booth 配置文件。要访问 YaST 模块，请从命令行使用 <command>yast2 geo-cluster</command> 将它启动（或者启动 YaST，然后选择<menuchoice> <guimenu>高可用性</guimenu> <guimenu>地域群集</guimenu> </menuchoice>）。
  </para>
  <example xml:id="ex.ha.booth.conf.default">
   <title>Booth 配置文件</title>

<screen><?dbsuse-fo font-size="0.75em"?>

transport = UDP <co xml:id="co.ha.geo.booth.config.transport"/>
port = 9929 <co xml:id="co.ha.geo.booth.config.port"/>
arbitrator = 147.2.207.14 <co xml:id="co.ha.geo.booth.config.arbitrator"/>
site =  192.168.201.151 <co xml:id="co.ha.geo.booth.config.site"/>
site =  192.168.202.151 <xref linkend="co.ha.geo.booth.config.site" xrefstyle="select:label nopage"/>
authfile = /etc/booth/authkey <co xml:id="co.ha.geo.booth.config.auth"/>
ticket = "ticket-nfs" <co xml:id="co.ha.geo.booth.config.ticket"/>
     expire = 600 <co xml:id="co.ha.geo.booth.config.expiry"/>
     timeout = 10 <co xml:id="co.ha.geo.booth.config.timeout"/>
     retries = 5 <co xml:id="co.ha.geo.booth.config.retries"/>
     renewal-freq = 30 <co xml:id="co.ha.geo.booth.config.renewal"/>
     before-acquire-handler<co xml:id="co.ha.geo.booth.config.handler"/> = /etc/booth/ticket-nfs<co xml:id="co.ha.geo.booth.config.script"/> ms_drbd_nfs<co xml:id="co.ha.geo.booth.config.rsc"/>
     acquire-after = 60 <co xml:id="co.ha.geo.booth.config.acquire-after"/>
ticket = "ticketA" <xref linkend="co.ha.geo.booth.config.ticket" xrefstyle="select:label nopage"/>
     expire = 600 <xref linkend="co.ha.geo.booth.config.expiry" xrefstyle="select:label nopage"/>
     timeout = 10 <xref linkend="co.ha.geo.booth.config.timeout" xrefstyle="select:label nopage"/>
     retries = 5 <xref linkend="co.ha.geo.booth.config.retries" xrefstyle="select:label nopage"/>
     renewal-freq = 30 <xref linkend="co.ha.geo.booth.config.renewal" xrefstyle="select:label nopage"/>
     before-acquire-handler<xref linkend="co.ha.geo.booth.config.handler" xrefstyle="select:label nopage"/> = /etc/booth/ticket-A<xref linkend="co.ha.geo.booth.config.script" xrefstyle="select:label nopage"/> db-1 <xref linkend="co.ha.geo.booth.config.rsc" xrefstyle="select:label nopage"/>
     acquire-after = 60 <xref linkend="co.ha.geo.booth.config.acquire-after" xrefstyle="select:label nopage"/>
ticket = "ticketB" <xref linkend="co.ha.geo.booth.config.ticket" xrefstyle="select:label nopage"/>
     expire = 600 <xref linkend="co.ha.geo.booth.config.expiry" xrefstyle="select:label nopage"/>
     timeout = 10 <xref linkend="co.ha.geo.booth.config.timeout" xrefstyle="select:label nopage"/>
     retries = 5 <xref linkend="co.ha.geo.booth.config.retries" xrefstyle="select:label nopage"/>
     renewal-freq = 30 <xref linkend="co.ha.geo.booth.config.renewal" xrefstyle="select:label nopage"/>
     before-acquire-handler<xref linkend="co.ha.geo.booth.config.handler" xrefstyle="select:label nopage"/> = /etc/booth/ticket-B<xref linkend="co.ha.geo.booth.config.script" xrefstyle="select:label nopage"/> db-8 <xref linkend="co.ha.geo.booth.config.rsc" xrefstyle="select:label nopage"/>
     acquire-after = 60 <xref linkend="co.ha.geo.booth.config.acquire-after" xrefstyle="select:label nopage"/>
    </screen>
   <calloutlist>
    <callout arearefs="co.ha.geo.booth.config.transport">
     <para>
      用于站点间通讯的传输协议。仅支持 UDP，但将来可支持其他传输层。因此，目前可以省略此参数。
     </para>
    </callout>
    <callout arearefs="co.ha.geo.booth.config.port">
     <para>
      用于在每个站点上 booth 实例之间通讯的端口。如果不使用默认端口 (<literal>9929</literal>)，请选择尚未用于其他服务的端口。确保在节点和仲裁方的防火墙上都打开该端口。booth 客户端使用 TCP 来与 <systemitem class="daemon">boothd</systemitem> 通讯。Booth 始终会同时绑定到 UDP 和 TCP 端口并予以侦听。
     </para>
    </callout>
    <callout arearefs="co.ha.geo.booth.config.arbitrator">
     <para>
       用作仲裁方的计算机的 IP 地址。请为地域群集设置中要使用的每个仲裁方添加一个项。
     </para>
    </callout>
    <callout arearefs="co.ha.geo.booth.config.site">
     <para>
      用于站点上 <systemitem class="daemon">boothd</systemitem> 的 IP 地址。请为地域群集设置中要使用的每个站点添加一个项。确保为每个站点插入正确的虚拟 IP 地址 (<systemitem>IPaddr2</systemitem>)，否则 booth 机制将不能正确运行。有关如何为 booth 配置虚拟 IP 的细节，请参见<xref linkend="pro.ha.geo.setup.rsc.boothd"/>。Booth 可以使用 IPv4 和 IPv6 地址。

     </para>
    </callout>
    <callout arearefs="co.ha.geo.booth.config.auth">
     <para>
      可选的参数。基于共享密钥为客户端和服务器启用 booth 身份验证。此参数指定密钥文件的路径。 
     </para>
     <itemizedlist>
      <title>密钥要求</title>
      <listitem>
       <para>密钥可以是二进制数或文本。</para>
       <para>如果是文本，将忽略以下字符：前置和尾随空格、换行符。</para>
      </listitem>
      <listitem>
       <para>密钥长度必须为 8 到 64 个字符。</para>
      </listitem>
      <listitem>
        <para>密钥必须属于用户 <systemitem class="username">hacluster</systemitem> 和组 <systemitem class="groupname">haclient</systemitem>。
        </para>
      </listitem>
      <listitem>
       <para>密钥必须只能由文件所有者读取。</para>
      </listitem>
     </itemizedlist>
    </callout>
    <callout arearefs="co.ha.geo.booth.config.ticket">
     <para>
      booth 要管理的票据。请为每个票据添加一个 <literal>ticket</literal> 条目。在本示例中，票据 <literal>ticket-nfs</literal> 在下文中将用于 NFS 和 DRBD 的故障转移。有关详细信息，请参见<xref linkend="sec.ha.geo.drbd"/>。
     </para>
    </callout>
    <callout arearefs="co.ha.geo.booth.config.expiry">
     <para>
      可选的参数。定义票据的失效时间，以秒为单位。已获得票据的站点将会定期续订票据。如果 booth 在截至所定义的失效时间内没有收到票据续订信息，票据将被撤消并授予其他站点。如果没有指定到期时间，默认情况下，票据将于 <literal>600</literal> 秒后过期。不应将该参数设置为小于 120 秒的值。
     </para>
    </callout>
    <callout arearefs="co.ha.geo.booth.config.timeout">
     <para>
      可选的参数。定义超时期限，以秒为单位。如果 booth 未在此期限内收到回复，则在该段时间过后，booth 将重发送包。定义的超时应足够长，以便包能够进入其他 booth 成员（所有仲裁方和站点）。
     </para>
    </callout>
    <callout arearefs="co.ha.geo.booth.config.retries">
     <para>
      可选的参数。定义 booth 在放弃等待其他站点的确认之前需要重试发送包多少次。小于 <literal>3</literal> 的值无效，会阻止 booth 启动。
     </para>
    </callout>
    <callout arearefs="co.ha.geo.booth.config.renewal">
     <para>
      可选的参数。设置票据续订频率周期。默认情况下，票据续订每隔失效时间的一半发生一次。如果在持续较长的一段时间内网络可靠性往往降低，则建议以更高的频率续订票据。在每次续订之前，应运行 <literal>before-acquire-handler</literal>。
     </para>
    </callout>
    <callout arearefs="co.ha.geo.booth.config.handler">
     <para>
      可选的参数。支持一个或多个脚本。如果使用多个脚本，则每个脚本可以负责不同的检查，例如群集状态、数据中心连接、环境运行状况传感器和其他检查。将所有脚本储存在目录 <filename>/etc/booth.d/<replaceable>票据名称</replaceable></filename>中，并确保它们具有正确的所有权（用户 <systemitem class="username">hacluster</systemitem> 和组 <systemitem class="groupname">haclient</systemitem>）。将目录名称指派为参数值 <parameter>before-acquire-handler</parameter>。
     </para>
     <para>
      此目录中的脚本按字母顺序执行。在 <systemitem class="daemon">boothd</systemitem> 尝试获取或续订票据之前，将调用所有脚本。要授予或续订票据，<emphasis>所有</emphasis>脚本必须成功。语义与单个脚本的语义相同：如果退出代码不为 <literal>0</literal>，<systemitem class="daemon">boothd</systemitem> 将放弃票据。
     </para>
    </callout>
    <callout arearefs="co.ha.geo.booth.config.script">
     <para>
      产品中包含的 <filename>/usr/share/booth/service-runnable</filename> 脚本用作示例。要使用该脚本，请将它链接到相应的 <quote>ticket</quote> 目录：
     </para>
     <screen><prompt role="root">root # </prompt><command>ln</command> -s /usr/share/booth/service-runnable /etc/booth.d/<replaceable>TICKET_NAME</replaceable></screen>
     <para>
      假设 <filename>/etc/booth.d<replaceable>票据名称</replaceable></filename>目录包含 <command>service-runnable</command> 脚本。这个简单的脚本基于 <command>crm_simulate</command>。它可用于测试是否<emphasis>可以</emphasis>在当前群集站点上运行特定的群集资源。这意味着，它将检查群集运行状况是否足够良好，可以运行该资源（满足所有资源依赖性要求、群集分区具有仲裁、没有脏节点，等等）。例如，如果依赖链中的某个服务在所有可用节点上的失败计数为 <literal>INFINITY</literal>，则无法在该站点上运行该服务。在这种情况下，声明票据就没有意义。
     </para>
    </callout>
    <callout arearefs="co.ha.geo.booth.config.rsc">
     <para>
      <literal>before-acquire-handler</literal>（在本例中为 <filename>service-runnable</filename> 脚本）要测试的资源。需要参照相应票据保护的资源。在本示例中，资源·<literal>db-1</literal> 由 <literal>ticketA</literal> 保护，<literal>db-8</literal> 由 <literal>ticketB</literal> 保护。DRBD 的资源 (<literal>ms_drbd_nfs</literal>) 由票据 <literal>ticket-nfs</literal> 保护。
     </para>
    </callout>
    <callout arearefs="co.ha.geo.booth.config.acquire-after">
     <para>
      可选的参数。票据丢失后，booth 将额外等待这段时间，然后再获取票据。这样，丢失票据的站点便可以通过停止资源或者屏蔽资源来放弃资源。典型的延迟为 <literal>60</literal> 秒，但最终延迟取决于受保护的资源和屏蔽配置。默认值为 <literal>0</literal>。
     </para>
     <para>
      如果您不确定停止资源、降级资源或屏蔽节点的时间有多长（该时间取决于 <literal>loss-policy</literal>），可以使用此参数来防止资源同时在两个站点上运行。
     </para>
    </callout>
   </calloutlist>
  </example>
  <procedure xml:id="pro.ha.geo.setup.booth.config.edit">
   <title>手动编辑 Booth 配置文件</title>
   <step>
    <para>
     以 <systemitem class="username">root</systemitem> 或同等身份登录到群集节点。
    </para>
   </step>
   <step>
    <para>
     将示例 booth 配置文件 <filename>/etc/booth/booth.conf.example</filename> 复制到 <filename>/etc/booth/booth.conf</filename>：
    </para>
    <remark>toms 2016-08-09: "cp -p" is needed, see https://bugzilla.suse.com/show_bug.cgi?id=968865#c14</remark>
    <screen><prompt role="root">root # </prompt><command>cp</command> -p /etc/booth/booth.conf.example /etc/booth/booth.conf</screen>
   </step>
   <step>
    <para>
     根据<xref linkend="ex.ha.booth.conf.default"/>编辑 <filename>/etc/booth/booth.conf</filename>。
    </para>
   </step>
   <step>
    <para>
     确认更改并保存文件。
    </para>
   </step>
   <step>
    <para>
     在所有群集节点和仲裁方上，打开在防火墙中为 booth 配置的端口。参见<xref linkend="ex.ha.booth.conf.default"/>中的位置 <xref linkend="co.ha.geo.booth.config.port"/>。
    </para>
   </step>
  </procedure>
  <procedure xml:id="pro.ha.geo.setup.booth.yast">
   <title>使用 YaST 设置 Booth</title>
   <step>
    <para>
     以 <systemitem class="username">root</systemitem> 或同等身份登录到群集节点。
    </para>
   </step>
   <step>
    <para>
     启动 YaST <guimenu>地域群集</guimenu>模块。
    </para>
   </step>
   <step>
    <para>
     选择<guimenu>编辑</guimenu>现有 booth 配置文件，或者单击<guimenu>添加</guimenu>创建新的 booth 配置文件。
    </para>
    <substeps performance="required">
     <step xml:id="step.ha.booth.conf.params">
      <para>
       在出现的屏幕中配置以下参数：
      </para>
      <itemizedlist>
       <listitem>
        <formalpara>
         <title>配置文件</title>
         <para>
          booth 配置文件的名称。YaST 建议按默认使用 <literal>booth</literal>。这样，就会将 booth 配置写入 <filename>/etc/booth/booth.conf</filename>。仅当您需要根据<xref linkend="sec.ha.geo.booth.multi"/>中所述为不同的地域群集设置多个 booth 实例时，才更改此值。
         </para>
        </formalpara>
       </listitem>
       <listitem>
        <formalpara>
         <title>传输</title>
         <para>
          用于站点间通讯的传输协议。仅支持 UDP，但将来可支持其他传输层。另请参见<xref linkend="ex.ha.booth.conf.default"/>中的位置 <xref linkend="co.ha.geo.booth.config.transport"/>。
         </para>
        </formalpara>
       </listitem>
       <listitem>
        <formalpara>
         <title>端口</title>
         <para>
          用于在每个站点上 booth 实例之间通讯的端口。另请参见<xref linkend="ex.ha.booth.conf.default"/>中的位置 <xref linkend="co.ha.geo.booth.config.port"/>。
         </para>
        </formalpara>
       </listitem>
       <listitem>
        <formalpara>
         <title>仲裁方</title>
         <para>
           用作仲裁方的计算机的 IP 地址。另请参见<xref linkend="ex.ha.booth.conf.default"/>中的位置 <xref linkend="co.ha.geo.booth.config.arbitrator"/>。
         </para>
        </formalpara>
        <para>
         要指定<guimenu>仲裁方</guimenu>，请单击<guimenu>添加</guimenu>。在打开的对话框中，输入仲裁方的 IP 地址，然后单击<guimenu>确定</guimenu>。
        </para>
       </listitem>
       <listitem>
        <formalpara>
         <title>Site</title>
         <para>
          用于站点上 <systemitem class="daemon">boothd</systemitem> 的 IP 地址。另请参见<xref linkend="ex.ha.booth.conf.default"/>中的位置 <xref linkend="co.ha.geo.booth.config.site"/>。
         </para>
        </formalpara>
        <para>
         要指定地域群集的<guimenu>站点</guimenu>，请单击<guimenu>添加</guimenu>。在打开的对话框中，输入一个站点的 IP 地址，然后单击<guimenu>确定</guimenu>。
        </para>
       </listitem>
       <listitem>
        <formalpara>
         <title>票据</title>
         <para>
          booth 要管理的票据。另请参见<xref linkend="ex.ha.booth.conf.default"/>中的位置 <xref linkend="co.ha.geo.booth.config.ticket"/>。
         </para>
        </formalpara>
        <para>
         要指定<guimenu>票据</guimenu>，请单击<guimenu>添加</guimenu>。在打开的对话框中，输入唯一的<guimenu>票据</guimenu>名称。若要使用相同的参数和值定义多个票据，请创建一个<quote>票据模板</quote>来为所有票据指定默认参数和值，从而减少配置工作量。为此，请使用 <literal>__default__</literal> 作为<guimenu>票据</guimenu>名称。
        </para>
       </listitem>
       <listitem>
        
        <formalpara>
         <title>鉴定</title>
         <para>要为 booth 启用身份验证，请单击<guimenu>身份验证</guimenu>，然后在打开的对话框中，激活<guimenu>启用安全身份验证</guimenu>。如果已有一个密钥，请在<guimenu>身份验证文件</guimenu>中指定路径和文件名。要为新的地域群集生成密钥文件，请单击<guimenu>生成身份验证密钥文件</guimenu>。随后将创建密钥并将其写入<guimenu>身份验证文件</guimenu>中指定的位置。</para>
        </formalpara>
        <para>
         此外，可以指定票据的可选参数。有关概述，请参见<xref linkend="ex.ha.booth.conf.default"/>中的位置 <xref linkend="co.ha.geo.booth.config.expiry"/> 到 <xref linkend="co.ha.geo.booth.config.acquire-after"/>。
        </para>
        <para>
         单击<guimenu>确定</guimenu>确认更改。
        </para>
       </listitem>
      </itemizedlist>
      <figure xml:id="fig.yast2.ha.geo.booth">
       <title>示例票据依赖性</title>
       <mediaobject>
        <imageobject role="fo">
         <imagedata fileref="yast2_geo_cluster_booth.png" width="80%" format="PNG"/>
        </imageobject>
        <imageobject role="html">
         <imagedata fileref="yast2_geo_cluster_booth.png" width="50%" format="PNG"/>
        </imageobject>
       </mediaobject>
      </figure>
     </step>
     <step>
      <para>
       单击<guimenu>确定</guimenu>关闭当前 booth 配置屏幕。YaST 将显示定义的 booth 配置文件的名称。
      </para>
     </step>
    </substeps>
   </step>
   <step>
    <para>
     在关闭 YaST 模块之前，请切换到<guimenu>防火墙配置</guimenu>类别。
    </para>
   </step>
   <step>
    <para>
     要打开您为 booth 配置的端口，请启用<guimenu>打开防火墙中的端口</guimenu>。
    </para>
    <important>
     <title>防火墙设置仅适用于本地计算机</title>
     <para>
      防火墙设置仅适用于当前计算机。将为 <filename>/etc/booth/booth.conf</filename> 中指定的所有端口或者其他任何 booth 配置文件打开 UDP/TCP 端口（请参见<xref linkend="sec.ha.geo.booth.multi"/>）。
     </para>
     <para>
      请确保同时在地域群集的其他所有节点和仲裁方上打开相应的端口。可以手动或者通过将以下文件与 Csync2 同步来执行此操作：
     </para>
     <itemizedlist>
      <listitem>
       <para>
        <filename>/etc/sysconfig/SuSEfirewall2</filename>
       </para>
      </listitem>
      <listitem>
       <para>
        <filename>/etc/sysconfig/SuSEfirewall2.d/services/booth</filename>
       </para>
      </listitem>
     </itemizedlist>
    </important>
   </step>
   <step>
    <para>
     单击<guimenu>完成</guimenu>确认所有设置并关闭 YaST 模块。根据<xref linkend="step.ha.booth.conf.params"/> 中指定的<guimenu>配置文件</guimenu><replaceable>名称</replaceable>，配置将写入 <filename>/etc/booth/<replaceable>名称</replaceable>.conf</filename>。
    </para>
   </step>
  </procedure>
 </sect2>

 <sect2 xml:id="sec.ha.geo.booth.multi">
  <title>多个租户的 Booth 设置</title>

  <para>
    对于包含多个地域群集的设置，可以<quote>共享</quote>同一个仲裁方（从 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise High Availability Extension</phrase></phrase> 12 开始）。通过提供多个 booth 配置文件，可以在同一个仲裁方上启动多个 booth 实例，其中每个 booth 实例在不同的端口上运行。这样，便可以使用<emphasis>一台</emphasis>计算机充当<emphasis>不同</emphasis>地域群集的仲裁方。
  </para>
  <para>
   假设您有两个地域群集，一个位于 EMEA（欧洲、中东和非洲），另一个位于 APAC（亚太区）。
  </para>
  <para>
   要为这两个地域群集使用同一个仲裁方，请在 <filename>/etc/booth</filename> 目录中创建两个配置文件：<filename>/etc/booth/emea.conf</filename> 和 <filename>/etc/booth/apac.conf</filename>。最起码，这两个配置文件的以下参数必须不同：
  </para>
  <itemizedlist>
   <listitem>
    <para>
     用于 booth 实例通讯的端口。
    </para>
   </listitem>
   <listitem>
    <para>
     属于使用仲裁方的不同地域群集的站点。
    </para>
   </listitem>
  </itemizedlist>
  <example xml:id="ex.ha.conf.booth.multi-1">
   <title><filename>/etc/booth/apac.conf</filename></title>
<screen><?dbsuse-fo font-size="0.75em"?>

transport = UDP <xref linkend="co.ha.geo.booth.config.transport" xrefstyle="select:label nopage"/>
port = 9133 <xref linkend="co.ha.geo.booth.config.port" xrefstyle="select:label nopage"/>
arbitrator = 147.2.207.14 <xref linkend="co.ha.geo.booth.config.arbitrator" xrefstyle="select:label nopage"/>
site = 192.168.2.254 <xref linkend="co.ha.geo.booth.config.site" xrefstyle="select:label nopage"/>
site = 192.168.1.112 <xref linkend="co.ha.geo.booth.config.site" xrefstyle="select:label nopage"/>
authfile = /etc/booth/authkey-apac <xref linkend="co.ha.geo.booth.config.auth" xrefstyle="select:label nopage"/>
ticket ="tkt-db-apac-intern" <xref linkend="co.ha.geo.booth.config.ticket"/>
     timeout = 10 
     retries = 5 
     renewal-freq = 60 
     before-acquire-handler<xref linkend="co.ha.geo.booth.config.handler" xrefstyle="select:label nopage"/> = /usr/share/booth/service-runnable<xref linkend="co.ha.geo.booth.config.script" xrefstyle="select:label nopage"/> db-apac-intern <xref linkend="co.ha.geo.booth.config.rsc" xrefstyle="select:label nopage"/> 
ticket = "tkt-db-apac-cust" <xref linkend="co.ha.geo.booth.config.ticket" xrefstyle="select:label nopage"/>
     timeout = 10 
     retries = 5 
     renewal-freq = 60 
     before-acquire-handler = /usr/share/booth/service-runnable db-apac-cust</screen>
  </example>
  <example xml:id="ex.ha.conf.booth.multi-2">
   <title><filename>/etc/booth/emea.conf</filename></title>
<screen><?dbsuse-fo font-size="0.75em"?>

transport = UDP <xref linkend="co.ha.geo.booth.config.transport" xrefstyle="select:label nopage"/>
port = 9150 <xref linkend="co.ha.geo.booth.config.port" xrefstyle="select:label nopage"/>
arbitrator = 147.2.207.14 <xref linkend="co.ha.geo.booth.config.arbitrator" xrefstyle="select:label nopage"/>
site = 192.168.201.151 <xref linkend="co.ha.geo.booth.config.site" xrefstyle="select:label nopage"/>
site = 192.168.202.151 <xref linkend="co.ha.geo.booth.config.site" xrefstyle="select:label nopage"/>
authfile = /etc/booth/authkey-emea <xref linkend="co.ha.geo.booth.config.auth" xrefstyle="select:label nopage"/>
ticket = "tkt-sap-crm" <xref linkend="co.ha.geo.booth.config.ticket"/>
     expire = 900 
     renewal-freq = 60 
     before-acquire-handler<xref linkend="co.ha.geo.booth.config.handler" xrefstyle="select:label nopage"/> = /usr/share/booth/service-runnable<xref linkend="co.ha.geo.booth.config.script" xrefstyle="select:label nopage"/> sap-crm <xref linkend="co.ha.geo.booth.config.rsc" xrefstyle="select:label nopage"/>
ticket = "tkt-sap-prod" <xref linkend="co.ha.geo.booth.config.ticket" xrefstyle="select:label nopage"/>
     expire = 600 
     renewal-freq = 60 
     before-acquire-handler = /usr/share/booth/service-runnable sap-prod</screen>
  </example>
  <calloutlist>
   <callout arearefs="co.ha.geo.booth.config.transport">
    <para>
     用于站点间通讯的传输协议。仅支持 UDP，但将来可支持其他传输层。因此，目前可以省略此参数。
    </para>
   </callout>
   <callout arearefs="co.ha.geo.booth.config.port">
    <para>
     用于在每个站点上 booth 实例之间通讯的端口。配置文件使用不同的端口来允许在同一仲裁方上启动多个 booth 实例。
    </para>
   </callout>
   <callout arearefs="co.ha.geo.booth.config.arbitrator">
    <para>
      用作仲裁方的计算机的 IP 地址。在上述示例中，我们为不同的地域群集使用了同一个仲裁方。
    </para>
   </callout>
   <callout arearefs="co.ha.geo.booth.config.site">
    <para>
     用于站点上 <systemitem class="daemon">boothd</systemitem> 的 IP 地址。两个 booth 配置文件中定义的站点不同，因为这些站点属于两个不同的地域群集。
    </para>
   </callout>
   <callout arearefs="co.ha.geo.booth.config.auth">
    <para>
     可选的参数。基于共享密钥为客户端和服务器启用 booth 身份验证。此参数指定密钥文件的路径。为不同的租户使用不同的密钥文件。
    </para>
    <itemizedlist>
      <title>密钥要求</title>
      <listitem>
       <para>密钥可以是二进制数或文本。</para>
       <para>如果是文本，将忽略以下字符：前置和尾随空格、换行符。</para>
      </listitem>
      <listitem>
       <para>密钥长度必须为 8 到 64 个字符。</para>
      </listitem>
      <listitem>
        <para>密钥必须属于用户 <systemitem class="username">hacluster</systemitem> 和组 <systemitem class="groupname">haclient</systemitem>。
        </para>
      </listitem>
      <listitem>
       <para>密钥必须只能由文件所有者读取。</para>
      </listitem>
     </itemizedlist>
   </callout>
   <callout arearefs="co.ha.geo.booth.config.ticket">
    <para>
     booth 要管理的票据。理论上讲，可以在不同的 booth 配置文件中定义相同的票据名称 — 票据不会造成干扰，因为它们属于不同 booth 实例管理的不同地域群集。但是，（为了便于讲述），我们建议按上述示例中所示，为每个地域群集使用不同的票据名称。
    </para>
   </callout>
   <callout arearefs="co.ha.geo.booth.config.handler">
    <para>
     可选的参数。如果设置该参数，则在 <systemitem class="daemon">boothd</systemitem> 尝试获取或续订票据之前，将调用指定的命令。如果退出代码不为 <literal>0</literal>，<systemitem class="daemon">boothd</systemitem> 将放弃票据。
    </para>
   </callout>
   <callout arearefs="co.ha.geo.booth.config.script">
    <para>
     此处提到的 <filename>service-runnable</filename> 脚本在产品中用作示例。它是一个基于 <command>crm_simulate</command> 的简单脚本。它可用于测试是否<emphasis>可以</emphasis>在当前群集站点上运行特定的群集资源。这意味着，它将检查群集运行状况是否足够良好，可以运行该资源（满足所有资源依赖性要求、群集分区具有仲裁、没有脏节点，等等）。例如，如果依赖链中的某个服务在所有可用节点上的失败计数为 <literal>INFINITY</literal>，则无法在该站点上运行该服务。在这种情况下，声明票据就没有意义。
    </para>
   </callout>
   <callout arearefs="co.ha.geo.booth.config.rsc">
    <para>
     <literal>before-acquire-handler</literal>（在本例中为 <filename>service-runnable</filename> 脚本）要测试的资源。需要参照相应票据保护的资源。
    </para>
   </callout>
  </calloutlist>
  <procedure>
   <title>为不同的地域群集使用相同的仲裁方</title>
   <step>
    <para>
     如<xref linkend="ex.ha.conf.booth.multi-1"/>和<xref linkend="ex.ha.conf.booth.multi-2"/>中所述，在 <filename>/etc/booth</filename> 中创建不同的 booth 配置文件。可以手动执行此操作，或者按<xref linkend="pro.ha.geo.setup.booth.yast"/>中所述使用 YaST 来创建。
    </para>
   </step>
   <step>
    <para>
     在仲裁方上，打开 <filename>/etc/booth</filename> 中任一 booth 配置文件内定义的端口。
    </para>
   </step>
   <step>
    <para>
     在属于使用仲裁方的单个地域群集的节点上，打开相应 booth 实例所用的端口。
    </para>
   </step>
   <step>
    <para>
     在使用相同 booth 配置的所有群集节点和仲裁方上，同步相应的 booth 配置文件。有关细节，请参见<xref linkend="sec.ha.geo.booth.sync"/>。
    </para>
   </step>
   <step>
    <para>
     在仲裁方上，按<xref linkend="vle.ha.geo.setup.booth.service.arbitrator"/>中所述为多租户设置启动各个 booth 实例。
    </para>
   </step>
   <step>
    <para>
     在各个地域群集上，按<xref linkend="vle.ha.geo.setup.booth.service.sites"/>中所述启动 booth 服务。
    </para>
   </step>
  </procedure>
 </sect2>

 <sect2 xml:id="sec.ha.geo.booth.sync">
  <title>将 Booth 配置同步到所有站点和仲裁方</title>
  <note>
   <title>在所有站点和仲裁方上使用相同的 Booth 配置</title>
   <para>
    要使 booth 正常工作，一个地域群集中的所有群集节点和仲裁方必须使用相同的 booth 配置。
   </para>
   <para>
    可以使用 Csync2 来同步 booth 配置。有关细节，请参见<xref linkend="sec.ha.geo.booth.sync.csync2.setup"/>和<xref linkend="sec.ha.geo.booth.sync.csync2.start"/>。
   </para>
   <para>
    如果任何 booth 配置发生更改，请务必在所有参与方上相应地更新配置文件，并按<xref linkend="sec.ha.geo.setup.booth.reconfig"/>中所述重启动 booth 服务。
   </para>
  </note>
 </sect2>

 <sect2 xml:id="sec.ha.geo.setup.booth.service">
  <title>启用和启动 Booth 服务</title>
  <variablelist>
   <varlistentry xml:id="vle.ha.geo.setup.booth.service.sites">
    <term>在群集站点上启动 Booth 服务</term>
    <listitem>
     <para>
      每个群集站点的 booth 服务由<xref linkend="pro.ha.geo.setup.rsc.boothd"/>中配置的 booth 资源组管理。要为每个站点启动一个 booth 服务实例，请在每个群集站点上启动相应的 booth 资源组。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry xml:id="vle.ha.geo.setup.booth.service.arbitrator">
    <term>在仲裁方上启动 Booth 服务</term>

    <listitem>
     <para>
      从 SUSE Linux Enterprise 12 开始，booth 仲裁方由 systemd 管理。单元文件名为 <filename>booth@.service</filename>。<literal>@</literal> 表示可以使用一个参数（在本例中为配置文件的名称）运行该服务。
     </para>
     <para>
      要在仲裁方上<emphasis>启用</emphasis> booth 服务，请使用以下命令：
     </para>
<screen><prompt role="root">root # </prompt><command>systemctl</command> enable booth@booth</screen>
     <para>
      从命令行启用服务后，只要该服务未禁用，就可以使用 YaST 服务管理器对它进行管理。如果该服务已禁用，则下一次重启动 systemd 时，它将从 YaST 的服务列表中消失。
     </para>
     <para>
      但是，用于<emphasis>启动</emphasis> booth 服务的命令取决于 booth 设置：
     </para>
     <itemizedlist>
      <listitem>
       <para>
        如果按<xref linkend="sec.ha.geo.booth.default"/>中所述使用默认设置，则表示只配置了 <filename>/etc/booth/booth.conf</filename>。在这种情况下，请登录到每个仲裁方并使用以下命令：
       </para>
<screen><prompt role="root">root # </prompt><command>systemctl</command> start booth@booth</screen>
      </listitem>
      <listitem>
       <para>
        如果按<xref linkend="sec.ha.geo.booth.multi"/>中所述以多租户模式运行 booth，则已在 <filename>/etc/booth</filename> 中配置了多个 booth 配置文件。要为单个 booth 实例启动服务，请使用 <command>systemctl start booth@</command> <replaceable>NAME</replaceable>，其中的 <replaceable>NAME</replaceable> 代表相应配置文件 <filename>/etc/booth/<replaceable>名称</replaceable>.conf</filename> 的名称。
       </para>
       <para>
        例如，如果创建了 booth 配置文件 <filename>/etc/booth/emea.conf</filename> 和 <filename>/etc/booth/apac.conf</filename>，请登录到仲裁方并执行以下命令：
       </para>
<screen><prompt role="root">root # </prompt><command>systemctl</command> start booth@emea
<prompt role="root">root # </prompt><command>systemctl</command> start booth@apac</screen>
       <para>

       </para>
      </listitem>
     </itemizedlist>
     <para>
      这将以仲裁方模式启动 booth 服务。它可以与所有其他 booth 守护程序通讯，但和群集站点上运行的 booth 守护程序不同，它不能被授予票据。Booth 仲裁方只参与选择。否则，它们处于休眠状态。
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
 </sect2>

 <sect2 xml:id="sec.ha.geo.setup.booth.reconfig">
  <title>运行时重配置 Booth</title>

  <para>
   如果在已运行 booth 服务的情况下需要更改 booth 配置，请执行以下操作：
  </para>
  <procedure>
   <step>
    <para>
     根据需要调整 booth 配置文件。
    </para>
   </step>
   <step>
    <para>
     将更新的 booth 配置文件同步到属于地域群集的所有群集节点和仲裁方。有关细节，请参见<xref linkend="sec.ha.geo.sync"/>。
    </para>
   </step>
   <step>

    <para>
     按<xref linkend="sec.ha.geo.setup.booth.service"/>中所述，在仲裁方和站点上重启动 booth 服务。这不会给已授予站点的票据造成任何影响。
    </para>
   </step>
  </procedure>
 </sect2>
</sect1>
