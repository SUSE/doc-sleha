<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE chapter PUBLIC "-//Novell//DTD NovDoc XML V1.0//EN" "novdocx.dtd">
<!--
*********************************
Please see LICENSE.txt for this document's license.
*********************************
-->
<chapter xml:base="ha_agents.xml" id="cha.ha.agents">
 <title>添加或修改资源代理</title>
 <abstract>
  <para>
   需由群集管理的所有任务都必须可用作资源。在此处需要考虑两个主要组：资源代理和 STONITH 代理。对于这两个类别，您都可以添加自己的代理，根据需要扩展群集的功能。
  </para>
 </abstract>
 <sect1 id="sec.ha.stonithagents">
  <title>STONITH 代理</title>

  <para>
   群集有时会检测到某个节点行为异常，需要删除此节点。这称为<emphasis>屏蔽</emphasis>，通常使用 STONITH 资源实现。所有 STONITH 资源都位于每个节点上的 <filename>/usr/lib/stonith/plugins</filename> 中。
  </para>

  <warning>
   <title>不支持外部 SSH/STONITH</title>
   <para>
    由于无法了解 SSH 可能对其他系统问题如何做出反应。出于此原因，生产环境不支持外部 SSH/STONITH 代理（例如 <literal>stonith:external/ssh</literal>）。如果您仍要使用此类代理进行测试，请安装 <systemitem class="resource">libglue-devel</systemitem> 包。
   </para>
  </warning>

  <para>
   要（从软件端）获取所有当前可用的 STONITH 设备列表，请使用 <command>crm ra list stonith</command> 命令。如果您找不到收藏的代理，请安装 <systemitem class="resource">-devel</systemitem> 包。
  </para>

  <para>
   目前尚无有关写入 STONITH 代理的文档。如果要写入新的 STONITH 代理，请参见 <systemitem class="resource">cluster-glue</systemitem> 包的源中提供的示例。
  </para>
 </sect1>
 <sect1 id="sec.ha.writingresourceagents">
  <title>写入 OCF 资源代理</title>

  <para>
   所有 OCF 资源代理 (RA) 都可在 <filename>/usr/lib/ocf/resource.d/</filename> 中找到，请参见<xref linkend="sec.ha.config.basics.raclasses"/>了解更多信息。每个资源代理都必须支持以下操作才能进行控制：
  </para>

  <variablelist>
   <varlistentry>
    <term><command>start</command>
    </term>
    <listitem>
     <para>
      启动或启用资源
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><command>stop</command>
    </term>
    <listitem>
     <para>
      停止或禁用资源
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><command>status</command>
    </term>
    <listitem>
     <para>
      返回资源状态
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><command>monitor</command>
    </term>
    <listitem>
     <para>
      与 <command>status</command> 类似，但还会检查是否存在意外状态
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><command>validate</command>
    </term>
    <listitem>
     <para>
      验证资源配置
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><command>meta-data</command>
    </term>
    <listitem>
     <para>
      返回有关资源代理的 XML 格式的信息
     </para>
    </listitem>
   </varlistentry>
  </variablelist>

  <para>
   创建 OCF RA 的常规过程大概如下：
  </para>

  <procedure>
   <step performance="required">
    <para>
     将文件 <filename>/usr/lib/ocf/resource.d/pacemaker/Dummy</filename> 装载为模板。
    </para>
   </step>
   <step performance="required">
    <para>
     为每个新资源代理创建新的子目录，以避免发生命名冲突。例如，如果您的一个资源组 <literal>kitchen</literal> 具有资源 <literal>coffee_machine</literal>，可将此资源添加到目录 <filename>/usr/lib/ocf/resource.d/kitchen/</filename>。要访问此资源代理，请执行命令 <command>crm</command>：
    </para>
<screen><command>configure</command><command>primitive</command> coffee_1 <emphasis>ocf:coffee_machine:kitchen</emphasis> ...</screen>
   </step>
   <step performance="required">
    <para>
     实施其他外壳功能，并用不同名称保存文件。
    </para>
   </step>
  </procedure>

  <para>
   可在 <ulink url="http://linux-ha.org/wiki/Resource_Agents"/> 中找到有关写入 OCF 资源代理的更多细节。在<xref linkend="cha.ha.concepts"/>中可以找到有关若干概念的特殊信息。
  </para>
 </sect1>
 <xi:include xmlns:xi="http://www.w3.org/2001/XInclude" href="ha_error_codes.xml" parse="xml"/>
</chapter>
