<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE appendix
[
  <!ENTITY % entities SYSTEM "entity-decl.ent">
    %entities;
]>
<!-- Converted by suse-upgrade version 1.1 -->
<!--https://fate.suse.com/314907: hb_reports without ssh root access  -->
<appendix xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" version="5.0" xml:id="app.crm_report.nonroot">
 <title>Running Cluster Reports Without &rootuser; Access</title>
 <info/>
 <para>
  All cluster nodes must be able to access each other via SSH. Tools like
  <command>hb_report</command> or <command>crm_report</command> (for
  troubleshooting) and &hawk;'s <guimenu>History Explorer</guimenu>
  require passwordless SSH access between the nodes, otherwise they can only
  collect data from the current node.
 </para>
 <para>
  If passwordless SSH &rootuser; access does not comply with regulatory
  requirements, you can use a work-around for running cluster reports. It
  consists of the following basic steps:
 </para>
 <orderedlist spacing="normal">
  <listitem>
   <para>
    Creating a dedicated local user account (for running
    <command>crm_report</command> or <command>hb_report</command>).
   </para>
  </listitem>
  <listitem>
   <para>
    Configuring a passwordless SSH access for that user account, best by
    using a non-standard SSH port.
   </para>
  </listitem>
  <listitem>
   <para>
    Configuring <command>sudo</command> for that user.
   </para>
  </listitem>
  <listitem>
   <para>
    Running <command>crm_report</command> or <command>hb_report</command> as
    that user.
   </para>
  </listitem>
 </orderedlist>
 <para>
  By default when <command>crm_report</command> or
  <command>hb_report</command> are run, they attempt to authenticate to
  remote nodes first as &rootuser;, then as user
  <systemitem class="username">hacluster</systemitem>. However, if your
  local security policy prevents &rootuser; login using SSH, the script
  execution will fail on all remote nodes. Even attempting to run the script
  as user <systemitem class="username">hacluster</systemitem> will fail
  because this is a service account, and its shell is set to
  <filename>/bin/false</filename>, which prevents login. Creating a
  dedicated local user is the only option to successfully run the
  <command>crm_report</command> or <command>hb_report</command> script on
  all nodes in the &ha; cluster.
 </para>
 <sect1>
  <title>Creating a Local User Account</title>

  <para>
   In the following example, we will create a local user named
   <systemitem class="username">hareport</systemitem> from command line. The
   password can be anything that meets your security requirements.
   Alternatively, you can create the user account and set the password with
   &yast;.
  </para>

  <procedure>
   <title>Creating a Dedicated User Account for Running Cluster Reports</title>
   <step>
    <para>
     Start a shell and create a user
     <systemitem class="username">hareport</systemitem> with a home
     directory <filename>/home/hareport </filename>:
    </para>
<screen>&prompt.root;<command>useradd</command> -m -d /home/hareport -c “HA Report” hareport</screen>
   </step>
   <step>
    <para>
     Set a password for the user:
    </para>
<screen>&prompt.root;passwd hareport</screen>
   </step>
   <step>
    <para>
     When prompted, enter and re-enter a password for the user.
    </para>
   </step>
  </procedure>

  <important>
   <title>Same User Is Required On Each Cluster Nodes</title>
   <para>
    To create the same user account on all nodes, repeat the steps above on
    each cluster node.
   </para>
  </important>
 </sect1>
 <sect1>
  <title>Configuring a Passwordless SSH Account</title>

  <para>
   <remark>taroth 2015-06-18: todo - check with DEVs if the following two procedures are still needed since hb_report
        has the -X option now...</remark>
  </para>

  <procedure>
   <title>Configuring the SSH Daemon for a Non-Standard Port</title>
   <para>
    By default the SSH daemon, and the SSH client, talk and listen on port
    <literal>22</literal>. If your network security guidelines require the
    default SSH port to be changed to an alternate high numbered port you
    need to modify the daemon's configuration file
    <filename>/etc/ssh/sshd_config</filename>.
   </para>
   <step>
    <para>
     To modify the default port, search the file for the
     <literal>Port</literal> line, uncomment it and edit it according to
     your wishes. For example, set it to:
    </para>
<screen>Port 5022</screen>
   </step>
   <step>
    <para>
     If your organization does not permit the &rootuser; user to access
     other servers, search the file for the
     <literal>PermitRootLogin</literal> entry, uncomment it and set it to
     <literal>no</literal>:
    </para>
<screen>PermitRootLogin no</screen>
   </step>
   <step>
    <para>
     Alternatively, add the respective lines to the end of the file by
     executing the following commands:
    </para>
<screen>&prompt.root;echo “PermitRootLogin no” &gt;&gt; /etc/ssh/sshd_config
        &prompt.root;echo “Port 5022” &gt;&gt; /etc/ssh/sshd_config</screen>
   </step>
   <step>
    <para>
     After modifying <filename>/etc/ssh/sshd_config</filename>, restart the
     SSH daemon to make the new settings take effect:
    </para>
<screen>&prompt.root;systemctl restart sshd.service</screen>
   </step>
  </procedure>

  <important>
   <title>Same Settings Are Required On Each Cluster Node</title>
   <para>
    Repeat the SSH daemon configuration above on each cluster node.
   </para>
  </important>

  <procedure>
   <title>Configuring the SSH Client for a Non-Standard Port</title>
   <para>
    If the SSH port change is going to be made on all nodes in the cluster,
    it is useful to modify the SSH configuration file,
    <filename>/etc/ssh/sshd_config</filename>. This prevents you from
    specify the SSH port on the command line (with the <option>-X</option>
    option) when running <command>hb_report</command> (or to modify the
    hb_report script to use the non-standard port). At this time there is no
    command line switch for hb_report to specify the SSH port.
    <remark>taroth 2015-06-18: @DEVs, this is no longer true, we know have the '-X' option.
          BTW, does the option only work for 'hb_report' or also for 'crm_report'?</remark>
   </para>
   <step>
    <para>
     To modify the default port, search the file for the
     <literal>Port</literal> line, uncomment it and edit it according to
     your wishes. For example, set it to:
    </para>
<screen>Port 5022</screen>
   </step>
   <step>
    <para>
     Alternatively, add the respective line to the end of the file by
     executing the following commands:
    </para>
<screen>&prompt.root;echo “Port 5022” &gt;&gt; /etc/ssh/ssh_config</screen>
   </step>
  </procedure>

  <note>
   <title>Settings Only Required on One Node</title>
   <para>
    The SSH client configuration above is only needed on the node on which
    you want to run the cluster report.
   </para>
  </note>

  <procedure>
   <title>Configuring Shared SSH Keys</title>
   <para>
    You can access other servers using SSH and not be requested for a
    password. While this may appear insecure at first sight, it is actually
    a very secure access method since the users can only access servers that
    their public key has been shared with. The shared key must be created as
    the user that will use the key.
   </para>
   <step>
    <para>
     Log in to one of the nodes with the user account that you have created
     for running cluster reports (in our example above, the user account was
     <systemitem class="username">hareport</systemitem>).
    </para>
   </step>
   <step>
    <para>
     Generate a new key:
    </para>
<screen><prompt role="user">hareport &gt; </prompt>ssh-keygen –t rsa</screen>
    <para>
     This command will generate a 2048 bit key by default. The default
     location for the key is <filename>~/.ssh/</filename>. You are asked to
     set a passphrase on the key. However, this is optional. For the
     purposes of running the cluster report script there should be no
     passphrase on the key.
     <remark>taroth
            2015-06-22: @DEVs: any reasons why no passphrase? simply not needed? or detrimental in any way?</remark>
    </para>
   </step>
   <step>
    <para>
     After the keys have been generated, copy the public key to
     <emphasis>each</emphasis> of the other nodes
     (<emphasis>including</emphasis> the node where you created the key):
    </para>
<screen><prompt role="user">hareport &gt; </prompt>ssh-copy-id -i ~/.ssh/id_rsa.pub <replaceable>HOSTNAME_OR_IP</replaceable></screen>
    <para>
     In the command, you can either use the DNS name for each server, an
     alias, or the IP address . During the copy process you will be asked to
     accept the host key for each node, and you will need to provide the
     password for the <systemitem class="username">hareport</systemitem>
     user account (this will be the only time you need to enter it).
    </para>
   </step>
   <step>
    <para>
     After the key is shared to all cluster nodes, test if you can log in as
     user <systemitem class="username">hareport</systemitem> to the other
     nodes by using passwordless SSH:
     <remark>taroth </remark>
    </para>
<screen><prompt role="user">hareport &gt; </prompt>ssh <replaceable>HOSTNAME_OR_IP</replaceable></screen>
    <para>
     You should be automatically connected to the remote server without
     being asked to accept a certificate or enter a password.
    </para>
   </step>
  </procedure>

  <note>
   <title>Settings Only Required on One Node</title>
   <para>
    If you intend to run the cluster report from the same node each time, it
    is sufficient to execute the procedure above on this node only.
    Otherwise repeat the procedure on each node.
   </para>
   <para>
    <remark>taroth 2015-06-22: DEVs,does this note only apply to the last step (test connectivity with 'ssh
          HOSTNAME' or to the complete procedure?</remark>
   </para>
  </note>
 </sect1>
 <sect1>
  <title>Configuring <command>sudo</command></title>

  <para>
   The <command>sudo</command> command allows a regular user to quickly
   become &rootuser; and issue a command, with or without providing a
   password. Sudo access can be given to all root-level commands or to
   specific commands only. Sudo typically uses aliases to define the entire
   command string.
  </para>

  <para>
   To configure sudo either use <command>visudo</command>
   (<emphasis>not</emphasis> vi) or &yast;.
  </para>

  <warning>
   <title>Do Not Use vi</title>
   <para>
    For sudo configuration from command line, you must edit the sudoers file
    as &rootuser; with <command>visudo</command>. Using any other editor
    may result in syntax or file permission errors that prevent sudo from
    running.
   </para>
  </warning>

  <procedure>
   <step>
    <para>
     Log in as &rootuser;.
    </para>
   </step>
   <step>
    <para>
     To open the <filename>/etc/sudoers</filename> file, enter
     <command>visudo</command>.
    </para>
   </step>
   <step>
    <para>
     Look for the following categories: <literal>Host alias
     specification</literal>,<literal>User alias specification</literal>,
     <literal>Cmnd alias specification</literal>, and FIXME
    </para>
<!--<para>add the following entries to <filename>/etc/sudoers</filename>:</para>-->
<screen>Host_Alias	CLUSTER = &node1;,&node2;,&node3; <co xml:id="ha.sudoers.host.alias"/>
          User_Alias HA = hareport <co xml:id="ha.sudoers.user.alias"/>
          Cmnd_Alias HA_ALLOWED = /bin/su ,/usr/sbin/hb_report ,/usr/sbin/crm_report <co xml:id="ha.sudoers.cmd.alias"/>
          Runas_Alias R = root <co xml:id="ha.sudoers.runas.alias"/>
          HA	CLUSTER = (R) NOPASSWD:HA_ALLOWED  <co xml:id="ha.sudoers.rule"/></screen>
    <calloutlist>
     <callout arearefs="ha.sudoers.host.alias">
      <para>
       The host alias defines on which server (or range of servers) the sudo
       user has rights to issue commands. In the host alias you can use DNS
       names, or IP Addresses, or specify an entire network range (for
       example, <literal>172.17.12.0/24</literal>). To limit the scope of
       access you should specify the host names for the cluster nodes only.
      </para>
     </callout>
     <callout arearefs="ha.sudoers.user.alias">
      <para>
       The user alias allows you to add multiple local user accounts to a
       single alias. However, in this case you could avoid creating a since
       only one account is being used. In the example above, we added the
       <systemitem class="username">hareport</systemitem> user which we have
       created for running cluster reports.
      </para>
     </callout>
     <callout arearefs="ha.sudoers.cmd.alias">
      <para>
       The command alias defines which commands can be executed by the user.
       This is useful if you want to limit what the non-root user can access
       when using <command>sudo</command>. In this case the
       <systemitem class="username">hareport</systemitem> user account will
       need access to the commands <command>hb_report</command> (or
       <command>crm_report</command>) and <command>su</command>.
      </para>
     </callout>
     <callout arearefs="ha.sudoers.runas.alias">
      <para>
       The runas alias specifies the account that the command will be run
       as. In this case &rootuser;.
      </para>
     </callout>
     <callout arearefs="ha.sudoers.rule">
      <para>
       This is what the resulting rule looks like. Add the NOPASSWORD option
       to ensure that the user
       <systemitem class="username">hareport</systemitem> can execute the
       cluster report without providing a password.
      </para>
     </callout>
    </calloutlist>
   </step>
  </procedure>

<!--            
      
      In the sudoers file there are two lines that may interfere with the sudo rule you just setup. Locate the
      following section by using visudo and remark out the two lines in bold below. This will ensure that
      haereport does not get prompted for a password.
      
      # In the default (unconfigured) configuration, sudo asks for the root password.
      # This allows use of an ordinary user account for administration of a freshly
      # installed system. When configuring sudo, delete the two
      # following lines:
      Defaults      targetpw
      ALL    ALL = (ALL) ALL
      
      No other changes are needed for sudo and no services need to be restarted.
      
      NOTE: This sudo configuration must be made on all nodes in the cluster-->
 </sect1>
 <sect1>
  <title>Running A Cluster Report</title>

  <para>
   work in progress
  </para>
 </sect1>
</appendix>
