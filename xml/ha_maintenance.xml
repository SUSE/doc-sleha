<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE chapter
[
  <!ENTITY % entities SYSTEM "entity-decl.ent">
    %entities;
]>
<chapter xmlns="http://docbook.org/ns/docbook"
 xmlns:xi="http://www.w3.org/2001/XInclude"
 xmlns:xlink="http://www.w3.org/1999/xlink" version="5.0"
 xml:id="cha.ha.maintenance">

 <title>Executing Maintenance Tasks</title>
 <info>
   <abstract>
    &maint-mode-basics;
   </abstract>
      <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
        <dm:maintainer/>
        <dm:status>editing</dm:status>
        <dm:deadline/>
        <dm:priority/>
        <dm:translation>yes</dm:translation>
        <dm:languages/>
        <dm:release/>
        <dm:repository/>
      </dm:docmanager>
    </info>

<sect1 xml:id="sec.ha.config.basics.maint.mode">
  <title>Maintenance Options</title>
  <para>
   With regard to that, the &hasi; provides <literal>maintenance</literal>
   options on several levels:
  </para>

  <itemizedlist>
   <listitem>
    <para>
     for resources
    </para>
   </listitem>
   <listitem>
    <para>
     for nodes
    </para>
   </listitem>
   <listitem>
    <para>
     for the whole cluster
    </para>
   </listitem>
  </itemizedlist>

  &warning-maint-mode;

  <para>
   Use the maintenance mode if you need to perform maintenance tasks and do
   not want to receive any notification by the cluster during that time.
   In maintenance mode, you can stop or restart cluster resources at
   will&mdash;the &hasi; will not attempt to restart them. All
   resources automatically become unmanaged: The &hasi; will cease
   monitoring them and thus be oblivious to their status. You can even stop
   all &pace; services on a node, and all daemons and processes
   originally started as &pace;-managed cluster resources will continue
   to run.
  </para>
  <para>
   However, as &corosync; is also stopped when you stop the &pace; service,
   this might lead to unexpected results for some resources. For example, DLM
   depends on the membership and messaging services provided by &corosync;. If
   &corosync; stops, the DLM resource will assume a split-brain scenario and
   trigger a fencing operation. To avoid this, manually stop resources like DLM
   or bring them back from maintenance mode before stopping the &pace; service.
  </para>
  <para>
   If you attempt to start &pace; services on a node while the
   cluster is in maintenance mode, &pace; will initiate a single one-shot
   monitor operation (a <quote>probe</quote>) for every resource to evaluate
   which resources are currently running on that node. However, it will take
   no further action other than determining the resources' status.
  </para>

  <para>
   If you want to suspend management of an individual resource but still want the
   cluster to monitor the resource and to report any failures, set the
   <option>is-managed</option> meta attribute for this resource to
   <literal>false</literal>. Do so either by using &hawk2; or by executing the
   following command with the &crmshell;:
  </para>
<screen>&prompt.root;crm resource unmanage <replaceable>RESOURCE_ID</replaceable></screen>
  <para>
   For the difference between maintenance mode and <option>is-managed</option>,
   see also <xref linkend="tab.ha.basics.meta"/>.
  </para>
  <para>
   For details on setting or unsetting maintenance mode with your preferred
   cluster management tool:
  </para>

  <itemizedlist>
   <listitem>
    <para>
     &hawk2;: <xref linkend="sec.conf.hawk2.maintenance"/>
    </para>
   </listitem>
   <listitem>
    <para>
     &crmsh;: <xref linkend="sec.ha.manual_config.cli.maint.mode"/>
    </para>
   </listitem>
  </itemizedlist>

<sect2 xml:id="sec.ha.config.hawk.maint.mode">
  <title>Using Maintenance Mode</title>
   &maint-mode-basics;
    <para>
   With regard to that, &hasi; provides <literal>maintenance</literal>
   options on several levels:
  </para>
  <itemizedlist>
   <listitem>
    <para>
     <xref linkend="pro.ha.config.hawk.maint.mode.rsc" xrefstyle="select:title"/>
    </para>
   </listitem>
   <listitem>
    <para>
     <xref linkend="pro.ha.config.hawk.maint.mode.nodes" xrefstyle="select:title"/>
    </para>
   </listitem>
   <listitem>
    <para>
     <xref linkend="pro.ha.config.hawk.maint.mode.cluster" xrefstyle="select:title"/>
    </para>
   </listitem>
  </itemizedlist>
   
   &warning-maint-mode;
   
   <para>
   For more details on what happens to the resources and the cluster while
   in maintenance mode, see
   <xref linkend="sec.ha.config.basics.maint.mode"/>.
  </para>
  <procedure xml:id="pro.ha.config.hawk.maint.mode.rsc">
   <title>Applying Maintenance Mode to Resources</title>
   <step>
    <para>
     Start a Web browser and log in to the cluster as described in
     <xref linkend="sec.conf.hawk2.login"/>.
    </para>
   </step>
   <step>
    <para>
     In the left navigation bar, select <guimenu>Resources</guimenu>. Select
     the resource you want to put in maintenance mode or unmanaged mode,
     click the wrench icon next to the resource and select <guimenu>Edit
     Resource</guimenu>.
    </para>
   </step>
   <step>
    <para>
     Open the <guimenu>Meta Attributes</guimenu> category.
    </para>
   </step>
   <step>
    <para>
     From the empty drop-down list, select the
     <guimenu>maintenance</guimenu> attribute and click the plus icon to add
     it.
    </para>
   </step>
   <step>
    <para>
     Activate the check box next to <literal>maintenance</literal> to set
     the maintenance attribute to <literal>yes</literal>.
    </para>
   </step>
   <step>
    <para>
     Confirm your changes.
    </para>
   </step>
   <step>
    <para>
     After you have finished the maintenance task for that resource,
     deactivate the check box next to the <literal>maintenance</literal>
     attribute for that resource.
    </para>
    <para>
     From this point on, the resource will be managed by the &hasi;
     software again.
    </para>
   </step>
  </procedure>
<!--taroth 2013-03-27: fate#313381 (SP3)-->
  <procedure xml:id="pro.ha.config.hawk.maint.mode.nodes">
   <title>Applying Maintenance Mode to Nodes</title>
   <para>
    Sometimes it is necessary to put single nodes into maintenance mode.
<!--taroth 2014-10-01: commenting because of bnc#869684: 
      If your cluster consists of more than 3 nodes, you can easily set one node
     to maintenance mode, while the other nodes continue their normal
     operation.-->
   </para>
   <step>
    <para>
     Start a Web browser and log in to the cluster as described in
     <xref linkend="sec.conf.hawk2.login"/>.
    </para>
   </step>
   <step>
    <para>
     In the left navigation bar, select <guimenu>Cluster Status</guimenu>.
    </para>
   </step>
   <step>
    <para>
     In one of the individual nodes' views, click the wrench icon next to
     the node and select <guimenu>Maintenance</guimenu>.
    </para>
    <para>
     This will add the following instance attribute to the node:
     <literal>maintenance="true"</literal>. The resources previously running
     on the maintenance-mode node will become <literal>unmanaged</literal>.
     No new resources will be allocated to the node until it leaves the
     maintenance mode.
    </para>
   </step>
   <step>
    <para>
     To deactivate the maintenance mode, click the wrench icon next to the
     node and select <guimenu>Ready</guimenu>.
    </para>
   </step>
  </procedure>
  <procedure xml:id="pro.ha.config.hawk.maint.mode.cluster">
   <title>Applying Maintenance Mode to the Cluster</title>
   <para>
    For setting or unsetting the maintenance mode for the whole cluster,
    proceed as follows:
   </para>
   <step>
    <para>
     Start a Web browser and log in to the cluster as described in
     <xref linkend="sec.conf.hawk2.login"/>.
    </para>
   </step>
   <step>
    <para>
     In the left navigation bar, select <guimenu>Cluster
     Configuration</guimenu>.
    </para>
   </step>
   <step>
    <para>
     In the <guimenu>CRM Configuration</guimenu> group, select the
     <guimenu>maintenance-mode</guimenu> attribute from the empty drop-down
     box and click the plus icon to add it.
    </para>
   </step>
   <step>
    <para>
     To set <literal>maintenance-mode=true</literal>, activate the check box
     next to <literal>maintenance-mode</literal> and confirm your changes.
    </para>
   </step>
   <step>
    <para>
     After you have finished the maintenance task for the whole cluster,
     deactivate the check box next to the
     <literal>maintenance-mode</literal> attribute.
    </para>
    <para>
     From this point on, &hasi; will take over cluster management again.
    </para>
   </step>
  </procedure>
 </sect2>

<sect2 xml:id="sec.ha.manual_config.cli.maint.mode">
   <title>Using Maintenance Mode</title>
<!--   <remark>toms 2013-03-28: FATE#313381</remark>-->
   
   &maint-mode-basics;
   <para>
    With regard to that, &hasi; provides <literal>maintenance</literal>
    options on several levels:
   </para>
   <variablelist>
    <varlistentry>
     <term>Applying Maintenance Mode to your Cluster</term>
     <listitem>
      <para>
       In case you want to put the whole cluster in maintenance mode, use
       the following command:
      </para>
<screen>&prompt.root;<command>crm</command> configure property maintenance-mode=true</screen>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>Applying Maintenance Mode to Nodes</term>
     <listitem>
      <para>
<!--taroth 2014-10-01: commenting because of bnc#869684: 
       If your cluster consists of more than 3 nodes, you can 
       easily set one node to maintenance mode, while the other nodes 
       continue their normal operation.-->
       For example, to put the node <literal>&node1;</literal> into
       maintenance mode:
      </para>
<screen>&prompt.root;<command>crm</command> node maintenance &node1;</screen>
      <para>
       The <command>crm status</command> command will show the maintenance
       mode for &node1; and no more resources will be allocated to that
       node. To remove the maintenance flag from the node, use:
      </para>
<screen>&prompt.root;<command>crm</command> node ready &node1;</screen>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>Applying Maintenance Mode to Resources</term>
     <listitem>
      <para>
       To put a specific resource into maintenance mode (for example,
       the resource <literal>ipaddress</literal>) enter:
      </para>
<screen>&prompt.root;<command>crm</command> resource maintenance ipaddress true</screen>
     </listitem>
    </varlistentry>
   </variablelist>
   
   &warning-maint-mode;
   
   <para>
    For more details on what happens to the resources and the cluster while
    in maintenance mode, see
    <xref linkend="sec.ha.config.basics.maint.mode"/>.
   </para>
  </sect2>

 </sect1>
</chapter>