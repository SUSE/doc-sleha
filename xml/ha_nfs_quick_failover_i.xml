<?xml version="1.0" encoding="UTF-8"?>
<?xml-stylesheet href="urn:x-suse:xslt:profiling:novdoc-profile.xsl"
  type="text/xml" 
  title="Profiling step"?>
<!DOCTYPE sect1 PUBLIC "-//Novell//DTD NovDoc XML V1.0//EN"
                      "novdocx.dtd"
[
<!ENTITY % NOVDOC.DEACTIVATE.IDREF "IGNORE">
<!ENTITY % entities SYSTEM "entity-decl.ent">
%entities;
]>
<sect1 id="sec_ha_quick_nfs_failover">
 <title>Ensuring Smooth Cluster Failover</title>

 <para>
  For NFSv4 connections, the NFSv4 lease time can influence cluster
  failover.
 </para>

 <sect2 id="sec_ha_quick_nfs_failover_lease_time">
  <title>NFSv4 Lease Time</title>
  <para>
   For exports used by NFSv4 clients, the NFS server hands out
   <emphasis>leases</emphasis> which the client holds for the duration of
   file access and then relinquishes. If the NFS resource shuts down or
   migrates while one of its clients is holding a lease on it, the client
   never lets go of the lease&#8201;&#8212;&#8201;at which point the server
   considers the lease expired after the expiration of a certain grace
   period.
  </para>
  <para>
   While any clients are still holding unexpired leases, the NFS server
   maintains an open file handle on the underlying file system, preventing
   it from being unmounted. The <literal>exportfs</literal> resource agent
   handles this through the <literal>wait_for_leasetime_on_stop</literal>
   resource parameter. When set, it simply rides out the grace period before
   declaring the resource properly stopped. At that point, the cluster can
   proceed by unmounting the underlying file system (and subsequently,
   bringing both the file system and the NFS export up on the other cluster
   node).
  </para>
  <para>
   On some systems, this grace period is set to 90 seconds by default, which
   may cause a prolonged period of NFS lock-up that clients experience
   during an NFS service transition on the cluster.
  </para>
 </sect2>

 <sect2 id="sec_ha_quick_nfs_failover_lease_time_change">
  <title>Modifying NFSv4 Lease Time</title>
  <para>
   To allow for faster failover, you may decrease the grace period by
   modifying the <literal>nfsv4leasetime</literal> virtual file.
  </para>
  <note>
   <title>Modification and Restart</title>
   <para>
    To modify the file, the NFS Kernel server must be stopped. Any
    modification only becomes active after the NFS Kernel server is
    restarted.
    <remark>pmarek 2013-11-28: I guess that reconnecting the clients
     should be enough, too - taroth 2013-12-03: no idea - DEVs, your say?</remark>
   </para>
  </note>
  <para>
   To set the grace period to <literal>10</literal> seconds, issue the
   following command on the cluster nodes:
  </para>
<screen>echo 10 &gt; /proc/fs/nfsd/nfsv4leasetime</screen>
 </sect2>
</sect1>
