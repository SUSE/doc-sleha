<?xml version="1.0" encoding="UTF-8"?>
<sect1 xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="geo_sync_i.xml" version="5.0" xml:id="sec.ha.geo.sync">
 <title>すべてのサイトとアービトレータ間の設定ファイルの同期</title>

 <info>
      <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
        <dm:maintainer/>
        <dm:status>編集</dm:status>
        <dm:deadline/>
        <dm:priority/>
        <dm:translation>yes</dm:translation>
        <dm:languages/>
        <dm:release/>
        <dm:repository/>
      </dm:docmanager>
    </info>
    <para>
  クラスタ内のすべてのノードとGeoクラスタ全体にわたって重要な設定ファイルを複製するには、Csync2を使用します。Csync2は、同期グループ別にソートされた任意の数のホストを操作できます。各同期グループは、メンバーホストの独自のリストとその包含/除外パターン(同期グループ内でどのファイルを同期するか定義するパターン)を持っています。グループ、各グループに属するホスト名、および各グループの包含/除外ルールは、Csync2設定ファイル<filename>/etc/csync2/csync2.cfg</filename>で指定されます。
 </para>

 <para>
  Csync2は、認証には、同期グループ内でIPアドレスと事前共有キーを使用します。管理者は、同期グループごとに1つのキーファイルを生成し、そのファイルをすべてのグループメンバにコピーする必要があります。
 </para>

 <para>
  Csync2は、TCPポート(デフォルトでは<literal>6556</literal>)を介して他のサーバにアクセスして、リモートCsync2インスタンスを開始します。Csync2の詳細については、<link xlink:href="http://oss.linbit.com/csync2/paper.pdf"/>を参照してください。
 </para>

 <sect2 xml:id="sec.ha.geo.booth.sync.csync2.setup">
  <title>Geoクラスタ用のCsync2設定</title>
  <para>
   YaSTを使用して個別のクラスタ向けにCsync2を設定する方法については、<phrase role="productname"><phrase os="sles">SUSE Linux Enterprise High Availability Extension</phrase></phrase>の『<citetitle>Administration Guide</citetitle>』で、「<citetitle>Installation and Basic Setup</citetitle>」の章の「<citetitle>Transferring the Configuration to All Nodes</citetitle>」という節を参照してください。ただしYaSTは、Geoクラスタに必要な設定のような複雑なCsync2設定を処理することはできません。<xref linkend="fig.ha.geo.csync.config"/>に示すような以下の設定については、設定ファイルを編集することでCsync2を手動で設定してください。
  </para>
  <para>
   ローカルクラスタ内だけでなく、さまざまな地域に分散されたサイト間でもファイルを同期させるようにCsync2を調整するには、Csync2の設定で以下の2つの同期グループを定義する必要があります。
  </para>
  <itemizedlist>
   <listitem>
    <para>
     グローバルグループ<literal>ha_global</literal>(Geoクラスタに属しているすべてのサイトとアービトレータの間で、グローバルに同期される必要のあるファイル用)
    </para>
   </listitem>
   <listitem>
    <para>
     ローカルクラスタサイトのグループ<literal>ha_local</literal>(ローカルクラスタ内で同期される必要のあるファイル用)
    </para>
   </listitem>
  </itemizedlist>
  <para>
   これら2つの同期グループ用の複数のCsync2設定ファイルの概要については、<xref linkend="fig.ha.geo.csync.config"/>を参照してください。
  </para>
  <figure xml:id="fig.ha.geo.csync.config">
   <title>Geoクラスタ用のCsync2設定の例</title>
   <mediaobject>
    <imageobject role="fo">
     <imagedata fileref="multi-site-csync2.svg" width="100%"/>
    </imageobject>
    <imageobject role="html">
     <imagedata fileref="multi-site-csync2.png" width="100%" format="PNG"/>
    </imageobject>
   </mediaobject>
  </figure>
  <para>
   認証鍵ファイルとそれらの参照は赤色で表示されています。Csync2設定ファイルの名前は青色で表示されており、それらの参照は緑色で表示されています。詳細については、<xref linkend="vl.fig.ha.geo.csync.config.files"/>を参照してください。
  </para>
  <variablelist xml:id="vl.fig.ha.geo.csync.config.files">
   <title>Csync2の設定例: 設定ファイル</title>
   <varlistentry xml:id="vle.ha.geo.csync.csync2.cfg">
    <term><filename>/etc/csync2/csync2.cfg</filename>
    </term>
    <listitem>
     <para>
      メインのCsync2設定ファイル。このファイルは意図的に簡潔になっており、以下のみで構成されています。
     </para>
     <itemizedlist>
      <listitem>
       <para>
        同期グループ<literal>ha_local</literal>の定義。このグループは2つのノード(<literal>this-site-host-1</literal>と<literal>this-site-host-2</literal>)で構成されており、<filename>/etc/csync2/ha_local.key</filename>を使用して認証を行います。このグループのみについて同期されるファイルのリストは、別のCsync2設定ファイルである<filename>/etc/csync2/ha_local.cfg</filename>に記載されています。このファイルは、<literal>config</literal>ステートメントを使用して組み込まれています。
       </para>
      </listitem>
      <listitem>
       <para>
        別のCsync2設定ファイルである<filename>/etc/csync2.cfg/ha_global.cfg</filename>の参照。このファイルも<literal>config</literal>ステートメントを使用して組み込まれています。
       </para>
      </listitem>
     </itemizedlist>
    </listitem>
   </varlistentry>
   <varlistentry xml:id="vle.ha.geo.csync.ha_local.cfg">
    <term><filename>/etc/csync2/ha_local.cfg</filename>
    </term>
    <listitem>
     <para>
      このファイルはローカルクラスタのみに関するものです。このファイルでは、<literal>ha_local</literal>同期グループ内でのみ同期されるファイルのリストが指定されます。これらのファイルはクラスタごとに固有であるからです。特に重要なものは以下のとおりです。
     </para>
     <itemizedlist>
      <listitem>
       <para>
        <filename>/etc/csync2/csync2.cfg</filename>: このファイルには、ローカルクラスタノードのリストが含まれています。
       </para>
      </listitem>
      <listitem>
       <para>
        <filename>/etc/csync2/ha_local.key</filename>: ローカルクラスタ内のCsync2同期用に使用される認証鍵です。
       </para>
      </listitem>
      <listitem>
       <para>
        <filename>/etc/corosync/corosync.conf</filename>: このファイルでは、ローカルクラスタノード間の通信チャネルが定義されます。
       </para>
      </listitem>
      <listitem>
       <para>
        <filename>/etc/corosync/authkey</filename>: Corosync認証鍵です。
       </para>
      </listitem>
     </itemizedlist>
     <para>
      リスト内の残りのファイルは、実際のクラスタセットアップに応じて異なります。<xref linkend="fig.ha.geo.csync.config"/>でリストされているファイルは単なる例です。サイト固有アプリケーションのファイルも同期することを希望する場合は、それらのファイルも<filename>ha_local.cfg</filename>に組み込んでください。<filename>ha_local.cfg</filename>ファイルは、Geoクラスタの特定サイトに属しているノードを対象としていますが、このファイルの内容はすべてのサイト上で同じである可能性があります。異なる複数のホスト群や異なる複数の鍵が必要な場合は、必要に応じてグループを追加してください。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry xml:id="vle.ha.geo.csync.ha_global.cfg">
    <term><filename>/etc/csync2.cfg/ha_global.cfg</filename>
    </term>
    <listitem>
     <para>
      このファイルでは、Csync2同期グループ<literal>ha_global</literal>が定義されています。このグループは、複数のサイトにわたる「すべての」クラスタノード(アービトレータを含む)にまたがっています。<emphasis/>Csync2同期グループごとに異なる鍵を使用することが推奨されているため、このグループは<filename>/etc/csync2/ha_global.key</filename>を使用して認証を行います。<literal>include</literal>ステートメントでは、<literal>ha_global</literal>同期グループ内で同期されるファイルのリストを指定します。特に重要なものは以下のとおりです。
     </para>
     <itemizedlist>
      <listitem>
       <para>
        <filename>/etc/csync2/ha_global.cfg</filename>と<filename>/etc/csync2/ha_global.key</filename>: <literal>ha_global</literal>同期グループ用の設定ファイルと、このグループ内の同期用の認証鍵です。
       </para>
      </listitem>
      <listitem>
       <para>
        <filename>/etc/booth/</filename>: ブース設定が格納されているデフォルトディレクトリです。1つのブースセットアップを複数のテナント用に使用している場合は、このディレクトリには複数のブース設定ファイルが格納されています。ブース用に認証を使用している場合は、鍵ファイルもこのディレクトリに配置すると便利です。 
       </para>
      </listitem>
      <listitem>
       <para>
        <filename>/etc/drbd.conf</filename>と<filename>/etc/drbd.d</filename>(クラスタセットアップ内でDRBDを使用している場合): DRBDの設定は、リソース設定ファイルに含まれているホスト名から得られるため、グローバルに同期させることができます。
       </para>
      </listitem>
      <listitem>
       <para>
        <filename>/etc/zypp/repos.de</filename>: パッケージリポジトリは、すべてのクラスタノード上で同じである可能性が高いです。
       </para>
      </listitem>
     </itemizedlist>
     <para>
      リスト内の他のファイル(<filename>/etc/root/<replaceable>*</replaceable></filename>)は、利便性のため(クラスタ管理を簡易化するため)に組み込むことができるファイルの例です。
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
  <note>
   <para>
    <filename>csync2.cfg</filename>ファイルと<filename>ha_local.key</filename>ファイルはサイト固有であるため、クラスタサイトごとに異なる内容でこれらのファイルを作成する必要があります。これらのファイルの内容は、同じクラスタに属しているノード上では同じですが、別のクラスタ上では異なります。各<filename>csync2.cfg</filename>ファイルには、対象となるサイトに属しているホスト(クラスタノード)のリストに加えて、サイト固有の認証鍵が含まれている必要があります。
   </para>
   <para>
    アービトレータは<filename>csync2.cfg</filename>ファイルも必要とします。ただし、アービトレータは<filename>ha_global.cfg</filename>を参照するだけでかまいません。
   </para>
  </note>
 </sect2>

 <sect2 xml:id="sec.ha.geo.booth.sync.csync2.start">
  <title>Csync2を使用した変更内容の同期</title>
  <para>
   Csync2を使用してファイルを正常に同期するには、以下の前提条件が満たされている必要があります。
  </para>
  <itemizedlist>
   <listitem>
    <para>
     同じ同期グループに属しているすべてのマシンで同じCsync2設定を使用できる。
    </para>
   </listitem>
   <listitem>
    <para>
     各同期グループのCsync2認証鍵をそのグループのすべてのメンバーで使用できる。
    </para>
   </listitem>
   <listitem>
    <para>
    「すべての」ノードとアービトレータ上でCsync2が実行されている。<emphasis/>
    </para>
   </listitem>
  </itemizedlist>
  <para>
   したがって、Csync2を初めて実行する前に、以下の準備を行う必要があります。
  </para>
  <procedure>
   <step>
    <para>
     同期グループごとに1台のマシンにログインして、各グループ用の認証鍵を生成します。
    </para>
    <screen><prompt role="root">root # </prompt><command>csync2</command> -k <replaceable>NAME_OF_KEYFILE</replaceable></screen>
    <para>
     ただし、同じグループの他のメンバー上で鍵ファイルを再生成「しない」でください。<emphasis/>
    </para>
    <para>
     <xref linkend="fig.ha.geo.csync.config"/>を基準にした場合、これにより生成される鍵ファイルは、<filename>/etc/csync2/ha_global.key</filename>と、サイトあたり1つのローカル鍵(<filename>/etc/csync2/ha_local.key</filename>)です。
    </para>
   </step>
   <step>
    <para>
     各鍵ファイルを各同期グループの「すべての」メンバーにコピーします。<emphasis/><xref linkend="fig.ha.geo.csync.config"/>を基準にして、以下の手順を実行します。
    </para>
    <substeps performance="required">
     <step>
      <para>
       <filename>/etc/csync2/ha_global.key</filename>を「すべての」関連先(Geoクラスタのすべてのサイト上のすべてのクラスタノードとアービトレータ)にコピーします。<emphasis/>この鍵ファイルは、<filename>ha_global.cfg</filename>で指定されている<literal>ha_global</literal>グループに含まれるすべてのホスト上で使用できる必要があります。
      </para>
     </step>
     <step>
      <para>
       各サイトのローカル鍵ファイル(<filename>/etc/csync2/ha_local.key</filename>)を、Geoクラスタの各サイトに属しているすべてのクラスタノードにコピーします。
      </para>
     </step>
    </substeps>
   </step>
   <step>
    <para>
     サイト固有の<filename>/etc/csync2/csync2.cfg</filename>設定ファイルを、Geoクラスタの各サイトに属しているすべてのクラスタノードとアービトレータにコピーします。
    </para>
   </step>
   <step>
    <para>
     すべてのノードとアービトレータ上で次のコマンドを実行して、Csync2サービスがブート時に自動的に開始されるようにします。
    </para>
<screen><prompt role="root">root # </prompt><command>systemctl</command> enable csync2.socket</screen>
   </step>
   <step>
    <para>
     すべてのノードとアービトレータ上で次のコマンドを実行して、Csync2サービスを今すぐ開始します。
    </para>
<screen><prompt role="root">root # </prompt><command>systemctl</command> start csync2.socket</screen>
   </step>
  </procedure>
  <procedure xml:id="pro.ha.geo.setup.csync2.start">
   <title>Csync2を使用したファイルの同期</title>
   <step>
    <para>
     最初にすべてのファイルを一度同期させるには、設定の「コピー元」であるマシン上で次のコマンドを実行します。<emphasis/>
    </para>
<screen><prompt role="root">root # </prompt><command>csync2</command> <option>-xv</option></screen>
    <para>
     これにより、すべてのファイルが同期グループの他のメンバーにプッシュされることで、すべてのファイルが一度同期されます。すべてのファイルが正常に同期されると、Csync2がエラーなしで終了します。
    </para>
    <para>
     同期対象の1つ以上のファイルが(現在のマシン上だけでなく)他のマシン上で変更されている場合は、Csync2から衝突が報告されます。次の出力とよく似た出力が表示されます。
    </para>
<screen>While syncing file /etc/corosync/corosync.conf:
ERROR from peer site-2-host-1: File is also marked dirty here!
Finished with 1 errors.</screen>
   </step>
   <step>
    <para>
     現在のマシン上のファイルバージョンが<quote>最適な</quote>バージョンであることが分かっている場合は、そのファイルを強制的に使用して再同期を行うことで、衝突を解決できます。
    </para>
<screen><prompt role="root">root # </prompt><command>csync2</command> <option>-f</option> /etc/corosync/corosync.conf
<prompt role="root">root # </prompt><command>csync2</command> <option>-x</option></screen>
   </step>
  </procedure>
  <para>
   Csync2オプションの詳細については、<command>csync2 </command><option>-help</option>を実行してください。
  </para>
  <note>
   <title>変更後の同期のプッシュ</title>
   <para>
    Csync2は変更のみをプッシュします。Csync2はマシン間でファイルを絶えず同期しているわけではありません。<emphasis/>
   </para>
   <para>
    同期が必要なファイルを更新するたびに、変更を加えたマシン上で<command>csync2 </command><option>-xv</option>を実行することで、変更を同じ同期グループの他のマシンにプッシュする必要があります。変更されていないファイルが配置された他のマシン上でこのコマンドを実行しても、何も起こりません。
   </para>
  </note>
 </sect2>
</sect1>
