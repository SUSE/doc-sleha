<?xml version="1.0" encoding="UTF-8"?>
<sect1 xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="geo_resources_i.xml" version="5.0" xml:id="sec.ha.geo.rsc">
 <title>クラスタリソースと制約の設定</title>

 <info>
      <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
        <dm:maintainer/>
        <dm:status>編集</dm:status>
        <dm:deadline/>
        <dm:priority/>
        <dm:translation>yes</dm:translation>
        <dm:languages/>
        <dm:release/>
        <dm:repository/>
      </dm:docmanager>
    </info>
    <para>
  特定のクラスタセットアップのために定義する必要があるリソースや制約の他に、Geoクラスタでは、次に説明するように、追加のリソースと制約が必要になります。以下の例で示しているcrmシェル(crmsh)またはHA Web Konsole (Hawk2)を使用して、これらのリソースや制約を設定できます。
 </para>

 <para>
  この節では、Geoクラスタに固有のタスクを主に扱います。推奨されるクラスタ管理ツールの概要と、このツールを使用してリソースと制約を設定する方法に関する一般的な指示については、<phrase role="productname"><phrase os="sles">SUSE Linux Enterprise High Availability Extension</phrase></phrase>の『<citetitle>Administration Guide</citetitle>』(<link xlink:href="http://www.suse.com/documentation/"/>から入手可能)で、以下のいずれかの章を参照してください。
 </para>

 <itemizedlist>
  <listitem>
   <para>
    Hawk2: 「<citetitle>クラスタリソースの設定と管理(Webインタフェース)</citetitle>」の章
   </para>
  </listitem>
  <listitem>
   <para>
    crmsh: 「<citetitle>クラスタリソースの設定と管理(コマンドライン)</citetitle>」の章
   </para>
  </listitem>
 </itemizedlist>

 <important>
  <title>サイト間でCIBが同期されない</title>
  <para>
   CIBは、Geoクラスタのクラスタサイト間で自動的に同期「されません」。<emphasis/>したがって、サイトごとにGeoクラスタ全体にわたって高可用性が求められるすべてのリソースを適宜設定する必要があります。
  </para>
  <para>
   他のクラスタサイトへの設定の転送を簡易化するために、サイト固有のパラメータを持つリソースを、そのリソースが実行されているクラスタサイトの名前に応じてそれらのパラメータの値が決定されるような形で設定できます。
  </para>
  <para>
   このことを実現するために、各サイトのクラスタ名をそれぞれの<filename>/etc/corosync/corosync.conf</filename>ファイルで指定する必要があります。たとえば、サイト1(<literal>amsterdam</literal>)の<filename>/etc/corosync/corosync.conf</filename>には、次のエントリが含まれている必要があります。
  </para>
<screen>totem {
   [...]
   cluster_name: amsterdam
   }</screen>
  <para>
   1つのサイト上でリソースを設定した後に、すべてのクラスタサイト上で必要なリソースにタグ付けして、それらのリソースを現在のCIBからエクスポートして、別のクラスタサイトのCIBにインポートできます。詳細については、<xref linkend="sec.ha.geo.rsc.sync.cib"/>を参照してください。
  </para>
 </important>

 <sect2 xml:id="sec.ha.geo.rsc.drbd">
  <title>DRBDのリソースと制約</title>
  <para>
   DRBDのセットアップを完了するには、いくつかのリソースと制約を設定して(<xref linkend="pro.ha.geo.rsc.drbd" xrefstyle="select:label"/>を参照)、それらのリソースと制約を他のクラスタサイトに転送する必要があります(<xref linkend="sec.ha.geo.rsc.sync.cib"/>を参照)。
  </para>
  <procedure xml:id="pro.ha.geo.rsc.drbd">
   <title>DRBDセットアップ向けのリソースの設定</title>
   <step>
    <para>
     クラスタ<literal>amsterdam</literal>のいずれかのノード上で、シェルを起動して、<systemitem class="username">root</systemitem>または同等の権限でログインします。
    </para>
   </step>
   <step>
    <para>
     「<command>crm configure</command>」と入力して、対話式crmシェルに切り替えます。
    </para>
   </step>
   <step>
    <para>
     NFS向けの(サイト固有の)サービスIPアドレスを基本プリミティブとして設定します。
    </para>
<screen><prompt role="custom">crm(live)configure# </prompt><command>primitive</command> ip_nfs ocf:heartbeat:IPaddr2 \
  params iflabel="nfs" nic="eth1" cidr_netmask="24"
  params rule #cluster-name eq amsterdam ip="192.168.201.151" \
  params rule #cluster-name eq berlin ip="192.168.202.151" \
  op monitor interval=10</screen>
   </step>
   <step>
    <para>
     ファイルシステムリソースとNFSサーバ用リソースを設定します。
    </para>
    <screen><prompt role="custom">crm(live)configure# </prompt><command>primitive</command> nfs_fs ocf:heartbeat:Filesystem \
  params device="/dev/drbd/by-res/nfs/0" directory="/mnt/nfs" \
  fstype="ext4"
<prompt role="custom">crm(live)configure# </prompt><command>primitive</command> nfs_service systemd:nfs-server</screen>
   </step>
   <step>
    <para>
     DRBD用の以下のプリミティブとマルチステートリソースを設定します。
    </para>
<screen><prompt role="custom">crm(live)configure# </prompt><command>primitive</command> drbd_nfs ocf:linbit:drbd \
  params drbd_resource="nfs-upper" \
  op monitor interval="31" role="Slave" \
  op monitor interval="30" role="Master"
<prompt role="custom">crm(live)configure# </prompt><command>primitive</command> drbd_nfs_lower ocf:linbit:drbd \
  params rule #cluster-name eq amsterdam \
  drbd_resource="nfs-lower-amsterdam" \
  params rule #cluster-name eq berlin \
  drbd_resource="nfs-lower-berlin" \                                
  op monitor interval="31" role="Slave" \
  op monitor interval="30" role="Master"
<prompt role="custom">crm(live)configure# </prompt><command>ms</command> ms_drbd_nfs drbd_nfs \
  meta master-max="1" master-node-max="1" \
  clone-max="1" clone-node-max="1" notify="true"
<prompt role="custom">crm(live)configure# </prompt><command>ms</command> ms_drbd_nfs_lower drbd_nfs_lower \
  meta master-max="1" master-node-max="1" \
  clone-max="2" clone-node-max="1" notify="true"</screen>
   </step>
   <step>
    <para>
     以下のコロケーション制約と順序付け制約が適用されるグループを追加します。
    </para>
<screen><prompt role="custom">crm(live)configure# </prompt><command>group</command> g_nfs nfs_fs nfs_service
<prompt role="custom">crm(live)configure# </prompt><command>colocation</command> col_nfs_ip_with_lower \
   inf: ip_nfs:Started  ms_drbd_nfs_lower:Master
<prompt role="custom">crm(live)configure# </prompt><command>colocation</command> col_nfs_g_with_upper \
   inf: g_nfs:Started  ms_drbd_nfs:Master
<prompt role="custom">crm(live)configure# </prompt><command>colocation</command> col_nfs_upper_with_ip \
   inf: ms_drbd_nfs:Master  ip_nfs:Started
<prompt role="custom">crm(live)configure# </prompt><command>order</command> o_lower_drbd_before_ip_nfs \
   inf: ms_drbd_nfs_lower:promote  ip_nfs:start
<prompt role="custom">crm(live)configure# </prompt><command>order</command> o_ip_nfs_before_drbd \
   inf: ip_nfs:start  ms_drbd_nfs:promote
<prompt role="custom">crm(live)configure# </prompt><command>order</command> o_drbd_nfs_before_svc \
   inf: ms_drbd_nfs:promote  g_nfs:start</screen>
   </step>
   <step>
    <para>
     <command>show</command>で変更内容をレビューします。
    </para>
   </step>
   <step>
    <para>
     すべて正しければ、<command>commit</command>で変更を送信し、<command>exit</command>でcrmライブ設定を終了します。
    </para>
    <para>
     設定がCIBに保存されます。
    </para>
   </step>
  </procedure>
 </sect2>

 <sect2 xml:id="sec.ha.geo.rsc.booth">
  <title>チケットの依存関係、ブースの制約とリソース</title>
  <para>
   ブースのセットアップを完了するには、以下の手順を実行して、リソースのフェールオーバーとブースに必要なリソースと制約を設定する必要があります。
  </para>
  <itemizedlist>
   <listitem>
    <para>

     <xref linkend="pro.ha.geo.setup.rsc.constraints" xrefstyle="select:title"/>
    </para>
   </listitem>
   <listitem>
    <para>

     <xref linkend="pro.ha.geo.setup.rsc.boothd" xrefstyle="select:title"/>
    </para>
   </listitem>
   <listitem>
    <para>

     <xref linkend="pro.ha.geo.setup.rsc.order" xrefstyle="select:title"/>
    </para>
   </listitem>
  </itemizedlist>
  <para>
   リソースの設定は、それぞれのクラスタサイトで使用できる必要があります。<xref linkend="sec.ha.geo.rsc.sync.cib"/>の説明に従って、リソースの設定を他のサイトに転送します。
  </para>
  <procedure xml:id="pro.ha.geo.setup.rsc.constraints">
   <title>リソースのチケット依存関係の設定</title>
   <para>
     Geoクラスタでは、特定のチケットに依存するリソースを指定できます。この特殊なタイプの制約と合わせて、チケットが取り消された場合のそれぞれのリソースの動作を定義する<literal>loss-policy</literal>を設定できます。属性<literal>loss-policy</literal>は次の値を持つことができます。
    </para>
    <itemizedlist>
     <listitem>
      <para>
       <literal>fence</literal>: 該当するリソースを実行するノードをフェンスします。
      </para>
     </listitem>
     <listitem>
      <para>
       <literal>stop</literal>: 該当するリソースを停止します。
      </para>
     </listitem>
     <listitem>
      <para>
       <literal>freeze</literal>: 該当するリソースに何も実行しません。
      </para>
     </listitem>
     <listitem>
      <para>
       <literal>demote</literal>: <literal>master</literal>モードで実行する該当のリソースを<literal>slave</literal>モードに降格します。
      </para>
     </listitem>
    </itemizedlist> 
   <step>
    <para>
     クラスタamsterdamのいずれかのノード上で、シェルを起動して、<systemitem class="username">root</systemitem>または同等の権限でログインします。

    </para>
   </step>
   <step>
    <para>
     「<command>crm configure</command>」と入力して、対話式crmシェルに切り替えます。
    </para>
   </step>
   <step xml:id="step.ha.geo.setup.rsc.constraints">
    <para>
     特定のチケットにどのリソースが依存するかを指定する制約を設定します。たとえば、<xref linkend="sec.ha.geo.drbd.scenario"/>で概示したDRBDのシナリオ向けに以下の制約が必要です。
    </para>
<screen><prompt role="custom">crm(live)configure# </prompt><command>rsc_ticket</command> nfs-req-ticket-nfs ticket-nfs: \ 
   ms_drbd_nfs:Master loss-policy=demote</screen>
    <para>
     このコマンドは、<literal>nfs-req-ticket-nfs</literal>というIDを持つ制約を作成します。この制約により、マルチステートリソースの<literal>ms_drbd_nfs</literal>が<literal>ticket-nfs</literal>に依存することが指定されます。ただし、このリソースのマスタモードのみがこのチケットに依存します。<literal>ticket-nfs</literal>が取り消された場合は、<literal>ms_drbd_nfs</literal>は自動的に<literal>slave</literal>モードに降格されて、その結果としてDRBDが<literal>Secondary</literal>モードになります。このようにして、サイトがこのチケットを持たない場合でも、DRBDのレプリケーションが引き続き実行されることが保証されます。
    </para>
   </step>
   <step>
    <para>
     さらに多くのチケットに依存するその他のリソースが必要な場合は、<command>rsc_ticket</command>で必要なだけ制約を作成します。
    </para>
   </step>
   <step>
    <para>
     <command>show</command>で変更内容をレビューします。
    </para>
   </step>
   <step>
    <para>
     すべて正しければ、<command>commit</command>で変更を送信し、<command>exit</command>でcrmライブ設定を終了します。
    </para>
    <para>
     設定がCIBに保存されます。
    </para>
   </step>
  </procedure>
  <example xml:id="ex.ha.geo.setup.rsc.ticket.dep">
   <title>プリミティブのチケット依存関係</title>
   <para>
    以下ではもう1つの例として、プリミティブリソース<literal>rsc1</literal>を<literal>ticketA</literal>に依存させる制約を示します。
   </para>
<screen><prompt role="custom">crm(live)configure# </prompt><command>rsc_ticket</command> rsc1-req-ticketA ticketA: \
   rsc1 loss-policy="fence"</screen>
   <para>
    <literal>ticketA</literal>が取り消された場合は、このリソースを実行しているノードはフェンスされます。
   </para>
  </example>
  <procedure xml:id="pro.ha.geo.setup.rsc.boothd">
   <title><systemitem class="daemon">boothd</systemitem>のリソースグループの設定</title> 
   <para>
      各サイトは、その他のブースデーモンと通信する<systemitem class="daemon">boothd</systemitem>のインスタンスを1つ実行する必要があります。デーモンはあらゆるノードで起動できるため、プリミティブリソースとして設定する必要があります。(可能な場合)<systemitem>boothd</systemitem>リソースが同じノード上にとどまるようにするには、リソースの固着性を設定に追加します。各デーモンは持続的なIPアドレスを必要とするため、他のプリミティブは仮想IPアドレスで設定します。両方のプリミティブをグループ化します。</para> 
   <step>
    <para>
     クラスタ<literal>amsterdam</literal>のいずれかのノード上で、シェルを起動して、<systemitem class="username">root</systemitem>または同等の権限でログインします。
    </para>
   </step>
   <step>
    <para>
     「<command>crm configure</command>」と入力して、対話式crmシェルに切り替えます。
    </para>
   </step>
   <step>
    <para>
     以下のように入力して、両方のプリミティブリソースを作成して、これらのリソースを<literal>g-booth</literal>という1つのグループに追加します。
    </para>
<screen><prompt role="custom">crm(live)configure# </prompt><command>primitive</command> ip-booth ocf:heartbeat:IPaddr2 \
  params iflabel="ha" nic="eth1" cidr_netmask="24"
  params rule #cluster-name eq amsterdam ip="192.168.201.151" \
  params rule #cluster-name eq berlin ip="192.168.202.151" 
<prompt role="custom">crm(live)configure# </prompt><command>primitive</command> booth ocf:pacemaker:booth-site \
  meta resource-stickiness="INFINITY" \
  params config="nfs" op monitor interval="10s"
<prompt role="custom">crm(live)configure# </prompt><command>group</command> g-booth ip-booth booth</screen>
    <para>
     この設定では、各ブースデーモンは、デーモンが実行しているノードとは関係なく、個々のIPアドレスで使用できます。 
    </para>
   </step>
   <step>
    <para>
     <command>show</command>で変更内容をレビューします。
    </para>
   </step>
   <step>
    <para>
     すべて正しければ、<command>commit</command>で変更を送信し、<command>exit</command>でcrmライブ設定を終了します。
    </para>
    <para>
     設定がCIBに保存されます。
    </para>
   </step>
  </procedure>

  <procedure xml:id="pro.ha.geo.setup.rsc.order">
   <title>順序の制約の追加</title> 
   <para>
      チケットがサイトに付与されにもかかわらず、そのサイトのすべてのノードが<systemitem class="daemon">boothd</systemitem>リソースグループを何らかの理由でホストできない場合は、地理的に分散したサイト間で<quote>スプリットブレイン</quote>が発生する可能性があります。その場合は、そのチケットの別のサイトへのフェールオーバーを安全に管理するための<systemitem class="daemon">boothd</systemitem>インスタンスが使用できなくなっていると考えられます。チケットの同時実行違反(チケットは複数のサイトに同時に付与されている)の可能性を回避するため、順序の制約を追加します。 
     </para>  
   <step>
    <para>
     クラスタamsterdamのいずれかのノード上で、シェルを起動して、<systemitem class="username">root</systemitem>または同等の権限でログインします。
    </para>
   </step>
   <step>
    <para>
     「<command>crm configure</command>」と入力して、対話式crmシェルに切り替えます。
    </para>
   </step>
   <step>
    <para>
     順序の制約の作成
    </para>
<screen><prompt role="custom">crm(live)configure# </prompt><command>order</command> o-booth-before-nfs inf: g-booth ms_drbd_nfs:promote</screen>
    <para>
     順序付け制約の<literal>o-booth-before-nfs</literal>は、<literal>g-booth</literal>リソースグループが開始された後にのみ、リソース<literal>ms_drbd_nfs</literal>をマスタモードに昇格できることを指定します。
    </para>
   </step>
   <step>
    <para>
     特定のチケットに依存するその他のリソースについて、さらに順序の制約を定義します。
    </para>
   </step>
   <step>
    <para>
     <command>show</command>で変更内容をレビューします。
    </para>
   </step>
   <step>
    <para>
     すべて正しければ、<command>commit</command>で変更を送信し、<command>exit</command>でcrmライブ設定を終了します。
    </para>
    <para>
     設定がCIBに保存されます。
    </para>
   </step>
  </procedure>
  <example xml:id="ex.ha.geo.rsc.order">
   <title>プリミティブの順序付け制約</title>
   <para>
    特定のチケットに依存するリソースがマルチステートリソースではないが、プリミティブである場合は、順序付け制約は次のようになります。
   </para>
<screen><prompt role="custom">crm(live)configure# </prompt><command>order</command> o-booth-before-rsc1 inf: g-booth rsc1</screen>
   <para>
    この制約では、<literal>g-booth</literal>リソースグループの後にのみ<literal>rsc1</literal> (<literal>ticketA</literal>に依存)を開始できることが指定されます。
   </para>
  </example>
 </sect2>

 <sect2 xml:id="sec.ha.geo.rsc.sync.cib">

  <title>他のクラスタサイトへのリソース設定の転送</title>
  <para>
   <xref linkend="sec.ha.geo.rsc.drbd" xrefstyle="select:label"/>と<xref linkend="sec.ha.geo.rsc.booth" xrefstyle="select:label"/>の説明に従って1つのクラスタサイトのリソースを設定した場合、まだ作業は完了していません。そのリソース設定をGeoクラスタの他のサイトに転送する必要があります。
  </para>
  <para>
   この転送を簡易化するために、「すべての」<emphasis/>クラスタサイト上で必要なリソースにタグ付けして、それらのリソースを現在のCIBからエクスポートして、別のクラスタサイトのCIBにインポートできます。<xref linkend="pro.ha.geo.rsc.sync.cib"/>では、この操作の実行方法を例示しています。これは以下の前提条件に基づいています。
  </para>
  <itemizedlist>
   <title>前提条件</title>
   <listitem>
    <para>
     クラスタ<literal>amsterdam</literal>とクラスタ<literal>berlin</literal>という2つのサイトからなるGeoクラスタを使用している。
    </para>
   </listitem>
   <listitem>
    <para>
     各サイトのクラスタ名はそれぞれの<filename>/etc/corosync/corosync.conf</filename>ファイルで指定されている。
    </para>
<screen>totem {
     [...]
     cluster_name: amsterdam
     }</screen>
    <para>
     この操作は手動で実行することも(<filename>/etc/corosync/corosync.conf</filename>を編集)、YaSTクラスタモジュールを使用して実行することもできます。後者の方法については、<phrase role="productname"><phrase os="sles">SUSE Linux Enterprise High Availability Extension</phrase></phrase> <phrase role="productnumber"><phrase os="sles">12 SP2</phrase></phrase>の『<citetitle>Administration Guide</citetitle>』(<link xlink:href="http://www.suse.com/documentation/"/>から入手可能)を参照してください。「<citetitle>Installation and Basic Setup</citetitle>」という章の「<citetitle>Defining the First Communication Channel</citetitle>」の手順を参照してください。
    </para>
   </listitem>
   <listitem>
    <para>
     <xref linkend="sec.ha.geo.rsc.drbd"/>と<xref linkend="sec.ha.geo.rsc.booth"/>の説明に従って、DRBDとブースに必要なリソースを設定済みである。
    </para>
   </listitem>
  </itemizedlist>
  <procedure xml:id="pro.ha.geo.rsc.sync.cib">
   <title>他のクラスタサイトへのリソース設定の転送</title>
   <step>
    <para>
     クラスタ<literal>amsterdam</literal>のいずれかのノードにログインします。
    </para>
   </step>
   <step>
    <para>
     次のコマンドを実行してこのクラスタを開始します。
    </para>
<screen><prompt role="root">root # </prompt><command>systemctl</command> start pacemaker</screen>
   </step>
   <step>
    <para>
     「<command>crm configure</command>」と入力して、対話式crmシェルに切り替えます。
    </para>
   </step>
   <step>
    <para>
     Geoクラスタ全体にわたって必要なリソースと制約にタグ付けします。
    </para>
    <substeps performance="required">
     <step>
      <para>
       現在のCIB設定を確認します。
      </para>
<screen><prompt role="custom">crm(live)configure# </prompt>show</screen>
     </step>
     <step>
      <para>
       次のコマンドを入力して、<literal>geo_resources</literal>というタグが付けられたGeoクラスタ関連リソースをグループ化します。
      </para>
<screen><prompt role="custom">crm(live)configure# </prompt><command>tag</command> geo_resources: \
  ip_nfs nfs_fs nfs_service drbd_nfs drbd_nfs_lower ms_drbd_nfs \
  ms_drbd_nfs_lower g_nfs <co xml:id="co.geo.rsc.drbd"/>\
  col_nfs_ip_with_lower  col_nfs_g_with_upper col_nfs_upper_with_ip <xref linkend="co.geo.rsc.drbd" xrefstyle="select:label"/>\
  o_lower_drbd_before_ip_nfs o_ip_nfs_before_drbd \
  o_drbd_nfs_before_svc <xref linkend="co.geo.rsc.drbd" xrefstyle="select:label"/>\
  nfs-req-ticket-nfs ip-booth booth g-booth o-booth-before-nfs <co xml:id="co.geo.rsc.booth"/>
  [...] <co xml:id="co.geo.rsc.any"/></screen>
      <para>
       タグ付けによって、それらのリソース間にコロケーションや順序付けの関係が生じるわけではありません。
      </para>
      <calloutlist>
       <callout arearefs="co.geo.rsc.drbd">
        <para>
         DRBDのリソースと制約。<xref linkend="sec.ha.geo.rsc.drbd"/>を参照してください。
        </para>
       </callout>
       <callout arearefs="co.geo.rsc.booth">
        <para>
         boothdのリソースと制約。<xref linkend="sec.ha.geo.rsc.booth"/>を参照してください。
        </para>
       </callout>
       <callout arearefs="co.geo.rsc.any">
        <para>
         Geoクラスタのすべてのサイト上で必要な、現在のセットアップの他のリソース。
        </para>
       </callout>
      </calloutlist>
     </step>
     <step>
      <para>
       <command>show</command>で変更内容をレビューします。
      </para>
     </step>
     <step>
      <para>
       設定が希望どおりの場合は、<command>submit</command>を使用して変更内容を送信して、<command>exit</command>を実行してcrmライブシェルを終了します。
      </para>
     </step>
    </substeps>
   </step>
   <step xml:id="st.ha.geo.rsc.sync.cib.export.start">
    <para>
     タグ付けされたリソースと制約を<filename>exported.cib</filename>という名前のファイルにエクスポートします。
    </para>
<screen><prompt role="root">root # </prompt><command>crm configure show</command> tag:geo_resources geo_resources &gt; exported.cib</screen>
    <para>
     <command>crm configure show tag:</command><replaceable>TAGNAME</replaceable>コマンドを実行すると、<replaceable>TAGNAME</replaceable>で指定したタグに属しているすべてのリソースが表示されます。
    </para>
   </step>
   <step>
    <para>
     クラスタ<literal>berlin</literal>のいずれかのノードにログインして、以下の手順を実行します。
    </para>
    <substeps performance="required">
     <step>
      <para>
       次のコマンドを実行してこのクラスタを開始します。
      </para>
<screen><prompt role="root">root # </prompt><command>systemctl</command> start pacemaker</screen>
     </step>
     <step>
      <para>
       <filename>exported.cib</filename>ファイルをクラスタ<literal>amsterdam</literal>からこのノードにコピーします。<remark>taroth
        2014-11-26: alternatively, the CIB can be loaded from an URL - consider
        if to mention this, too</remark>
      </para>
     </step>
     <step>
      <para>
       タグ付けされたリソースと制約を<filename>exported.cib</filename>ファイルからクラスタ<literal>berlin</literal>のCIBにインポートします。
      </para>
<screen><prompt role="root">root # </prompt><command>crm configure load</command> update <replaceable>PATH_TO_FILE/exported.cib</replaceable></screen>
      <para>
       <command>crm configure load</command>コマンドの<option>update</option>パラメータを使用している場合は、crmshはこのファイルの内容を現在のCIB設定内に統合しようとします(現在のCIBをこのファイルの内容に置き換えるのではなく)。
      </para>
     </step>
     <step xml:id="st.ha.geo.rsc.sync.cib.import.stop">
      <para>
       次のコマンドを使用して、更新されたCIB設定を表示します。
      </para>
<screen><prompt role="root">root # </prompt><command>crm configure show</command></screen>
      <para>
       インポートされたリソースと制約がCIBに表示されます。
      </para>
     </step>
    </substeps>
   </step>
  </procedure>
  <para>
   この設定によって得られる結果は次のとおりです。
  </para>
  <itemizedlist>
   <listitem>
    <para>
     <literal>ticket-nfs</literal>をクラスタ<literal>amsterdam</literal>に付与する場合、リソース<literal>ip_nfs</literal>をホストしているノードには<literal>192.168.201.151</literal>というIPアドレスが割り当てられます。
    </para>
   </listitem>
   <listitem>
    <para>
     <literal>ticket-nfs</literal>をクラスタ<literal>berlin</literal>に付与する場合、リソース<literal>ip_nfs</literal>をホストしているノードには<literal>192.168.202.151</literal>というIPアドレスが割り当てられます。
    </para>
   </listitem>
  </itemizedlist>
  <example xml:id="ex.ha.geo.rsc.refer.params">
   <title>リソース内のサイト依存パラメータの参照</title>
   <para>
    <xref linkend="pro.ha.geo.rsc.drbd" xrefstyle="select:label"/>の例に基づいて、別のリソースのサイト固有パラメータを参照するリソースを作成することもできます(<literal>ip_nfs</literal>のIPパラメータなど)。次の手順に従います。
   </para>
   <orderedlist spacing="normal">
    <listitem>
     <para>
      クラスタ<literal>amsterdam</literal>上で、<literal>ip_nfs</literal>のIPパラメータを参照するダミーリソースを作成します。このリソースは、これらのパラメータをこのリソースの<literal>state</literal>パラメータの値として使用します。
     </para>
<screen><prompt role="custom">crm(live)configure# </prompt><command>primitive</command> dummy1 ocf:pacemaker:Dummy \
  params rule #cluster-name eq amsterdam \
  @ip_nfs-instance_attributes-0-ip:state \
  params rule #cluster-name eq berlin \
  @ip_nfs-instance_attributes-1-ip:state \
  op monitor interval=10</screen>
    </listitem>
    <listitem>
     <para>
      <literal>dummy1</literal>リソースが<literal>ticket-nfs</literal>に依存することを指定する制約も追加します。
     </para>
<screen><prompt role="custom">crm(live)configure# </prompt><command>rsc_ticket</command> dummy1-dep-ticket-nfs \
  ticket-nfs: dummy1 loss-policy=stop</screen>
    </listitem>
    <listitem>
     <para>
      これらのリソースと制約にタグ付けします。
     </para>
<screen><prompt role="custom">crm(live)configure# </prompt><command>tag</command> geo_resources_2: dummy1 \
  dummy1-dep-ticket-nfs</screen>
    </listitem>
    <listitem>
     <para>
      <command>show</command>コマンドを使用して変更内容を確認して、<command>submit</command>コマンドを使用して変更内容を送信して、<command>exit</command>コマンドを使用してcrmライブシェルを終了します。
     </para>
    </listitem>
    <listitem>
     <para>
      <literal>geo_resources_2</literal>というタグが付けられたリソースをクラスタ<literal>amsterdam</literal>からエクスポートして、クラスタ<literal>berlin</literal>のCIBにインポートします(<xref linkend="pro.ha.geo.rsc.sync.cib" xrefstyle="select:label"/>の<xref linkend="st.ha.geo.rsc.sync.cib.export.start"/>から<xref linkend="st.ha.geo.rsc.sync.cib.import.stop"/>を参考にしてください)。
     </para>
    </listitem>
   </orderedlist>
   <para>
    この設定によって得られる結果は次のとおりです。
   </para>
   <itemizedlist>
    <listitem>
     <para>
      <literal>ticket-nfs</literal>をクラスタ<literal>amsterdam</literal>に付与する場合は、<literal>dummy</literal>リソースをホストしているノード上に、<filename>/var/lib/heartbeat/cores/192.168.201.151</filename>というファイルが作成されます。
     </para>
    </listitem>
    <listitem>
     <para>
      <literal>ticket-nfs</literal>をクラスタ<literal>berlin</literal>に付与する場合は、<literal>dummy</literal>リソースをホストしているノード上に、<filename>/var/lib/heartbeat/cores/192.168.202.151</filename>というファイルが作成されます。
     </para>
    </listitem>
   </itemizedlist>
  </example>
 </sect2>
</sect1>
