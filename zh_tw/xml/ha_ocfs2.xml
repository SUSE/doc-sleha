<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="ha_ocfs2.xml" version="5.0" xml:id="cha.ha.ocfs2">
 <title>OCFS2</title>
 <info>
      <abstract>
        <para>
    Oracle Cluster File System 2 (OCFS2) 是一般性用途的日誌檔案系統，自 Linux 2.6 版起便已完全整合到該核心中。OCFS2 可讓您將應用程式二進位檔案、資料檔案和資料庫儲存於裝置上的共享儲存中。叢集中所有節點均同時具有檔案系統的讀取與寫入權限。透過複製品資源管理的使用者空間控制精靈可提供與 HA 堆疊的整合，特別是與 Corosync 和分散式鎖定管理員 (DLM) 的整合。
   </para>
      </abstract>
      <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
        <dm:translation>是</dm:translation>
      </dm:docmanager>
    </info>
    <indexterm class="startofrange" xml:id="idx.filesystems.ocfs2">
 <primary> 檔案系統</primary>
 <secondary> OCFS2</secondary></indexterm> 
 <sect1 xml:id="sec.ha.ocfs2.features">
  <title>特點及優勢</title>

  <para>
   OCFS2 可用於下列儲存解決方案，例如︰
  </para>

  <itemizedlist>
   <listitem>
    <para>
     一般應用程式與工作負載。
    </para>
   </listitem>
   <listitem>
    <para>
     叢集中的 Xen 影像儲存。Xen 虛擬機器與虛擬伺服器可以儲存到叢集伺服器掛接的 OCFS2 磁碟區。如此即可便捷地在伺服器之間實現 Xen 虛擬機器的可攜性。
    </para>
   </listitem>
   <listitem>
    <para>
     LAMP (Linux、Apache、MySQL 和 PHP | Perl | Python) 堆疊。
    </para>
   </listitem>
  </itemizedlist>

  <para>
   做為一款高效能、對稱、平行的叢集檔案系統，OCFS2 支援下列功能︰
  </para>

  <itemizedlist>
   <listitem>
    <para>
     叢集上的所有節點均可使用應用程式的檔案。使用者只需在叢集上的 OCFS2 磁碟區安裝一次即可。
    </para>
   </listitem>
   <listitem>
    <para>
     所有節點可直接透過標準檔案系統介面同時讀取及寫入儲存，讓叢集上執行的應用程式更易於管理。
    </para>
   </listitem>
   <listitem>
    <para>
     檔案存取透過 DLM 來協調。在多數情況下，DLM 控制都能起到很好的效果，但如果應用程式設計與 DLM 爭奪檔案存取協調權，則擴充性可能就會受到限制。
    </para>
   </listitem>
   <listitem>
    <para>
     所有後端儲存均可使用儲存備份功能。您可輕鬆建立共享應用程式檔案的複本，以利於提供有效的災難復原。
    </para>
   </listitem>
  </itemizedlist>

  <para>
   OCFS2 亦提供下列功能︰
  </para>

  <itemizedlist>
   <listitem>
    <para>
     中繼資料快取。
    </para>
   </listitem>
   <listitem>
    <para>
     中繼資料日誌。
    </para>
   </listitem>
   <listitem>
    <para>
     跨節點資料檔案一致性。
    </para>
   </listitem>
   <listitem>
    <para>
     支援的多區塊最大大小為 4 KB，叢集最大大小為 1 MB，磁碟區最大大小為 4 PB (拍位元組)。
    </para>
   </listitem>
   <listitem>
    <para>
     最多支援 32 個叢集節點。
    </para>
   </listitem>
   <listitem>
    <para>
     支援對資料庫檔案進行非同步的直接 I/O 存取，以提升資料庫效能。
    </para>
   </listitem>
  </itemizedlist>

  <note>
   <title>對 OCFS2 的支援</title>
   <para>
    僅當與 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise High Availability Extension</phrase></phrase> 所提供的 pcmk (Pacemaker) 堆疊搭配使用時，SUSE 才支援 OCFS2。與 o2cb 堆疊組合使用時，SUSE 不提供對 OCFS2 的支援。
   </para>
  </note>
 </sect1>
 <sect1 xml:id="sec.ha.ocfs2.utils">
  <title>OCFS2 套件與管理公用程式</title>

  <para>
   OCFS1 核心模組 (<literal>ocfs2</literal>) 會自動安裝到 SUSE® Linux Enterprise Server <phrase role="productnumber"><phrase os="sles">15 SP2</phrase></phrase> 上的 High Availability Extension 中。若要使用 OCFS2，請確定在叢集中的每個節點上安裝您核心適用的以下套件︰ <package>ocfs2-tools</package>  及相符的  <package>ocfs2-kmp-*</package>
    套件。
  </para>

  <para>
   每則訊息前的 <package>ocfs2-tools</package>  套件提供下列用於管理 OFS2 磁碟區的公用程式。如需有關語法的資訊，請參閱其 man 頁面。
  </para>

  <table>
   <title>OCFS2 公用程式</title>
   <tgroup cols="2">
    <thead>
     <row>
      <entry>
       <para>
        OCFS2 公用程式
       </para>
      </entry>
      <entry>
       <para>
        描述
       </para>
      </entry>
     </row>
    </thead>
    <tbody>
     <row>
      <entry>
       <para>
        debugfs.ocfs2
       </para>
      </entry>
      <entry>
       <para>
        檢查 OCFS 檔案系統的狀態以進行除錯。
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        fsck.ocfs2
       </para>
      </entry>
      <entry>
       <para>
        檢查檔案系統是否有錯誤，並選擇性修復錯誤。
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        mkfs.ocfs2
       </para>
      </entry>
      <entry>
       <para>
        在裝置上建立 OCFS2 檔案系統，通常是共用實體或邏輯磁碟上的分割區。
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        mounted.ocfs2
       </para>
      </entry>
      <entry>
       <para>
        偵測並列出叢集系統上的所有 OCFS2 磁碟區。偵測並列出掛接 OCFS2 裝置的系統上之所有節點，或列出所有 OCFS2 裝置。
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        tunefs.ocfs2
       </para>
      </entry>
      <entry>
       <para>
        變更 OCFS2 檔案系統參數，包括磁碟區標籤、節點插槽數量、所有節點插槽的日至大小，以及磁碟區大小。
       </para>
      </entry>
     </row>
    </tbody>
   </tgroup>
  </table>
 </sect1>
 <sect1 xml:id="sec.ha.ocfs2.create.service">
  <title>設定 OCFS2 服務和 STONITH 資源</title>



  <para>
   建立 OCFS2 磁碟區之前，您必須先將 DLM 及 STONITH 資源設定為叢集中的服務。
  </para>

  <para>
   下面的程序將使用 <command>crm</command> 外圍程序來設定叢集資源。或者，您也可以依<xref linkend="sec.ha.ocfs2.rsc.hawk2"/>所述，使用 Hawk2 來設定資源。
  </para>

  <procedure xml:id="pro.ocfs2.stonith">
   <title>設定 STONITH 資源</title>
   <note>
    <title>需要 STONITH 裝置</title>
    <para>
     您需要設定一部圍籬區隔裝置。如果沒有設定合適的 STONITH 機制 (如 <literal>external/sbd</literal>)，組態將失敗。
    </para>
   </note>
   <step>
    <para>
     啟動外圍程序，並以 <systemitem class="username">root</systemitem> 或同等身分登入。
    </para>
   </step>
   <step>
    <para>
     依<xref linkend="pro.ha.storage.protect.sbd.create"/> 所述建立一個 SBD 分隔區。
    </para>
   </step>
   <step>
    <para>
     執行 <command>crm</command> <option> configure</option>。
    </para>
   </step>
   <step>
    <para>
     將 <literal>external/sbd</literal> 設定為圍籬區隔裝置，並且 <literal>/dev/sdb2</literal> 做為共享儲存上的專用分割區，用於活動訊號與圍籬區隔操作︰
    </para>
<screen><prompt role="custom">crm(live)configure# </prompt><command>primitive</command> sbd_stonith stonith:external/sbd \
  params pcmk_delay_max=30 meta target-role="Started"</screen>
   </step>
   <step>
    <para>
     使用 <command>show</command> 檢閱所做的變更。
    </para>
   </step>
   <step>
    <para>
     如果所有設定都正確，請使用 <command>commit</command> 提交變更，然後使用 <command>exit</command> 離開 crm 即時組態。
    </para>
   </step>
  </procedure>

  <para>
    如需為 DLM 設定資源群組的詳細資料，請參閱<xref linkend="pro.dlm.resources"/>。
  </para>
 </sect1>
 <sect1 xml:id="sec.ha.ocfs2.create">
  <title>建立 OCFS2 磁碟區</title>

  <para>
   依照<xref linkend="sec.ha.ocfs2.create.service"/>所述設定 DLM 叢集資源後，將系統設定為使用 OCFS2，並建立 OCFs2 磁碟區。
  </para>

  <note>
   <title>應用程式與資料檔案使用的 OCFS2 磁碟區</title>
   <para>
    一般情況下，建議您將應用程式檔案與資料檔案儲存在不同的 OCFS2 磁碟區中。如果您的應用程式磁碟區和資料磁碟區對於掛接有不同的要求，請務必將它們儲存到不同的磁碟區中。
   </para>
  </note>

  <para>
   開始之前，請先準備要用於 OCFS2 磁碟區的區塊裝置。將裝置留為可用空間。
  </para>

  <para>
   然後按<xref linkend="pro.ocfs2.volume"/> 中所述，使用 <command>mkfs.ocfs2</command> 建立並格式化 OCFS2 磁碟區。此指令最重要的參數列於<xref linkend="tab.ha.ofcs2.mkfs.ocfs2.params"/>。如需詳細資訊及指令語法，請參閱 <command>mkfs.ocfs2</command> man 頁面。
  </para>

  <table xml:id="tab.ha.ofcs2.mkfs.ocfs2.params">
   <title>OCFS2 的重要參數</title>
   <tgroup cols="2">
    <thead>
     <row>
      <entry>
       <para>
        OCFS2 參數
       </para>
      </entry>
      <entry>
       <para>
        描述與建議
       </para>
      </entry>
     </row>
    </thead>
    <tbody>
     <row>
      <entry>
       <para>
        磁碟區標籤 (<option>-L</option>)
       </para>
      </entry>
      <entry>
       <para>
        磁碟區的描述性名稱可讓其掛接於不同節點時易於辨識。使用 <command>tunefs.ocfs2</command> 公用程式依需要修改標籤。
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        叢集大小 (<option>-C</option>)
       </para>
      </entry>
      <entry>
       <para>
        叢集大小是配置給持有資料的檔案之空間最小單位。如需可用選項及建議，請參閱 <command>mkfs.ocfs2</command> man 頁面。
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        節點插槽數量 (<option>-N</option>)
       </para>
      </entry>
      <entry>
       <para>
        可同時掛接磁碟區的最大節點數量。OCFS2 會分別為每個節點建立系統檔案，例如日誌。存取磁碟區的節點可以是小 endian 架構 (如 AMD64/Intel 64) 和大 endian 架構 (如 S/390x) 的組合。
       </para>
       <para>
        節點特定的檔案稱為本地檔案。節點插槽號碼會附加至本機檔案。例如，<literal>journal:0000</literal> 隸屬於指派至插槽 <literal>0</literal> 的任一節點。
       </para>
       <para>
        建立磁碟區時，請根據您希望同時掛接磁碟區的節點數量，設定節點插槽的最大磁碟區數量。使用 <command>tunefs.ocfs2</command> 公用程式可以視需要增加節點數。請注意，此值只能增加，不能減少。
       </para>
       <para>
        如果未指定 <option>-N</option> 參數，系統會根據檔案系統的大小確定插槽數。
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        區塊大小 (<option>-b</option>)
       </para>
      </entry>
      <entry>
       <para>
        檔案系統可定址的空間最小單位。請在建立磁碟區時指定區塊大小。如需可用選項及建議，請參閱 <command>mkfs.ocfs2</command> man 頁面。

       </para>
      </entry>
     </row>

     <row>
      <entry>
       <para>
        開啟/關閉特定功能 (<option>--fs-features</option>)
       </para>
      </entry>
      <entry>
       <para>
        可提供以逗號分隔的功能標籤清單，<systemitem>mkfs.ocfs2</systemitem> 會根據此清單嘗試建立具有這些功能集的檔案系統。若要開啟功能，請在清單中包含該功能。若要關閉功能，則在名稱前預增 <literal>no</literal>。
       </para>
       <para>
        如需所有可用標記的綜覽，請參閱 <command>mkfs.ocfs2</command> man 頁面。
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        預定義功能 (<option>--fs-feature-level</option>)
       </para>
      </entry>
      <entry>
       <para>
        可讓您從一組預定義檔案系統功能中進行選擇。如需可用選項，請參閱 <command>mkfs.ocfs2</command> man 頁面。
       </para>
      </entry>
     </row>
    </tbody>
   </tgroup>
  </table>



  <para>
   使用 <command>mkfs.ocfs2</command> 建立並格式化磁碟區時，如果不指定任何功能，則預設會啟用下列功能︰<option>backup-super</option>、<option>sparse</option>、<option>inline-data</option>、<option>unwritten</option>、<option>metaecc</option>、<option>indexed-dirs</option> 和 <option>xattr</option>。
  </para>

  <procedure xml:id="pro.ocfs2.volume">
   <title>建立並格式化 OCFS2 磁碟區</title>
   <para>
    在其中<emphasis>一</emphasis>個叢集節點上執行下列步驟。
   </para>
   <step>
    <para>
     開啟終端機視窗，並以 <systemitem class="username">root</systemitem> 身分登入。
    </para>
   </step>
   <step>
    <para>
     使用指令 <command>crm status</command> 檢查叢集是否上線。
    </para>
   </step>
   <step>
    <para>
     使用 <command>mkfs.ocfs2</command> 公用程式建立並格式化磁碟區。如需此指令的語法資訊，請參閱 <command>mkfs.ocfs2</command> man 頁面。
    </para>
    <para>
     例如，若要在 <filename>/dev/sdb1</filename> 上建立最多支援 32 個叢集節點的新 OCFS2 檔案系統，請輸入以下指令︰
    </para>
<screen><prompt role="root">root # </prompt> mkfs.ocfs2 -N 32 /dev/sdb1</screen>


   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="sec.ha.ocfs2.mount">
  <title>掛接 OCFS2 磁碟區</title>

  <para>
   您可以按<xref linkend="pro.ocfs2.mount.cluster"/> 中所述，手動或使用叢集管理員掛接 OCFS2 磁碟區。
  </para>

  <procedure xml:id="pro.ocfs2.mount.manual">
   <title>手動掛接 OCFS2 磁碟區</title>
   <step>
    <para>
     開啟終端機視窗，並以 <systemitem class="username">root</systemitem> 身分登入。
    </para>
   </step>
   <step>
    <para>
     使用指令 <command>crm status</command> 檢查叢集是否上線。
    </para>
   </step>
   <step>
    <para>
     從指令行掛接磁碟區，請使用 <command>mount</command> 指令。
    </para>
   </step>
  </procedure>

  <warning>
   <title>手動掛接的 OCFS2 裝置</title>
   <para>
    如果您為了測試目的手動掛接了 OCFS2 檔案系統，則在開始將其做為叢集資源使用之前，務必要將其卸載恢復原狀。
   </para>
  </warning>

  <procedure xml:id="pro.ocfs2.mount.cluster">
   <title>使用叢集資源管理員掛接 OCFS2 磁碟區</title>
   <para>
    若要使用 High Availability 軟體掛接 OCFS2 磁碟區，請在叢集中設定 ocfs2 檔案系統資源。下面的程序將使用 <command>crm</command> 外圍程序來設定叢集資源。或者，您也可以依<xref linkend="sec.ha.ocfs2.rsc.hawk2"/>所述，使用 Hawk2 來設定資源。
   </para>
   <step>
    <para>
     啟動外圍程序，並以 <systemitem class="username">root</systemitem> 或同等身分登入。
    </para>
   </step>
   <step>
    <para>
     執行 <command>crm</command> <option> configure</option>。
    </para>
   </step>
   <step>
    <para>
     設定 Pacemaker 以在叢集中的各節點上掛接 OCFS2 檔案系統︰
    </para>
<screen><prompt role="custom">crm(live)configure# </prompt><command>primitive</command> ocfs2-1 ocf:heartbeat:Filesystem \
  params device="/dev/sdb1" directory="/mnt/shared" \
  fstype="ocfs2" options="acl" \
  op monitor interval="20" timeout="40" \
  op start timeout="60" op stop timeout="60" \
  meta target-role="Started"</screen>
   </step>
   <step>
    <para>
     將 <literal>ocfs2-1</literal> 基本資源新增至您在<xref linkend="pro.dlm.resources"/>中建立的 <literal>g-storage</literal> 群組。
    </para>
<screen><prompt role="custom">crm(live)configure# </prompt><command>modgroup</command> g-storage add ocfs2-1</screen>
    <para><command>add</command> 子指令預設會附加新的群組成員。鑒於基礎群組的內部並存與順序條件約束，Pacemaker 只會在其上也有 <systemitem class="resource">dlm</systemitem> 資源在執行的節點上啟動 <literal>ocfs2-1</literal> 資源。
    </para>
   </step>
   <step>
    <para>
     使用 <command>show</command> 檢閱所做的變更。

    </para>
   </step>
   <step>
    <para>
     如果所有設定都正確，請使用 <command>commit</command> 提交變更，然後使用 <command>exit</command> 離開 crm 即時組態。
    </para>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="sec.ha.ocfs2.rsc.hawk2">
  <title>使用 Hawk 設定 OCFS2 資源2</title>

  <para>
   除了使用 crm 外圍程序手動為 OCFS2 設定 DLM 和檔案系統資源以外，您還可以使用 Hawk2 <guimenu>設定精靈</guimenu>中的 OCFS2 範本。
  </para>

  <important>
   <title>手動設定與使用 Hawk2 的差別</title>
   <para>
    <guimenu>設定精靈</guimenu>中的 OCFS2 範本<emphasis>不</emphasis>包含 STONITH 資源的組態。如果使用該精靈，仍需在共享儲存上建立 SBD 分割區，並依照<xref linkend="pro.ocfs2.stonith"/>所述設定一個 STONITH 資源。
   </para>
   <remark>taroth 2014-08-15: todo for next release: unify manual configuration
    and configuration via Hawk (use same resources, same options
    etc.), filed https://bugzilla.novell.com/show_bug.cgi?id=892116 for this</remark>
   <para>
    使用 Hawk2 <guimenu>設定精靈</guimenu>中的 OCFS2 範本還會導致資源組態與<xref linkend="pro.dlm.resources"/>和<xref linkend="pro.ocfs2.mount.cluster"/>中所述的手動組態略有不同。
   </para>
  </important>

  <procedure xml:id="pro.ha.ocfs2.rsc.hawk">
   <title>使用 Hawk2 的<guimenu>精靈</guimenu>設定 OCFS2 資源</title>
   <step>
    <para>
     登入 Hawk2︰
    </para>
    <screen>https://<replaceable>HAWKSERVER</replaceable>:7630/</screen>
   </step>
   <step>
    <para>
     在左側導覽列中，選取<guimenu>精靈</guimenu>。
    </para>
   </step>
   <step>
    <para>
     展開<guimenu>檔案系統</guimenu>類別，然後選取 <literal>OCFS2 檔案系統</literal>。
    </para>
   </step>
   <step>
    <para>
     按照螢幕上的指示執行操作。如需關於某個選項的資訊，按一下該選項即可在 Hawk2 中顯示簡要說明文字。在最後一個設定步驟之後，<guimenu>驗證</guimenu>所輸入的值。
    </para>
    <para>
     精靈會顯示將套用於 CIB 的組態代碼片段以及任何其他變更 (如果需要)。
    </para>
    <informalfigure>
     <mediaobject>
      <imageobject role="fo">
       <imagedata fileref="hawk2-wizard-ocfs2-verify.png" width="70%" format="PNG"/>
      </imageobject>
      <imageobject role="html">
       <imagedata fileref="hawk2-wizard-ocfs2-verify.png" width="70%" format="PNG"/>
      </imageobject>
     </mediaobject>
    </informalfigure>
   </step>
   <step>
    <para>
     檢查建議的變更。如果一切都符合您的預期，請套用變更。
    </para>
    <para>
     如果動作成功，螢幕上會顯示一則訊息。
    </para>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="sec.ha.ocfs2.quota">
  <title>在 OCFS2 檔案系統上使用定額</title>



  <para>
   若要在 OCFS2 檔案系統上使用定額，請分別使用以下相應的定額功能或掛接選項來建立和掛接檔案系統︰<literal>ursquota</literal> (個別使用者的定額) 或 <literal>grpquota</literal> (群組的定額)。您也可在以後使用 <command>tunefs.ocfs2</command> 在解下的檔案系統上啟用這些功能。
  </para>

  <para>
   檔案系統啟用相應的定額功能後，將會在中繼資料中追蹤每個使用者 (或群組) 使用的空間量和檔案數量。由於 OCFS2 將定額資訊視為檔案系統內部的中繼資料，因此，您不需要執行 <command>quotacheck</command>(8) 程式。fsck.ocfs2 和檔案系統驅動程式自身中已內建所有功能。
  </para>

  <para>
   若要對每個使用者或群組強制實施限制，請執行 <command>quotaon</command>(8)，就像對其他任何檔案系統執行該指令一樣。
  </para>





  <para>
   出於效能的考量，每個叢集每隔 10 秒會在本地執行一次定額計算，並將此資訊同步至通用中央儲存。您可以使用 <command>tunefs.ocfs2</command>、選項 <option>usrquota-sync-interval</option> 和 <option>grpquota-sync-interval</option> 來調整此間隔。因此，定額資訊並非一直都是精確的，所以，當使用者或群組同時操作多個叢集節點時，可能會略微超出其定額限制。
  </para>
 </sect1>
 <sect1 xml:id="sec.ha.ocfs2.more">
  <title>更多資訊</title>

  <para>
   如需有關 OCFS2 的詳細資訊，請參閱下列連結的內容︰
  </para>

  <variablelist>
   <varlistentry>
    <term><link xlink:href="https://ocfs2.wiki.kernel.org/"/>
    </term>
    <listitem>
     <para>
      OCFS2 專案首頁。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><link xlink:href="http://oss.oracle.com/projects/ocfs2/"/>
    </term>
    <listitem>
     <para>
      Oracle 上的原 OCFS2 專案首頁。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><link xlink:href="http://oss.oracle.com/projects/ocfs2/documentation"/>
    </term>
    <listitem>
     <para>
      專案的原文件首頁。
     </para>
    </listitem>
   </varlistentry>
  </variablelist><indexterm class="endofrange" startref="idx.filesystems.ocfs2"/>
 </sect1>
</chapter>
