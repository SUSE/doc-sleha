<?xml version="1.0" encoding="UTF-8"?>
<sect1 xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="geo_ip_i.xml" version="5.0" xml:id="sec.ha.geo.ip.relocation">


 <title>透過 DNS 更新設定 IP 重新配置</title>

 <info>
      <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
        <dm:maintainer/>
        <dm:status>編輯</dm:status>
        <dm:deadline/>
        <dm:priority/>
        <dm:translation>yes</dm:translation>
        <dm:languages/>
        <dm:release/>
        <dm:repository/>
      </dm:docmanager>
    </info>
    <para>
  如果地理叢集的一個網站關閉並且發生了票證容錯移轉，您通常需要相應地調整網路路由 (或者需要事先為每個票證設定網路容錯移轉)。根據繫結到票證的服務類型，可以使用一種替代解決方案來重新設定路由：使用動態 DNS 更新並變更服務的 IP 位址。
 </para>

 <para>
  此案例必須滿足以下必要條件：
 </para>

 <itemizedlist>
  <listitem>
   <para>
    需要容錯移轉的服務已繫結到某個主機名稱。
   </para>
  </listitem>
  <listitem>
   <para>
    DNS 伺服器必須針對動態 DNS 更新進行了設定。如需如何使用 BIND/named 執行此操作的資訊，請參閱 <literal>named</literal> 文件或造訪 <link xlink:href="http://www.semicomplete.com/articles/dynamic-dns-with-dhcp/"/>。<remark>taroth 2014-11-21: lmb, would you consider the aforementioned link appropriate (WRT to
     our customers and the kind of setup that is needed here)?</remark>如需如何設定 DNS (包括區域資料的動態更新) 的詳細資訊，請參閱《SUSE Linux Enterprise  管理指南》中的「<citetitle>網域名稱系統</citetitle>」一章。此文件位於 <link xlink:href="http://www.suse.com/documentation/"/>。
   </para>
  </listitem>
  <listitem>
   <para>
    以下範例假設 DNS 更新受到要更新區域的共用金鑰 (TSIG 金鑰) 保護。可以使用 <command>dnssec-keygen</command> 建立該金鑰：
   </para>
<screen><prompt role="root">root # </prompt><command>dnssec-keygen</command> -a hmac-md5 -b 128 -n USER geo-update</screen>
   <para>
    如需詳細資訊，請參閱 <command>dnssec-keygen</command> man 頁面，或者 <link xlink:href="http://www.suse.com/documentation/"/> 上的《SUSE Linux Enterprise 管理指南》。請參閱「<citetitle>網域名稱系統</citetitle>」一章中的「<citetitle>安全交易</citetitle>」 一節。
   </para>
  </listitem>
 </itemizedlist>

 <para>
  <xref linkend="ex.ha.geo.dyn.dns.rsc.config"/>說明了如何使用 <systemitem>ocf:heartbeat:dnsupdate</systemitem> 資源代辦來管理 <command>nsupdate</command> 指令。<remark>taroth 2014-11-21: lmb, is the following correct? it
   is mentioned in the description of fate#316112, however, your example in c#9 mentions focuses on
   IPv4 only...</remark>該資源代辦支援 IPv4 和 IPv6。
 </para>

 <example xml:id="ex.ha.geo.dyn.dns.rsc.config">
  <title>動態 DNS 更新的資源組態</title>
<screen><prompt role="custom">crm(live)configure# </prompt><command>primitive</command> dns-update-ip ocf:heartbeat:dnsupdate params \
  hostname="www.domain.com"<co xml:id="co.dyn.dns.hostname"/> ip="192.168.3.4"<co xml:id="co.dyn.dns.ip"/>\
  keyfile="<replaceable>/etc/whereever/Kgeo-update*</replaceable>.key"<co xml:id="co.dyn.dns.key"/>\
  server="192.168.1.1"<co xml:id="co.dyn.dns.srv"/> serverport="53"<co xml:id="co.dyn.dns.srv.port"/></screen>
  <calloutlist>
   <callout arearefs="co.dyn.dns.hostname">
    <para>
     與需要連同票證一起容錯移轉之服務繫結的主機名稱。需要透過動態 DNS 更新此主機名稱的 IP 位址。
    </para>
   </callout>
   <callout arearefs="co.dyn.dns.ip">
    <para>
     要遷移的服務所在的伺服器 IP 位址。<remark>taroth 2014-11-21:
     lmb, this description taken from fate c#9 is IMHO a bit misleading as it seems to imply that
     this param is about the *current* IP address. However, from the description in
     /usr/lib/ocf/resource.d/heartbeat/dnsupdate, I think this needs to be the IP address that
     will be used for the hostname *after* failover - is that correct?</remark>這裡指定的 IP 位址也可以受叢集控制。這不會處理本地容錯移轉，但可以確定在票證容錯移轉後，外部各方會導向至正確的網站。
    </para>
   </callout>
   <callout arearefs="co.dyn.dns.key">
    <para>
     使用 <command>dnssec-keygen</command> 產生之公用金鑰檔案的路徑。
    </para>
   </callout>
   <callout arearefs="co.dyn.dns.srv">
    <para>
     要將更新傳送到的 DNS 伺服器 IP 位址。如果未提供伺服器，則預設為正確區域的主伺服器。
    </para>
   </callout>
   <callout arearefs="co.dyn.dns.srv.port">
    <para>
     與 DNS 伺服器通訊時使用的埠。僅當指定了 DNS 伺服器時，此選項才生效。
    </para>
   </callout>
  </calloutlist>
  <para>
   在使用上述資源組態的情況下，資源代辦將負責從 DNS 記錄中移除發生故障的地理叢集網站，並透過動態 DNS 更新來變更服務的 IP。
  </para>
 </example>
</sect1>
