<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="ha_loadbalancing.xml" version="5.0" xml:id="cha.ha.lb">

 <title>負載平衡</title>
 <info>
      <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
        <dm:maintainer/>
        <dm:status>編輯</dm:status>
        <dm:deadline/>
        <dm:priority/>
        <dm:translation>yes</dm:translation>
        <dm:languages/>
        <dm:release/>
        <dm:repository/>
      </dm:docmanager>
 <abstract>
  <para>
  在<emphasis>負載平衡</emphasis>的情況下，一個伺服器叢集對於外部用戶端而言就是一台大型的高速伺服器。這種表面上的單個伺服器稱為<emphasis>虛擬伺服器</emphasis>。它包含一或多個用於發送內送要求的負載平衡器，以及數個執行實際服務的真實伺服器。對 High Availability Extension 完成負載平衡設定後，您可以建置擴充性強、可用性高的網路服務，例如 Web、快取、郵件、FTP、媒體和 VoIP 服務。
 </para>
 </abstract>
 </info>
    
 <sect1 xml:id="sec.ha.lb.overview">
  <title>概念綜覽</title>
  <para>
   High Availability Extension 支援兩種負載平衡技術︰Linux 虛擬伺服器 (LVS) 和 HAProxy。兩者的主要差別在於，Linux 虛擬伺服器在 OSI 第 4 層 (傳輸層) 上運作，可設定核心的網路層，而 HAProxy 在第 7 層 (應用程式層) 上的使用者空間中執行。因此，Linux 虛擬伺服器所需的資源更少，但處理的負載更多，而 HAProxy 可以檢查流量，執行 SSL 終止，以及根據流量內容做出分派決策。
  </para>
  <para>
   另一方面，Linux 虛擬伺服器包含兩個不同的軟體︰IPVS (IP 虛擬伺服器) 和 KTCPVS (核心 TCP 虛擬伺服器)。IPVS 提供第 4 層負載平衡，而 KTCPVS 提供第 7 層負載平衡。
  </para>
  <para>
   本章會提供負載平衡與高可用性結合使用的概念綜覽，然後簡要介紹 Linux 虛擬伺服器和 HAProxy。最後，提供其他閱讀材料的連結。
  </para>
  <para>
   實際的伺服器與負載平衡器之間可透過高速 LAN 或地理位置分散的 WAN 來連接。負載平衡器會將要求發送到不同的伺服器。它們可以讓叢集的多個平行服務顯示為單一 IP 位址 (虛擬 IP 位址或 VIP) 上的一個虛擬服務。發送請求可以使用 IP 負載平衡技術或應用程式層級的負載平衡技術。以透明方式在叢集中新增或移除節點可以實現系統的延展性。
  </para>

  <para>
   高可用性透過偵測節點或服務失敗，並相應地照常重新設定整個虛擬伺服器系統來實現。
  </para>

  <remark>Most of the following items are taken from FATE#316459. Not
  sure if this is really correct. Needs technical proofreading by an
  expert.</remark>

  <para>
   負載平衡策略有多種。以下是一些適用於 Linux 虛擬伺服器的第 4 層策略︰
  </para>

  <itemizedlist>
   <listitem>
    <formalpara>
     <title>遞迴</title>
     <para>
      最簡單的策略就是將每個連接輪流導向至不同的位址。例如，一個 DNS 伺服器可能有多個項目對應於一個指定主機名稱。使用 DNS 遞迴時，該 DNS 伺服器會輪流傳回所有這些項目。因此，不同的用戶端將會看到不同的位址。
     </para>
    </formalpara>
   </listitem>
   <listitem>
    <formalpara>
     <title>選取<quote>最佳</quote>伺服器</title>
     <para>
      雖然此策略存在一些弊端，但您可以使用<quote>第一台做出回應的伺服器</quote>或<quote>負載最低的伺服器</quote>方案來實現平衡。
     </para>
    </formalpara>
   </listitem>
   <listitem>
    <formalpara>
     <title>平衡每台伺服器的連接數</title>
     <para>
      使用者與伺服器之間的負載平衡器可以將一定數量的使用者分散到多台伺服器上。
     </para>
    </formalpara>
   </listitem>
   <listitem>
    <formalpara>
     <title>Geo 位置</title>
     <para>
      可以將用戶端導向至附近的伺服器。
     </para>
    </formalpara>
   </listitem>
  </itemizedlist>

  <para>
   以下是一些適用於 HAProxy 的第 7 層策略︰
  </para>

  <itemizedlist>
   <listitem>
    <formalpara>
     <title>URI</title>
     <para>
      檢查 HTTP 內容並將其發送到最適合此特定 URL 的伺服器。
     </para>
    </formalpara>
   </listitem>
   <listitem>
    <formalpara>
     <title>URL 參數、RDP Cookie</title>
     <para>
      檢查 HTTP 內容中的工作階段參數 (可能在 post 參數中) 或 RDP (遠端桌面通訊協定) 工作階段 cookie，並將其發送到為此工作階段提供服務的伺服器。
     </para>
    </formalpara>
   </listitem>
  </itemizedlist>

  <para>
   儘管與前一種策略存在一些相同之處，但如果 LVS/<command>ipvsadm</command> 無法滿足需要，您可以使用 HAProxy，反之亦然︰
  </para>

  <itemizedlist>
   <listitem>
    <formalpara>
     <title>SSL 終止</title>
     <para>
      前端負載平衡器可以處理 SSL 層。因此，雲端節點不需要存取 SSL 金鑰，而可以利用負載平衡器中的 SSL 加速器。
     </para>
    </formalpara>
   </listitem>
   <listitem>
    <formalpara>
     <title>應用程式層級</title>
     <para>
      HAProxy 在應用程式層級運作，因此，負載平衡決策受內容資料流的影響。這樣，便可以根據 cookie 和其他此類過濾器實現持久性。
     </para>
    </formalpara>
   </listitem>
  </itemizedlist>

  <para>
   另一方面，HAProxy 不能完全取代 LVS/<command>ipvsadm</command>︰
  </para>

  <itemizedlist>
   <listitem>
    <para>
     LVS 支援<quote>直接路由</quote>，在此模式下，負載平衡器只運作於內傳資料流中，而外傳流量將直接路由至用戶端。在非對稱環境中，這有可能會大幅提高輸送量。
    </para>
   </listitem>
   <listitem>
    <para>
     LVS 支援複製可設定狀態的連接表 (透過 <systemitem class="daemon">conntrackd</systemitem>)。如此便能實現對用戶端和伺服器透明的負載平衡器容錯移轉。
    </para>
   </listitem>
  </itemizedlist>
 </sect1>

 <xi:include href="ha_lb_lvs.xml"/>
 <xi:include href="ha_lb_haproxy.xml"/>

 <sect1 xml:id="sec.ha.lb.more">
  <title>更多資訊</title>

  <itemizedlist>
    <listitem>
      <para><link xlink:href="http://www.haproxy.org"/></para>
    </listitem>
    <listitem>
      <para>專案首頁 <link xlink:href="http://www.linuxvirtualserver.org/"/>。
  </para>
    </listitem>
    <listitem>
      <para>如需有關 <systemitem class="daemon">ldirectord</systemitem> 的資訊，請參閱完整的 man 頁面。</para>
    </listitem>
    <listitem>
      <para>LVS 知識庫︰<link xlink:href="http://kb.linuxvirtualserver.org/wiki/Main_Page"/></para>
    </listitem>
  </itemizedlist>
 </sect1>
</chapter>
