<?xml version="1.0" encoding="UTF-8"?>
<?xml-stylesheet href="urn:x-suse:xslt:profiling:docbook51-profile.xsl"
 type="text/xml"
 title="Profiling step"?>
<appendix xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="ha_iscsi_for_sbd.xml" xml:id="ha-iscsi-for-sbd" xml:lang="es" version="5.1">
 <title>Almacenamiento iSCSI básico para el SBD</title>
 <info>
  <abstract>
   <para>
    Utilice los siguientes procedimientos para configurar el almacenamiento iSCSI básico para utilizarlo con el SBD. Estos procedimientos solo se recomiendan con fines de prueba. Antes de usar iSCSI en un entorno de producción, consulte la <link xlink:href="https://documentation.suse.com/sles/html/SLES-all/cha-iscsi.html">Storage Administration Guide (Guía de administración del almacenamiento) de SUSE Linux Enterprise Server</link>.
   </para>
  </abstract>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
 </info>

 <itemizedlist>
  <title>Requisitos</title>
  <listitem>
   <para>
    Una máquina virtual de SUSE Linux Enterprise Server para actuar como destino iSCSI. Esta máquina virtual no debe formar parte del clúster.
   </para>
  </listitem>
  <listitem>
   <para>
    Dos dispositivos de almacenamiento virtual en la máquina virtual: un dispositivo de 20 GB para el sistema y un dispositivo de 1 GB para el SBD.
   </para>
  </listitem>
  <listitem>
   <para>
    Dos nodos de SUSE Linux Enterprise Server que aún no se hayan añadido a un clúster High Availability
   </para>
  </listitem>
 </itemizedlist>

 <para>
  En primer lugar, configure un destino iSCSI en la máquina virtual:
 </para>

 <procedure xml:id="pro-iscsi-for-sbd-target">
  <title>Configuración de un destino iSCSI</title>
  <step>
   <para>
    Instale el paquete <package>yast2-iscsi-lio-server</package>:
   </para>
<screen><prompt role="root"># </prompt><command>zypper install yast2-iscsi-lio-server</command></screen>
  </step>
  <step>
   <para>
    Inicie el módulo <literal>iscsi-lio-server</literal> en YaST:
   </para>
<screen><prompt role="root"># </prompt><command>yast2 iscsi-lio-server</command></screen>
  </step>
  <step>
   <para>
    En la pestaña <guimenu>Servicio</guimenu>, en <guimenu>Después de reiniciar</guimenu>, seleccione <guimenu>Iniciar durante el arranque</guimenu>.
   </para>
  </step>
  <step>
   <para>
    Active <guimenu>Puerto abierto en el cortafuegos</guimenu>.
   </para>
  </step>
  <step>
   <para>
    En la pestaña <guimenu>Global</guimenu>, active <guimenu>Autenticación de descubrimiento</guimenu>.
    </para>
   </step>
  <step>
   <para>
    En <guimenu>Autenticación mediante destinos</guimenu>, introduzca un valor en <guimenu>Nombre de usuario</guimenu> y en <guimenu>Contraseña</guimenu>.
   </para>
  </step>
  <step>
   <para>
    En <guimenu>Autenticación mediante iniciador</guimenu>, introduzca un valor en <guimenu>Nombre de usuario mutuo</guimenu> y en <guimenu>Contraseña mutua</guimenu>. Esta contraseña debe ser diferente de la que ha indicado en <guimenu>Autenticación mediante destinos</guimenu>.
   </para>
  </step>
  <step>
   <para>
    En la pestaña <guimenu>Destinos</guimenu>, seleccione <guimenu>Añadir</guimenu>.
   </para>
  </step>
  <step>
   <para>
    Cambie el nombre de <guimenu>Destino</guimenu> sustituyendo <literal>.com.example</literal>.
   </para>
  </step>
  <step>
   <para>
    La <guimenu>dirección IP</guimenu> de este servidor se debería rellenar automáticamente. Si no fuera así, añada la dirección IP ahora.
   </para>
  </step>
  <step>
   <para>
    Seleccione <guimenu>Añadir</guimenu>.
   </para>
  </step>
  <step>
   <para>
    En la ventana <guimenu>Detalles del LUN</guimenu>, introduzca en <guimenu>Vía del LUN</guimenu> la vía al dispositivo de almacenamiento de 1 GB (por ejemplo, <filename>/dev/vbd</filename>).
   </para>
  </step>
  <step>
   <para>
    Seleccione <guimenu>Aceptar</guimenu>.
   </para>
  </step>
  <step>
   <para>
    Seleccione <guimenu>Siguiente</guimenu>.
   </para>
  </step>
  <step>
   <para>
    Seleccione <guimenu>Finalizar</guimenu> para cerrar YaST.
   </para>
  </step>
  <step>
   <para>
    Para comprobar la configuración del destino, cambie a la interfaz de línea de comandos del destino:
   </para>
<screen><prompt role="root"># </prompt><command>targetcli</command></screen>
   <para>
    Muestre la configuración:
   </para>
<screen><prompt>/&gt; </prompt><command>ls</command></screen>
  </step>
 </procedure>

 <para>
  A continuación, configure los iniciadores iSCSI en los nodos. Repita este procedimiento en ambos nodos:
 </para>

 <procedure xml:id="pro-iscsi-for-sbd-clients">
  <title>Configuración de un iniciador iSCSI</title>
  <step>
   <para>
    Instale los paquetes necesarios:
   </para>
<screen><prompt role="root"># </prompt><command>zypper install open-iscsi yast2-iscsi-client</command></screen>
  </step>
  <step>
   <para>
    Inicie el servicio <literal>iscsid</literal>:
   </para>
<screen><prompt role="root"># </prompt><command>systemctl start iscsid</command></screen>
  </step>
  <step>
   <para>
    Abra el módulo <literal>iscsi-client</literal> en YaST:
   </para>
<screen><prompt role="root"># </prompt><command>yast2 iscsi-client</command></screen>
  </step>
  <step>
   <para>
    En la pestaña <guimenu>Destinos descubiertos</guimenu>, seleccione <guimenu>Descubrir</guimenu>.
   </para>
  </step>
  <step>
   <para>
    Introduzca la dirección IP del destino iSCSI.
   </para>
  </step>
  <step>
   <para>
    Desactive <guimenu>Sin autenticación de descubrimiento</guimenu>.
   </para>
  </step>
  <step>
   <para>
    En <guimenu>Autenticación mediante iniciador</guimenu>, introduzca el <guimenu>nombre de usuario</guimenu> y la <guimenu>contraseña</guimenu> del iniciador.
   </para>
  </step>
  <step>
   <para>
    En <guimenu>Autenticación mediante destinos</guimenu>, introduzca el <guimenu>nombre de usuario</guimenu> y la <guimenu>contraseña</guimenu> del destino.
   </para>
  </step>
  <step>
   <para>
    Seleccione <guimenu>Siguiente</guimenu>.
   </para>
  </step>
  <step>
   <para>
    Cuando YaST descubra el destino iSCSI, seleccione <guimenu>Conectar</guimenu>.
   </para>
  </step>
  <step>
   <para>
    En <guimenu>Inicio</guimenu>, seleccione <guimenu>en el arranque</guimenu>.
   </para>
  </step>
  <step>
   <para>
    Seleccione <guimenu>Siguiente</guimenu>.
   </para>
  </step>
  <step>
   <para>
    Seleccione <guimenu>Aceptar</guimenu> para cerrar YaST.
   </para>
  </step>
  <step>
   <para>
    Compruebe el iniciador iSCSI:
   </para>
<screen><prompt role="root"># </prompt><command>lsscsi</command>
[0:0:1:0] cd/dvd QEMU QEMU DVD-ROM 2.5+ /dev/sr0
[2:0:0:0] disk LIO-ORG IBLOCK 4.0 /dev/sda</screen>
   <para>
    Busque una línea con <literal>IBLOCK</literal>. En este ejemplo, el dispositivo iSCSI es <literal>/dev/sda</literal>.
   </para>
  </step>
  <step>
   <para>
    Compruebe el estado del servicio <literal>iscsid</literal>:
   </para>
<screen><prompt role="root"># </prompt><command>systemctl status iscsid</command></screen>
  </step>
 </procedure>

 <para>
  Encontrará el nombre del dispositivo estable en <filename>/dev/disk/by-id/</filename>. Normalmente, un dispositivo iSCSI comienza con <literal>scsi-SLIO-ORG_IBLOCK</literal>.
 </para>
 <para>
  Si tiene varios discos, puede ejecutar el comando <command>lsblk -o name,serial</command> para confirmar qué nombre de dispositivo estable corresponde a qué nombre corto (por ejemplo, <filename>/dev/sda</filename>).
 </para>
 <para>
  Cuando configure el clúster, especifique el nombre del dispositivo estable mediante uno de estos métodos:
 </para>
 <itemizedlist>
  <listitem>
   <para>
    Cuando se ejecute <command>crm cluster init</command>, introduzca el nombre del dispositivo estable cuando se le solicite.
   </para>
  </listitem>
  <listitem>
   <para>
    Antes de ejecutar <command>crm cluster init</command>, añada el nombre del dispositivo estable a <filename>/etc/sysconfig/sbd</filename>:
   </para>
<screen>SBD_DEVICE=/dev/disk/by-id/scsi-SLIO-ORG_IBLOCK_<replaceable>DEVICE_ID_STRING</replaceable></screen>
   <para>
    Cuando ejecute <command>crm cluster init</command>, responda <literal>n</literal> a esta pregunta:
   </para>
<screen>SBD is already configured to use /dev/disk/by-id/scsi-SLIO-ORG_IBLOCK_... - overwrite (y/n)?</screen>
  </listitem>
 </itemizedlist>
</appendix>
