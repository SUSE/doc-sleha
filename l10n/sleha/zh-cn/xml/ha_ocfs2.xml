<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="ha_ocfs2.xml" version="5.0" xml:id="cha-ha-ocfs2">
 <title>OCFS2</title>
 <info>
      <abstract>
        <para>
    Oracle Cluster File System 2 (OCFS2) 是一个自 Linux 2.6 内核以来完全集成的通用日志文件系统。OCFS2 可将应用程序二进制文件、数据文件和数据库储存到共享储存设备。群集中的所有节点对文件系统都有并行的读和写权限。用户空间控制守护程序（通过克隆资源管理）提供与 HA 堆栈的集成，尤其是与 Corosync 和分布式锁管理器 (DLM) 的集成。
   </para>
      </abstract>
      <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
        <dm:translation>yes</dm:translation>
      </dm:docmanager>
    </info>
 <sect1 xml:id="sec-ha-ocfs2-features">
  <title>功能和优势</title>

  <para>
   OCFS2 可用于以下储存解决方案，例如：
  </para>

  <itemizedlist>
   <listitem>
    <para>
     一般应用程序和工作负荷。
    </para>
   </listitem>
   <listitem>
    <para>
     群集中的 Xen 映像存储。Xen 虚拟机和虚拟服务器可存储于由群集服务器安装的 OCFS2 卷中。它提供了 Xen 虚拟机在各服务器之间的快速便捷的可移植性。
    </para>
   </listitem>
   <listitem>
    <para>
     LAMP (Linux、Apache、MySQL 和 PHP | Perl | Python) 堆栈。
    </para>
   </listitem>
  </itemizedlist>

  <para>
   作为高性能、非对称的并行群集文件系统，OCFS2 支持以下功能：
  </para>

  <itemizedlist>
   <listitem>
    <para>
     应用程序文件对群集中的所有节点均可用。用户只需在群集中的 OCFS2 上安装它一次。
    </para>
   </listitem>
   <listitem>
    <para>
     所有节点都可以通过标准文件系统接口直接并行读写至储存区，从而方便地管理运行于群集上的应用程序。
    </para>
   </listitem>
   <listitem>
    <para>
     文件访问通过 DLM 协调。DLM 控制在多数情况下都运行良好，但如果应用程序的设计与 DLM 争夺对文件访问的协调，则此设计可能会限制可伸缩性。
    </para>
   </listitem>
   <listitem>
    <para>
     所有后端储存上都可以使用储存备份功能。可以方便地创建共享应用程序文件的图形，它能够帮助提供有效的故障恢复。
    </para>
   </listitem>
  </itemizedlist>

  <para>
   OCFS2 还提供以下功能：
  </para>

  <itemizedlist>
   <listitem>
    <para>
     元数据缓存。
    </para>
   </listitem>
   <listitem>
    <para>
     元数据日志。
    </para>
   </listitem>
   <listitem>
    <para>
     跨节点的文件数据一致性。
    </para>
   </listitem>
   <listitem>
    <para>
     支持多达 4 KB 的多个块大小、多达 1 MB 的群集大小，最大卷大小为 4 PB (Petabyte)。
    </para>
   </listitem>
   <listitem>
    <para>
     支持最多 32 个群集节点。
    </para>
   </listitem>
   <listitem>
    <para>
     对于数据库文件的异步和直接 I/O 支持，提高了数据库性能。
    </para>
   </listitem>
  </itemizedlist>

  <note>
   <title>OCFS2 的支持</title>
   <para>
    仅当与 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise High Availability Extension</phrase></phrase> 提供的 pcmk (Pacemaker) 堆栈搭配使用时，SUSE 才支持 OCFS2。与 o2cb 堆栈结合使用时，SUSE 不提供对 OCFS2 的支持。
   </para>
  </note>
 </sect1>
 <sect1 xml:id="sec-ha-ocfs2-utils">
  <title>OCFS2 软件包和管理实用程序</title>

  <para>
   OCFS4 内核模块（<literal>ocfs2</literal>）自动安装到 SUSE® Linux Enterprise Server <phrase role="productnumber"><phrase os="sles">15 SP2</phrase></phrase> 中的 High Availability Extension 上。要使用 OCFS2，请确保已在群集中的每个节点上安装以下软件包：<package>ocfs2-tools</package> 和与内核匹配的 <package>ocfs2-kmp-*</package> 软件包。
  </para>

  <para>
   <package>ocfs2-tools</package> 软件包提供以下用于管理 OCFS2 卷的实用程序。有关语法信息，请参见其手册页。
  </para>

  <table>
   <title>OCFS2 实用程序</title>
   <tgroup cols="2">
    <thead>
     <row>
      <entry>
       <para>
        OCFS2 实用程序
       </para>
      </entry>
      <entry>
       <para>
        说明
       </para>
      </entry>
     </row>
    </thead>
    <tbody>
     <row>
      <entry>
       <para>
        debugfs.ocfs2
       </para>
      </entry>
      <entry>
       <para>
        检查 OCFS 文件系统的状态以进行调试。
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        fsck.ocfs2
       </para>
      </entry>
      <entry>
       <para>
        检查文件系统的错误并进行选择性的修改。
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        mkfs.ocfs2
       </para>
      </entry>
      <entry>
       <para>
        在某个设备上创建 OCFS2 文件系统，通常是共享物理或逻辑磁盘上的某个分区。
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        mounted.ocfs2
       </para>
      </entry>
      <entry>
       <para>
        检测并列出群集系统上所有的 OCFS2 卷。检测并列出已经安装了 OCFS2 设备的系统上的所有节点或列出所有的 OCFS2 设备。
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        tunefs.ocfs2
       </para>
      </entry>
      <entry>
       <para>
        更改 OCFS2 文件系统参数，包括卷标、节点槽号、所有节点槽的日志大小和卷大小。
       </para>
      </entry>
     </row>
    </tbody>
   </tgroup>
  </table>
 </sect1>
 <sect1 xml:id="sec-ha-ocfs2-create-service">
  <title>配置 OCFS2 服务和 STONITH 资源</title>



  <para>
   创建 OCFS2 卷之前，必须先将 DLM 和 STONITH 资源配置为群集中的服务。
  </para>

  <para>
   以下过程使用 <command>crm</command> 外壳配置群集资源。或者，您也可以按<xref linkend="sec-ha-ocfs2-rsc-hawk2"/>中所述，使用 Hawk2 来配置资源。
  </para>

  <procedure xml:id="pro-ocfs2-stonith">
   <title>配置 STONITH 资源</title>
   <note>
    <title>需要 STONITH 设备</title>
    <para>
     您需要配置屏蔽设备。没有一个适当的 STONITH 机制（如 <literal>external/sbd</literal>），则配置会失败。
    </para>
   </note>
   <step>
    <para>
     启动壳层，并以 <systemitem class="username">root</systemitem> 用户身份或同等身份登录。
    </para>
   </step>
   <step>
    <para>
     如<xref linkend="pro-ha-storage-protect-sbd-create"/>中所述，创建 SBD 分区。
    </para>
   </step>
   <step>
    <para>
     运行 <command>crm</command> <option> configure</option>。
    </para>
   </step>
   <step>
    <para>
     将 <literal>external/sbd</literal> 配置为屏蔽设备，并将 <literal>/dev/sdb2</literal> 作为存储检测信号和屏蔽的共享储存上的专用分区：
    </para>
<screen><prompt role="custom">crm(live)configure# </prompt><command>primitive</command> sbd_stonith stonith:external/sbd \
  params pcmk_delay_max=30 meta target-role="Started"</screen>
   </step>
   <step>
    <para>
     使用 <command>show</command> 查看更改。
    </para>
   </step>
   <step>
    <para>
     如果所有设置均正确无误，请使用 <command>commit</command> 提交更改，然后使用 <command>quit</command> 离开 crm 在线配置。
    </para>
   </step>
  </procedure>

  <para>
    有关为 DLM 配置资源组的细节，请参见<xref linkend="pro-dlm-resources"/>。
  </para>
 </sect1>
 <sect1 xml:id="sec-ha-ocfs2-create">
  <title>创建 OCFS2 卷</title>

  <para>
   根据<xref linkend="sec-ha-ocfs2-create-service"/>中所述配置 DLM 群集资源后，请将系统配置为使用 OCFS2，并创建 OCFs2 卷。
  </para>

  <note>
   <title>用于存储应用程序和数据文件的 OCFS2 卷</title>
   <para>
    我们建议您通常将应用程序文件和数据文件储存在不同的 OCFS2 卷上。如果应用程序卷和数据卷具有不同的挂载要求，则必须将它们储存在不同的卷上。
   </para>
  </note>

  <para>
   开始之前要准备计划用于 OCFS2 卷的块设备。将这些设备留作可用空间。
  </para>

  <para>
   然后，按<xref linkend="pro-ocfs2-volume"/>中所述使用 <command>mkfs.ocfs2</command> 创建和格式化 OCFS2 卷。此命令最重要的参数列于<xref linkend="tab-ha-ofcs2-mkfs-ocfs2-params"/>中。有关此命令的更多信息和命令语法，请参见 <command>mkfs.ocfs2</command> 手册页。
  </para>

  <table xml:id="tab-ha-ofcs2-mkfs-ocfs2-params">
   <title>重要的 OCFS2 参数</title>
   <tgroup cols="2">
    <thead>
     <row>
      <entry>
       <para>
        OCFS2 参数
       </para>
      </entry>
      <entry>
       <para>
        描述和建议
       </para>
      </entry>
     </row>
    </thead>
    <tbody>
     <row>
      <entry>
       <para>
        卷标 (<option>-L</option>)
       </para>
      </entry>
      <entry>
       <para>
        卷的描述性名称能够在不同节点上安装卷时唯一标识它。使用 <command>tunefs.ocfs2</command> 实用程序根据需要修改该卷标。
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        群集大小 (<option>-C</option>)
       </para>
      </entry>
      <entry>
       <para>
        群集大小是分配给文件以保存数据的最小空间单元。有关可用选项和推荐的信息，请参见 <command>mkfs.ocfs2</command> 手册页。
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        节点槽数 (<option>-N</option>)
       </para>
      </entry>
      <entry>
       <para>
        可以同时安装卷的最大节点数。OCFS2 将为每个节点创建单独的系统文件（如日志）。访问卷的节点可以是小端体系结构（如 AMD64/Intel 64）和大端体系结构（如 S/390x）的组合。
       </para>
       <para>
        节点特定的文件称为本地文件。节点槽号附加到该本地文件。例如：<literal>journal:0000</literal> 属于指派到槽号 <literal>0</literal> 的所有节点。
       </para>
       <para>
        根据预期有多少个节点并行挂载卷，在创建卷时设置每个卷的最大节点槽数。使用 <command>tunefs.ocfs2</command> 实用程序根据需要增加节点槽数。请注意，该值不能减小，并且一个节点槽将占用 100 MiB 磁盘空间。
       </para>
       <para>
        如果未指定 <option>-N</option> 参数，系统会根据文件系统的大小确定节点槽数。有关默认的值，请参见 <command>mkfs.ocfs2</command> 手册页。
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        块大小 (<option>-b</option>)
       </para>
      </entry>
      <entry>
       <para>
        文件系统可寻址的最小空间单元创建卷时请指定块大小。有关可用选项和推荐的信息，请参见 <command>mkfs.ocfs2</command> 手册页。

       </para>
      </entry>
     </row>

     <row>
      <entry>
       <para>
        打开/关闭特定功能 (<option>--fs-features</option>)
       </para>
      </entry>
      <entry>
       <para>
        可以提供功能标志的逗号分隔列表，<systemitem>mkfs.ocfs2</systemitem> 会尝试根据此列表创建具有那些功能的文件系统。要打开某功能，请将其加入列表。要关闭某功能，请在其名称前加 <literal>no</literal>。
       </para>
       <para>
        有关所有可用标志的概述，请参见 <command>mkfs.ocfs2</command> 手册页。
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        预定义功能 (<option>--fs-feature-level</option>)
       </para>
      </entry>
      <entry>
       <para>
        允许您从一组预定义文件系统功能中进行选择。有关可用选项的信息，请参见 <command>mkfs.ocfs2</command> 手册页。
       </para>
      </entry>
     </row>
    </tbody>
   </tgroup>
  </table>



  <para>
   如果使用 <command>mkfs.ocfs2</command> 创建和格式化卷时未指定任何功能，则默认情况下将启用以下功能：<option>backup-super</option>、<option>sparse</option>、<option>inline-data</option>、<option>unwritten</option>、<option>metaecc</option>、<option>indexed-dirs</option> 和 <option>xattr</option>。
  </para>

  <procedure xml:id="pro-ocfs2-volume">
   <title>创建并格式化 OCFS2 卷</title>
   <para>
    只在群集节点之<emphasis>一</emphasis>上执行以下步骤。
   </para>
   <step>
    <para>
     以 <systemitem class="username">root</systemitem> 用户身份打开终端窗口并登录。
    </para>
   </step>
   <step>
    <para>
     使用命令 <command>crm status</command> 检查群集是否联机。
    </para>
   </step>
   <step>
    <para>
     使用 <command>mkfs.ocfs2</command> 实用程序创建并格式化卷。有关此命令语法的信息，请参见 <command>mkfs.ocfs2</command> 手册页。
    </para>
    <para>
     例如，要在 <filename>/dev/sdb1</filename> 上创建最多支持 32 个群集节点的新 OCFS2 文件系统，请输入以下命令：
    </para>
<screen><prompt role="root">root # </prompt> mkfs.ocfs2 -N 32 /dev/sdb1</screen>


   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="sec-ha-ocfs2-mount">
  <title>挂载 OCFS2 卷</title>

  <para>
   可以手动挂载 OCFS2 卷，也可以按<xref linkend="pro-ocfs2-mount-cluster"/>中所述使用群集管理器挂载。
  </para>

  <procedure xml:id="pro-ocfs2-mount-manual">
   <title>手动挂载 OCFS2 卷</title>
   <step>
    <para>
     以 <systemitem class="username">root</systemitem> 用户身份打开终端窗口并登录。
    </para>
   </step>
   <step>
    <para>
     使用命令 <command>crm status</command> 检查群集是否联机。
    </para>
   </step>
   <step>
    <para>
     使用 <command>mount</command> 命令从命令行挂载卷。
    </para>
   </step>
  </procedure>
   <tip>
    <title>在单个节点上挂载现有的 OCFS2 卷</title>
    <para>
     您可以在单个节点（不具有功能完备的群集堆栈）上挂载 OCFS2 卷：例如，用于快速访问备份中的数据。要执行此操作，请使用 <command>mount</command> 命令和 <literal>-o nocluster</literal> 选项。
    </para>
    <warning role="compact">
     <para>
      此挂载方法缺少针对整个群集的保护能力。为了避免损坏文件系统，您必须确保仅将其挂载到一个节点上。
     </para>
    </warning>
   </tip>

  <procedure xml:id="pro-ocfs2-mount-cluster">
   <title>使用群集资源管理器挂载 OCFS2 卷</title>
   <para>
    要使用 High Availability 软件挂载 OCFS2 卷，请在群集中配置 ocfs2 文件系统资源。以下过程使用 <command>crm</command> 外壳配置群集资源。或者，您也可以按<xref linkend="sec-ha-ocfs2-rsc-hawk2"/>中所述，使用 Hawk2 来配置资源。
   </para>
   <step>
    <para>
     启动壳层，并以 <systemitem class="username">root</systemitem> 用户身份或同等身份登录。
    </para>
   </step>
   <step>
    <para>
     运行 <command>crm</command> <option> configure</option>。
    </para>
   </step>
   <step>
    <para>
     配置 Pacemaker 以在群集中的每个节点上挂载 OCFS2 文件系统：
    </para>
<screen><prompt role="custom">crm(live)configure# </prompt><command>primitive</command> ocfs2-1 ocf:heartbeat:Filesystem \
  params device="/dev/sdb1" directory="/mnt/shared" fstype="ocfs2" \
  op monitor interval="20" timeout="40" \
  op start timeout="60" op stop timeout="60" \
  meta target-role="Started"</screen>
   </step>
   <step>
    <para>
     将 <literal>ocfs2-1</literal> 原始资源添加到您在<xref linkend="pro-dlm-resources"/>中创建的 <literal>g-storage</literal> 组。
    </para>
<screen><prompt role="custom">crm(live)configure# </prompt><command>modgroup</command> g-storage add ocfs2-1</screen>
    <para><command>add</command> 子命令默认会追加新的组成员。由于基本组具有内部共置和顺序约束，Pacemaker 将仅在也已运行 <systemitem class="resource">ocfs2-1</systemitem>dlm<literal> 资源的节点上启动 </literal> 资源。
    </para>
   </step>
   <step>
    <para>
     使用 <command>show</command> 查看更改。

    </para>
   </step>
   <step>
    <para>
     如果所有设置均正确无误，请使用 <command>commit</command> 提交更改，然后使用 <command>quit</command> 离开 crm 在线配置。
    </para>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="sec-ha-ocfs2-rsc-hawk2">
  <title>使用 Hawk2 配置 OCFS2 资源</title>

  <para>
   除了使用 crm 外壳为 OCFS2 手动配置 DLM 和文件系统资源以外，您还可以使用 Hawk2 <guimenu>设置向导</guimenu>中的 OCFS2 模板。
  </para>

  <important>
   <title>手动配置与使用 Hawk2 的区别</title>
   <para>
    <guimenu>设置向导</guimenu>中的 OCFS2 模板<emphasis>不</emphasis>包括 STONITH 资源的配置。如果使用该向导，仍需在共享储存上创建 SBD 分区，并根据<xref linkend="pro-ocfs2-stonith"/>中所述配置一个 STONITH 资源。
   </para>
   <remark>taroth 2014-08-15: todo for next release: unify manual configuration
    and configuration via Hawk (use same resources, same options
    etc), filed https://bugzilla.novell.com/show_bug.cgi?id=892116 for this</remark>
   <para>
    使用 Hawk2 <guimenu>设置向导</guimenu>中的 OCFS2 模板还会导致资源配置与<xref linkend="pro-dlm-resources"/>和<xref linkend="pro-ocfs2-mount-cluster"/>中所述的手动配置略有不同。
   </para>
  </important>

  <procedure xml:id="pro-ha-ocfs2-rsc-hawk">
   <title>使用 Hawk2 的<guimenu>向导</guimenu>配置 OCFS2 资源</title>
   <step>
    <para>
     登录 Hawk2：
    </para>
    <screen>https://<replaceable>HAWKSERVER</replaceable>:7630/</screen>
   </step>
   <step>
    <para>
     在左侧导航栏中，选择<guimenu>向导</guimenu>。
    </para>
   </step>
   <step>
    <para>
     展开<guimenu>文件系统</guimenu>类别，然后选择 <literal>OCFS2 文件系统</literal>。
    </para>
   </step>
   <step>
    <para>
     按照屏幕指导执行操作。如果需要有关某个选项的信息，在 Hawk2 中单击它即可显示简短帮助文本。完成最后的配置步骤后，<guimenu>校验</guimenu>您所输入的值。
    </para>
    <para>
     向导会显示将应用于 CIB 的配置代码段以及任何其他更改（如果需要）。
    </para>
    <informalfigure>
     <mediaobject>
      <imageobject role="fo">
       <imagedata fileref="hawk2-wizard-ocfs2-verify.png" width="70%" format="PNG"/>
      </imageobject>
      <imageobject role="html">
       <imagedata fileref="hawk2-wizard-ocfs2-verify.png" width="70%" format="PNG"/>
      </imageobject>
     </mediaobject>
    </informalfigure>
   </step>
   <step>
    <para>
     检查建议的更改。如果一切都符合您的预期，请应用更改。
    </para>
    <para>
     如果操作成功，屏幕上会显示一条消息。
    </para>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="sec-ha-ocfs2-quota">
  <title>在 OCFS2 文件系统上使用定额</title>



  <para>
   要在 OCFS2 文件系统上使用定额，请分别使用相应的定额功能或挂载选项创建和挂载文件系统：<literal>ursquota</literal>（用于单独用户的定额）或 <literal>grpquota</literal>（用于组的定额）。这些功能也可以稍后使用 <command>tunefs.ocfs2</command> 在未挂载的文件系统上启用。
  </para>

  <para>
   文件系统启用了相应的定额功能后，它会跟踪其元数据，查看每个用户（或组）使用的空间和文件数。由于 OCFS2 将定额信息视为文件系统内部元数据，因此您无需运行 <command>quotacheck</command>(8) 程序。所有功能都内置到 fsck.ocfs2 和文件系统驱动程序中。
  </para>

  <para>
   要实施强加于每个用户或组的限制，请如同在任何其他文件系统上一样运行 <command>quotaon</command>(8)。
  </para>





  <para>
   由于性能原因，每个群集节点都会在本地执行定额会计，并每 10 秒将此信息与通用中央储存同步一次。此间隔可使用 <command>tunefs.ocfs2</command>、选项 <option>usrquota-sync-interval</option> 和 <option>grpquota-sync-interval</option> 进行调整。因此，定额信息可能不会始终都准确，因而在几个群集节点上并行操作时，用户或组可以稍微超出其定额限制。
  </para>
 </sect1>
 <sect1 xml:id="sec-ha-ocfs2-more">
  <title>更多信息</title>

  <para>
   有关 OCFS2 的更多信息，请参见以下链接：
  </para>

  <variablelist>
   <varlistentry>
    <term><link xlink:href="https://ocfs2.wiki.kernel.org/"/>
    </term>
    <listitem>
     <para>
      OCFS2 项目主页。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><link xlink:href="http://oss.oracle.com/projects/ocfs2/"/>
    </term>
    <listitem>
     <para>
      Oracle 上的原 OCFS2 项目主页。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><link xlink:href="http://oss.oracle.com/projects/ocfs2/documentation"/>
    </term>
    <listitem>
     <para>
      项目的原文档主页。
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
 </sect1>
</chapter>
