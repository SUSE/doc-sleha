<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="ha_migration.xml" version="5.0" xml:id="cha-ha-migration">

 <title>升级群集和更新软件包</title>
 <info>
      <abstract>
        <para>
    本章介绍两种不同方案：将群集升级到 SUSE Linux Enterprise High Availability 另一个版本（主要版本或服务包），以及更新群集节点上的单个软件包。请参见<xref linkend="sec-ha-migration-upgrade"/>与<xref linkend="sec-ha-migration-update"/>。
   </para>
        <para>
    如果您要升级群集，请在开始升级之前查看<xref linkend="sec-ha-migration-upgrade-oview"/>和<xref linkend="sec-ha-migration-upgrade-require"/>。
   </para>
      </abstract>
      <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
        <dm:maintainer/>
        <dm:status>editing</dm:status>
        <dm:deadline/>
        <dm:priority/>
        <dm:translation>yes</dm:translation>
        <dm:languages/>
        <dm:release/>
        <dm:repository/>
      </dm:docmanager>
    </info>
    <sect1 xml:id="sec-ha-migration-terminology">
  <title>术语</title>

  <para>
   下面介绍本章中使用的最重要术语的定义：
  </para>

  <variablelist>
   <varlistentry>
    <term>主要版本</term>
    <term>正式发布 (GA) 版本</term>
    <listitem>
     <para>
      主要版本是一个新的产品版本，增加了新功能和工具并停用了先前弃用的组件。其含有不向后兼容的更改。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry xml:id="vle-upgrade-offline">
    <term>群集脱机升级</term>
    <listitem>
     <para>
      如果新产品版本包含不可向后兼容的重大更改，则需要通过群集脱机升级来升级群集。需要先使所有节点下线并将群集作为一个整体进行升级，然后才能使所有节点重新上线。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry xml:id="vle-upgrade-rolling">
    <term>群集滚动升级</term>
    <listitem>
     <para>
      执行群集滚动升级时，每次会升级一个群集节点，此时，群集的其他节点仍在运行中。需将第一个节点下线，进行升级，然后再使其重新上线以加入群集。然后，需要逐个对其余节点重复上述过程，直到所有群集节点都升级为主要版本。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>服务包 (SP)</term>
    <listitem>
     <para>
      将几个补丁合并到便于安装或部署的一个组织体中。服务包都有编号，通常包含程序的安全性修复、更新、升级或增强功能。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>更新</term>
    <listitem>
     <para>
      安装某个软件包的更新<emphasis>次要</emphasis>版本，其中通常包含安全修复和其他重要修复。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>升级</term>
    <listitem>
     <para>
      安装软件包或分发包的更新<emphasis>主要</emphasis>版本，这会引入<emphasis>新功能</emphasis>。另请参见<xref linkend="vle-upgrade-offline"/>与<xref linkend="vle-upgrade-rolling"/>。
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
 </sect1>
 <sect1 xml:id="sec-ha-migration-upgrade">
  <title>将群集升级到产品的最新版本</title>

  <para>
   支持哪种升级路径以及如何执行升级，取决于当前的产品版本以及您要迁移到的目标版本。
  </para>

  <sect2 xml:id="sec-ha-migration-upgrade-oview">
   <title>SLE HA 和 SLE HA Geo 支持的升级路径</title>
    <para>
    SUSE Linux Enterprise High Availability 支持的升级路径与底层基础系统支持的升级路径相同。要了解完整信息，请参见 SUSE Linux Enterprise Server《升级指南》中的<link xlink:href="https://documentation.suse.com/sles-15/html/SLES-all/cha-upgrade-paths.html#sec-upgrade-paths-supported"><citetitle>Supported Upgrade Paths to SUSE Linux Enterprise Server 15 SP7</citetitle></link>。
    </para>

    <para>
    此外，由于 High Availability 群集堆栈提供了两种升级群集的方法，以下规则也适用：</para>
    <itemizedlist>
    <listitem>
      <formalpara>
      <title><xref linkend="vle-upgrade-rolling"/></title>
      <para>仅在同一主要版本内支持群集滚动升级（从一个服务包升级到下一个服务包，或从产品的 GA 版本升级到 SP1）。</para>
      </formalpara>
    </listitem>
    <listitem>
      <formalpara>
      <title><xref linkend="vle-upgrade-offline" xrefstyle="select:label"/></title>
        <para>要从一个主要版本升级到下一个主要版本（例如，从 SLE HA 12 升级到 SLE HA 15），或者从一个主要版本中的服务包升级到下一个主要版本（例如，从 SLE HA 12 SP5 升级到 SLE HA 15），需要执行群集脱机升级。
      </para>
      </formalpara>
    </listitem>
    </itemizedlist>

    <important>
    <title>升级后不支持混合群集和还原</title>
    <itemizedlist>
      <listitem>
      <para>
        <emphasis>不</emphasis>支持在 SUSE Linux Enterprise High Availability 12/SUSE Linux Enterprise High Availability 15 上运行混合群集。
      </para>
      </listitem>
      <listitem>
      <para>
        完成升级到产品版本 15 的过程后，<emphasis>不</emphasis>支持再还原到产品版本 12。
      </para>
      </listitem>
    </itemizedlist>
    </important>

   
   <note>
    <title>跳过服务包</title>
    <para>
     最简单的升级路径是按顺序安装所有服务包。对于 SUSE Linux Enterprise 15 产品系列（GA 和后续服务包），还支持在升级时跳过服务包（最多跳过两个）。例如，支持从 SLE HA 15 SP3 升级到 15 SP6（前提是支持 SLE HA 15 SP3）。
    </para>
   </note>

  <figure xml:id="fig-ha-migration-upgrade-oview">
   <title>支持的升级路径概述</title>
   <mediaobject>
    <imageobject role="fo">
     <imagedata fileref="upgrade-paths_sleha.svg" width="100%"/>
    </imageobject>
    <imageobject role="html">
     <imagedata fileref="upgrade-paths_sleha.png" width="80%"/>
    </imageobject>
    <textobject role="description">
      <phrase>此图显示了支持的 High Availability 群集升级路径。黑色箭头表示可以在不停止群集的情况下完成的升级。橙色箭头表示只能在停止群集的情况下完成的升级。蓝色箭头表示可以在停止群集的情况下从 LTSS 版本进行的升级。</phrase>
    </textobject>
   </mediaobject>
  </figure>
  </sect2>

  <sect2 xml:id="sec-ha-migration-upgrade-require">
   <title>升级前的必要准备</title>
   <variablelist>
    <varlistentry>
     <term>备份</term>
     <listitem>
      <para>
       确保系统备份为最新的且可恢复。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>测试</term>
     <listitem>
      <para>
       请先在群集设置的临时实例上测试升级过程，然后再在生产环境中执行该过程。这样，您便可以估算出维护期所需的时间段。这还有助于检测和解决任何意外问题。
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
  </sect2>

  <sect2 xml:id="sec-ha-migration-upgrade-offline">
   <title>群集脱机升级</title>
   <para>
    本节介绍如何从 SLE HA 12 升级到 SLE HA 15。请查看<xref linkend="fig-ha-migration-upgrade-oview"/>，确认支持升级的服务包。如果您的群集仍旧基于早期的服务包，请先将其升级到 SLES 和 SLE HA 的某个版本，这个版本必须可以用作升级到 SLE HA 15 的源。如果要从 SLE HA 12 SP5 升级，请参见<link xlink:href="https://documentation.suse.com/sle-ha/12-SP5/html/SLE-HA-all/cha-ha-migration.html#sec-ha-migration-upgrade">将群集升级到产品的最新版本</link>。
   </para>

<procedure xml:id="pro-ha-migration-offline-12-15">
    <title>从产品版本 12 升级到 15：群集脱机升级</title>
   <important>
     <title>从头开始安装</title>
     <para>如果您决定从头开始安装（而不是升级）群集节点，请参见<xref linkend="sec-ha-requirements-sw"/>了解 SUSE Linux Enterprise High Availability 15 SP7 所需的模块列表。有关模块、扩展及相关产品的详细信息，请参见 SUSE Linux Enterprise Server 15 的发行说明。可访问 <link xlink:href="https://www.suse.com/releasenotes/"></link> 来获取这些文档。
     </para>
    </important>
    <step>
     <para>
      在开始脱机升级到 SUSE Linux Enterprise High Availability 15 之前，请按<xref linkend="note-ha-cib-upgrade"/>中所述手动升级当前群集中的 CIB 语法。
     </para>
    </step>
    <step>
     <para>
      登录到每个群集节点，并使用以下命令停止群集堆栈：
     </para>
<screen><prompt role="root"># </prompt><command>crm cluster stop</command></screen>
    </step>
    <step>
     <para>
      将每个群集节点都升级到 SUSE Linux Enterprise Server 和 SUSE Linux Enterprise High Availability 的所需目标版本 - 请参见<xref linkend="sec-ha-migration-upgrade-oview"/>。
     </para>
    </step>
    <step>
     <para>
      完成升级过程后，请登录每个节点，并引导装有升级版 SUSE Linux Enterprise Server 和 SUSE Linux Enterprise High Availability 的每个节点。
     </para>
    </step>
    <step>
     <para>如果您使用群集 LVM，则需要从 clvmd 迁移到 lvmlockd。请参见 <command>lvmlockd</command> 手册页的 <citetitle>Changing a clvm/clustered VG to a shared VG</citetitle> 部分。
     </para>
     <para>
      如果您还使用 <systemitem class="daemon">cmirrord</systemitem>，我们强烈建议迁移到群集 MD。请参见<xref linkend="sec-ha-clvm-migrate"/>。
     </para>
    </step>
    <step>
     <para>
      登录某个群集节点，并启动所有节点上的群集堆栈：
     </para>
<screen><prompt role="root"># </prompt><command>crm cluster start --all</command></screen>
     <note>
      <title><option>--all</option> 选项仅在 15 SP4 版本中可用</title>
      <para>
       SUSE Linux Enterprise High Availability 15 SP4 中添加了 <option>--all</option> 选项。在早期版本中，您必须逐一在每个节点上运行 <command>crm cluster start</command> 命令。
      </para>
     </note>
    </step>
    <step>
     <para>
      使用 <command>crm status</command> 或 Hawk2 检查群集状态。
     </para>
    </step>
   </procedure>

    <note xml:id="note-ha-cib-upgrade">
    <title>升级 CIB 语法版本</title>
    <para>
     有时，新功能只能在最新的 CIB 语法版本中使用。升级到新产品版本时，默认<emphasis>不会</emphasis>升级 CIB 语法版本。
     </para>
    <procedure>
     <step>
      <para>使用以下命令检查版本：</para>
<screen><command>cibadmin -Q | grep validate-with</command></screen>
     </step>
     <step>
      <para>使用以下命令升级到最新的 CIB 语法版本：
      </para>
<screen><prompt role="root"># </prompt><command>cibadmin --upgrade --force</command></screen>
     </step>
    </procedure>
   </note>
  </sect2>

  <sect2 xml:id="sec-ha-migration-upgrade-rolling">
   <title>群集滚动升级</title>
   <para>
    本节介绍如何升级到新 SLE HA 15 服务包。请查看<xref linkend="fig-ha-migration-upgrade-oview"/>，确认支持升级的服务包。
   </para>

   <para>根据情况使用以下其中一个过程：</para>
   <itemizedlist>
    <listitem>
     <para>
      <xref linkend="pro-ha-migration-rolling-upgrade"/>。
     </para>
    </listitem>
    <listitem>
     <para>
      <xref linkend="pro-ha-migration-rolling-upgrade-newsp-freshinstall"/>。
     </para>
    </listitem>
   </itemizedlist>

   <warning>
    <title>活动的群集堆栈</title>
    <para>
     在开始升级某个节点之前，请<emphasis>停止</emphasis><emphasis>该节点上</emphasis>的群集堆栈。
    </para>
    <para>
     如果节点上的群集资源管理器在软件更新期间处于活动状态，可能会导致活动的节点被屏蔽等结果。
    </para>
   </warning>
   <important>
    <title>群集滚动升级的时间限制</title>
    <para>
     只有在将<emphasis>所有</emphasis>群集节点都升级到最新产品版本之后，才可使用该版本提供的新功能。在群集滚动升级期间，只有较短的一段时间支持混合版本群集升级。请在一周内完成群集滚动升级。
    </para>
    <para>
     当所有上线节点运行的都是升级的版本后，其他使用旧版本的节点不升级就无法（重新）加入群集。
    </para>
   </important>
   <procedure xml:id="pro-ha-migration-rolling-upgrade">
    <title>执行群集滚动升级</title>

    <step>
     <para>
      以 <systemitem class="username">root</systemitem> 用户身份登录要升级的节点，并停止群集堆栈：
     </para>
<screen><prompt role="root"># </prompt><command>crm cluster stop</command></screen>
    </step>
    <step xml:id="step-ha-migration-upgrade-tolatest">
     <para>
      按 <link xlink:href="https://documentation.suse.com/sles/html/SLES-all/book-upgrade.html">SLES 15 SP7《升级指南》</link>所述升级到 SUSE Linux Enterprise Server 和 SUSE Linux Enterprise High Availability 扩展的所需目标版本。
     </para>
     <para>
       如果需要升级 Geo 群集，请参见<xref linkend="cha-ha-geo-upgrade"/>。
     </para>
    </step>
    <step xml:id="step-ha-migration-upgrade-ais">
     <para>
      在升级后的节点上启动群集堆栈，使该节点重新加入群集：
     </para>
<screen><prompt role="root"># </prompt><command>crm cluster start</command></screen>
    </step>
    <step>
     <para>
      使下一个节点处于脱机状态，并对此节点重复上述过程。
     </para>
    </step>
    <step>
     <para>
      使用 <command>crm status</command> 或 Hawk2 检查群集状态。
     </para>
     <para>
      如果检测到您的群集节点使用的是不同的 CRM 版本，Hawk2 <guimenu>状态</guimenu>屏幕还会显示一条警告。
     </para>
    </step>
   </procedure>
   <important>
    <title>滚动升级的时间限制</title>
    <para>
     只有在将<emphasis>所有</emphasis>群集节点都升级到最新产品版本之后，才可使用该版本提供的新功能。对于采用混合版本的群集，其在滚动升级期间受支持的时间非常短暂。请在一周内完成滚动升级。
    </para>
   </important>
   <para>如果检测到您的群集节点使用的是不同的 CRM 版本，Hawk2 <guimenu>状态</guimenu>屏幕还会显示一条警告。</para>
   <para>除了就地升级之外，许多客户更喜欢进行全新安装，即使是要升级到下一个服务包时也是如此。下面的过程说明将双节点群集（包含节点 alice 和 bob）升级到下一个服务包 (SP) 的情况：
   </para>
   <procedure xml:id="pro-ha-migration-rolling-upgrade-newsp-freshinstall">
    <title>执行新服务包的群集范围全新安装</title>
    <step xml:id="st-ha-migration-rolling-up-sp-backup">
     <para>备份群集配置。下面的列表中显示了至少应备份的文件：
     </para>
     
     <screen>/etc/corosync/corosync.conf
/etc/corosync/authkey
/etc/sysconfig/sbd
/etc/modules-load.d/watchdog.conf
/etc/hosts
/etc/chrony.conf</screen>
     
     <para>根据您的资源，您可能还需要备份以下文件：</para>
     
     <screen>/etc/services
/etc/passwd
/etc/shadow
/etc/groups
/etc/drbd/*
/etc/lvm/lvm.conf
/etc/mdadm.conf
/etc/mdadm.SID.conf</screen>
     
    </step>
    <step xml:id="st-ha-migration-rolling-alice">
     <para>先从节点 alice 开始。
     </para>
     <substeps>
      <step>
       <para>
        将节点置于待机模式。这样便能将资源移出节点：
       </para>
       <screen><prompt role="root"># </prompt><command>crm --wait node standby alice reboot</command></screen>
       <para>
        如果使用 <option>--wait</option> 选项，该命令仅会在群集完成转换并变为空闲状态时返回。<option>reboot</option> 选项可使节点一旦重新上线就已脱离待机模式。尽管 <option>reboot</option> 选项的名称是重引导，但只要节点下线后又上线，该选项就会起作用。
       </para>
      </step>
      <step>
       <para>停止节点 alice 上的群集服务：</para>
       <screen><prompt role="root"># </prompt><command>crm cluster stop</command></screen>
      </step>
      <step>
       <para>
        此时，alice 不再有任何资源处于运行状态。升级节点 alice，完成后将其重引导。假定群集服务不会在系统引导时启动。
       </para>
      </step>
      <step>
       <para>
        将<xref linkend="st-ha-migration-rolling-up-sp-backup"/> 中的备份文件复制到原始位置。
       </para>
      </step>
      <step>
       <para>将节点 alice 重新加入群集：</para>
       <screen><prompt role="root"># </prompt><command>crm cluster start</command></screen>
      </step>
      <step>
       <para>检查资源是否正常。</para>
      </step>
     </substeps>
    </step>
    <step>
     <para>对节点 bob 重复<xref linkend="st-ha-migration-rolling-alice"/>。
     </para>
    </step>
   </procedure>
  </sect2>
 </sect1>
 <sect1 xml:id="sec-ha-migration-update">
  <title>更新群集节点上的软件包</title>

  <warning>
   <title>活动的群集堆栈</title>
   <para>
    开始更新节点的软件包之前，请<emphasis>停止</emphasis><emphasis>该节点上</emphasis>的群集堆栈或将该<emphasis>节点置于维护模式</emphasis>，具体取决于群集堆栈是否受影响。有关详细信息，请参见<xref linkend="step-update-check"/>。
   </para>
   <para>
    如果节点上的群集资源管理器在软件更新期间处于活动状态，可能会导致活动的节点被屏蔽等结果。
   </para>
  </warning>

  <procedure>
   <step xml:id="step-update-check">
    <para>
     在节点上安装任何软件包更新之前，请先确认以下问题：
    </para>
    <itemizedlist>
     <listitem>
      <para>
       该更新是否会影响属于 SUSE Linux Enterprise High Availability 的任何软件包？如果 <literal>yes</literal>，请先在节点上停止群集堆栈，然后再开始软件更新：
      </para>
<screen><prompt role="root"># </prompt><command>crm cluster stop</command></screen>
     </listitem>
     <listitem>
      <para>
       软件包更新操作是否需要重引导计算机？如果 <literal>yes</literal>：请先在节点上停止群集堆栈，然后再开始软件更新：
      </para>
<screen><prompt role="root"># </prompt><command>crm cluster stop</command></screen>
     </listitem>
     <listitem>
      <para>
       如果不属于上述任何一种情况，则不需要停止群集堆栈。在这种情况下，请先将节点置于维护模式，然后再开始软件更新：
      </para>
<screen><prompt role="root"># </prompt><command>crm node maintenance <replaceable>NODE_NAME</replaceable></command></screen>
      <para>
       有关维护模式的更多细节，请参见<xref linkend="sec-ha-maint-overview"/>。
      </para>
     </listitem>
    </itemizedlist>
   </step>
   <step>
    <para>
     使用 YaST 或 Zypper 来安装软件包更新。
    </para>
   </step>
   <step>
    <para>
     在成功安装更新后：
    </para>
    <itemizedlist>
     <listitem>
      <para>
       启动相应节点上的群集堆栈（如果在执行<xref linkend="step-update-check"/> 时已将它停止）：
      </para>
<screen><prompt role="root"># </prompt><command>crm cluster start</command></screen>
     </listitem>
     <listitem>
      <para>
       或者去除维护标志，使节点恢复正常模式：
      </para>
<screen><prompt role="root"># </prompt><command>crm node ready <replaceable>NODE_NAME</replaceable></command></screen>
     </listitem>
    </itemizedlist>
   </step>
   <step>
    <para>
     使用 <command>crm status</command> 或 Hawk2 检查群集状态。
    </para>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="sec-ha-migration-more">
  <title>更多信息</title>

  <para>
   有关您要升级到的产品的任何更改和新功能的详细信息，请参见其发行说明，网址为 <link xlink:href="https://www.suse.com/releasenotes/"></link>。
  </para>
 </sect1>
</chapter>
