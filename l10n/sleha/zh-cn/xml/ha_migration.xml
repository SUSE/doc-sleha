<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="ha_migration.xml" version="5.0" xml:id="cha-ha-migration">

 <title>升级群集和更新软件包</title>
 <info>
      <abstract>
        <para>
    本章介绍两种不同方案：将群集升级为 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise High Availability Extension</phrase></phrase> 的另一个版本（主要版本或服务包），以及更新群集节点上的单个软件包。请参见<xref linkend="sec-ha-migration-upgrade"/>与<xref linkend="sec-ha-migration-update"/>。
   </para>
        <para>
    如果您要升级群集，请在开始升级之前查看<xref linkend="sec-ha-migration-upgrade-oview"/>和<xref linkend="sec-ha-migration-upgrade-require"/>。
   </para>
      </abstract>
      <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
        <dm:maintainer/>
        <dm:status>编辑</dm:status>
        <dm:deadline/>
        <dm:priority/>
        <dm:translation>yes</dm:translation>
        <dm:languages/>
        <dm:release/>
        <dm:repository/>
      </dm:docmanager>
    </info>
    <sect1 xml:id="sec-ha-migration-terminology">
  <title>术语</title>

  <para>
   下面介绍本章中使用的最重要术语的定义：
  </para>



  <variablelist>
   <varlistentry>
    <term>主要版本</term>
    <term>正式发布 (GA) 版本</term>
    <listitem>
     <para>
      主要版本是一个新的产品版本，增加了新功能和工具并停用了先前弃用的组件。其含有不向后兼容的更改。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry xml:id="vle-upgrade-offline">
    <term>群集脱机升级</term>
    <listitem>
     <para>
      如果新产品版本包含不可向后兼容的重大更改，则需要通过群集脱机升级来升级群集。需要先使所有节点脱机并将群集作为一个整体进行升级，然后才能使所有节点重新联机。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry xml:id="vle-upgrade-rolling">
    <term>群集滚动升级</term>
    <listitem>
     <para>
      执行群集滚动升级时，每次会升级一个群集节点，此时，群集的其他节点仍在运行中。需将第一个节点脱机，进行升级，然后再使其重新联机以加入群集。然后，需要逐个对其余节点重复上述过程，直到所有群集节点都升级为主要版本。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>服务包 (SP)</term>
    <listitem>
     <para>
      将几个补丁合并到便于安装或部署的一个组织体中。服务包是有编号的并通常包含安全性修复、更新、升级或程序增强。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>更新</term>
    <listitem>
     <para>
      安装某个软件包的较新<emphasis>次要</emphasis>版本，其中通常包含安全修复和其他重要修复。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>升级</term>
    <listitem>
     <para>
      安装软件包或分发包的更新<emphasis>主要</emphasis>版本，引入<emphasis>新功能</emphasis>。另请参见<xref linkend="vle-upgrade-offline"/>与<xref linkend="vle-upgrade-rolling"/>。
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
 </sect1>
 <sect1 xml:id="sec-ha-migration-upgrade">
  <title>将群集升级到产品的最新版本</title>

  <para>
   支持哪种升级路径以及如何执行升级，取决于当前产品版本以及您要迁移到的目标版本。
  </para>

  <para>
   High Availability Extension 支持的升级路径与底层基础系统支持的升级路径相同。有关完整概述，请参见<citetitle>《SUSE Linux Enterprise Server 升级指南》</citetitle>中的 <link xlink:href="https://documentation.suse.com/sles-15/html/SLES-all/cha-upgrade-paths.html#sec-upgrade-paths-supported"><citetitle>SUSE Linux Enterprise Server <phrase role="productnumber"><phrase os="sles">15 SP3 支持的升级路径</phrase></phrase></citetitle></link> 一节。
  </para>

  <para>
   此外，由于高可用性群集堆栈提供了两种升级群集的方法，以下规则也适用：</para>
  <itemizedlist>
   <listitem>
    <formalpara>
     <title><xref linkend="vle-upgrade-rolling"/></title>
     <para>仅在同一主要版本内支持群集滚动升级（从一个服务包升级到下一个服务包，或从产品的 GA 版本升级到 SP1）。</para>
    </formalpara>
   </listitem>
   <listitem>
    <formalpara>
     <title><xref linkend="vle-upgrade-offline" xrefstyle="select:label"/></title>
      <para>要从一个主要版本升级到下一个主要版本（例如，从 SLE HA 12 升级到 SLE HA 15），或者从一个主要版本中的服务包升级到下一个主要版本（例如，从 SLE HA 12 SP3 升级到 SLE HA 15），需要执行群集脱机升级。
     </para>
    </formalpara>
   </listitem>
  </itemizedlist>

  <para>
   <xref linkend="sec-ha-migration-upgrade-oview" xrefstyle="select:label"/> 列出了 SLE HA (Geo) 支持的从一个版本升级到下一个版本的升级路径和方法。<citetitle>相关细节</citetitle>列中显示您应参考的特定升级文档（还包括基础系统和 Geo Clustering for SUSE Linux Enterprise High Availability Extension）。此文档可从以下位置获得：</para>
   <itemizedlist>
    <listitem>
     <para>
      <link xlink:href="https://documentation.suse.com/sles-15"/>
     </para>
    </listitem>
    <listitem>
     <para>
      <link xlink:href="https://documentation.suse.com/sle-ha-15"/>
     </para>
    </listitem>
   </itemizedlist>

  <important>
   <title>升级后不支持混合群集和还原</title>
   <itemizedlist>
    <listitem>
     <para>
      不支持在 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise High Availability Extension</phrase></phrase> 12/<phrase role="productname"><phrase os="sles">SUSE Linux Enterprise High Availability Extension</phrase></phrase> 15 上运行混合群集。<emphasis/>
     </para>
    </listitem>
    <listitem>
     <para>
      完成到产品版本 15 的升级过程后，<emphasis>不</emphasis>支持再还原到产品版本 12。
     </para>
    </listitem>
   </itemizedlist>
  </important>

  <sect2 xml:id="sec-ha-migration-upgrade-oview">
   <title>SLE HA 和 SLE HA Geo 支持的升级路径</title>
   <informaltable>
    <tgroup cols="3">
     <colspec colnum="1" colname="1" colwidth="28*"/>
     <colspec colnum="2" colname="2" colwidth="22*"/>
     <colspec colnum="3" colname="3" colwidth="50*"/>
     <thead>
      <row>
       <entry>
        <para>
         升级前版本和目标版本
        </para>
       </entry>
       <entry>
        <para>
         升级路径
        </para>
       </entry>
       <entry>
        <para>
         相关细节
        </para>
       </entry>
      </row>
     </thead>
     <tbody>
      <row>
       <entry>
        <para>
         SLE HA 11 SP3 到
        </para>
       <para>SLE HA (Geo) 12</para>
       </entry>
       <entry>
        <para>
         群集脱机升级
        </para>
       </entry>
       <entry>
        <itemizedlist>
         <listitem>
          <para>
           基本系统：SLES 12 的《<citetitle>部署指南</citetitle>》中的“<citetitle>更新和升级 SUSE Linux Enterprise</citetitle>”部分
          </para>
         </listitem>
         <listitem>
          <para>
           SLE HA：<xref linkend="pro-ha-migration-offline" xrefstyle="select:title nopage"/>
          </para>
         </listitem>
         <listitem>
          <para>
           SLE HA Geo：SLE HA 12 的《<citetitle>Geo 群集快速入门</citetitle>》中的“<citetitle>从 SLE HA (Geo) 11 SP3 升级到 SLE HA Geo 12</citetitle>”一节
          </para>
         </listitem>
        </itemizedlist>
       </entry>
      </row>
      <row>
       <entry>
        <para>
         从 SLE HA (Geo) 11 SP4 升级到 SLE HA (Geo) 12 SP1
        </para>
       </entry>
       <entry>
        <para>
         群集脱机升级
        </para>
       </entry>
       <entry>
        <itemizedlist>
         <listitem>
          <para>
           基本系统：SLES 12 SP1 的《<citetitle>部署指南</citetitle>》中的“<citetitle>更新和升级 SUSE Linux Enterprise</citetitle>”部分
          </para>
         </listitem>
         <listitem>
          <para>
           SLE HA：<xref linkend="pro-ha-migration-offline" xrefstyle="select:title nopage"/>
          </para>
         </listitem>
         <listitem>
          <para>
           SLE HA Geo：SLE HA 12 SP1 的《<citetitle>Geo 群集快速入门</citetitle>》中的“<citetitle>升级到最新的产品版本</citetitle>”一节
          </para>
         </listitem>
        </itemizedlist>
       </entry>
      </row>
      <row>
       <entry>
        <para>
         从 SLE HA (Geo) 12 升级到 SLE HA (Geo) 12 SP1
        </para>
       </entry>
       <entry>
        <para>
         群集滚动升级
        </para>
       </entry>
       <entry>
        <itemizedlist>
         <listitem>
          <para>
           基础系统：SLES 12 SP1 的《<citetitle>部署指南</citetitle>》中的“<citetitle>更新和升级 SUSE Linux Enterprise</citetitle>”部分
          </para>
         </listitem>
         <listitem>
          <para>
           SLE HA：<xref linkend="pro-ha-migration-rolling-upgrade" xrefstyle="select:title nopage"/>
          </para>
         </listitem>
         <listitem>
          <para>
           SLE HA Geo：SLE HA 12 SP1 的《<citetitle>Geo 群集快速入门</citetitle>》中的“<citetitle>升级到最新的产品版本</citetitle>”一节
          </para>
         </listitem>
        </itemizedlist>
       </entry>
      </row>
      <row>
       <entry>
        <para>从 SLE HA (Geo) 12 SP1 升级到 SLE HA (Geo) 12 SP2</para>
       </entry>
       <entry>
        <para>群集滚动升级</para>
       </entry>
       <entry>
        <itemizedlist>
         <listitem>
          <para>
           基础系统：SLES 12 SP2 的《<citetitle>部署指南</citetitle>》中的“<citetitle>更新和升级 SUSE Linux Enterprise</citetitle>”部分
          </para>
         </listitem>
         <listitem>
          <para>
           SLE HA：<xref linkend="pro-ha-migration-rolling-upgrade" xrefstyle="select:title nopage"/>
          </para>
         </listitem>
         <listitem>
          <para>
           SLE HA Geo：SLE HA 12 SP2 的《<citetitle>Geo 群集快速入门</citetitle>》中的“<citetitle>升级到最新的产品版本</citetitle>”一节
          </para>
         </listitem>
         <listitem>
          <para>DRBD 8 到 DRBD 9：<xref linkend="sec-ha-drbd-migrate" xrefstyle="select:title nopage"/></para>
         </listitem>
        </itemizedlist>
       </entry>
      </row>
      <row>
       <entry>
        <para>从 SLE HA (Geo) 12 SP2 升级到 SLE HA (Geo) 12 SP3</para>
       </entry>
       <entry>
        <para>群集滚动升级</para>
       </entry>
       <entry>
        <itemizedlist>
         <listitem>
          <para>
           基础系统：SLES 12 SP3 的《<citetitle>部署指南</citetitle>》中的“<citetitle>更新和升级 SUSE Linux Enterprise</citetitle>”部分
          </para>
         </listitem>
         <listitem>
          <para>
           SLE HA：<xref linkend="pro-ha-migration-rolling-upgrade" xrefstyle="select:title nopage"/>
          </para>
         </listitem>
         <listitem>
          <para>
           SLE HA Geo：SLE HA 12 SP3 的《<citetitle>Geo 群集指南</citetitle>》中的“<citetitle>升级到最新的产品版本</citetitle>”一节
          </para>
         </listitem>
        </itemizedlist>
       </entry>
      </row>
      <row>
       <entry>
        <para>从 SLE HA (Geo) 12 SP3 升级到 SLE HA (Geo) 12 SP4</para>
       </entry>
       <entry>
        <para>群集滚动升级</para>
       </entry>
       <entry>
        <itemizedlist>
         <listitem>
          <para>
           基础系统：SLES 12 SP4 的《<citetitle>部署指南</citetitle>》中的“<citetitle>更新和升级 SUSE Linux Enterprise</citetitle>”部分
          </para>
         </listitem>
         <listitem>
          <para>
           SLE HA：<xref linkend="pro-ha-migration-rolling-upgrade" xrefstyle="select:title nopage"/>
          </para>
         </listitem>
         <listitem>
          <para>
           SLE HA Geo：SLE HA 12 SP4 的《<citetitle>Geo 群集指南</citetitle>》中的“<citetitle>升级到最新的产品版本</citetitle>”一节
          </para>
         </listitem>
        </itemizedlist>
       </entry>
      </row>
      <row>
       <entry>
        <para>从 SLE HA (Geo) 12 SP3 到 SLE HA (Geo) 15</para>
       </entry>
       <entry>
        <para>群集脱机升级</para>
       </entry>
       <entry>
        <itemizedlist>
         <listitem>
          <para>
           基础系统：SLES 15 的《<citetitle>升级指南</citetitle>》
          </para>
         </listitem>
         <listitem>
          <para>
           SLE HA：<xref linkend="pro-ha-migration-offline-12-15" xrefstyle="select:title nopage"/>
          </para>
         </listitem>
         <listitem>
          <para>
           SLE HA Geo：<xref linkend="cha-ha-geo-upgrade"/>
          </para>
         </listitem>
         <listitem>
          <para>群集式 LVM：<xref linkend="sec-ha-clvm-migrate" xrefstyle="select:title nopage"/></para>
         </listitem>
        </itemizedlist>
       </entry>
      </row>
      <row>
       <entry>
        <para>从 SLE HA (Geo) 12 SP4 升级到 SLE HA (Geo) 12 SP5</para>
       </entry>
       <entry>
        <para>群集滚动升级</para>
       </entry>
       <entry>
        <itemizedlist>
         <listitem>
          <para>
           基本系统：SLES 12 SP5 的《<citetitle>部署指南</citetitle>》中的“<citetitle>更新和升级 SUSE Linux Enterprise</citetitle>”部分
          </para>
         </listitem>
         <listitem>
          <para>
           SLE HA：<xref linkend="pro-ha-migration-rolling-upgrade" xrefstyle="select:title nopage"/>
          </para>
         </listitem>
         <listitem>
          <para>
           SLE HA Geo：<xref linkend="cha-ha-geo-upgrade"/>
          </para>
         </listitem>
        </itemizedlist>
       </entry>
      </row>
      <row>
       <entry>
        <para>从 SLE HA (Geo) 12 SP4 升级到 SLE HA (Geo) 15 SP1</para>
       </entry>
       <entry>
        <para>群集脱机升级</para>
       </entry>
       <entry>
        <itemizedlist>
         <listitem>
          <para>
           基础系统：SLES 15 SP1 的《<citetitle>升级指南</citetitle>》
          </para>
         </listitem>
         <listitem>
          <para>
           SLE HA：<xref linkend="pro-ha-migration-offline-12-15" xrefstyle="select:title nopage"/>
          </para>
         </listitem>
         <listitem>
          <para>
           SLE HA Geo：<xref linkend="cha-ha-geo-upgrade"/>
          </para>
         </listitem>
         <listitem>
          <para>群集式 LVM：<xref linkend="sec-ha-clvm-migrate" xrefstyle="select:title nopage"/></para>
         </listitem>
        </itemizedlist>
       </entry>
      </row>
      <row>
       <entry>
        <para>从 SLE HA (Geo) 12 SP5 升级到 SLE HA (Geo) 15 SP2</para>
       </entry>
       <entry>
        <para>群集脱机升级</para>
       </entry>
       <entry>
        <itemizedlist>
         <listitem>
          <para>
           基础系统：SLES 15 SP2 的《<citetitle>升级指南</citetitle>》
          </para>
         </listitem>
         <listitem>
          <para>
           SLE HA：<xref linkend="pro-ha-migration-offline-12-15" xrefstyle="select:title nopage"/>
          </para>
         </listitem>
         <listitem>
          <para>
           SLE HA Geo：<xref linkend="cha-ha-geo-upgrade"/>
          </para>
         </listitem>
         <listitem>
          <para>群集式 LVM：<xref linkend="sec-ha-clvm-migrate" xrefstyle="select:title nopage"/></para>
         </listitem>
        </itemizedlist>
       </entry>
      </row>
      <row>
       <entry>
        <para>从 SLE HA (Geo) 15 升级到 SLE HA (Geo) 15 SP1</para>
       </entry>
       <entry>
        <para>群集滚动升级</para>
       </entry>
       <entry>
        <itemizedlist>
         <listitem>
          <para>
           基础系统：SLES 15 SP1 的《<citetitle>升级指南</citetitle>》
          </para>
         </listitem>
         <listitem>
          <para>
           SLE HA：<xref linkend="pro-ha-migration-rolling-upgrade" xrefstyle="select:title nopage"/>
          </para>
         </listitem>
         <listitem>
          <para>
           SLE HA Geo：<xref linkend="cha-ha-geo-upgrade"/>
          </para>
         </listitem>
        </itemizedlist>
       </entry>
      </row>
      <row>
       <entry>
        <para>从 SLE HA (Geo) 15 SP1 升级到 SLE HA (Geo) 15 SP2</para>
       </entry>
       <entry>
        <para>群集滚动升级</para>
       </entry>
       <entry>
        <itemizedlist>
         <listitem>
          <para>
           基础系统：SLES 15 SP2 的《<citetitle>升级指南</citetitle>》
          </para>
         </listitem>
         <listitem>
          <para>
           SLE HA：<xref linkend="pro-ha-migration-rolling-upgrade" xrefstyle="select:title nopage"/>
          </para>
         </listitem>
         <listitem>
          <para>
           SLE HA Geo：<xref linkend="cha-ha-geo-upgrade"/>
          </para>
         </listitem>
        </itemizedlist>
       </entry>
      </row>
      <row>
       <entry>
        <para>从 SLE HA (Geo) 15 SP2 升级到 SLE HA (Geo) 15 SP3</para>
       </entry>
       <entry>
        <para>群集滚动升级</para>
       </entry>
       <entry>
        <itemizedlist>
         <listitem>
          <para>
           基础系统：SLES 15 SP3 的《<citetitle>升级指南</citetitle>》
          </para>
         </listitem>
         <listitem>
          <para>
           SLE HA：<xref linkend="pro-ha-migration-rolling-upgrade" xrefstyle="select:title nopage"/>
          </para>
         </listitem>
         <listitem>
          <para>
           SLE HA Geo：<xref linkend="cha-ha-geo-upgrade"/>
          </para>
         </listitem>
        </itemizedlist>
       </entry>
      </row>
     </tbody>
    </tgroup>
   </informaltable>

   
   <note>
    <title>跳过服务包</title>
    <para>
     最简单的升级路径是按顺序安装所有服务包。对于 SUSE Linux Enterprise 15 产品系列（GA 和后续服务包），还支持在升级时跳过某个服务包。例如，支持从 SLE 15 GA 升级到 15 SP2，或从 SLE 15 SP1 升级到 15 SP3。
    </para>
   </note>
  </sect2>

  <sect2 xml:id="sec-ha-migration-upgrade-require">
   <title>升级前的必要准备</title>
   <variablelist>
    <varlistentry>
     <term>备份</term>
     <listitem>
      <para>
       确保系统备份为最新的且可恢复。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>测试</term>
     <listitem>
      <para>
       请先在群集设置的临时实例上测试升级过程，然后再在生产环境中执行该过程。这样，您便可以估算出维护期所需的时间段。这还有助于检测和解决可能会出现的任何意外问题。
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
  </sect2>

  <sect2 xml:id="sec-ha-migration-upgrade-offline">
   <title>群集脱机升级</title>
   <para>
    本节内容适用于以下场合：
   </para>
   <itemizedlist>
    <listitem>
     <para>
      从 SLE HA 11 SP3 升级到 SLE HA 12 - 有关细节，请参见<xref linkend="pro-ha-migration-offline"/>。</para>
    </listitem>
    <listitem>
     <para>
      从 SLE HA 11 SP4 升级到 SLE HA 12 SP1 - 有关细节，请参见<xref linkend="pro-ha-migration-offline"/>。
     </para>
    </listitem>
    <listitem>
     <para>
      从 SLE HA 12 SP3 升级到 SLE HA 15 - 有关细节，请参见<xref linkend="pro-ha-migration-offline-12-15"/>。
     </para>
    </listitem>
    <listitem>
     <para>
      从 SLE HA 12 SP4 升级到 SLE HA 15 SP1 - 有关细节，请参见<xref linkend="pro-ha-migration-offline-12-15"/>。
     </para>
    </listitem>
    <listitem>
     <para>
      从 SLE HA 12 SP5 升级到 SLE HA 15 SP2 - 有关细节，请参见<xref linkend="pro-ha-migration-offline-12-15"/>。
     </para>
    </listitem>
   </itemizedlist>
   <para>
    如果您的群集仍旧基于早期的产品版本而不是上面所列的版本，请先将它升级到 SLES 和 SLE HA 的某个版本，而该版本可用作升级到所需目标版本的源。
   </para>

   <procedure xml:id="pro-ha-migration-offline">
    <title>从产品版本 11 升级到 12：群集脱机升级</title>
    <para>
     High Availability Extension 12 群集堆栈的各个组件包含了重大更改（例如 <filename>/etc/corosync/corosync.conf</filename>、OCFS2 的磁盘格式）。因此，不支持从任何 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise High Availability Extension</phrase></phrase> 11 版本进行<literal>群集滚动升级</literal>。必须将所有群集节点脱机，并根据下面所述将群集作为一个整体升级。
    </para>
    <step>
     <para>
      登录到每个群集节点，并使用以下命令停止群集堆栈：
     </para>
<screen><prompt role="root">root # </prompt><command>rcopenais</command> stop</screen>
    </step>
    <step>
     <para>
      将每个群集节点都升级到 SUSE Linux Enterprise Server 和 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise High Availability Extension</phrase></phrase> 的所需目标版本 — 请参见<xref linkend="sec-ha-migration-upgrade-oview"/>。
     </para>
    </step>
    <step>
     <para>
      完成升级过程后，请重引导装有 SUSE Linux Enterprise Server 和 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise High Availability Extension</phrase></phrase> 升级版的每个节点。
     </para>
    </step>
    <step>
     <para>
      如果在群集设置中使用了 OCFS2，请执行以下命令以更新设备上的结构：
     </para>
<screen><prompt role="root">root # </prompt><command>o2cluster</command> --update <replaceable>PATH_TO_DEVICE</replaceable></screen>
     <para>
      它会为磁盘添加额外参数。<phrase role="productname"><phrase os="sles">SUSE Linux Enterprise High Availability Extension</phrase></phrase> 12 和 12 SPx 随附的已更新 OCFS2 版本需要这些参数。
     </para>
    </step>
    <step>
     <para>
      要更新 Corosync 2 的 <filename>/etc/corosync/corosync.conf</filename>，请执行以下操作：
     </para>
     <substeps>
      <step>
       <para>
        登录到某个节点，然后启动 YaST 群集模块。
       </para>
      </step>
      <step>
       <para>
        切换到<guimenu>通讯通道</guimenu>类别并输入以下新参数的值：<guimenu>群集名称</guimenu>和<guimenu>预期投票数</guimenu>。有关细节，请分别参见<xref linkend="pro-ha-installation-setup-channel1-udp"/>或<xref linkend="pro-ha-installation-setup-channel1-udpu"/>。
       </para>
       <para>
        如果 YaST 检测到对 Corosync 2 无效或缺失的任何其他选项，它会提示您进行更改。
       </para>

      </step>
      <step>
       <para>
        确认在 YaST 中所做更改。YaST 会将配置写入 <filename>/etc/corosync/corosync.conf</filename>。
       </para>
      </step>
      <step>
       <para>
        如果为群集配置了 Csync2，请使用以下命令将更新的 Corosync 配置推送到其他群集节点：
       </para>
<screen><prompt role="root">root # </prompt><command>csync2</command> <option>-xv</option></screen>
       <para>
        有关 Csync2 的细节，请参见<xref linkend="sec-ha-installation-setup-csync2"/>。
       </para>
       <para>
        或者，也可以通过将 <filename>/etc/corosync/corosync.conf</filename> 手动复制到所有群集节点，来同步更新的 Corosync 配置。
       </para>
      </step>
     </substeps>
    </step>
    <step>
     <para>
      登录到每个节点，并使用以下命令启动群集堆栈：
     </para>
<screen><prompt role="root">root # </prompt><command>crm</command> cluster start</screen>
    </step>
    <step>
     <para>
      使用 <command>crm status</command> 或 Hawk2 检查群集状态。
     </para>
    </step>
    <step>
     <para>将以下服务配置为在引导时启动：</para>
     <screen><prompt role="root">root # </prompt>systemctl enable pacemaker
<prompt role="root">root # </prompt>systemctl enable hawk
<prompt role="root">root # </prompt>systemctl enable sbd</screen>
    </step>
   </procedure>

 <note xml:id="note-ha-cib-upgrade">
    <title>升级 CIB 语法版本</title>
    <para>
     有时，新功能只能在最新的 CIB 语法版本中使用。升级到新的产品版本时，默认<emphasis>不会</emphasis>升级 CIB 语法版本。
     </para>
    <procedure>
     <step>
      <para>使用以下命令检查版本：</para>
<screen>cibadmin -Q | grep validate-with</screen>
     </step>
     <step>
      <para>使用以下命令升级到最新的 CIB 语法版本：
      </para>
<screen><prompt role="root">root # </prompt><command>cibadmin</command> --upgrade --force</screen>
     </step>
    </procedure>
   </note>

<procedure xml:id="pro-ha-migration-offline-12-15">
    <title>从产品版本 12 升级到 15：群集脱机升级</title>
   <important>
     <title>从头开始安装</title>
     <para>如果您决定从头开始安装群集节点（而不是升级它们），请参见<xref linkend="sec-ha-requirements-sw"/>以获取 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise High Availability Extension</phrase></phrase> <phrase role="productnumber"><phrase os="sles">15 SP3</phrase></phrase> 所需的模块列表。有关模块、扩展及相关产品的详细信息，请参见 SUSE Linux Enterprise Server 15 的发行说明。可从 <link xlink:href="https://www.suse.com/releasenotes/"/> 访问这些文档。
     </para>
    </important>
    <step>
     <para>
      在开始脱机升级到 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise High Availability Extension</phrase></phrase> 15 之前，请如<xref linkend="note-ha-cib-upgrade"/>中所述手动升级当前群集中的 CIB 语法。
     </para>
    </step>
    <step>
     <para>
      登录到每个群集节点，并使用以下命令停止群集堆栈：
     </para>
<screen><prompt role="root">root # </prompt><command>crm</command> cluster stop</screen>
    </step>
    <step>
     <para>
      将每个群集节点都升级到 SUSE Linux Enterprise Server 和 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise High Availability Extension</phrase></phrase> 的所需目标版本 — 请参见<xref linkend="sec-ha-migration-upgrade-oview"/>。
     </para>
    </step>
    <step>
     <para>
      完成升级过程后，请登录每个节点，并引导装有 SUSE Linux Enterprise Server 和 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise High Availability Extension</phrase></phrase> 升级版的每个节点。
     </para>
    </step>
    <step>
     <para>如果您使用群集 LVM，则需要从 clvmd 迁移到 lvmlockd。请参见 <command>lvmlockd</command> 的手册页中的 <citetitle>changing clvm VG to lockd VG</citetitle>（将 clvm VG 更改为 lockd VG）部分，另请参见<xref linkend="sec-ha-clvm-migrate"/>。
     </para>
    </step>
    <step>
     <para>
      使用以下命令启动群集堆栈：
     </para>
<screen><prompt role="root">root # </prompt><command>crm</command> cluster start</screen>
    </step>
    <step>
     <para>
      使用 <command>crm status</command> 或 Hawk2 检查群集状态。
     </para>
    </step>
   </procedure>
  </sect2>

  <sect2 xml:id="sec-ha-migration-upgrade-rolling">
   <title>群集滚动升级</title>
   <para>
    本节内容适用于以下场合：
   </para>
   <itemizedlist>
    <listitem>
     <para>
      从 SLE HA 12 升级到 SLE HA 12 SP1
     </para>
    </listitem>
    <listitem>
     <para>
      从 SLE HA 12 SP1 升级到 SLE HA 12 SP2
     </para>
    </listitem>
    <listitem>
     <para>
      从 SLE HA 12 SP2 升级到 SLE HA 12 SP3
     </para>
    </listitem>
    <listitem>
     <para>
      从 SLE HA 12 SP3 升级到 SLE HA 12 SP4
     </para>
    </listitem>
    <listitem>
     <para>
      从 SLE HA 12 SP4 升级到 SLE HA 12 SP5
     </para>
    </listitem>
    <listitem>
     <para>
      从 SLE HA 15 升级到 SLE HA 15 SP1
     </para>
    </listitem>
    <listitem>
     <para>
      从 SLE HA 15 SP1 升级到 SLE HA 15 SP2
     </para>
    </listitem>
    <listitem>
     <para>
      从 SLE HA 15 SP2 升级到 SLE HA 15 SP3
     </para>
    </listitem>

   </itemizedlist>

   <para>根据情况使用以下其中一个过程：</para>
   <itemizedlist>
    <listitem>
     <para>
      如果要进行较为常规的滚动升级，请参见<xref linkend="pro-ha-migration-rolling-upgrade" xrefstyle="select:label"/>。
     </para>
    </listitem>
    <listitem>
     <para>
      如果要进行特定的滚动升级，请参见<xref linkend="pro-ha-migration-rolling-upgrade-newsp-freshinstall" xrefstyle="select:label"/>。
     </para>
    </listitem>
   </itemizedlist>

   <warning>
    <title>活动的群集堆栈</title>
    <para>
     在开始升级某个节点之前，请<emphasis>停止</emphasis><emphasis>该节点上的</emphasis>群集堆栈。
    </para>
    <para>
     如果节点上的群集资源管理器在软件更新期间处于活动状态，可能会导致活动的节点被屏蔽等结果。
    </para>
   </warning>
   <important>
    <title>群集滚动升级的时间限制</title>
    <para>
     只有在将<emphasis>所有</emphasis>群集节点都升级到最新产品版本之后，最新产品版本提供的新功能才可用。在群集滚动升级期间，只有较短的一段时间支持混合版本群集升级。请在一周内完成群集滚动升级。
    </para>
    <para>
     当所有联机节点运行的都是升级的版本后，其他使用旧版本的节点不升级就无法（重新）加入群集。
    </para>
   </important>
   <procedure xml:id="pro-ha-migration-rolling-upgrade">
    <title>执行群集滚动升级</title>

    <step>
     <para>
      以 <systemitem class="username">root</systemitem> 用户身份登录要升级的节点，并停止群集堆栈：
     </para>
<screen><prompt role="root">root # </prompt><command>crm</command> cluster stop</screen>
    </step>
    <step xml:id="step-ha-migration-upgrade-tolatest">
     <para>
      升级到 SUSE Linux Enterprise Server 和 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise High Availability Extension</phrase></phrase> 的所需目标版本。要了解各个升级过程的细节，请参见<xref linkend="sec-ha-migration-upgrade-oview"/>。
     </para>
    </step>
    <step xml:id="step-ha-migration-upgrade-ais">
     <para>
      在升级后的节点上启动群集堆栈，使该节点重新加入群集：
     </para>
<screen><prompt role="root">root # </prompt><command>crm</command> cluster start</screen>
    </step>
    <step>
     <para>
      使下一个节点处于脱机状态，并对此节点重复上述过程。
     </para>
    </step>
    <step>
     <para>
      使用 <command>crm status</command> 或 Hawk2 检查群集状态。
     </para>
     <para>
      如果检测到您的群集节点有不同的 CRM 版本，Hawk2 <guimenu>状态</guimenu>屏幕还会显示一条警告。
     </para>
    </step>
   </procedure>
   <important>
    <title>滚动升级的时间限制</title>
    <para>
     只有在将<emphasis>所有</emphasis>群集节点都升级到最新产品版本之后，最新产品版本提供的新功能才可用。对于采用混合版本的群集，其在滚动升级期间受支持的时间非常短暂。请在一周内完成滚动升级。
    </para>
   </important>
   <para>如果检测到您的群集节点有不同的 CRM 版本，Hawk2 <guimenu>状态</guimenu>屏幕还会显示一条警告。</para>
   <para>除了就地升级之外，许多客户更喜欢进行全新安装，即使是要升级到下一个服务包时也是如此。下面的过程显示双节点群集（包含节点 alice 和 bob）升级到下一个服务包 (SP) 的情况：
   </para>
   <procedure xml:id="pro-ha-migration-rolling-upgrade-newsp-freshinstall">
    <title>执行新服务包的群集范围全新安装</title>
    <step xml:id="st-ha-migration-rolling-up-sp-backup">
     <para>备份群集配置。下面的列表中显示了至少应备份的文件：
     </para>
     
     <screen>/etc/corosync/corosync.conf
/etc/corosync/authkey
/etc/sysconfig/sbd
/etc/modules-load.d/watchdog.conf
/etc/hosts
/etc/ntp.conf</screen>
     
     <para>根据您的资源，您可能还需要备份以下文件：</para>
     
     <screen>/etc/services
/etc/passwd
/etc/shadow
/etc/groups
/etc/drbd/*
/etc/lvm/lvm.conf
/etc/mdadm.conf
/etc/mdadm.SID.conf</screen>
     
    </step>
    <step xml:id="st-ha-migration-rolling-alice">
     <para>先从节点 alice 开始。
     </para>
     <substeps>
      <step>
       <para>
        将节点置于待机模式。这样便能将资源移出节点：
       </para>
       <screen><prompt role="root">root # </prompt><command>crm</command> --wait node standby alice reboot</screen>
       <para>
        使用 <option>--wait</option> 选项，该命令仅会在群集完成转换并变为空闲状态时返回。<option>reboot</option> 选项可使节点一旦重新联机就已脱离待机模式。尽管 <option>reboot</option> 选项的名称是重引导，但只要节点脱机后又联机，该选项就会起作用。
       </para>
      </step>
      <step>
       <para>停止节点 alice 上的群集服务：</para>
       <screen><prompt role="root">root # </prompt><command>crm</command> cluster stop</screen>
      </step>
      <step>
       <para>
        此时，alice 不再有任何资源处于运行状态。升级节点 alice，完成后将其重引导。假定群集服务不会在系统引导时启动。
       </para>
      </step>
      <step>
       <para>
        将<xref linkend="st-ha-migration-rolling-up-sp-backup"/> 中的备份文件复制到原始位置。
       </para>
      </step>
      <step>
       <para>将节点 alice 重新加入群集：</para>
       <screen><prompt role="root">root # </prompt><command>crm</command> cluster start</screen>
      </step>
      <step>
       <para>检查资源是否正常。</para>
      </step>
     </substeps>
    </step>
    <step>
     <para>对节点 bob 重复<xref linkend="st-ha-migration-rolling-alice"/>。
     </para>
    </step>
   </procedure>
  </sect2>
 </sect1>
 <sect1 xml:id="sec-ha-migration-update">
  <title>更新群集节点上的软件包</title>

  <warning>
   <title>活动的群集堆栈</title>
   <para>
    启动某节点的软件包更新之前，请<emphasis>停止</emphasis><emphasis>该节点上</emphasis>的群集堆栈，或将<emphasis>该节点置于维护模式</emphasis>，具体取决于群集堆栈是否受影响。有关详细信息，请参见 <xref linkend="step-update-check"/>。
   </para>
   <para>
    如果节点上的群集资源管理器在软件更新期间处于活动状态，可能会导致活动的节点被屏蔽等结果。
   </para>
  </warning>

  <procedure>
   <step xml:id="step-update-check">
    <para>
     在节点上安装任何软件包更新之前，请先确认以下问题：
    </para>
    <itemizedlist>
     <listitem>
      <para>
       这种更新是否会影响属于 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise High Availability Extension</phrase></phrase> 或 Geo Clustering for SUSE Linux Enterprise High Availability Extension 的任何软件包？如果<literal>是</literal>，请先在节点上停止群集堆栈，然后再开始软件更新：
      </para>
<screen><prompt role="root">root # </prompt><command>crm</command> cluster stop</screen>
     </listitem>
     <listitem>
      <para>
       软件包更新操作是否需要重引导计算机？如果<literal>是</literal>，请先在节点上停止群集堆栈，然后再开始软件更新：
      </para>
<screen><prompt role="root">root # </prompt><command>crm</command> cluster stop</screen>
     </listitem>
     <listitem>
      <para>
       如果不属于上述任何一种情况，则不需要停止群集堆栈。在这种情况下，请先将节点置于维护模式，然后再开始软件更新：
      </para>
<screen><prompt role="root">root # </prompt><command>crm</command> node maintenance <replaceable>NODE_NAME</replaceable></screen>
      <para>
       有关维护模式的更多细节，请参见<xref linkend="sec-ha-maint-overview"/>。
      </para>
     </listitem>
    </itemizedlist>
   </step>
   <step>
    <para>
     使用 YaST 或 Zypper 来安装软件包更新。
    </para>
   </step>
   <step>
    <para>
     在成功安装更新后：
    </para>
    <itemizedlist>
     <listitem>
      <para>
       启动相应节点上的群集堆栈（如果在执行<xref linkend="step-update-check"/> 时已将它停止）：
      </para>
<screen><prompt role="root">root # </prompt><command>crm</command> cluster start</screen>
     </listitem>
     <listitem>
      <para>
       或者去除维护标志，使节点恢复正常模式：
      </para>
<screen><prompt role="root">root # </prompt><command>crm</command> node ready <replaceable>NODE_NAME</replaceable></screen>
     </listitem>
    </itemizedlist>
   </step>
   <step>
    <para>
     使用 <command>crm status</command> 或 Hawk2 检查群集状态。
    </para>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="sec-ha-migration-more">
  <title>更多信息</title>

  <para>
   有关您要升级到的产品的任何更改和新功能的详细信息，请参见其发行说明，所在网址为 <link xlink:href="https://www.suse.com/releasenotes/"/>。
  </para>
 </sect1>
</chapter>
