<?xml version="1.0" encoding="UTF-8"?>
<sect1 xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="ha_hawk2_history_i.xml" version="5.0" xml:id="sec-conf-hawk2-history">
 <title>查看群集历史记录</title>

 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:maintainer/>
   <dm:status>editing</dm:status>
   <dm:deadline/>
   <dm:priority/>
   <dm:translation>yes</dm:translation>
   <dm:languages/>
   <dm:release/>
   <dm:repository/>
  </dm:docmanager>
 </info>

 <para>
  Hawk2 提供了以下用于查看群集上的过去事件（按不同级别和不同详细程度）的功能：
 </para>

 <itemizedlist>
  <listitem>
   <para>
    <xref linkend="sec-conf-hawk2-history-recent"/>
   </para>
  </listitem>
  <listitem>
   <para>
    <xref linkend="sec-conf-hawk2-history-explorer"/>
   </para>
  </listitem>
  <listitem>
   <para>
    <xref linkend="sec-conf-hawk2-history-transitions"/>
   </para>
  </listitem>
 </itemizedlist>

 <para>
  您也可以使用 crmsh 查看群集历史记录信息：
 </para>
 <itemizedlist>
  <listitem>
   <para>
    <xref linkend="sec-ha-config-crm-history"/>
   </para>
  </listitem>
 </itemizedlist>

 <sect2 xml:id="sec-conf-hawk2-history-recent">
  <title>查看节点或资源的最近事件</title>
  <procedure>
   <step>
    <para>
     登录 Hawk2：
    </para>
<screen>https://<replaceable>HAWKSERVER</replaceable>:7630/</screen>
   </step>
   <step>
    <para>
     从左侧导航栏中，选择<menuchoice><guimenu>监视</guimenu>
     <guimenu>状态</guimenu></menuchoice>。它会列出<guimenu>资源</guimenu>和<guimenu>节点</guimenu>。
    </para>
   </step>
   <step>
    <para>
     要查看资源的最近事件：
    </para>
    <substeps>
     <step>
      <para>
       单击<guimenu>资源</guimenu>并选择相应的资源。
      </para>
     </step>
     <step>
      <para>
       在资源的<guimenu>操作</guimenu>列中，单击向下箭头按钮并选择<guimenu>最近的事件</guimenu>。
      </para>
      <para>
       Hawk2 会打开一个新窗口，显示最近事件的表视图。
      </para>
     </step>
    </substeps>
   </step>
   <step>
    <para>
     要查看节点的最近事件：
    </para>
    <substeps>
     <step>
      <para>
       单击<guimenu>节点</guimenu>并选择相应的节点。
      </para>
     </step>
     <step>
      <para>
       在节点的<guimenu>操作</guimenu>列中，选择<guimenu>最近的事件</guimenu>。
      </para>
      <para>
       Hawk2 会打开一个新窗口，显示最近事件的表视图。
      </para>
      <figure>
       <title>“最近的事件”表</title>
       <mediaobject>
        <imageobject role="fo">
         <imagedata fileref="hawk2-node-events.png" width="100%"/>
        </imageobject>
        <imageobject role="html">
         <imagedata fileref="hawk2-node-events.png" width="90%"/>
        </imageobject>
        <textobject role="description">
          <phrase>显示节点 alice 上最近的资源操作的表。</phrase>
        </textobject>
       </mediaobject>
      </figure>
     </step>
    </substeps>
   </step>
  </procedure>
 </sect2>

 <sect2 xml:id="sec-conf-hawk2-history-explorer">
  <title>使用历史记录浏览器生成群集报告</title>
  <para>
   从左侧导航栏中，选择<menuchoice><guimenu>查错</guimenu>
   <guimenu>历史记录</guimenu></menuchoice>，以访问<guimenu>历史记录浏览器</guimenu>。<guimenu>历史记录浏览器</guimenu>可让您创建详细的群集报告并查看转换信息。它提供以下选项：
  </para>
  <variablelist>
   <varlistentry>
    <term><guimenu>生成</guimenu>
    </term>
    <listitem>
     <para>
      创建特定时间内的群集报告。Hawk2 会调用 <command>crm report</command> 命令来生成报告。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><guimenu>上载</guimenu>
    </term>
    <listitem>
     <para>
      允许您上载直接使用 crm 外壳创建的或位于不同群集上的 <literal>crm report</literal> 存档。
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
  <para>
   生成或上载报告后，它们会显示在<guimenu>报告</guimenu>下方。在报告列表中，您可以显示报告的细节，或者下载或删除报告。
  </para>
  <figure>
   <title>Hawk2 - 历史记录浏览器主视图</title>
   <mediaobject>
    <imageobject role="fo">
     <imagedata fileref="hawk2-history-explorer-main.png" width="100%"/>
    </imageobject>
    <imageobject role="html">
     <imagedata fileref="hawk2-history-explorer-main.png" width="90%"/>
    </imageobject>
   </mediaobject>
  </figure>
  <procedure xml:id="pro-hawk2-history-report">
   <title>生成或上载群集报告</title>
   <step>
    <para>
     登录 Hawk2：
    </para>
<screen>https://<replaceable>HAWKSERVER</replaceable>:7630/</screen>
   </step>
   <step>
    <para>
     从左侧导航栏中，选择<menuchoice><guimenu>查错</guimenu>
     <guimenu>历史记录</guimenu></menuchoice>。
    </para>
    <para>
     <guimenu>历史记录浏览器</guimenu>屏幕会在<guimenu>生成</guimenu>视图中打开。默认情况下，报告的建议时间段为过去 1 小时。
    </para>
   </step>
   <step>
    <para>
     要创建群集报告：
    </para>
    <substeps>
     <step>
      <para>
       要立即启动报告，请单击<guimenu>生成</guimenu>。
      </para>
     </step>
     <step>
      <para>
       要修改报告的时间段，请单击建议时间段的任意位置并从下拉框中选择另一个选项。您还可以分别输入<guimenu>自定义</guimenu>的开始日期、结束日期及小时。要启动报告，请单击<guimenu>生成</guimenu>。
      </para>
      <para>
       报告生成后会显示在<guimenu>报告</guimenu>下方。
      </para>
     </step>
    </substeps>
   </step>
   <step>
    <para>
     要上载群集报告，<command>crm report</command> 存档必须位于您可通过 Hawk2 访问的文件系统中。按如下所示继续：
    </para>
    <substeps>
     <step>
      <para>
       切换到<guimenu>上载</guimenu>选项卡。
      </para>
     </step>
     <step>
      <para>
       <guimenu>浏览</guimenu>群集报告存档并单击<guimenu>上载</guimenu>。
      </para>
      <para>
       报告上载后会显示在<guimenu>报告</guimenu>下方。
      </para>
     </step>
    </substeps>
   </step>
   <step>
    <para>
     要下载或删除报告，请在<guimenu>操作</guimenu>列中单击报告旁边的相应图标。
    </para>
   </step>
   <step>
    <para>
     要查看<xref linkend="il-hawk2-history-report-details" xrefstyle="select:title"/>，请单击报告的名称，或从<guimenu>操作</guimenu>列中选择<guimenu>显示</guimenu>。
    </para>
    <figure>
     <title>Hawk2 报告细节</title>
     <mediaobject>
      <imageobject role="fo">
       <imagedata fileref="hawk2-history-report-details.png" width="100%"/>
      </imageobject>
      <imageobject role="html">
       <imagedata fileref="hawk2-history-report-details.png" width="90%"/>
      </imageobject>
      <textobject role="description">
        <phrase>报告细节，包括名称、时间范围、节点事件和资源事件。</phrase>
      </textobject>
     </mediaobject>
    </figure>
   </step>
   <step>
    <para>
     单击<guimenu>报告</guimenu>按钮返回到报告列表。
    </para>
   </step>
  </procedure>
  <itemizedlist xml:id="il-hawk2-history-report-details">
   <title>历史记录浏览器中的报告细节</title>
   <listitem>
    <para>
     报告的名称。
    </para>
   </listitem>
   <listitem>
    <para>
     报告的开始时间。
    </para>
   </listitem>
   <listitem>
    <para>
     报告的结束时间。
    </para>
   </listitem>
   <listitem>
    <para>
     报告所涵盖的群集中的转换次数以及所有转换的时间表。要了解如何查看转换的更多细节，请参见<xref linkend="sec-conf-hawk2-history-transitions" xrefstyle="select:label"/>。
    </para>
   </listitem>
   <listitem>
    <para>
     节点事件。
    </para>
   </listitem>
   <listitem>
    <para>
     资源事件。
    </para>
   </listitem>
  </itemizedlist>
 </sect2>

 <sect2 xml:id="sec-conf-hawk2-history-transitions">
  <title>在历史记录浏览器中查看转换细节</title>
  <para>
   对于每个转换，群集都会保存其所提供的状态副本，作为对 <systemitem class="daemon">pacemaker-schedulerd</systemitem> 的输入。会记录此存档的路径。所有 <filename>pe-*</filename> 文件都在指定协调器 (DC) 上生成。由于群集中的 DC 可能会更换，因此可能存在来自多个节点的 <filename>pe-*</filename> 文件。所有 <filename>pe-*</filename> 文件都是保存的 CIB 快照，<systemitem class="daemon">pacemaker-schedulerd</systemitem> 在执行计算时会将其用作输入。
  </para>
  <para>
   在 Hawk2 中，您可以显示每个 <filename>pe-*</filename> 文件的名称、创建时间以及文件是在哪个节点上创建的。<guimenu>历史记录浏览器</guimenu>可以根据相应的 <filename>pe-*</filename> 文件直观显示以下细节：
  </para>
  <variablelist xml:id="vl-hawk2-history-transition-details">
   <title>历史记录浏览器中的转换细节</title>
   <varlistentry>
    <term><guimenu>细节</guimenu>
    </term>
    <listitem>
     <para>
      显示属于转换的日志记录数据片段。显示以下命令的输出（包括资源代理的日志消息）：
     </para>
<screen>crm history transition <replaceable>peinput</replaceable></screen>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><guimenu>配置</guimenu>
    </term>
    <listitem>
     <para>
      显示创建 <filename>pe-*</filename> 文件时的群集配置。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><guimenu>差别</guimenu>
    </term>
    <listitem>
     <para>
      显示选定 <filename>pe-*</filename> 文件与下一个文件之间的配置和状态差异。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><guimenu>登录</guimenu>
    </term>
    <listitem>
     <para>
      显示属于转换的日志记录数据片段。显示以下命令的输出：
     </para>
<screen>crm history transition log <replaceable>peinput</replaceable></screen>
     <para>
      这包括来自以下守护程序的细节：<systemitem class="daemon">pacemaker-controld</systemitem>、<systemitem class="daemon">pacemaker-schedulerd</systemitem> 和 <systemitem class="daemon">pacemaker-execd</systemitem>。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><guimenu>图形</guimenu>
    </term>
    <listitem>
     <para>
      显示转换的图形表示形式。如果您单击<guimenu>图表</guimenu>，系统会模拟该计算（与 <systemitem class="daemon">pacemaker-schedulerd</systemitem> 执行的计算完全一样），并生成直观的图表。
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
  <procedure xml:id="pro-hawk2-history-transitions">
   <title>查看转换细节</title>
   <step>
    <para>
     登录 Hawk2：
    </para>
<screen>https://<replaceable>HAWKSERVER</replaceable>:7630/</screen>
   </step>
   <step>
    <para>
     从左侧导航栏中，选择<menuchoice><guimenu>查错</guimenu>
     <guimenu>历史记录</guimenu></menuchoice>。
    </para>
    <para>
     如果报告已生成或上载，它们会显示在<guimenu>报告</guimenu>列表中。否则，请按<xref linkend="pro-hawk2-history-report" xrefstyle="select:label"/> 中所述生成或上载报告。
    </para>
   </step>
   <step>
    <para>
     单击报告的名称或从<guimenu>操作</guimenu>列中选择<guimenu>显示</guimenu>以打开<xref linkend="il-hawk2-history-report-details"/>。
    </para>
   </step>
   <step>
    <para>
     要访问转换细节，您需要在下面显示的转换时间表中选择一个转换点。使用<guimenu>上一个</guimenu>和<guimenu>下一个</guimenu>以及<guimenu>放大</guimenu>和<guimenu>缩小</guimenu>图标查找您感兴趣的转换。
    </para>
   </step>
   <step>
    <para>
     要显示 <filename>pe-input*</filename> 文件的名称、创建时间以及文件是在哪个节点上创建的，请将鼠标指针悬停在时间线的转换点上。
    </para>
   </step>
   <step>
    <para>
     要查看<xref linkend="vl-hawk2-history-transition-details"/>，请单击要了解其详细信息的转换点。
    </para>
   </step>
   <step>
    <para>
     要显示<guimenu>细节</guimenu>、<guimenu>配置</guimenu>、<guimenu>差异</guimenu>、<guimenu>日志</guimenu>或<guimenu>示意图</guimenu>，请单击相应的按钮以显示<xref linkend="vl-hawk2-history-transition-details"/>中所述的内容。
    </para>
   </step>
   <step>
    <para>
     要返回报告列表，请单击<guimenu>报告</guimenu>按钮。
    </para>
   </step>
  </procedure>
 </sect2>

 <sect2 xml:id="sec-ha-config-crm-history">
  <title>使用 crmsh 检索历史记录信息</title>
  <para>
   调查群集的历史记录是一项复杂的任务。为简化此任务，crmsh 包含了 <command>history</command> 命令及其子命令。假定已正确配置 SSH。
  </para>
  <para>
   每个群集都会移动状态、迁移资源或启动重要进程。这些操作均可通过 <command>history</command> 子命令进行检索。
  </para>
  <para>
   默认情况下，所有 <command>history</command> 命令会查看最近一小时的事件。要更改此时间段，请使用 <command>limit</command> 子命令。语法是：
  </para>
<screen><prompt role="root"># </prompt><command>crm history</command>
<prompt role="custom">crm(live)history# </prompt><command>limit <replaceable>FROM_TIME</replaceable> [<replaceable>TO_TIME</replaceable>]</command></screen>
  <para>
   有效示例如下所示：
  </para>
  <variablelist>
   <varlistentry>
    <term><command>limit 4:00pm</command>
    </term>
    <term><command>limit 16:00</command>
    </term>
    <listitem>
     <para>
      上述两个命令表达同一个意思：今天下午 4 点。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><command>limit 2012/01/12 6pm</command>
    </term>
    <listitem>
     <para>
      2012 年 1 月 12 日下午 6 点
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><command>limit "Sun 5 20:46"</command>
    </term>
    <listitem>
     <para>
      当年当月 5 日（星期日）晚上 8:46
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
  <para>
   要查找更多示例以及如何创建时间段的信息，请访问 <link xlink:href="https://labix.org/python-dateutil"/>。
  </para>
  <para>
   <command>info</command> 子命令可显示 <command>crm report</command> 涉及的所有参数：
  </para>
<screen><prompt role="custom">crm(live)history# </prompt><command>info</command>
Source: live
Period: 2012-01-12 14:10:56 - end
Nodes: alice
Groups:
Resources:</screen>
  <para>
   要想只对 <command>crm report</command> 使用特定参数，请通过 <command>help</command> 子命令查看可用的选项。
  </para>
  <para>
   要降低细节级别，请使用 <command>detail</command> 子命令及级别：
  </para>
<screen><prompt role="custom">crm(live)history# </prompt><command>detail 1</command></screen>
  <para>
   级别数字越高，报告就越详细。默认值为 <literal>0</literal>（零）。
  </para>
  <para>
   设置上述参数后，使用 <command>log</command> 显示日志消息。
  </para>
  <para>
   要显示上次转换操作，请使用以下命令：
  </para>
<screen><prompt role="custom">crm(live)history# </prompt><command>transition -1</command>
INFO: fetching new logs, please wait ...</screen>
  <para>
   此命令会获取日志并运行 <command>dotty</command> （来自 <package>graphviz</package> 软件包）以显示转换图。外壳会打开日志文件，您在其中可以使用 <keycap function="down"/> 和 <keycap function="up"/> 光标键浏览内容。
  </para>
  <para>
   如果希望不要打开转换图，请使用 <option>nograph</option> 选项：
  </para>
<screen><prompt role="custom">crm(live)history# </prompt><command>transition -1 nograph</command></screen>
 </sect2>
</sect1>
