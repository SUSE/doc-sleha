<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="geo_ip_i.xml" version="5.0" xml:id="cha-ha-geo-ip-relocation">

 <title>通过 DNS 更新设置 IP 转移</title>
 <info xmlns:d="http://docbook.org/ns/docbook">
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
  <dm:translation>yes</dm:translation>
  </dm:docmanager>
 <revhistory xml:id="rh-cha-ha-geo-ip-relocation">
   <revision>
     <date>2025-02-12</date>
     <revdescription>
       <para/>
     </revdescription>
   </revision>
 </revhistory>
</info>
 <para>
  如果 Geo 群集的一个站点关闭并且发生了票据故障转移，您通常需要相应地调整网络路由（或者需要事先为每个票据配置网络故障转移）。根据绑定到票据的服务类型，可以使用一种备选的解决方案来重配置路由：使用动态 DNS 更新并更改服务的 IP 地址。
 </para>
 <para>
  此方案必须满足以下先决条件：
 </para>
 <itemizedlist>
  <listitem>
   <para>
    需要故障转移的服务已绑定到某个主机名。
   </para>
  </listitem>
  <listitem>
   <para>
    DNS 服务器必须针对动态 DNS 更新进行了配置。有关如何使用 BIND/named 执行此操作的信息，请参见 <literal>named</literal> 文档或访问 <link xlink:href="https://www.semicomplete.com/articles/dynamic-dns-with-dhcp/"></link>。有关如何设置 DNS（包括区域数据动态更新）的详细信息，请参见<link xlink:href="https://documentation.suse.com/sles-15/html/SLES-all/cha-dns.html">《SUSE Linux Enterprise Server 15 SP7 管理指南》</link>。
   </para>
  </listitem>
  <listitem>
   <para>
    以下示例假设 DNS 更新受到要更新的区域的共享密钥（TSIG 密钥）保护。可以使用 <command>dnssec-keygen</command> 创建该密钥：
   </para>
<screen><prompt role="root"># </prompt><command>dnssec-keygen -a hmac-md5 -b 128 -n USER geo-update</command></screen>
   <para>
    有关详细信息，请参见 <command>dnssec-keygen</command> 手册页或<link xlink:href="https://documentation.suse.com/sles-15/html/SLES-all/cha-dns.html#sec-dns-tsig">《SUSE Linux Enterprise Server 15 SP7 管理指南》</link>。
   </para>
  </listitem>
 </itemizedlist>
 <para>
  <xref linkend="ex-ha-geo-dyn-dns-rsc-config"/>演示了如何使用 <systemitem>ocf:heartbeat:dnsupdate</systemitem> 资源代理来管理 <command>nsupdate</command> 命令。<remark>taroth 2014-11-21: lmb, is the following correct? it
   is mentioned in the description of fate#316112, however, your example in c#9 mentions focuses on
   IPv4 only...</remark>该资源代理支持 IPv4 和 IPv6。
 </para>
 <example xml:id="ex-ha-geo-dyn-dns-rsc-config">
  <title>动态 DNS 更新的资源配置</title>
<screen><prompt role="custom">crm(live)configure# </prompt><command>primitive dns-update-ip ocf:heartbeat:dnsupdate params \
  hostname="www.domain.com" \</command><co xml:id="co-dyn-dns-hostname"/>
  <command>ip="192.168.3.4" \</command><co xml:id="co-dyn-dns-ip"/>
  <command>keyfile="<replaceable>/etc/whereever/Kgeo-update*</replaceable>.key" \</command><co xml:id="co-dyn-dns-key"/>
  <command>server="192.168.1.1" \</command><co xml:id="co-dyn-dns-srv"/>
  <command>serverport="53" \</command><co xml:id="co-dyn-dns-srv-port"/>
  <command>op monitor timeout=30s interval=10s</command></screen>
  <calloutlist>
   <callout arearefs="co-dyn-dns-hostname">
    <para>
     与需要连同票据一起故障转移的服务绑定的主机名。需要通过动态 DNS 更新此主机名的 IP 地址。
    </para>
   </callout>
   <callout arearefs="co-dyn-dns-ip">
    <para>
     托管要迁移的服务的服务器的 IP 地址。<remark>taroth 2014-11-21:
     lmb, this description taken from fate c#9 is IMHO a bit misleading as it seems to imply that
     this param is about the *current* IP address. However, from the description in
     /usr/lib/ocf/resource.d/heartbeat/dnsupdate, I think this needs to be the IP address that
     will be used for the hostname *after* failover - is that correct?</remark>此处指定的 IP 地址也可以受群集控制。这不会处理本地故障转移，但可以确保在票据故障转移后，外部各方将会定向到正确的站点。
    </para>
   </callout>
   <callout arearefs="co-dyn-dns-key">
    <para>
     使用 <command>dnssec-keygen</command> 生成的公共密钥文件的路径。
    </para>
   </callout>
   <callout arearefs="co-dyn-dns-srv">
    <para>
     要将更新发送到的 DNS 服务器的 IP 地址。如果未提供服务器，则默认为正确区域的主服务器。
    </para>
   </callout>
   <callout arearefs="co-dyn-dns-srv-port">
    <para>
     与 DNS 服务器通讯时使用的端口。仅当指定了 DNS 服务器时，此选项才生效。
    </para>
   </callout>
  </calloutlist>
  <para>
   在使用上述资源配置的情况下，资源代理将负责从 DNS 记录中去除发生故障的地域群集站点，并通过动态 DNS 更新来更改服务的 IP。
  </para>
 </example>
</chapter>
