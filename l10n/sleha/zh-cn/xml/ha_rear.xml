<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="ha_rear.xml" version="5.0" xml:id="cha-ha-rear">
 <title>使用 ReaR (Relax-and-Recover) 实现灾难恢复</title>
 <info>
      <abstract>
        <para>
    Relax-and-Recover (<quote>ReaR</quote>) 是供系统管理员使用的灾难恢复框架。它是一个 Bash 脚本集合，您需要根据要在发生灾难时加以保护的特定生产环境调整这些脚本。
   </para>
        <para>
    没有任何灾难恢复解决方案能够现成地解决问题。因此，必须在灾难发生<emphasis>之前</emphasis>做好准备措施。
   </para>
      </abstract>
      <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
        <dm:maintainer/>
        <dm:status>editing</dm:status>
        <dm:deadline/>
        <dm:priority/>
        <dm:translation>yes</dm:translation>
        <dm:languages/>
        <dm:release/>
        <dm:repository/>
      </dm:docmanager>
    </info>
    <sect1 xml:id="sec-ha-rear-concept">
  <title>概念概述</title>



  <para>
   以下几节介绍了灾难恢复的总体概念，以及使用 ReaR 成功实现灾难恢复所需执行的基本步骤。另外还提供了有关 ReaR 要求、要注意的一些限制、各种方案和备份工具的指南。
  </para>

  <sect2 xml:id="sec-ha-rear-concept-drp">
   <title>创建灾难恢复计划</title>
   <para>
    在最坏的情况发生<emphasis>之前</emphasis>采取措施：分析 IT 基础架构是否存在任何重大风险，评估您的预算，并制定灾难恢复计划。如果您还没有现行的灾难恢复计划，请先了解有关以下每个步骤的信息：
   </para>
   <itemizedlist>
    <listitem>
     <formalpara>
      <title>风险分析</title>
      <para>
       对基础设施进行可靠的风险分析。列出所有可能的威胁并评估它们的严重性。确定这些威胁的相似程度并划分优先级。建议使用简单的分类：可能性和影响。
      </para>
     </formalpara>
    </listitem>
    <listitem>
     <formalpara>
      <title>预算计划</title>
      <para>
       分析结果是一个概述，指出哪些风险可以忍受，哪些风险对业务非常关键。问问自己，怎样才能将风险将至最低，而这需要付出多大的代价。根据公司的规模，在灾难恢复方面的花费占总体 IT 预算的 2% 到 15%。
      </para>
     </formalpara>
    </listitem>
    <listitem>
     <formalpara>
      <title>制定灾难恢复计划</title>
      <para>
       制作核对清单、测试过程、建立并指派优先级以及列出 IT 基础设施库存。定义当基础设施中的一些服务失败时，如何处理问题。
      </para>
     </formalpara>
    </listitem>
    <listitem>
     <formalpara>
      <title>测试</title>
      <para>
       定义详细的计划后，测试该计划。每年至少测试一次。使用与主要 IT 基础设施相同的测试硬件。
      </para>
     </formalpara>
    </listitem>
   </itemizedlist>
  </sect2>

  <sect2 xml:id="sec-ha-rear-concept-recovery">
   <title>灾难恢复意味着什么？</title>
   <para>
    如果生产环境中的某个系统已毁坏（可能出于任何原因 - 例如，硬件损坏、配置不当或软件问题），您需要重创建该系统。可以在相同的硬件或者兼容的替代硬件上重创建。重创建系统并不只是意味着从备份中恢复文件，还包括准备系统的存储空间（与分区、文件系统和安装点相关），以及重新安装引导加载程序。
   </para>
  </sect2>

  <sect2 xml:id="sec-ha-rear-concept-basics">
   <title>灾难恢复如何与 ReaR 配合工作？</title>
   <para>
    在系统正常运行期间，创建文件的备份并在恢复媒体上创建恢复系统。该恢复系统包含一个恢复安装程序。
   </para>
   <para>
    如果系统已损坏，您可以更换受损的硬件（如果需要），从恢复媒体引导恢复系统，然后起动恢复安装程序。恢复安装程序会重新创建系统：首先，它会准备存储设备（分区、文件系统、挂载点），然后会从备份恢复文件。最后，它会重新安装引导加载程序。
   </para>
  </sect2>

  <sect2 xml:id="sec-ha-rear-concept-requirements">
   <title>ReaR 要求</title>
   <para>
    要使用 ReaR，您至少需要两个相同的系统：用来运行生产环境的计算机，以及相同的测试计算机。举例来说，这里所说的<quote>相同</quote>是指您可以将一个网卡替换为使用相同内核驱动程序的另一个网卡。
   </para>
   <warning>
    <title>需要相同的驱动程序</title>
    <para>
     如果某个硬件组件使用的驱动程序与生产环境中所用的驱动程序不同，ReaR 不会将该组件视为相同。
    </para>
   </warning>
  </sect2>


  <sect2 xml:id="sec-ha-rear-concept-versions">
   <title>ReaR 版本更新</title>

   <para>
    要查看适用于 SUSE Linux Enterprise High Availability 15 SP7 的 ReaR 版本，请运行以下命令：
   </para>
<screen><prompt role="root"># </prompt><command>zypper search --type package --verbose rear</command></screen>

   <note>
    <title>在更改日志中查找重要信息</title>
    <para>
     有关 Bug 修复、不兼容性及其他问题的任何信息都可在包的更改日志中找到。如果需要重新验证灾难恢复过程，建议您另外也要审阅 ReaR 的较新软件包版本。
    </para>
   </note>

   <para>
     您需要了解 ReaR 的以下问题：
   </para>

    <itemizedlist>
     <listitem>
     <para>
      您需要安装可提供辅助工具 <filename>/usr/bin/xorrisofs</filename> 的 <package>xorriso</package> 软件包，才能在 UEFI 系统上实现灾难恢复。此辅助工具用于创建 UEFI 可引导 ReaR 恢复系统 ISO 映像。
     </para>
     </listitem>
     <listitem>
     <para>
      如果您使用某个 ReaR 版本实现的灾难恢复过程已通过测试并且功能完好，请不要更新 ReaR。请保留该 ReaR 软件包，并且不要更改您的灾难恢复方法。
     </para>
     </listitem>
     <listitem>
     <para>
      ReaR 的版本更新是以独立软件包的形式提供的，这些软件包在设计上有意彼此冲突，目的是防止所安装的版本意外地被另一个版本替换。
     </para>
     </listitem>
    </itemizedlist>

   <para>
    在以下情况下，您需要重新验证现有的灾难恢复过程：
   </para>

   <itemizedlist>
    <listitem>
     <para>
      针对每个 ReaR 版本更新。
     </para>
    </listitem>
    <listitem>
     <para>手动更新 ReaR 时。</para>
    </listitem>
    <listitem>
     <para>
      针对 ReaR 使用的每个软件。
     </para>
    </listitem>
    <listitem>
     <para>
      如果更新了底层系统组件（例如 <command>btrfs</command>、<command>parted</command> 及类似组件）。
     </para>
    </listitem>
   </itemizedlist>
  </sect2>

  <sect2 xml:id="sec-ha-rear-concept-limit">
   <title>针对 Btrfs 的限制</title>
   <para>
    如果您使用 Btrfs，请注意以下限制。
   </para>
   <variablelist>
    <varlistentry>
     <term>您的系统包括子卷，但不包括快照子卷</term>
     <listitem>
      <para>
       至少需要 ReaR 版本 1.17.2.a。此版本支持重新创建<quote>正常</quote>Btrfs 子卷结构（不包括快照子卷）。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>您的系统包括快照子卷</term>
     <listitem>
      <warning>
       <para>
        <emphasis>无法</emphasis>照常使用基于文件的备份软件来备份和恢复 Btrfs 快照子卷。
       </para>
      </warning>
      <para>
       尽管 Btrfs 文件系统上的最新快照子卷几乎不占用任何磁盘空间（因为 Btrfs 具有写入时复制功能），但在使用基于文件的备份软件时，这些文件将作为完整文件进行备份。在备份中，这些文件的大小是其原始文件大小的两倍。因此，也就无法将快照恢复到它们以前在原始系统上的状态。
      </para>


     </listitem>
    </varlistentry>
    <varlistentry>
     <term>您的 SLE 系统需要匹配的 ReaR 配置</term>
     <listitem>
      <remark>toms 2018-04-18: See https://github.com/rear/rear/issues/1368#issuecomment-302410707</remark>
      <para>
       例如，SLE12 GA、SLE12 SP1 和 SLE12 SP2 中的设置具有数个不兼容的 Btrfs 默认结构。因此，使用匹配的 ReaR 配置文件至关重要。请参见示例文件 <filename>/usr/share/rear/conf/examples/SLE12*-btrfs-example.conf</filename>。<remark>toms 2018-04-18: https://github.com/rear/rear/issues/1368#issuecomment-302410707</remark>
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
  </sect2>

  <sect2 xml:id="sec-ha-rear-concept-scenarios">
   <title>方案和备份工具</title>
   <para>
    ReaR 能够创建可从本地媒体（例如硬盘、闪存盘、DVD/CD-R）或通过 PXE 引导的灾难恢复系统（包括系统特定的恢复安装程序）。可以将备份数据存储在网络文件系统（如 NFS）中，如<xref linkend="ex-ha-rear-nfs-server-backup" xrefstyle="select:label"/> 中所述。
   </para>
   <para>
    ReaR 不会替换文件备份，而是对它进行补充。默认情况下，ReaR 支持常规 <command>tar</command> 命令和若干第三方备份工具（例如 Tivoli Storage Manager、QNetix Galaxy、Symantec NetBackup、EMC NetWorker 或 HP DataProtector）。有关将 ReaR 与用作备份工具的 EMC NetWorker 配合使用的示例配置，请参见<xref linkend="ex-ha-rear-config-EMC" xrefstyle="select:label"/>。
   </para>
  </sect2>

  <sect2 xml:id="sec-ha-rear-concept-overview">
   <title>基本步骤</title>
   <para>
    要在发生灾难时使用 ReaR 成功进行恢复，需要执行以下基本步骤：
   </para>
   <variablelist>
    <varlistentry>

     <term><xref linkend="sec-ha-rear-config" xrefstyle="select:title"/>
     </term>
     <listitem>
      <para>
       这会涉及到一些任务，例如，编辑 ReaR 配置文件、调整 Bash 脚本，以及配置您要使用的备份解决方案。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>

     <term><xref linkend="sec-ha-rear-mkbackup" xrefstyle="select:title"/>
     </term>
     <listitem>
      <para>
       在要保护的系统处于正常运行状态时，创建文件备份，并生成包含适用于特定系统的 ReaR 恢复安装程序的恢复系统。
      </para>
      <para>
       若要使用 <command>tar</command> 进行基本备份，请使用 <command>rear mkbackup</command> 命令来创建备份和恢复系统。
      </para>
      <para>
       若要使用第三方备份工具，请使用 <command>rear mkrescue</command> 命令创建恢复系统，并使用第三方备份工具创建备份。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>

     <term><xref linkend="sec-ha-rear-testing" xrefstyle="select:title"/>
     </term>
     <listitem>
      <para>
       每次使用 ReaR 创建灾难恢复媒体时，都要全面测试灾难恢复过程。所用测试计算机上的硬件必须与生产环境中的硬件<emphasis>相同</emphasis>。有关细节，请参见 <xref linkend="sec-ha-rear-concept-requirements"/>。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>

     <term><xref linkend="sec-ha-rear-recover" xrefstyle="select:title"/>
     </term>
     <listitem>
      <para>
       灾难发生后，更换任何受损的硬件（如果需要）。然后，引导 ReaR 恢复系统，并使用 <command>rear recover</command> 命令启动恢复安装程序。
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
  </sect2>
 </sect1>
 <sect1 xml:id="sec-ha-rear-config">
  <title>设置 ReaR 和备份解决方案</title>
  <para>
   要安装最新版 ReaR，请运行以下命令：
  </para>
<screen><prompt role="root"># </prompt><command>zypper install rear</command></screen>
  <para>
    如果需要安装早期版本的 ReaR，您可以指定软件包版本。例如：
  </para>
<screen><prompt role="root"># </prompt><command>zypper install rear23a</command></screen>
  <para>
   要配置 ReaR，请在 ReaR 配置文件 <filename>/etc/rear/local.conf</filename> 中添加相应设置，此外可以根据需要编辑属于 ReaR 框架一部分的 Bash 脚本。具体而言，您需要定义 ReaR 应该执行的以下任务：
  </para>

  <itemizedlist>
   <listitem>
    <formalpara>
     <title>如何备份文件以及如何创建和存储灾难恢复系统</title>
     <para>
      这需要在 <filename>/etc/rear/local.conf</filename> 中配置。
     </para>
    </formalpara>
   </listitem>
   <listitem>
    <formalpara>
     <title>需要重新创建的对象（分区、文件系统、挂载点等）</title>
     <para>
      这可以在 <filename>/etc/rear/local.conf</filename> 中定义。要重创建非标准系统，您可能需要增强 Bash 脚本。
     </para>
    </formalpara>
   </listitem>
   <listitem>
    <formalpara>
     <title>恢复过程的工作方式</title>
     <para>
      要更改 ReaR 生成恢复安装程序的方式，或者要调整 ReaR 恢复安装程序执行的操作，您需要编辑 Bash 脚本。
     </para>
    </formalpara>
   </listitem>
  </itemizedlist>

  <para>
   所有 ReaR 配置变量及其默认值都在 <filename>/usr/share/rear/conf/default.conf</filename> 中进行了说明。
  </para>
  <para>
   以下是一些有用的配置选项示例。您还可以在 <filename>/usr/share/rear/conf/examples/</filename> 子目录中找到适合不同场景的示例文件。请参考它们来创建您的 <filename>/etc/rear/local.conf</filename> 文件。
  </para>

  <example xml:id="ex-ha-rear-nfs-server-backup">
   <title>使用 NFS 服务器存储文件备份</title>
  <orderedlist>
   <listitem>
    <para>
     按照<link xlink:href="https://documentation.suse.com/sles-15/html/SLES-all/cha-nfs.html">《SUSE Linux Enterprise Server 15 SP7 管理指南》</link>所述，使用 YaST 设置 NFS 服务器。
    </para>
   </listitem>
   <listitem>
    <para>
     在 <filename>/etc/exports</filename> 文件中定义 NFS 服务器的配置。确保 NFS 服务器上的目录具有正确的挂载选项。例如，您可能需要 <literal>no_root_squash</literal>，因为 <command>rear mkbackup</command> 命令以 <systemitem class="username">root</systemitem> 身份运行。有关详细信息，请参见 <command>man exports</command>。
    </para>
   </listitem>
   <listitem>
    <para>
     调整配置文件 <filename>/etc/rear/local.conf</filename> 中的各个 <varname>BACKUP</varname> 参数，让 ReaR 将文件备份存储在相应的 NFS 服务器上。已安装系统中的 <filename>/usr/share/rear/conf/examples/SLE*-example.conf</filename> 下提供了示例。
    </para>
   </listitem>
  </orderedlist>
  </example>

  <example xml:id="ex-ha-rear-config-sles-btrfs">
    <title>使用 <command>tar</command> 备份 Btrfs 子卷</title>
    <para>
     Btrfs 采用子卷架构，但 <command>tar</command> 使用 <option>--one-file-system</option> 选项创建备份时会排除子卷。因此，必须在 ReaR 配置中明确包含子卷的挂载点。
    </para>
    <para>
     将此配置代码段添加到 <filename>/etc/rear/local.conf</filename> 中，并根据您的设置进行调整。有关详细信息和其他选项，请参见示例文件 <filename>/usr/share/rear/conf/examples/SLE*-btrfs-example.conf</filename>。
    </para>
<screen>OUTPUT=ISO
BACKUP=NETFS
BACKUP_URL=nfs://<replaceable>host.example.com/path/to/rear/backup</replaceable>
BACKUP_PROG_INCLUDE=( /root /boot/grub2/i386-pc /tmp /opt /var /boot/grub2/x86_64-efi /srv /usr/local )</screen>
    <tip>
      <title><literal>BACKUP_PROG_INCLUDE</literal> 的挂载点</title>
      <para>
        您可以通过运行以下命令确定特定系统上子卷的挂载点：
      </para>
<screen><prompt role="root"># </prompt><command>findmnt -n -r -o TARGET -t btrfs | grep -v '^/$' | egrep -v 'snapshots|crash'</command></screen>
    </tip>
  </example>

  <example xml:id="ex-ha-rear-config-EMC">
   <title>使用 EMC NetWorker 等第三方备份工具</title>
   <para>
    要使用第三方备份工具代替 <command>tar</command>，您需要在 ReaR 配置文件中进行相应的设置。
   </para>
   <para>
    以下是 EMC NetWorker 的示例配置。将此配置代码段添加到 <filename>/etc/rear/local.conf</filename> 中，并根据您的设置进行调整：
   </para>
<screen>BACKUP=NSR
OUTPUT=ISO
BACKUP_URL=nfs://<replaceable>host.example.com/path/to/rear/backup</replaceable>
OUTPUT_URL=nfs://<replaceable>host.example.com/path/to/rear/backup</replaceable>
NSRSERVER=<replaceable>backupserver.example.com</replaceable>
RETENTION_TIME="Month"</screen>
   <para>
    有关支持的第三方备份工具的详细信息，请参见 <command>man rear</command> 的 <citetitle>BACKUP SOFTWARE INTEGRATION</citetitle> 部分。
   </para>
  </example>

  <example xml:id="ex-ha-rear-config-multipath">
    <title>备份多路径设备</title>
    <para>
     默认情况下，ReaR 会忽略多路径设备上的文件系统，因为它假定它们位于远程存储设备上，不是本地系统的一部分。您可以将以下代码添加到 <filename>/etc/rear/local.conf</filename> 中，让 ReaR 将这些文件系统纳入备份范围：
    </para>
    <screen>AUTOEXCLUDE_MULTIPATH=n</screen>
  </example>

  <example xml:id="ex-ha-rear-config-UEFI">
    <title>使用 UEFI 引导系统</title>
    <para>
      如果系统使用 UEFI 引导加载程序进行引导，则需要进行其他配置：
    </para>
    <orderedlist>
      <listitem>
        <para>
          安装软件包 <package>xorriso</package>:
        </para>
<screen><prompt role="root"># </prompt><command>zypper install xorriso</command></screen>
      </listitem>
      <listitem>
        <para>
          将以下代码添加到 <filename>/etc/rear/local.conf</filename> 中：
        </para>
<screen>ISO_MKISOFS_BIN="/usr/bin/xorrisofs"</screen>
      </listitem>
      <listitem>
        <para>
          如果您的系统使用 UEFI 安全引导功能引导，还必须添加下行内容：
        </para>
<screen>SECURE_BOOT_BOOTLOADER="/boot/efi/EFI/sles/shim.efi"</screen>
      </listitem>
    </orderedlist>
    <para>
     有关用于 UEFI 的 ReaR 配置变量的详细信息，请参见 <filename>/usr/share/rear/conf/default.conf</filename> 文件。
    </para>
  </example>
 </sect1>
 <sect1 xml:id="sec-ha-rear-mkbackup">
  <title>创建恢复安装系统</title>
  <para>
   按照<xref linkend="sec-ha-rear-config" xrefstyle="select:label"/>所述配置 ReaR 后，创建恢复安装系统（包括 ReaR 恢复安装程序）和文件备份。
  </para>
  <example xml:id="ex-ha-rear-mkbackup">
    <title>使用基本 <command>tar</command> 备份方法创建恢复系统</title>
    <para>
      运行 <command>rear mkbackup</command> 命令：
    </para>
<screen><prompt role="root"># </prompt><command>rear -d -D mkbackup</command></screen>
    <para>
     此命令会执行以下步骤：
    </para>
    <itemizedlist>
      <listitem>
        <para>
        分析目标系统并收集信息，尤其是有关磁盘布局（分区、文件系统、安装点）和引导加载程序的信息。
        </para>
      </listitem>
      <listitem>
        <para>
        使用第一步收集的信息创建一个可引导恢复系统。生成的 ReaR 恢复安装程序<emphasis>专用于</emphasis>在发生灾难时要保护的系统。使用该安装程序只能重创建这个特定的系统。
        </para>
      </listitem>
      <listitem>
        <para>
        调用内部备份工具备份系统文件和用户文件。
        </para>
      </listitem>
    </itemizedlist>
  </example>
  <example xml:id="ex-ha-rear-mkrescue">
    <title>使用第三方备份方法创建恢复系统</title>
    <orderedlist>
      <listitem>
        <para>
          运行 <command>rear mkrescue</command> 命令：
        </para>
<screen><prompt role="root"># </prompt><command>rear -d -D mkrescue</command></screen>
        <para>
          此命令会分析目标并创建恢复系统，但<emphasis>不会</emphasis>创建文件备份。
        </para>
      </listitem>
      <listitem>
        <para>
          使用第三方备份工具创建文件备份。
        </para>
      </listitem>
    </orderedlist>
  </example>
 </sect1>

 <sect1 xml:id="sec-ha-rear-testing">
  <title>测试恢复过程</title>

  <para>
   创建恢复系统之后，在具有相同硬件的测试计算机上测试恢复过程。另请参见 <xref linkend="sec-ha-rear-concept-requirements"/>。确保测试计算机已正确设置，并可替代主计算机。
  </para>

  <warning>
   <title>使用相同硬件执行全面测试</title>
   <para>
    必须在计算机上全面测试灾难恢复过程。请定期测试恢复过程，确保一切按预期运行。
   </para>
  </warning>

  <procedure xml:id="pro-ha-rear-testing">
   <title>在测试计算机上执行灾难恢复</title>
   <step>
    <para>
     将您在<xref linkend="sec-ha-rear-mkbackup" xrefstyle="select:label"/>中创建的恢复系统刻录到 DVD 或 CD 中，以创建恢复媒体。或者，您可以通过 PXE 使用网络引导。
    </para>
   </step>
   <step>
    <para>
     从恢复媒体引导测试计算机。
    </para>
   </step>
   <step>
    <para>
     从菜单中选择<guimenu>恢复</guimenu>。
    </para>
   </step>
   <step>
    <para>
     以 <systemitem class="username">root</systemitem> 用户身份登录（无需口令）。
    </para>
   </step>
   <step>
    <para>
     输入以下命令启动恢复安装程序：
    </para>
<screen>rear -d -D recover</screen>
    <para>
     有关在此过程中 ReaR 所执行的步骤的细节，请参见<xref linkend="ol-ha-rear-recovers-steps"/>。
    </para>
   </step>
   <step>
    <para>
     恢复过程完成后，检查是否已成功重创建系统，并且该系统可在生产环境中替代原始系统运作。
    </para>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="sec-ha-rear-recover">
  <title>从灾难中恢复</title>

  <para>
   如果灾难已发生，请根据需要更换任何受损的硬件。然后按照<xref linkend="pro-ha-rear-testing" xrefstyle="select:label"/>所述，使用已修复的计算机（或使用已经过测试可替代原始系统运作的相同计算机）继续操作。
  </para>

  <para>
   <command>rear recover</command> 命令会执行以下步骤：
  </para>

  <orderedlist xml:id="ol-ha-rear-recovers-steps" spacing="normal">
   <title>恢复过程</title>
   <listitem>
    <para>
     恢复磁盘布局（分区、文件系统和安装点）。
    </para>
   </listitem>
   <listitem>
    <para>
     从备份中恢复系统和用户文件。
    </para>
   </listitem>
   <listitem>
    <para>
     恢复引导加载程序。
    </para>
   </listitem>
  </orderedlist>
 </sect1>
 <sect1 xml:id="sec-ha-rear-more">
  <title>更多信息</title>



  <itemizedlist>
   <listitem>
    <para>
     <link xlink:href="https://en.opensuse.org/SDB:Disaster_Recovery"></link>
    </para>
   </listitem>
   <listitem>
    <para>
     <command>rear</command> 手册页
    </para>
   </listitem>
   <listitem>
    <para>
     <filename>/usr/share/doc/packages/rear/</filename>
    </para>
   </listitem>
  </itemizedlist>
 </sect1>
</chapter>
