<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="ha_gfs2.xml" version="5.0" xml:id="cha-ha-gfs2">
 <title>GFS2</title>
 <info>
      <abstract>
        <para>
    全局文件系统 2 或称 GFS2 是适用于 Linux 计算机群集的共享磁盘文件系统。GFS2 允许所有节点直接同时访问同一个共享块储存。GFS2 不提供断开操作模式，也没有客户端角色或服务器角色。GFS2 群集中的所有节点以对等体的形式运行。GFS2 最多支持 32 个群集节点。在群集中使用 GFS2 需要通过硬件来访问共享储存，并需要通过一个锁管理器来控制对储存的访问。
   </para>
        <para>
    如果性能是其中一个主要要求，SUSE 建议为群集环境使用 OCFS2 而不要使用 GFS2。我们的测试表明，与采用此设置的 GFS2 相比，OCFS2 的表现更好。
   </para>
      </abstract>
      <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
        <dm:maintainer/>
        <dm:status>editing</dm:status>
        <dm:deadline/>
        <dm:priority/>
        <dm:translation>yes</dm:translation>
        <dm:languages/>
        <dm:release/>
        <dm:repository/>
      </dm:docmanager>
    </info>
    <sect1 xml:id="sec-ha-gfs2-utils">
  <title>GFS2 软件包和管理实用程序</title>

  <para>
   要使用 GFS2，请确保群集的每个节点上均已安装适用于您的内核的 <package>gfs2-utils</package> 和匹配的 <package>gfs2-kmp-*</package> 软件包。
  </para>

  <para>
   <package>gfs2-utils</package> 包提供以下实用程序，用于管理 GFS2 卷。有关语法信息，请参见其手册页。
  </para>

  <table>
   <title>GFS2 实用程序</title>
   <tgroup cols="2">
    <thead>
     <row>
      <entry>
       <para>
        GFS2 实用程序
       </para>
      </entry>
      <entry>
       <para>
        说明
       </para>
      </entry>
     </row>
    </thead>
    <tbody>
     <row>
      <entry>
       <para>
        fsck.gfs2
       </para>
      </entry>
      <entry>
       <para>
        检查文件系统的错误并进行选择性的修改。
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        gfs2_jadd
       </para>
      </entry>
      <entry>
       <para>
        将其他日志添加到 GFS2 文件系统。
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        gfs2_grow
       </para>
      </entry>
      <entry>
       <para>
        产生 GFS2 文件系统。
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        mkfs.gfs2
       </para>
      </entry>
      <entry>
       <para>
        在设备上创建 GFS2 文件系统，这通常是一个共享设备或分区。
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        tunegfs2
       </para>
      </entry>
      <entry>
       <para>
        可用于查看和操作 GFS2 文件系统参数（例如 <varname>UUID</varname>、<varname>label</varname>、<varname>lockproto</varname> 和 <varname>locktable</varname>）。
       </para>
      </entry>
     </row>
    </tbody>
   </tgroup>
  </table>
 </sect1>
 <sect1 xml:id="sec-ha-gfs2-create-service">
  <title>配置 GFS2 服务和 STONITH 资源</title>

  <para>
   在创建 GFS2 卷之前，必须先配置 DLM 和 STONITH 资源。
  </para>

  <procedure xml:id="pro-gfs2-stonith">
   <title>配置 STONITH 资源</title>
   <note>
    <title>需要 STONITH 设备</title>
    <para>
     您需要配置屏蔽设备。没有一个适当的 STONITH 机制（如 <literal>external/sbd</literal>），则配置会失败。
    </para>
   </note>
   <step>
    <para>
     启动壳层，并以 <systemitem class="username">root</systemitem> 用户身份或同等身份登录。
    </para>
   </step>
   <step>
    <para>
     如<xref linkend="pro-ha-storage-protect-sbd-create"/>中所述，创建 SBD 分区。
    </para>
   </step>
   <step>
    <para>
     运行 <command>crm</command> <option> configure</option>。
    </para>
   </step>
   <step>
    <para>
     将 <literal>external/sbd</literal> 配置为屏蔽设备，并将 <literal>/dev/sdb2</literal> 作为存储检测信号和屏蔽的共享储存上的专用分区：
    </para>
<screen><prompt role="custom">crm(live)configure# </prompt><command>primitive</command> sbd_stonith stonith:external/sbd \
    params pcmk_delay_max=30 meta target-role="Started"</screen>
   </step>
   <step>
    <para>
     使用 <command>show</command> 查看更改。
    </para>
   </step>
   <step>
    <para>
     如果所有设置均正确无误，请使用 <command>commit</command> 提交更改，然后使用 <command>quit</command> 离开 crm 在线配置。
    </para>
   </step>
  </procedure>

  <para>
    有关为 DLM 配置资源组的细节，请参见<xref linkend="pro-dlm-resources"/>。
  </para>
 </sect1>
 <sect1 xml:id="sec-ha-gfs2-create">
  <title>创建 GFS2 卷</title>

  <para>
   按<xref linkend="sec-ha-gfs2-create-service"/>中所述将 DLM 配置为群集资源后，将系统配置为使用 GFS2 并创建 GFS2 卷。
  </para>

  <note>
   <title>用于存储应用程序和数据文件的 GFS2 卷</title>
   <para>
    我们建议您通常应将应用程序文件和数据文件储存在不同的 GFS2 卷上。如果应用程序卷和数据卷具有不同的挂载要求，则必须将它们储存在不同的卷上。
   </para>
  </note>

  <para>
   开始之前要准备计划用于 GFS2 卷的块设备。将这些设备留作可用空间。
  </para>

  <para>
   然后，按<xref linkend="pro-gfs2-volume"/>中所述使用 <command>mkfs.gfs2</command> 创建并格式化 GFS2 卷。此命令最重要的参数列于<xref linkend="tab-ha-gfs2-mkfs-gfs2-params"/>中。有关更多信息和命令语法，请参见 <command>mkfs.gfs2</command> 手册页。
  </para>

  <table xml:id="tab-ha-gfs2-mkfs-gfs2-params">
   <title>重要的 GFS2 参数</title>
   <tgroup cols="2">
    <colspec colname="c1" colwidth="1*"/>
    <colspec colname="c2" colwidth="3*"/>
    <thead>
     <row>
      <entry>
       <para>
        GFS2 参数
       </para>
      </entry>
      <entry>
       <para>
        描述和建议
       </para>
      </entry>
     </row>
    </thead>
    <tbody>
     <row>
      <entry>
       <para>
        锁定协议名称 (<option>-p</option>)
       </para>
      </entry>
      <entry>
       <para>
        要使用的锁定协议的名称。可接受的锁定协议包括 lock_dlm（用于共享储存）；如果您将 GFS2 用作本地文件系统（只有 1 个节点），则可以指定 lock_nolock 协议。如果未指定此选项，假定采用 lock_dlm 协议。
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        锁定表名称 (<option>-t</option>)
       </para>
      </entry>
      <entry>
       <para>
        与您正在使用的锁定模块对应的锁定表字段。该字段的格式为 <replaceable>clustername</replaceable>:<replaceable>fsname</replaceable>。<replaceable>clustername</replaceable> 必须与群集配置文件 <filename>/etc/corosync/corosync.conf</filename> 中的条目匹配。只允许此群集的成员使用此文件系统。<replaceable>fsname</replaceable> 是唯一的文件系统名称（1 到 16 个字符），用于将此 GFS2 文件系统与创建的其他文件系统区分开来。
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        日志数量 (<option>-j</option>)
       </para>
      </entry>
      <entry>
       <para>
        要为 gfs2_mkfs 创建的日志数量。要挂载该文件系统的每台计算机至少需要一个日志。如果未指定此选项，将创建一个日志。
       </para>
      </entry>
     </row>
    </tbody>
   </tgroup>
  </table>

  <procedure xml:id="pro-gfs2-volume">
   <title>创建并格式化 GFS2 卷</title>
   <para>
    只在群集节点之<emphasis>一</emphasis>上执行以下步骤。
   </para>
   <step>
    <para>
     以 <systemitem class="username">root</systemitem> 用户身份打开终端窗口并登录。
    </para>
   </step>
   <step>
    <para>
     使用命令 <command>crm status</command> 检查群集是否联机。
    </para>
   </step>
   <step>
    <para>
     使用 <command>mkfs.gfs2</command> 实用程序创建并格式化卷。有关此命令的语法的信息，请参见 <command>mkfs.gfs2</command> 手册页。
    </para>
    <para>
     例如，要在 <filename>/dev/sdb1</filename> 上创建最多支持 32 个群集节点的新的 GFS2 文件系统，请使用以下命令：
    </para>
<screen><prompt role="root">root # </prompt>mkfs.gfs2 -t hacluster:mygfs2 -p lock_dlm -j 32 /dev/sdb1</screen>

    <para>
     <systemitem class="server">hacluster</systemitem> 名称与文件 <option>/etc/corosync/corosync.conf</option> 中的条目 <filename>cluster_name</filename> 相关（这是默认设置）。
    </para>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="sec-ha-gfs2-mount">
  <title>挂载 GFS2 卷</title>

  <para>
   可以手动挂载 GFS2 卷，也可以按<xref linkend="pro-gfs2-mount-cluster"/>中所述使用群集管理器挂载。
  </para>

  <procedure xml:id="pro-gfs2-mount-manual">
   <title>手动挂载 GFS2 卷</title>
   <step>
    <para>
     以 <systemitem class="username">root</systemitem> 用户身份打开终端窗口并登录。
    </para>
   </step>
   <step>
    <para>
     使用命令 <command>crm status</command> 检查群集是否联机。
    </para>
   </step>
   <step>
    <para>
     使用 <command>mount</command> 命令从命令行挂载卷。
    </para>
   </step>
  </procedure>

  <warning>
   <title>手动挂载的 GFS2 设备</title>
   <para>
    如果因方便测试而手动挂载了 GFS2 文件系统，在开始将其作为群集资源使用前，请务必再将其卸载。
   </para>
  </warning>

  <procedure xml:id="pro-gfs2-mount-cluster">
   <title>使用群集管理器挂载 GFS2 卷</title>
   <para>
    要使用高可用性软件挂载 GFS2 卷，请在群集中配置 OCF 文件系统资源。以下过程使用 <command>crm</command> 外壳配置群集资源。或者，您可以使用 Hawk2 配置资源。
   </para>
   <step>
    <para>
     启动壳层，并以 <systemitem class="username">root</systemitem> 用户身份或同等身份登录。
    </para>
   </step>
   <step>
    <para>
     运行 <command>crm</command> <option> configure</option>。
    </para>
   </step>
   <step>
    <para>
     配置 Pacemaker 以在群集中的每个节点上挂载 GFS2 文件系统：
    </para>
<screen><prompt role="custom">crm(live)configure# </prompt><command>primitive</command> gfs2-1 ocf:heartbeat:Filesystem \
  params device="/dev/sdb1" directory="/mnt/shared" fstype="gfs2" \
  op monitor interval="20" timeout="40" \
  op start timeout="60" op stop timeout="60" \
  meta target-role="Stopped"</screen>
   </step>
   <step>
    <para>
     创建一个基本组，该组包含您在<xref linkend="pro-dlm-resources"/>中创建的 <literal>dlm</literal> 基元以及 <literal>gfs2-1</literal> 基元。克隆组：
    </para>
<screen><prompt role="custom">crm(live)configure# </prompt><command>group</command> g-storage dlm  gfs2-1
     <command>clone</command> cl-storage g-storage \
     meta interleave="true"</screen>
    <para>
     由于基本组具有内部共置和顺序约束，Pacemaker 将仅在也已运行 <systemitem class="resource">gfs2-1</systemitem>dlm<literal> 资源的节点上启动 </literal> 资源。
    </para>
   </step>
   <step>
    <para>
     使用 <command>show</command> 查看更改。

    </para>
   </step>
   <step>
    <para>
     如果所有设置均正确无误，请使用 <command>commit</command> 提交更改，然后使用 <command>quit</command> 离开 crm 在线配置。
    </para>
   </step>
  </procedure>
 </sect1>
</chapter>
