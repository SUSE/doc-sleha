<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="ha_maintenance.xml" version="5.0" xml:id="cha-ha-maintenance">
 <title>执行维护任务</title>
 <info>
  <abstract>
   <para>
    要在群集节点上执行维护任务，可能需要停止该节点上运行的资源、移动这些资源，或者关闭或重引导该节点。此外，可能还需要暂时接管群集中资源的控制权，甚至需要在资源仍在运行时停止群集服务。
   </para>
   <para>
    本章介绍如何在不产生负面影响的情况下手动关闭群集节点。此外，本章将会概述群集堆栈提供的用于执行维护任务的不同选项。
   </para>
  </abstract>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:maintainer/>
   <dm:status>editing</dm:status>
   <dm:deadline/>
   <dm:priority/>
   <dm:translation>yes</dm:translation>
   <dm:languages/>
   <dm:release/>
   <dm:repository/>
  </dm:docmanager>
 </info>

 <sect1 xml:id="sec-ha-maint-outline">
  <title>准备和完成维护工作</title>
  <para>
   使用以下命令可启动、停止群集或查看群集状态：
  </para>
  <variablelist>
   <varlistentry>
    <term><command>crm cluster start [--all]</command></term>
    <listitem>
     <para>在一个或所有节点上启动群集服务</para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><command>crm cluster stop [--all]</command></term>
    <listitem>
     <para>在一个或所有节点上停止群集服务</para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><command>crm cluster restart [--all]</command></term>
    <listitem>
     <para>在一个或所有节点上重启动群集服务</para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><command>crm cluster status</command></term>
    <listitem>
     <para>查看群集堆栈的状态</para>
    </listitem>
   </varlistentry>
  </variablelist>
  <para>
   请以 <systemitem class="username">root</systemitem> 用户身份或拥有所需特权的用户身份执行上述命令。
  </para>
  <para>
   关闭或重引导某个群集节点（或停止节点上的群集服务）时，会触发以下过程：
  </para>
  <itemizedlist>
   <listitem>
    <para>
     该节点上运行的资源会停止，或被移出该节点。
    </para>
   </listitem>
   <listitem>
    <para>
     如果停止资源的操作失败或超时，STONITH 机制会屏蔽该节点并将其关闭。
    </para>
   </listitem>
  </itemizedlist>
  <warning>
   <title>数据丢失风险</title>
   <para>
    如果您需要执行测试或维护工作，请执行下面的一般步骤。
   </para>
   <para>
    如果不执行，有可能会产生意外的负面影响，例如，资源不按顺序启动、CIB 在群集节点之间不同步，甚至丢失数据。
   </para>
   <procedure>
   <step>
    <para>
     开始前，请选择<xref linkend="sec-ha-maint-overview"/>中所述的适当选项。
    </para>
   </step>
   <step>
    <para>
     请使用 Hawk2 或 crmsh 应用此选项。
    </para>
   </step>
   <step>
    <para>
     执行维护任务或测试。
    </para>
   </step>
   <step>
    <para>
     完成后，请将资源、节点或群集恢复<quote>正常</quote>工作状态。
    </para>
   </step>
  </procedure>
 </warning>
 </sect1>

 <sect1 xml:id="sec-ha-maint-overview">
  <title>用于维护任务的不同选项</title>

  <para>
   Pacemaker 提供了以下用于执行系统维护的选项：
  </para>

  <variablelist>
   <varlistentry xml:id="vle-ha-maint-mode-cluster">
    
    <term><xref linkend="sec-ha-maint-mode-cluster" xrefstyle="select:title"/></term>
    <listitem>
     <para>
      使用全局群集属性 <literal>maintenance-mode</literal> 可以一次性将所有资源置于维护状态。群集会停止监控这些资源，因而不知道它们的状态。<emphasis>只有</emphasis> Pacemaker 的资源管理功能会处于禁用状态。Corosync 和 SBD 仍会正常运行。请对涉及群集资源的所有任务都使用维护模式。对于涉及基础架构（例如存储或网络）的任何任务，最安全的方法是完全停止群集服务。请参见<xref linkend="vle-ha-maint-cluster-stop"/>。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry xml:id="vle-ha-maint-cluster-stop">
    
    <term><xref linkend="sec-ha-maint-cluster-stop" xrefstyle="select:title"/></term>
    <listitem>
     <para>
      一次性停止所有节点上的群集服务可以关闭群集，同时避免逐个关闭各个节点将会发生的大量资源迁移。由于不存在需要将资源迁移到的目标节点，因此所有资源都会停止。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry xml:id="vle-ha-maint-mode-node">
    
    <term><xref linkend="sec-ha-maint-mode-node" xrefstyle="select:title"/></term>
    <listitem>
     <para>
      此选项可以一次性将特定节点上运行的所有资源置于维护状态。群集会停止监控这些资源，因而不知道它们的状态。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry xml:id="vle-ha-maint-node-standby">
    
    <term><xref linkend="sec-ha-maint-node-standby" xrefstyle="select:title"/></term>
    <listitem>
     <para>
      处于待机模式的节点不再能够运行资源。该节点上运行的所有资源都会被移出或停止（如果没有其他节点可用于运行资源）。另外，该节点上的所有监控操作都会停止（设置了 <literal>role="Stopped"</literal> 的操作除外）。
     </para>
     <para>
      如果您需要停止群集中的某个节点，同时继续提供另一个节点上运行的服务，则可以使用此选项。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry xml:id="vle-ha-maint-shutdown-node">
    
    <term><xref linkend="sec-ha-maint-shutdown-node" xrefstyle="select:title"/></term>
    <listitem>
     <para>
      此选项可停止单个节点上的所有群集服务。该节点上运行的所有资源都会被移出或停止（如果没有其他节点可用于运行资源）。如果停止资源的操作失败或超时，将会屏蔽该节点。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry xml:id="vle-ha-maint-mode-rsc">
    
    <term><xref linkend="sec-ha-maint-mode-rsc" xrefstyle="select:title"/></term>
    <listitem>
     <para>
      为某个资源启用此模式后，便不会针对该资源触发监控操作。
     </para>
     <para>
      如果您需要手动调整此资源所管理的服务，并且不希望群集在此期间对该资源运行任何监控操作，则可以使用此选项。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry xml:id="vle-ha-maint-rsc-unmanaged">
    
    <term><xref linkend="sec-ha-maint-rsc-unmanaged" xrefstyle="select:title"/></term>
     <listitem>
     <para>
      使用 <option>is-managed</option> 元属性可以暂时<quote>释放</quote>某个资源，使其不受群集堆栈的管理。这意味着，您可以手动调整此资源管理的服务（例如，调整任何组件）。不过，群集会继续<emphasis>监控</emphasis>该资源并报告任何故障。
     </para>
     <para>
      如果您还希望群集停止<emphasis>监控</emphasis>该资源，请改为使用按资源维护模式（请参见<xref linkend="vle-ha-maint-mode-rsc"/>）。
     </para>
    </listitem>
   </varlistentry>

  </variablelist>
 </sect1>

 <sect1 xml:id="sec-ha-maint-mode-cluster">
  <title>将群集置于维护模式</title>
  <warning>
   <title>维护模式只会禁用 Pacemaker</title>
   <para>
    将群集置于维护模式时，只有 Pacemaker 的资源管理功能会被禁用。Corosync 和 SBD 仍会正常运行。这可能会引发屏蔽操作，具体取决于您的维护任务。
   </para>
   <para>
    请对涉及群集资源的所有任务都使用维护模式。对于涉及基础架构（例如存储或网络）的任何任务，最安全的方法是完全停止群集服务。请参见<xref linkend="sec-ha-maint-cluster-stop"/>。
   </para>
  </warning>
   <para>
    要在 crm 外壳中将群集置于维护模式，请使用以下命令：
   </para>
<screen><prompt role="root"># </prompt><command>crm maintenance on</command></screen>
   <para>
    要在完成维护工作后将群集恢复正常模式，请使用以下命令：
   </para>
<screen><prompt role="root"># </prompt><command>crm maintenance off</command></screen>

<procedure xml:id="pro-ha-maint-mode-cluster-hawk2">
   <title>使用 Hawk2 将群集置于维护模式</title>
   <step>
    <para>
     按<xref linkend="sec-conf-hawk2-login"/>中所述，启动 Web 浏览器并登录到群集。
    </para>
   </step>
   <step>
    <para>
     从左侧导航栏中，选择<menuchoice><guimenu>配置</guimenu> <guimenu>群集配置</guimenu></menuchoice>。
    </para>
   </step>
   <step>
    <para>
     从空下拉列表中选择 <guimenu>maintenance-mode</guimenu> 属性。
    </para>
   </step>
   <step>
    <para>
     从 <literal>maintenance-mode</literal> 下拉列表中选择<guimenu>是</guimenu>。
    </para>
   </step>
   <step>
     <para>
       单击<guimenu>应用</guimenu>。
     </para>
   </step>
   <step>
    <para>
     完成整个群集的维护任务后，从 <literal>maintenance-mode</literal> 下拉列表中选择<guimenu>否</guimenu>，然后单击<guimenu>应用</guimenu>。
    </para>
    <para>
     从此刻起，High Availability 会再次接管群集管理工作。
    </para>
   </step>
  </procedure>
</sect1>

<sect1 xml:id="sec-ha-maint-cluster-stop">
 <title>停止整个群集的群集服务</title>
 <para>
  要一次性停止所有节点上的群集服务，请使用以下命令：
 </para>
<screen><prompt role="root"># </prompt><command>crm cluster stop --all</command></screen>
 <para>
  要在完成维护工作后再次启动群集服务，请使用以下命令：
 </para>
<screen><prompt role="root"># </prompt><command>crm cluster start --all</command></screen>
 <warning>
  <title>不保证能正常关闭</title>
  <para>
   单独使用 <option>--all</option> 选项不能保证可将群集正常关闭，因为应用程序级别的资源停止失败可能会触发意外的屏蔽。如果应用程序是关键型应用程序，请考虑先停止这些应用程序，再停止整个群集的群集服务。
  </para>
 </warning>
</sect1>

 <sect1 xml:id="sec-ha-maint-mode-node">
  <title>将节点置于维护模式</title>
   <para>
    要在 crm 外壳中将节点置于维护模式，请使用以下命令：
   </para>
<screen><prompt role="root"># </prompt><command>crm node maintenance <replaceable>NODENAME</replaceable></command></screen>
   <para>
    要在完成维护工作后将节点恢复正常模式，请使用以下命令：
   </para>
<screen><prompt role="root"># </prompt><command>crm node ready <replaceable>NODENAME</replaceable></command></screen>

  <procedure xml:id="pro-ha-maint-mode-nodes-hawk2">
   <title>使用 Hawk2 将节点置于维护模式</title>
   <step>
    <para>
     按<xref linkend="sec-conf-hawk2-login"/>中所述，启动 Web 浏览器并登录到群集。
    </para>
   </step>
   <step>
    <para>
     在左侧导航栏中，选择<guimenu>群集状态</guimenu>。
    </para>
   </step>
   <step>
    <para>
     在其中某个节点的视图中，单击节点旁边的扳手图标，然后选择<guimenu>维护</guimenu>。
    </para>
   </step>
   <step>
    <para>
      完成维护任务后，单击节点旁边的扳手图标，然后选择<guimenu>就绪</guimenu>。
    </para>
   </step>
  </procedure>
 </sect1>

 <sect1 xml:id="sec-ha-maint-node-standby">
  <title>将节点置于待机模式</title>
   <para>
    要在 crm 外壳中将节点置于待机模式，请使用以下命令：
   </para>
<screen><prompt role="root"># </prompt><command>crm node standby <replaceable>NODENAME</replaceable></command></screen>
   <para>
    要在完成维护工作后将节点恢复上线状态，请使用以下命令：
   </para>
<screen><prompt role="root"># </prompt><command>crm node online <replaceable>NODENAME</replaceable></command></screen>

<procedure xml:id="pro-ha-maint-node-standby-hawk2">
  <title>使用 Hawk2 将节点置于待机模式</title>
   <step>
    <para>
     按<xref linkend="sec-conf-hawk2-login"/>中所述，启动 Web 浏览器并登录到群集。
    </para>
   </step>
   <step>
    <para>
     在左侧导航栏中，选择<guimenu>群集状态</guimenu>。
    </para>
   </step>
   <step>
    <para>
     在其中某个节点的视图中，单击节点旁边的扳手图标，然后选择<guimenu>待机</guimenu>。
    </para>
   </step>
   <step>
    <para>
     完成节点的维护任务。
    </para>
   </step>
   <step>
    <para>
     要停用待机模式，请单击节点旁边的扳手图标，然后选择<guimenu>就绪</guimenu>。
    </para>
   </step>
  </procedure>
</sect1>

<sect1 xml:id="sec-ha-maint-shutdown-node">
 <title>停止节点上的群集服务</title>
 <para>
  您可以按顺序将服务移出节点后再关闭或重引导该节点。这样可将服务迁移出节点，而不会受限于群集服务的关闭超时时长。
 </para>
 <procedure xml:id="pro-ha-maint-shutdown-node">
  <title>手动重引导群集节点</title>
  <step>
   <para>
    在要重引导或关闭的节点上，以 <systemitem class="username">root</systemitem> 或同等的身份登录。
   </para>
  </step>
  <step>
   <para>
    将节点置于 <literal>standby</literal> 模式：
   </para>
<screen><prompt role="root"># </prompt><command>crm node standby</command></screen>
   <para>
    默认情况下，节点在重引导后将保持 <literal>standby</literal> 模式。您也可以使用 <command>crm node standby reboot</command> 将节点设置为自动重新上线。
   </para>
  </step>
  <step>
   <para>
    检查群集状态：
   </para>
<screen><prompt role="root"># </prompt><command>crm status</command></screen>
   <para>
    此命令显示相关节点处于 <literal>standby</literal> 模式：
   </para>
<screen>[...]
Node <replaceable>bob</replaceable>: standby
[...]</screen>
  </step>
  <step>
   <para>
    停止该节点上的群集服务：
   </para>
<screen><prompt role="root"># </prompt><command>crm cluster stop</command></screen>
  </step>
  <step>
   <para>
    重引导该节点。
   </para>
  </step>
 </procedure>

 <para>
  要再次检查节点是否已加入群集，请执行以下操作：
 </para>

 <procedure>
  <step>
   <para>
    节点重引导后，再次登录该节点。
   </para>
  </step>
  <step>
   <para>
    检查群集服务是否已启动：
   </para>
<screen><prompt role="root"># </prompt><command>crm cluster status</command></screen>
   <para>
     这可能要花一些时间。如果群集服务无法自行重新启动，请手动启动它们：
   </para>
<screen><prompt role="root"># </prompt><command>crm cluster start</command></screen>
  </step>
  <step>
   <para>
    检查群集状态：
   </para>
<screen><prompt role="root"># </prompt><command>crm status</command></screen>
  </step>
  <step>
    <para>
      如果节点仍处于 <literal>standby</literal> 模式，请将其重新上线：
    </para>
<screen><prompt role="root"># </prompt><command>crm node online</command></screen>
  </step>
 </procedure>
</sect1>

 <sect1 xml:id="sec-ha-maint-mode-rsc">
  <title>将资源置于维护模式</title>
   <para>
    要在 crm 外壳中将资源置于维护模式，请使用以下命令：</para>
<screen><prompt role="root"># </prompt><command>crm resource maintenance <replaceable>RESOURCE_ID</replaceable> true</command></screen>
   <para>
    要在完成维护工作后将资源恢复正常模式，请使用以下命令：
   </para>
<screen><prompt role="root"># </prompt><command>crm resource maintenance <replaceable>RESOURCE_ID</replaceable> false</command></screen>

<procedure xml:id="pro-ha-maint-mode-rsc-hawk2">
   <title>使用 Hawk2 将资源置于维护模式</title>
   <step>
    <para>
     按<xref linkend="sec-conf-hawk2-login"/>中所述，启动 Web 浏览器并登录到群集。
    </para>
   </step>
   <step>
    <para>
     在左侧导航栏中，选择<guimenu>资源</guimenu>。
    </para>
   </step>
   <step>
    <para>
     选择要置于维护模式或不受管理模式的资源，单击该资源旁边的扳手图标，然后选择<guimenu>编辑资源</guimenu>。
    </para>
   </step>
   <step>
    <para>
     打开<guimenu>元属性</guimenu>类别。
    </para>
   </step>
   <step>
    <para>
     从空下拉列表中，选择 <guimenu>maintenance</guimenu> 属性，然后单击加号图标添加该属性。
    </para>
   </step>
   <step>
    <para>
     选中 <literal>maintenance</literal> 旁边的复选框，以将 maintenance 属性设置为 <literal>yes</literal>。
    </para>
   </step>
   <step>
    <para>
     确认更改。
    </para>
   </step>
   <step>
    <para>
     完成该资源的维护任务之后，取消选中该资源的 <literal>maintenance</literal> 属性旁边的复选框。
    </para>
    <para>
     从此刻起，资源再次由 High Availability 软件管理。
    </para>
   </step>
  </procedure>
</sect1>

<sect1 xml:id="sec-ha-maint-rsc-unmanaged">
  <title>将资源置于不受管理模式</title>
   <para>
    要在 crm 外壳中将资源置于不受管理模式，请使用以下命令：</para>
<screen><prompt role="root"># </prompt><command>crm resource unmanage <replaceable>RESOURCE_ID</replaceable></command></screen>
   <para>
    要在完成维护工作后再次将资源置于受管模式，请使用以下命令：
   </para>
<screen><prompt role="root"># </prompt><command>crm resource manage <replaceable>RESOURCE_ID</replaceable></command></screen>

 <procedure xml:id="pro-ha-maint-rsc-unmanaged-hawk2">
   <title>使用 Hawk2 将资源置于不受管理模式</title>
   <step>
    <para>
     按<xref linkend="sec-conf-hawk2-login"/>中所述，启动 Web 浏览器并登录到群集。
    </para>
   </step>
   <step>
    <para>
     从左侧导航栏中选择<guimenu>状态</guimenu>，然后转到<guimenu>资源</guimenu>列表。
    </para>
   </step>
   <step>
    <para>
     在<guimenu>操作</guimenu>列中，单击要修改的资源旁边的向下箭头图标，然后选择<guimenu>编辑</guimenu>。
    </para>
    <para>
     资源配置屏幕即会打开。
    </para>
   </step>
   <step>
    <para>
     在<guimenu>元属性</guimenu>下面，从空下拉列表中选择 <guimenu>is-managed</guimenu> 项。
    </para>
   </step>
   <step>
    <para>
     将其值设置为 <literal>No</literal>，然后单击<guimenu>应用</guimenu>。
    </para>
   </step>
   <step>
    <para>
     完成维护任务后，将 <guimenu>is-managed</guimenu> 设置为 <literal>Yes</literal>（即默认值）并应用更改。
    </para>
    <para>
     从此刻起，资源再次由 High Availability 软件管理。
    </para>
   </step>
  </procedure>
 </sect1>

<sect1 xml:id="sec-ha-maint-shutdown-node-maint-mode">
 <title>在维护模式下重引导群集节点</title>
    <note>
      <title>含义</title>
      <para>
       如果群集或某个节点处于维护模式，您可以使用群集堆栈外部的工具（例如 <command>systemctl</command>）手动将群集管理的组件作为资源进行操作。High Availability 软件不会监控这些组件或尝试重启动它们。
      </para>
      <para>
       如果您停止节点上的群集服务，所有守护程序和进程（最初作为 Pacemaker 管理的群集资源启动）都会继续运行。
      </para>
      <para>
       如果您在群集或某个节点处于维护模式时尝试启动该节点上的群集服务，Pacemaker 会针对每个资源启动一次性监控操作（<quote>探测</quote>），以确定哪些资源当前正在该节点上运行。不过，它只会确定资源的状态，而不执行其他操作。
      </para>
     </note>

   <procedure xml:id="pro-ha-maint-reboot-node">
    <title>在群集或节点处于维护模式的情况下重引导群集节点</title>
    <step>
    <para>
     在要重引导或关闭的节点上，以 <systemitem class="username">root</systemitem> 或同等的身份登录。
    </para>
   </step>
   <step>
    <para>
     如果您使用 DLM 资源（或依赖于 DLM 的其他资源），请确保在停止群集服务之前明确停止这些资源：
    </para>
<screen><prompt role="custom">crm(live)resource# </prompt><command>stop <replaceable>RESOURCE_ID</replaceable></command></screen>
    <para>
     这是因为停止 Pacemaker 也会停止 Corosync 服务，而 DLM 依赖于后者的成员资格和消息交换服务。如果 Corosync 停止，DLM 资源会表现为某种节点分裂情况并触发屏蔽操作。
    </para>
   </step>
   <step>
    <para>
     停止该节点上的群集服务：
    </para>
<screen><prompt role="root"># </prompt><command>crm cluster stop</command></screen>
   </step>
   <step>
    <para>
     关闭或重引导节点。
    </para>
   </step>
  </procedure>
 </sect1>
</chapter>
