<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="ha_migration.xml" version="5.0" xml:id="cha-ha-migration">

 <title>クラスタアップグレードとソフトウェアパッケージの更新</title>
 <info>
      <abstract>
        <para>
    この章では、次の2つの異なるシナリオ(SUSE Linux Enterprise High Availabilityの別バージョン(メジャーリリースまたはサービスパック)へのクラスタアップグレード、およびクラスタノード上の各パッケージの更新について説明します。<xref linkend="sec-ha-migration-upgrade"/>および<xref linkend="sec-ha-migration-update"/>を参照してください。
   </para>
        <para>
    クラスタをアップグレードする場合、アップグレードを開始する前に、<xref linkend="sec-ha-migration-upgrade-oview"/>および<xref linkend="sec-ha-migration-upgrade-require"/>を確認してください。
   </para>
      </abstract>
      <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
        <dm:maintainer/>
        <dm:status>editing</dm:status>
        <dm:deadline/>
        <dm:priority/>
        <dm:translation>yes</dm:translation>
        <dm:languages/>
        <dm:release/>
        <dm:repository/>
      </dm:docmanager>
    </info>
    <sect1 xml:id="sec-ha-migration-terminology">
  <title>用語集</title>

  <para>
   次に、この章で使用される最も重要な用語の定義を示します。
  </para>

  <variablelist>
   <varlistentry>
    <term>メジャーリリース</term>
    <term>一般出荷(GA)バージョン</term>
    <listitem>
     <para>
      メジャーリリースとは、新しい機能やツールを導入し、非推奨になっていたコンポーネントを削除した、新しい製品バージョンです。これには、後方互換性のない変更が存在します。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry xml:id="vle-upgrade-offline">
    <term>クラスタオフラインアップグレード</term>
    <listitem>
     <para>
      新しい製品バージョンに後方互換性のない大きな変更が含まれている場合は、クラスタオフラインアップグレードによってクラスタをアップグレードする必要があります。すべてのノードをオンラインに戻す前に、すべてのノードをオフラインにして、クラスタ全体をアップグレードする必要があります。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry xml:id="vle-upgrade-rolling">
    <term>クラスタローリングアップグレード</term>
    <listitem>
     <para>
      クラスタローリングアップグレードでは、1度に1つのクラスタノードがアップグレードされ、残りのクラスタはまだ実行されています。最初のノードをオフラインにし、アップグレードして、オンラインに戻してから、クラスタに参加させます。その後、すべてのクラスタノードがメジャーバージョンにアップグレードされるまで、1つずつアップグレードを続けます。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>サービスパック(SP)</term>
    <listitem>
     <para>
      複数のパッチを組み合わせて、インストールまたは展開しやすい形式にします。サービスパックには番号が付けられ、通常、プログラムのセキュリティ修正、更新、アップグレード、または拡張機能が含まれます。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>この状態から</term>
    <listitem>
     <para>
      新しい<emphasis>マイナー</emphasis>バージョンのパッケージのインストールです。通常、セキュリティ更新やその他の重要な修正が含まれています。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>アップグレード</term>
    <listitem>
     <para>
      パッケージまたはディストリビューションの新しい<emphasis>メジャー</emphasis>バージョンのインストール。これにより<emphasis>新機能</emphasis>がもたらされます。<xref linkend="vle-upgrade-offline"/>および<xref linkend="vle-upgrade-rolling"/>も参照してください。
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
 </sect1>
 <sect1 xml:id="sec-ha-migration-upgrade">
  <title>最新の製品バージョンへのクラスタアップグレード</title>

  <para>
   サポートされるアップグレードパスおよびアップグレードの実行方法は、現在の製品バージョンおよび移行したいターゲットバージョンによって異なります。
  </para>

  <sect2 xml:id="sec-ha-migration-upgrade-oview">
   <title>SLE HAおよびSLE HA Geoでサポートされるアップグレードパス</title>
    <para>
    SUSE Linux Enterprise High Availabilityには、基盤となる基本システムと同じサポートされているアップグレードパスがあります。完全な概要については、『SUSE Linux Enterprise Serverアップグレードガイド』のセクション<link xlink:href="https://documentation.suse.com/sles-15/html/SLES-all/cha-upgrade-paths.html#sec-upgrade-paths-supported"><citetitle>Supported Upgrade Paths to SUSE Linux Enterprise Server 15 SP7</citetitle></link>を参照してください。
    </para>

    <para>
    また、高可用性クラスタスタックはクラスタをアップグレードするための2つの方法を提供するため、次のルールが適用されます。</para>
    <itemizedlist>
    <listitem>
      <formalpara>
      <title><xref linkend="vle-upgrade-rolling"/></title>
      <para>クラスタローリングアップグレードは、同じメジャーリリース内(あるサービスパックから次のサービスパックへ、または製品のGAバージョンからSP1へ)でのみサポートされます。</para>
      </formalpara>
    </listitem>
    <listitem>
      <formalpara>
      <title><xref linkend="vle-upgrade-offline" xrefstyle="select:label"/></title>
        <para>あるメジャーリリースから次のメジャーリリース(たとえば、SSLE HA 12からSLE HA 15など)、または特定のメジャーリリース内のサービスパックから次のメジャーリリース(たとえば、SLE HA 12 SP5からSLE HA 15)へアップグレードするには、クラスタオフラインアップグレードが必要です。
      </para>
      </formalpara>
    </listitem>
    </itemizedlist>

    <important>
    <title>混合クラスタおよびアップグレード後に元に戻す操作はサポートされない</title>
    <itemizedlist>
      <listitem>
      <para>
        SUSE Linux Enterprise High Availability 12/SUSE Linux Enterprise High Availability 15で実行する混合クラスタはサポートされて<emphasis>いません</emphasis>。
      </para>
      </listitem>
      <listitem>
      <para>
        製品バージョン15へのアップグレードプロセス後に、製品バージョン12に戻す処理は、サポートされて<emphasis>いません</emphasis>。
      </para>
      </listitem>
    </itemizedlist>
    </important>

   
   <note>
    <title>サービスパックのスキップ</title>
    <para>
     最も単純なアップグレードパスは、すべてのサービスパックを連続してインストールすることです。SUSE Linux Enterprise 15製品ライン(GAおよび次のサービスパック)の場合、アップグレード時に最大2つのサービスパックをスキップすることもサポートされています。たとえば、SLE HA 15 SP3から15 SP6へのアップグレードがサポートされています(SLE HA 15 SP3がサポートされている場合)。
    </para>
   </note>

  <figure xml:id="fig-ha-migration-upgrade-oview">
   <title>サポートされているアップグレードパスの概要</title>
   <mediaobject>
    <imageobject role="fo">
     <imagedata fileref="upgrade-paths_sleha.svg" width="100%"/>
    </imageobject>
    <imageobject role="html">
     <imagedata fileref="upgrade-paths_sleha.png" width="80%"/>
    </imageobject>
    <textobject role="description">
      <phrase> この図は、高可用性クラスタでサポートされているアップグレードパスを示しています。黒の矢印は、クラスタを停止せずに実行できるアップグレードを示しています。オレンジの矢印は、クラスタを停止することによってのみ実行できるアップグレードを示しています。青の矢印は、クラスタを停止することによって実行できるLTSSバージョンからのアップグレードを示しています。 </phrase>
    </textobject>
   </mediaobject>
  </figure>
  </sect2>

  <sect2 xml:id="sec-ha-migration-upgrade-require">
   <title>アップグレード前に必要な準備</title>
   <variablelist>
    <varlistentry>
     <term>バックアップ</term>
     <listitem>
      <para>
       システムバックアップが最新で、復元可能かどうかを確認します。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>テスト</term>
     <listitem>
      <para>
       運用環境で実行する前に、まず、クラスタセットアップのステージングインスタンスでアップグレード手順をテストします。これにより、メンテナンス期間に要するタイムフレームを予測できます。予期しない問題を検出し、解決するのにも役立ちます。
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
  </sect2>

  <sect2 xml:id="sec-ha-migration-upgrade-offline">
   <title>クラスタオフラインアップグレード</title>
   <para>
    このセクションでは、SLE HA 12からSLE HA 15へのアップグレードについて説明します。<xref linkend="fig-ha-migration-upgrade-oview"/>で、アップグレード対象としてサポートされているサービスパックを確認してください。クラスタがまだこれらよりも古いサービスパックに基づいている場合は、まず、SLE HA 15にアップグレードするためのソースとして使用できるバージョンのSLESおよびSLE HAにクラスタをアップグレードします。SLE HA 12 SP5については、「<link xlink:href="https://documentation.suse.com/sle-ha/12-SP5/html/SLE-HA-all/cha-ha-migration.html#sec-ha-migration-upgrade">最新の製品バージョンへのクラスタアップグレード</link>」を参照してください。
   </para>

<procedure xml:id="pro-ha-migration-offline-12-15">
    <title>製品バージョン12から15へのアップグレード: クラスタオフラインアップグレード</title>
   <important>
     <title>最初からのインストール</title>
     <para>クラスタノードを(アップグレードするのではなく)最初からインストールすることにした場合、SUSE Linux Enterprise High Availability 15 SP7に必要なモジュールのリストについては、<xref linkend="sec-ha-requirements-sw"/>を参照してください。モジュール、拡張機能、および関連製品の詳細については、SUSE Linux Enterprise Server 15のリリースノートを確認してください。これらは、<link xlink:href="https://www.suse.com/releasenotes/"></link>から入手できます。
     </para>
    </important>
    <step>
     <para>
      SUSE Linux Enterprise High Availability 15へのオフラインアップグレードを開始する前に、<xref linkend="note-ha-cib-upgrade"/>の説明に従って現在のクラスタでCIB構文を手動でアップグレードしてください。
     </para>
    </step>
    <step>
     <para>
      各クラスタノードにログインし、次のコマンドを使用してクラスタスタックを停止します。
     </para>
<screen><prompt role="root"># </prompt><command>crm cluster stop</command></screen>
    </step>
    <step>
     <para>
      クラスタノードごとに、目的のターゲットバージョンのSUSE Linux Enterprise ServerおよびSUSE Linux Enterprise High Availabilityへのアップグレードを実行します。<xref linkend="sec-ha-migration-upgrade-oview"/>を参照してください。
     </para>
    </step>
    <step>
     <para>
      アップグレードプロセスが完了した後で、SUSE Linux Enterprise ServerおよびSUSE Linux Enterprise High Availabilityのアップグレード済みバージョンがインストールされた各ノードにログインして起動します。
     </para>
    </step>
    <step>
     <para>Cluster LVMを使用する場合は、clvmdからlvmlockdに移行する必要があります。<command>lvmlockd</command>のマニュアルページのセクション「<citetitle>Changing a clvm/clustered VG to a shared VG</citetitle>」を参照してください。
     </para>
     <para>
      <systemitem class="daemon">cmirrord</systemitem>も使用する場合は、Cluster MDに移行することを強くお勧めします。<xref linkend="sec-ha-clvm-migrate"/>を参照してください。
     </para>
    </step>
    <step>
     <para>
      クラスタノードにログインして、すべてのノードでクラスタスタックを起動します。
     </para>
<screen><prompt role="root"># </prompt><command>crm cluster start --all</command></screen>
     <note>
      <title><option>--all</option>オプションはバージョン15 SP4でのみ使用可能</title>
      <para>
       <option>--all</option>オプションは、SUSE Linux Enterprise High Availability 15 SP4で追加されました。以前のバージョンでは、各ノードで<command>crm cluster start</command>コマンドを1つずつ実行する必要があります。
      </para>
     </note>
    </step>
    <step>
     <para>
      <command>crm status</command>またはHawk2を使用してクラスタの状態を確認します。
     </para>
    </step>
   </procedure>

    <note xml:id="note-ha-cib-upgrade">
    <title>CIB構文バージョンのアップグレード</title>
    <para>
     新しい機能は、最新のCIB構文バージョンでのみ使用可能な場合もあります。新しい製品バージョンにアップグレードした場合でも、デフォルトではCIB構文バージョンはアップグレード<emphasis>されません</emphasis>。
     </para>
    <procedure>
     <step>
      <para>バージョンをチェックします。</para>
<screen><command>cibadmin -Q | grep validate-with</command></screen>
     </step>
     <step>
      <para>最新のCIB構文バージョンにアップグレードします。
      </para>
<screen><prompt role="root"># </prompt><command>cibadmin --upgrade --force</command></screen>
     </step>
    </procedure>
   </note>
  </sect2>

  <sect2 xml:id="sec-ha-migration-upgrade-rolling">
   <title>クラスタローリングアップグレード</title>
   <para>
    このセクションでは、新しいSLE HA 15サービスパックへのアップグレードについて説明します。<xref linkend="fig-ha-migration-upgrade-oview"/>で、アップグレード対象としてサポートされているサービスパックを確認してください。
   </para>

   <para>シナリオに合わせて次の手順のいずれかを使用します。</para>
   <itemizedlist>
    <listitem>
     <para>
      <xref linkend="pro-ha-migration-rolling-upgrade"/>ボタンをクリックします。
     </para>
    </listitem>
    <listitem>
     <para>
      <xref linkend="pro-ha-migration-rolling-upgrade-newsp-freshinstall"/>
     </para>
    </listitem>
   </itemizedlist>

   <warning>
    <title>アクティブなクラスタスタック</title>
    <para>
     ノードのアップグレードを開始する前に、<emphasis>そのノード上の</emphasis>クラスタスタックを<emphasis>停止</emphasis>します。
    </para>
    <para>
     ソフトウェアの更新中にノード上のクラスタリソースマネージャがアクティブな場合、アクティブノードのフェンシングのような結果を招く場合があります。
    </para>
   </warning>
   <important>
    <title>クラスタローリングアップグレードの時間制限</title>
    <para>
     最新の製品バージョンに装備されている新機能は、<emphasis>すべての</emphasis>クラスタノードが最新の製品バージョンにアップグレードされた後でないと使用できません。混合バージョンのクラスタは、クラスタローリングアップグレード中の短いタイムフレームでのみサポートされます。クラスタローリングアップグレードは1週間以内に完了してください。
    </para>
    <para>
     すべてのオンラインノードでアップグレードされたバージョンが実行される場合、古いバージョンの他のノードはアップグレードせずに(再)参加できなくなります。
    </para>
   </important>
   <procedure xml:id="pro-ha-migration-rolling-upgrade">
    <title>クラスタローリングアップグレードの実行</title>

    <step>
     <para>
      アップグレードするノードで<systemitem class="username">root</systemitem>としてログインし、クラスタスタックを停止します。
     </para>
<screen><prompt role="root"># </prompt><command>crm cluster stop</command></screen>
    </step>
    <step xml:id="step-ha-migration-upgrade-tolatest">
     <para>
      <link xlink:href="https://documentation.suse.com/sles/html/SLES-all/book-upgrade.html">SLES 15 SP7の『アップグレードガイド』</link>の説明に従って、目的のターゲットバージョンのSUSE Linux Enterprise ServerおよびSUSE Linux Enterprise High Availability Extensionへのアップグレードを実行します。
     </para>
     <para>
       Geoクラスタをアップグレードする必要がある場合は、<xref linkend="cha-ha-geo-upgrade"/>を参照してください。
     </para>
    </step>
    <step xml:id="step-ha-migration-upgrade-ais">
     <para>
      アップグレードしたノードでクラスタスタックを起動して、ノードをクラスタに再加入させます。
     </para>
<screen><prompt role="root"># </prompt><command>crm cluster start</command></screen>
    </step>
    <step>
     <para>
      次のノードをオフラインにし、そのノードに関して手順を繰り返します。
     </para>
    </step>
    <step>
     <para>
      <command>crm status</command>またはHawk2を使用してクラスタの状態を確認します。
     </para>
     <para>
      クラスタノードに異なるCRMバージョンが検出された場合、Hawk2の<guimenu>状態</guimenu>画面に警告も表示されます。
     </para>
    </step>
   </procedure>
   <important>
    <title>ローリングアップグレードの時間制限</title>
    <para>
     最新の製品バージョンに装備されている新機能は、<emphasis>すべての</emphasis>クラスタノードが最新の製品バージョンにアップグレードされた後でないと使用できません。混合バージョンのクラスタは、ローリングアップグレード中の短いタイムフレームでのみサポートされます。ローリングアップグレードは1週間以内に完了してください。
    </para>
   </important>
   <para>クラスタノードに異なるCRMバージョンが検出された場合、Hawk2の<guimenu>状態</guimenu>画面に警告も表示されます。</para>
   <para>多くのお客様は、インプレースアップグレードのほかに、次のサービスパックに移行する場合でも新規インストールを希望しています。次の手順は、ノードaliceおよびbobを含む2ノードクラスタを次のサービスパック(SP)にアップグレードするシナリオを示しています。
   </para>
   <procedure xml:id="pro-ha-migration-rolling-upgrade-newsp-freshinstall">
    <title>新しいサービスパックのクラスタ全体での新規インストールの実行</title>
    <step xml:id="st-ha-migration-rolling-up-sp-backup">
     <para>クラスタ設定のバックアップを作成します。次のリストに、最小ファイルセットを示します。
     </para>
     
     <screen>/etc/corosync/corosync.conf
/etc/corosync/authkey
/etc/sysconfig/sbd
/etc/modules-load.d/watchdog.conf
/etc/hosts
/etc/chrony.conf</screen>
     
     <para>リソースに応じて、次のファイルが必要になる場合もあります。</para>
     
     <screen>/etc/services
/etc/passwd
/etc/shadow
/etc/groups
/etc/drbd/*
/etc/lvm/lvm.conf
/etc/mdadm.conf
/etc/mdadm.SID.conf</screen>
     
    </step>
    <step xml:id="st-ha-migration-rolling-alice">
     <para>ノードaliceから開始します。
     </para>
     <substeps>
      <step>
       <para>
        ノードをスタンバイモードにします。これにより、リソースをノードから移動できます。
       </para>
       <screen><prompt role="root"># </prompt><command>crm --wait node standby alice reboot</command></screen>
       <para>
        <option>--wait</option>オプションを使用すると、このコマンドはクラスタが移行を終了してアイドル状態になるまで終了しません。<option>reboot</option>オプションには、ノードがもう一度オンラインになったときにはスタンバイモードではなくなるという効果があります。その名前に反して、<option>reboot</option>オプションはノードがオフラインまたはオンラインである限り機能します。
       </para>
      </step>
      <step>
       <para>ノードaliceでクラスタサービスを停止します。</para>
       <screen><prompt role="root"># </prompt><command>crm cluster stop</command></screen>
      </step>
      <step>
       <para>
        この時点で、aliceには実行中のリソースはありません。ノードaliceをアップグレードし、その後に再起動します。クラスタサービスは起動時には開始されないことが想定されます。
       </para>
      </step>
      <step>
       <para>
        バックアップファイルを<xref linkend="st-ha-migration-rolling-up-sp-backup"/>から元の場所にコピーします。
       </para>
      </step>
      <step>
       <para>ノードaliceをクラスタに戻します。</para>
       <screen><prompt role="root"># </prompt><command>crm cluster start</command></screen>
      </step>
      <step>
       <para>リソースに問題がないことを確認します。</para>
      </step>
     </substeps>
    </step>
    <step>
     <para>ノードbobに対して<xref linkend="st-ha-migration-rolling-alice"/>を繰り返します。
     </para>
    </step>
   </procedure>
  </sect2>
 </sect1>
 <sect1 xml:id="sec-ha-migration-update">
  <title>クラスタノード上のソフトウェアパッケージの更新</title>

  <warning>
   <title>アクティブなクラスタスタック</title>
   <para>
    ノードのパッケージ更新を開始する前に、クラスタスタックが影響を受けるか否かによって、<emphasis>そのノード上の</emphasis>クラスタスタックを<emphasis>停止</emphasis>するか、<emphasis>ノードを保守モード</emphasis>にします。詳細については<xref linkend="step-update-check"/>を参照してください。
   </para>
   <para>
    ソフトウェアの更新中にノード上のクラスタリソースマネージャがアクティブな場合、アクティブノードのフェンシングのような結果を招く場合があります。
   </para>
  </warning>

  <procedure>
   <step xml:id="step-update-check">
    <para>
     ノード上にパッケージ更新をインストールする前に、次の内容を確認してください。
    </para>
    <itemizedlist>
     <listitem>
      <para>
       この更新は、SUSE Linux Enterprise High Availabilityに属するパッケージに影響しますか?<literal>yes</literal>の場合は、ソフトウェアの更新を開始する前に、ノード上でクラスタスタックを停止します。
      </para>
<screen><prompt role="root"># </prompt><command>crm cluster stop</command></screen>
     </listitem>
     <listitem>
      <para>
       パッケージ更新には再起動が必要ですか。<literal>yes</literal>の場合は、ソフトウェアの更新を開始する前に、ノード上でクラスタスタックを停止します。
      </para>
<screen><prompt role="root"># </prompt><command>crm cluster stop</command></screen>
     </listitem>
     <listitem>
      <para>
       これらの状況のいずれにも該当しない場合は、クラスタスタックを停止する必要はありません。その場合は、ソフトウェアの更新を開始する前に、ノードを保守モードにします。
      </para>
<screen><prompt role="root"># </prompt><command>crm node maintenance <replaceable>NODE_NAME</replaceable></command></screen>
      <para>
       保守モードの詳細については、<xref linkend="sec-ha-maint-overview"/>を参照してください。
      </para>
     </listitem>
    </itemizedlist>
   </step>
   <step>
    <para>
     YaSTまたはZypperを使用してパッケージ更新をインストールします。
    </para>
   </step>
   <step>
    <para>
     更新が正常にインストールされたら、次のいずれかを行います。
    </para>
    <itemizedlist>
     <listitem>
      <para>
       それぞれのノードでクラスタスタックを起動します(<xref linkend="step-update-check"/>で停止した場合)。
      </para>
<screen><prompt role="root"># </prompt><command>crm cluster start</command></screen>
     </listitem>
     <listitem>
      <para>
       または、ノードの保守フラグを削除して、ノードを通常モードに戻します。
      </para>
<screen><prompt role="root"># </prompt><command>crm node ready <replaceable>NODE_NAME</replaceable></command></screen>
     </listitem>
    </itemizedlist>
   </step>
   <step>
    <para>
     <command>crm status</command>またはHawk2を使用してクラスタの状態を確認します。
    </para>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="sec-ha-migration-more">
  <title>詳細情報</title>

  <para>
   アップグレード先の製品の変更点と新機能の詳細については、それぞれのリリースノートを参照してください。リリースノートは、<link xlink:href="https://www.suse.com/releasenotes/"></link>で入手できます。
  </para>
 </sect1>
</chapter>
