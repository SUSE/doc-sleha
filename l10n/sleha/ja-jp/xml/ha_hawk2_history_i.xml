<?xml version="1.0" encoding="UTF-8"?>
<sect1 xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="ha_hawk2_history_i.xml" version="5.0" xml:id="sec-conf-hawk2-history">
 <title>クラスタ履歴の表示</title>

 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:maintainer/>
   <dm:status>editing</dm:status>
   <dm:deadline/>
   <dm:priority/>
   <dm:translation>yes</dm:translation>
   <dm:languages/>
   <dm:release/>
   <dm:repository/>
  </dm:docmanager>
 </info>

 <para>
  Hawk2には、クラスタの過去のイベントを表示する、次のような機能があります(いくつかの詳細さのレベルがあります)。
 </para>

 <itemizedlist>
  <listitem>
   <para>
    <xref linkend="sec-conf-hawk2-history-recent"/>
   </para>
  </listitem>
  <listitem>
   <para>
    <xref linkend="sec-conf-hawk2-history-explorer"/>
   </para>
  </listitem>
  <listitem>
   <para>
    <xref linkend="sec-conf-hawk2-history-transitions"/>
   </para>
  </listitem>
 </itemizedlist>

 <para>
  crmshを使用してクラスタ履歴情報を表示することもできます。
 </para>
 <itemizedlist>
  <listitem>
   <para>
    <xref linkend="sec-ha-config-crm-history"/>
   </para>
  </listitem>
 </itemizedlist>

 <sect2 xml:id="sec-conf-hawk2-history-recent">
  <title>ノードまたリソースの最近のイベントの表示</title>
  <procedure>
   <step>
    <para>
     Hawk2にログインします。
    </para>
<screen>https://<replaceable>HAWKSERVER</replaceable>:7630/</screen>
   </step>
   <step>
    <para>
     左のナビゲーションバーから、<menuchoice><guimenu>監視機能</guimenu>
     <guimenu>状態</guimenu></menuchoice>の順に選択します。<guimenu>Resources (リソース)</guimenu>と<guimenu>Nodes (ノード)</guimenu>が一覧表示されます。
    </para>
   </step>
   <step>
    <para>
     リソースの最近のイベントを表示するには
    </para>
    <substeps>
     <step>
      <para>
       <guimenu>Resources (リソース)</guimenu>をクリックして、それぞれのリソースを選択します。
      </para>
     </step>
     <step>
      <para>
       リソースの<guimenu>操作</guimenu>列で、下矢印ボタンをクリックして<guimenu>最近のイベント</guimenu>を選択します。
      </para>
      <para>
       Hawk2では、新しいウィンドウが開き、最新のイベントのテーブルビューが表示されます。
      </para>
     </step>
    </substeps>
   </step>
   <step>
    <para>
     ノードの最近のイベントを表示するには
    </para>
    <substeps>
     <step>
      <para>
       <guimenu>Nodes (ノード)</guimenu>をクリックして、それぞれのノードを選択します。
      </para>
     </step>
     <step>
      <para>
       ノードの<guimenu>操作</guimenu>列で、<guimenu>最近のイベント</guimenu>を選択します。
      </para>
      <para>
       Hawk2では、新しいウィンドウが開き、最新のイベントのテーブルビューが表示されます。
      </para>
      <figure>
       <title>最新イベントテーブル</title>
       <mediaobject>
        <imageobject role="fo">
         <imagedata fileref="hawk2-node-events.png" width="100%"/>
        </imageobject>
        <imageobject role="html">
         <imagedata fileref="hawk2-node-events.png" width="90%"/>
        </imageobject>
        <textobject role="description">
          <phrase>ノードaliceの最近のリソース操作を示すテーブル。</phrase>
        </textobject>
       </mediaobject>
      </figure>
     </step>
    </substeps>
   </step>
  </procedure>
 </sect2>

 <sect2 xml:id="sec-conf-hawk2-history-explorer">
  <title>クラスタレポートのための履歴エクスプローラーの使用</title>
  <para>
   左のナビゲーションバーから<menuchoice><guimenu>トラブルシューティング</guimenu>
   <guimenu>履歴</guimenu></menuchoice>を選択して、<guimenu>履歴エクスプローラー</guimenu>にアクセスします。<guimenu>履歴エクスプローラー</guimenu>では、詳細なクラスタレポートを作成し、遷移情報を表示できます。次のオプションが表示されます。
  </para>
  <variablelist>
   <varlistentry>
    <term><guimenu>生成</guimenu>
    </term>
    <listitem>
     <para>
      特定の時刻のクラスタレポートを作成します。Hawk2では、<command>crm report</command>コマンドをコールして、レポートを生成します。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><guimenu>アップロード</guimenu>
    </term>
    <listitem>
     <para>
      crmシェルで直接作成したか、異なるクラスタ上で作成した<literal>crm report</literal>アーカイブをアップロードできます。
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
  <para>
   レポートを生成するか、アップロードした後で、これらのレポートは<guimenu>レポート</guimenu>の下に表示されます。レポートのリストから、レポートの詳細を表示したり、レポートをダウンロードしたり、削除したりできます。
  </para>
  <figure>
   <title>Hawk2 - 履歴エクスプローラーのメインビュー</title>
   <mediaobject>
    <imageobject role="fo">
     <imagedata fileref="hawk2-history-explorer-main.png" width="100%"/>
    </imageobject>
    <imageobject role="html">
     <imagedata fileref="hawk2-history-explorer-main.png" width="90%"/>
    </imageobject>
   </mediaobject>
  </figure>
  <procedure xml:id="pro-hawk2-history-report">
   <title>クラスタレポートの生成またはアップロード</title>
   <step>
    <para>
     Hawk2にログインします。
    </para>
<screen>https://<replaceable>HAWKSERVER</replaceable>:7630/</screen>
   </step>
   <step>
    <para>
     左のナビゲーションバーから、<menuchoice><guimenu>トラブルシューティング</guimenu>
     <guimenu>履歴</guimenu></menuchoice>の順に選択します。
    </para>
    <para>
     <guimenu>生成</guimenu>ビューに<guimenu>履歴エクスプローラー</guimenu>画面が開きます。デフォルトでは、レポートの提案される時間フレームは最後の時刻です。
    </para>
   </step>
   <step>
    <para>
     クラスタレポートを作成するには
    </para>
    <substeps>
     <step>
      <para>
       レポートを直ちに開始するには、<guimenu>生成</guimenu>をクリックします。
      </para>
     </step>
     <step>
      <para>
       レポートの時間フレームを変更するには、提案される時間フレームの任意の場所をクリックし、ドロップダウンボックスから別のオプションを選択します。<guimenu>Custom (カスタム)</guimenu>開始日、終了日、および時間をそれぞれ入力することもできます。レポートを開始するには、<guimenu>生成</guimenu>をクリックします。
      </para>
      <para>
       レポートを終了した後で、そのレポートが<guimenu>レポート</guimenu>の下に表示されます。
      </para>
     </step>
    </substeps>
   </step>
   <step>
    <para>
     クラスタレポートをアップロードするには、Hawk2でアクセス可能なファイルシステム上に<command>crm report</command>アーカイブがある必要があります。以下に手順を示します。
    </para>
    <substeps>
     <step>
      <para>
       <guimenu>アップロード</guimenu>タブに切り替えます。
      </para>
     </step>
     <step>
      <para>
       クラスタレポートアーカイブを<guimenu>ブラウズ</guimenu>し、<guimenu>アップロード</guimenu>をクリックします。
      </para>
      <para>
       レポートがアップロードされると、そのレポートが<guimenu>レポート</guimenu>の下に表示されます。
      </para>
     </step>
    </substeps>
   </step>
   <step>
    <para>
     レポートをダウンロードまたは削除するには、<guimenu>操作</guimenu>列のレポートの横の各アイコンをクリックします。
    </para>
   </step>
   <step>
    <para>
     <xref linkend="il-hawk2-history-report-details" xrefstyle="select:title"/>を表示するには、レポートの名前をクリックするか、<guimenu>操作</guimenu>列から<guimenu>表示</guimenu>を選択します。
    </para>
    <figure>
     <title>Hawk2レポートの詳細</title>
     <mediaobject>
      <imageobject role="fo">
       <imagedata fileref="hawk2-history-report-details.png" width="100%"/>
      </imageobject>
      <imageobject role="html">
       <imagedata fileref="hawk2-history-report-details.png" width="90%"/>
      </imageobject>
      <textobject role="description">
        <phrase>レポートの詳細(名前、タイムフレーム、ノードイベント、リソースイベントなど)。</phrase>
      </textobject>
     </mediaobject>
    </figure>
   </step>
   <step>
    <para>
     <guimenu>レポート</guimenu>ボタンをクリックして、レポートのリストに戻ります。
    </para>
   </step>
  </procedure>
  <itemizedlist xml:id="il-hawk2-history-report-details">
   <title>履歴エクスプローラーのレポート詳細</title>
   <listitem>
    <para>
     レポートの名前です。
    </para>
   </listitem>
   <listitem>
    <para>
     レポートの開始時刻。
    </para>
   </listitem>
   <listitem>
    <para>
     レポートの終了時刻。
    </para>
   </listitem>
   <listitem>
    <para>
     レポートによってカバーされるクラスタのすべての遷移の遷移数およびタイムライン。遷移の詳細を表示する方法については、<xref linkend="sec-conf-hawk2-history-transitions" xrefstyle="select:label"/>を参照してください。
    </para>
   </listitem>
   <listitem>
    <para>
     ノードイベント.
    </para>
   </listitem>
   <listitem>
    <para>
     リソースイベント.
    </para>
   </listitem>
  </itemizedlist>
 </sect2>

 <sect2 xml:id="sec-conf-hawk2-history-transitions">
  <title>履歴エクスプローラーの遷移詳細の表示</title>
  <para>
   各遷移ごとに、クラスタは状態のコピーを保存し、これを<systemitem class="daemon">pacemaker-schedulerd</systemitem>への入力として提供します。このアーカイブへのパスがログ記録されます。すべての<filename>pe-*</filename>ファイルは指定コーディネータ(DC)上に生成されます。DCはクラスタ内で変更可能なため、いくつかのノードからの<filename>pe-*</filename>ファイルがある場合があります。すべての<filename>pe-*</filename>ファイルはCIBの保存済みスナップショットであり、<systemitem class="daemon">pacemaker-schedulerd</systemitem>による計算の入力として利用されます。
  </para>
  <para>
   Hawk2では、各<filename>pe-*</filename>ファイルの名前と作成時刻、およびそれが作成されたノードを表示できます。また、<guimenu>履歴エクスプローラー</guimenu>では、それぞれの<filename>pe-*</filename>ファイルに基づいて、次の詳細をビジュアル化できます。
  </para>
  <variablelist xml:id="vl-hawk2-history-transition-details">
   <title>履歴エクスプローラーでの遷移詳細</title>
   <varlistentry>
    <term><guimenu>詳細</guimenu>
    </term>
    <listitem>
     <para>
      遷移に属するログインデータのスニペットを表示します。次のコマンドの出力を表示します(リソースエージェントのログメッセージを含む)。
     </para>
<screen>crm history transition <replaceable>peinput</replaceable></screen>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><guimenu>設定</guimenu>
    </term>
    <listitem>
     <para>
      <filename>pe-*</filename>ファイルが作成された時刻でクラスタ設定を表示します。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><guimenu>差分</guimenu>
    </term>
    <listitem>
     <para>
      選択した<filename>pe-*</filename>ファイルと次のファイル間の設定と状態の相違を表示します。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><guimenu>ログ</guimenu>
    </term>
    <listitem>
     <para>
      遷移に属するログインデータのスニペットを表示します。次のコマンドの出力を表示します。
     </para>
<screen>crm history transition log <replaceable>peinput</replaceable></screen>
     <para>
      これには、<systemitem class="daemon">pacemaker-schedulerd</systemitem>、<systemitem class="daemon">pacemaker-controld</systemitem>および<systemitem class="daemon">pacemaker-execd</systemitem>の各デーモンの詳細が含まれています.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><guimenu>グラフ</guimenu>
    </term>
    <listitem>
     <para>
      遷移のグラフィカルな表現を示します。<guimenu>グラフ</guimenu>をクリックすると、(<systemitem class="daemon">pacemaker-schedulerd</systemitem>で実行したのものと同じ)計算がシミュレートされ、図表化されます。
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
  <procedure xml:id="pro-hawk2-history-transitions">
   <title>遷移詳細の表示</title>
   <step>
    <para>
     Hawk2にログインします。
    </para>
<screen>https://<replaceable>HAWKSERVER</replaceable>:7630/</screen>
   </step>
   <step>
    <para>
     左のナビゲーションバーから、<menuchoice><guimenu>トラブルシューティング</guimenu>
     <guimenu>履歴</guimenu></menuchoice>の順に選択します。
    </para>
    <para>
     レポートがすでに生成またはアップロードされている場合は、これらのレポートが<guimenu>レポート</guimenu>のリストに表示されます。そうでない場合は、<xref linkend="pro-hawk2-history-report" xrefstyle="select:label"/>で説明されるように、レポートを生成またはアップロードします。
    </para>
   </step>
   <step>
    <para>
     レポート名をクリックするか、<guimenu>操作</guimenu>列から<guimenu>表示</guimenu>を選択して、<xref linkend="il-hawk2-history-report-details"/>を開きます。
    </para>
   </step>
   <step>
    <para>
     遷移詳細にアクセスするには、下に示す遷移タイムラインの遷移ポイントを選択する必要があります。<guimenu>Previous (前へ)</guimenu>および<guimenu>Next (次へ)</guimenu>アイコンをおよび<guimenu>Zoom In (拡大)</guimenu>および<guimenu>Zoom Out (縮小)</guimenu>アイコンを使用して、興味ある遷移を探します。
    </para>
   </step>
   <step>
    <para>
     <filename>pe-input*</filename>ファイルの名前、それが作成された時刻およびノードを表示するには、タイムラインの遷移ポイントにマウスポインタを合わせます。
    </para>
   </step>
   <step>
    <para>
     <xref linkend="vl-hawk2-history-transition-details"/>を表示するには、さらに知りたい遷移ポイントをクリックします。
    </para>
   </step>
   <step>
    <para>
     <guimenu>詳細</guimenu>、<guimenu>環境設定</guimenu>、<guimenu>差分</guimenu>、<guimenu>Logs (ログ)</guimenu>または<guimenu>Graph (グラフ)</guimenu>を表示するには、各ボタンをクリックして<xref linkend="vl-hawk2-history-transition-details"/>で説明されるコンテンツを表示します。
    </para>
   </step>
   <step>
    <para>
     レポートのリストに戻るには、<guimenu>レポート</guimenu>ボタンをクリックします。
    </para>
   </step>
  </procedure>
 </sect2>

 <sect2 xml:id="sec-ha-config-crm-history">
  <title>crmshを使用した履歴情報の取得</title>
  <para>
   クラスタの履歴の調査は複雑な作業です。この作業を簡素化するために、crmshには<command>history</command>コマンドとそのサブコマンドが含まれています。これは、SSHが正しく設定されていることが前提となります。
  </para>
  <para>
   それぞれのクラスタは、状態を移動し、リソースを移行し、または重要なプロセスを開始します。これらすべてのアクションは、<command>history</command>のサブコマンドによって取得できます。
  </para>
  <para>
   デフォルトでは、すべての<command>history</command>コマンドは過去1時間のイベントを確認します。このタイムフレームを変更するには、<command>limit</command>サブコマンドを使用します。構文は次のとおりです。
  </para>
<screen><prompt role="root"># </prompt><command>crm history</command>
<prompt role="custom">crm(live)history# </prompt><command>limit <replaceable>FROM_TIME</replaceable> [<replaceable>TO_TIME</replaceable>]</command></screen>
  <para>
   有効な例として、次のようなものが挙げられます。
  </para>
  <variablelist>
   <varlistentry>
    <term><command>limit 4:00pm</command>
    </term>
    <term><command>limit 16:00</command>
    </term>
    <listitem>
     <para>
      どちらのコマンドも同じ意味で、今日の午後4時を表しています。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><command>limit 2012/01/12 6pm</command>
    </term>
    <listitem>
     <para>
      2012年1月12日の午後6時。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><command>limit "Sun 5 20:46"</command>
    </term>
    <listitem>
     <para>
      今年の今月の5日日曜日の午後8時46分。
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
  <para>
   その他の例とタイムフレームの作成方法については、<link xlink:href="https://labix.org/python-dateutil"/>を参照してください。
  </para>
  <para>
   <command>info</command>サブコマンドでは、<command>crm report</command>によって使用されているすべてのパラメータが表示されます。
  </para>
<screen><prompt role="custom">crm(live)history# </prompt><command>info</command>
Source: live
Period: 2012-01-12 14:10:56 - end
Nodes: alice
Groups:
Resources:</screen>
  <para>
   <command>crm report</command>を特定のパラメータに制限するには、サブコマンド<command>help</command>で使用可能なオプションを表示します。
  </para>
  <para>
   詳細レベルに絞り込んでいくには、サブコマンド<command>detail</command>とレベル数を使用します。
  </para>
<screen><prompt role="custom">crm(live)history# </prompt><command>detail 1</command></screen>
  <para>
   数値が大きいほど、レポートが詳細になっていきます。デフォルト値は<literal>0</literal> (ゼロ)です。
  </para>
  <para>
   ここまでのパラメータを設定したら、<command>log</command>を使用してログメッセージを表示します。
  </para>
  <para>
   最後の遷移を表示するには、次のコマンドを使用します。
  </para>
<screen><prompt role="custom">crm(live)history# </prompt><command>transition -1</command>
INFO: fetching new logs, please wait ...</screen>
  <para>
   このコマンドはログを取得し、<command>dotty</command> (<package>graphviz</package>パッケージから)を実行して、遷移グラフを表示します。シェルはログファイルを開きます。ログ内は、<keycap function="down"/>と<keycap function="up"/>カーソルキーでブラウズできます。
  </para>
  <para>
   遷移グラフを表示する必要がない場合には、<option>nograph</option>オプションを使用します。
  </para>
<screen><prompt role="custom">crm(live)history# </prompt><command>transition -1 nograph</command></screen>
 </sect2>
</sect1>
