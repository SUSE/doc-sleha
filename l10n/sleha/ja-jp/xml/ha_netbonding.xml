<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="ha_netbonding.xml" version="5.0" xml:id="cha-ha-netbonding">


 <title>ネットワークデバイスボンディング</title>
 <info>
  <abstract>
   <para>
   多くのシステムで、通常のEthernetデバイスの標準のデータセキュリティ/可用性の要件を超えるネットワーク接続の実装が望ましいことがあります。その場合、数台のEthernetデバイスを集めて1つのボンディングデバイスを設定できます。
   </para>
  </abstract>
      <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
        <dm:maintainer/>
        <dm:status>editing</dm:status>
        <dm:deadline/>
        <dm:priority/>
        <dm:translation>yes</dm:translation>
        <dm:languages/>
        <dm:release/>
        <dm:repository/>
      </dm:docmanager>
    </info>
 <para>
  ボンディングデバイスの設定には、ボンディングモジュールオプションを使用します。ボンディングデバイスの振る舞いは、ボンディングデバイスのモードによって決定されます。デフォルトの動作は、<systemitem>mode=active-backup</systemitem>であり、プライマリデバイスに障害が発生すると、別のデバイスがアクティブになります。
 </para>
 <para>
  Corosyncの使用時は、クラスタソフトウェアでボンディングデバイスが管理されることはありません。したがって、ボンディングデバイスにアクセスする可能性のあるクラスタノードごとに、ボンディングデバイスを設定する必要があります。
 </para>

 <sect1 xml:id="sec-ha-netbond-yast">
  <title>YaSTによるボンディングデバイスの設定</title>

  <para>
   ボンディングデバイスを設定するには、1つのボンディングデバイスに集めることができる数台のEthernetデバイスが必要です。以下に手順を示します。
  </para>

  <procedure>
   <step>
    <para>
     <systemitem class="username">root</systemitem>としてYaSTを開始し、<menuchoice>
     <guimenu>システム</guimenu> <guimenu>ネットワーク設定</guimenu>
     </menuchoice>の順に選択します。
    </para>
   </step>
   <step>
    <para>
     <guimenu>ネットワーク設定</guimenu>で、<guimenu>概要</guimenu>タブに切り替えて、使用可能なデバイスを表示します。
    </para>
   </step>
   <step>
    <para>
     1つのボンディングデバイスに集めるEthernetデバイスにIPアドレスが割り当てられているかどうかチェックします。割り当てられている場合は、それを変更します。
    </para>
    <substeps performance="required">
     <step>
      <para>
       選択するデバイスを選択して、<guimenu>編集</guimenu>をクリックします。
      </para>
     </step>
     <step xml:id="step-bond-slave">
      <para>
       開いている<guimenu>ネットワークカードの設定</guimenu>ダイアログの<guimenu>アドレス</guimenu>タブで、<guimenu>リンクおよびIPの設定無し(Bondポート)</guimenu>オプションを選択します。
      </para>
     </step>
     <step>
      <para>
       <guimenu>次へ</guimenu>をクリックして、<guimenu>ネットワーク設定</guimenu>ダイアログの<guimenu>Overview</guimenu>タブに戻ります。
      </para>
     </step>
    </substeps>
   </step>
   <step>
    <para>
     新しいボンディングデバイスを追加するには:
    </para>
    <substeps performance="required">
     <step>
      <para>
       <guimenu>追加</guimenu>をクリックして、<guimenu>デバイスの型</guimenu>を<guimenu>ボンド</guimenu>に変更します。<guimenu>次へ</guimenu>で続行します。
      </para>
     </step>
     <step>
      <para>
       IPアドレスをボンディングデバイスに割り当てる方法を選択します。3つの方法から選択できます。
      </para>
      <itemizedlist>
       <listitem>
        <para>
         リンクおよびIPの設定無し(Bondポート)
        </para>
       </listitem>
       <listitem>
        <para>
         可変IPアドレス(DHCPまたはZeroconf)
        </para>
       </listitem>
       <listitem>
        <para>
         固定IPアドレス
        </para>
       </listitem>
      </itemizedlist>
      <para>
       ご使用の環境に適合する方法を使用します。Corosyncで仮想IPアドレスを管理する場合は、<guimenu>静的割り当てIPアドレス</guimenu>を選択し、インタフェースにIPアドレスを割り当てます。
      </para>
     </step>
     <step>
      <para>
       <guimenu>Bondポート</guimenu>タブに切り替えます。
      </para>
     </step>
     <step>
      <para>
       ボンドに含めるEthernetデバイスを選択するには、各デバイスの前のチェックボックスを有効にします。
      </para>
     </step>
     <step>
      <para>
       <guimenu>ボンドドライバオプション</guimenu>を編集します。次のモードを使用できます。
      </para>
      <variablelist>
       <varlistentry>
        <term><literal>balance-rr</literal>
        </term>
        <listitem>
         <para>
          パケットが正しい順序で転送されなくなる代わりに、負荷分散と耐障害性が提供されます。これは、TCPの再構築時などに遅延の原因になる場合があります。
         </para>
        </listitem>
       </varlistentry>
       <varlistentry>
        <term><literal>active-backup</literal>
        </term>
        <listitem>
         <para>
          耐障害性を提供します。
         </para>
        </listitem>
       </varlistentry>
       <varlistentry>
        <term><literal>balance-xor</literal>
        </term>
        <listitem>
         <para>
          負荷分散と耐障害性を提供します。
         </para>
        </listitem>
       </varlistentry>
       <varlistentry>
        <term><literal>ブロードキャスト</literal>
        </term>
        <listitem>
         <para>
          耐障害性を提供します。
         </para>
        </listitem>
       </varlistentry>
       <varlistentry>
        <term><literal>802.3ad</literal>
        </term>
        <listitem>
         <para>
          接続されるスイッチでサポートされる場合は、ダイナミックリンク集合を提供します。
         </para>
        </listitem>
       </varlistentry>
       <varlistentry>
        <term><literal>balance-tlb</literal>
        </term>
        <listitem>
         <para>
          発信トラフィックの負荷分散を提供します。
         </para>
        </listitem>
       </varlistentry>
       <varlistentry>
        <term><literal>balance-alb</literal>
        </term>
        <listitem>
         <para>
          使用中にハードウェアアドレスの変更が可能なネットワークデバイスを使用する場合は、着信トラフィックと発信トラフィックの負荷分散を提供します。
         </para>
        </listitem>
       </varlistentry>
      </variablelist>
     </step>
     <step>
      <para>
       <guimenu>ボンドドライバオプション</guimenu>には、パラメータ<literal>miimon=100</literal>を必ず追加します。このパラメータがなければ、リンクが定期的にチェックされないため、ボンディングドライバは、障害リンクで引き続きパケットを失う可能性があります。
      </para>
     </step>
    </substeps>
   </step>
   <step>
    <para>
     <guimenu>次へ</guimenu>をクリックして、<guimenu>OK</guimenu>でYaSTを終了し、ボンディングデバイスの設定を完了します。YaSTが<filename>/etc/sysconfig/network/ifcfg-bond<replaceable>DEVICENUMBER</replaceable></filename>に設定を書き込みます。
    </para>
   </step>
  </procedure>
 </sect1>

 <sect1 xml:id="sec-ha-netbond-hotpug-yast">
  <title>デバイスをボンドにホットプラグする</title>

  <para>
   ボンドのインタフェースを別のものに置き換える必要が生じることがあります。たとえば、それぞれのネットワークデバイスに常に障害が発生する場合などです。解決方法として、ホットプラグを設定します。デバイスをMACアドレスではなくバスIDによって一致させるために、<systemitem>udev</systemitem>ルールを変更する必要もあります。これにより、ハードウェアが許可する場合は、不具合のあるハードウェア(同じスロットにあるのにMACアドレスが異なるネットワークカードなど)を置き換えることができます。
  </para>

  <procedure>
   <title>デバイスをYaSTとのボンドにホットプラグする</title>

   <para>
    手動の設定を行う場合は、『SUSE Linux Enterprise Server Administration Guide』の「<citetitle>Basic Networking</citetitle>」の章の「<citetitle>Hotplugging of bond ports</citetitle>」というセクションを参照してください。
   </para>
   <step>
    <para>
     <systemitem class="username">root</systemitem>としてYaSTを開始し、<menuchoice>
     <guimenu>システム</guimenu> <guimenu>ネットワーク設定</guimenu>
     </menuchoice>の順に選択します。
    </para>
   </step>
   <step>
    <para>
     <guimenu>ネットワーク設定</guimenu>で、<guimenu>Overview</guimenu>タブに切り替えて、すでに設定済みのデバイスを表示します。デバイスがすでにボンドで設定されている場合は、<guimenu>メモ</guimenu>列に表示されます。
    </para>
   </step>
   <step>
    <para>
     1つのボンディングデバイスに集められたEthernetデバイスのそれぞれに対して、次の手順を実行します。
    </para>
    <substeps performance="required">
     <step>
      <para>
       選択するデバイスを選択して、<guimenu>編集</guimenu>をクリックします。<guimenu>Network Card Setup</guimenu>ダイアログが開きます。
      </para>
     </step>
     <step>
      <para>
       <guimenu>一般</guimenu>タブに切り替えて、<guimenu>デバイスのアクティブ化</guimenu>が［<literal>ホットプラグ</literal>］に設定されていることを確認します。
      </para>
     </step>
     <step>
      <para>
       <guimenu>ハードウェア</guimenu>タブに切り替えます。
      </para>
     </step>
     <step>
      <para>
       <guimenu>Udevルール</guimenu>で、<guimenu>変更</guimenu>をクリックして<guimenu>BusID</guimenu>オプションを選択します。
      </para>
     </step>
     <step>
      <para>
       <guimenu>OK</guimenu>および<guimenu>次へ</guimenu>をクリックして、<guimenu>ネットワーク設定</guimenu>ダイアログの<guimenu>Overview</guimenu>タブに戻ります。この時点でEthernetデバイスエントリをクリックすると、下のペインにバスIDを含むデバイスの詳細が表示されます。
      </para>
     </step>
    </substeps>
   </step>
   <step>
    <para>
     <guimenu>OK</guimenu>をクリックして変更を確定し、ネットワーク設定を終了します。
    </para>
   </step>
  </procedure>

  <para>
   ブート時にネットワークセットアップはホットプラグデバイスを待機しませんが、ボンドの準備が整うのを待機します。これには少なくとも1つのデバイスが利用可能であることが必要です。インタフェースの1つがシステムから削除されると(NICドライバからアンバインド、NICドライバの<command>rmmod</command>、または実際のPCIホットプラグ取り外し)、カーネルによってボンドから自動的に削除されます。システムに新しいカードが追加されると(スロットのハードウェアが置換されると)、<systemitem>udev</systemitem>は、バスベースの永続名規則を適用することで名前を変更し、<command>ifup</command>を呼び出します。<command>ifup</command>呼び出しによって、ボンドに自動的に追加されます。
  </para>
 </sect1>
 <sect1 xml:id="sec-ha-netbonding-more">
  <title>詳細の参照先</title>

  <para>
   全モードおよび多数のオプションの詳細については、「<guimenu>Linux Ethernet Bonding Driver HOWTO</guimenu>」に記載されています。これは、<systemitem>kernel-source</systemitem>パッケージをインストールした後に参照できる<filename>/usr/src/linux/Documentation/networking/bonding.txt</filename>ファイルの内容です。
  </para>

  <para>
   High Availabilityセットアップの場合は、そのファイルで説明されている<option>miimon</option>および<option>use_carrier</option>オプションが特に重要です。
  </para>


 </sect1>
</chapter>
