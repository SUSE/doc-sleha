<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="ha_config_hawk2.xml" xml:id="cha-conf-hawk2" version="5.0">
 <title>Hawk2を使用したクラスタリソースの設定と管理</title>
 <info>
  <abstract>
   <para>
    クラスタリソースを設定および管理する場合、 Hawk2、またはcrmシェル(crmsh)コマンドラインユーティリティのいずれかを使用します。Hawkがインストールされている前のバージョンの<phrase role="roductnamereg"><phrase os="sles">SUSE® Linux Enterprise High Availability Extension</phrase></phrase>からアップグレードする場合は、パッケージが現在のバージョン、Hawk2で置き換えられます。
   </para>

   <para>
    Hawk2のユーザフレンドリなWebインタフェースを使用すると、High AvailabilityクラスタをLinuxまたは非Linuxマシンから同様に監視および管理することができます。Hawk2には、(グラフィカルな)Webブラウザを使用して、クラスタの内部または外部の任意のマシンからアクセスできます。
   </para>
  </abstract>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:maintainer/>
   <dm:status>editing</dm:status>
   <dm:deadline/>
   <dm:priority/>
   <dm:translation>yes</dm:translation>
   <dm:languages/>
   <dm:release/>
   <dm:repository/>
  </dm:docmanager>
 </info>
 <sect1 xml:id="sec-conf-hawk2-req">
  <title>Hawk2の要件</title>

  <para>
   Hawk2にログインするには、次の要件を満たす必要があります。
  </para>

  <variablelist>
   <varlistentry>
    <term><package>hawk2</package> ［Package］</term>
    <listitem>
     <para>
      Hawk2で接続するすべてのクラスタノードに<package>hawk2</package>パッケージをインストールする必要があります。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Webブラウザ</term>
    <listitem>
     <para>
      Hawk2を使用してクラスタノードにアクセスするマシンに必要なものは、JavaScriptとクッキーを有効にして接続を確立できるグラフィカルなWebブラウザです。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Hawk2サービス</term>
    <listitem>
     <para>
      Hawk2を使用するには、このWebインタフェースで接続するノード上で、それぞれのWebサービスが開始されている必要があります。<xref linkend="pro-ha-hawk2-service"/>を参照してください。
     </para>
     <para>
      crmシェルで提供されているブートストラップスクリプトを使用してクラスタを設定した場合、Hawk2サービスはすでに有効になっています。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>各クラスタノードのユーザ名、グループおよびパスワード</term>
    <listitem>
     <para>
      Hawk2ユーザは<systemitem class="groupname">haclient</systemitem>グループのメンバーである必要があります。インストール時に<systemitem class="username">hacluster</systemitem>という名前のLinuxユーザが作成されますが、このユーザが<systemitem class="groupname">haclient</systemitem>グループに追加されます。
     </para>
     <para>
      セットアップ用に<command>crm cluster init</command>スクリプトを使用している場合は、<systemitem class="username">hacluster</systemitem>ユーザに対してデフォルトパスワードが設定されます。Hawk2を起動する前に、安全なパスワードに変更してください。<command>crm cluster init</command>スクリプトを使用しなかった場合は、最初に<systemitem class="username">hacluster</systemitem>のパスワードを設定するか、または<systemitem class="groupname">haclient</systemitem>グループのメンバーである新しいユーザを作成します。Hawk2を使用して接続する各ノードでこれを実行します。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>ワイルドカード証明書の処理</term>
    <listitem>
     <para>
      ワイルドカード証明書は、複数のサブドメインに対して有効な公開鍵証明書です。たとえば、<systemitem class="domainname">*.example.com</systemitem>のワイルドカード証明書は、ドメイン<systemitem class="domainname">login.example.com</systemitem>、<systemitem class="domainname">www.example.com</systemitem>などをセキュリティ保護します。
     </para>
     <para>
      Hawk2はワイルドカード証明書と従来の証明書をサポートします。自己署名のデフォルトの公開鍵および証明書は<filename>/srv/www/hawk/bin/generate-ssl-cert</filename>で生成されます。
     </para>
     <para>
      独自の証明書(従来型またはワイルドカード)を使用するには、<filename>/etc/ssl/certs/hawk.pem</filename>で生成された証明書を独自の証明書に置き換えます。
     </para>
    </listitem>
   </varlistentry>
  </variablelist>

  <procedure xml:id="pro-ha-hawk2-service">
   <title>Hawk2サービスの開始</title>
   <step>
    <para>
     接続先にするノードで、シェルを開き、<systemitem class="username">root</systemitem>としてログインします。
    </para>
   </step>
   <step>
    <para>
     次のように入力して、サービスのステータスをチェックします。
    </para>
<screen><prompt role="root">root # </prompt><command>systemctl</command> status hawk</screen>
   </step>
   <step>
    <para>
     サービスが実行されていない場合は、次のコマンドでサービスを開始します。
    </para>
<screen><prompt role="root">root # </prompt><command>systemctl</command> start hawk</screen>
    <para>
     ブート時にHawk2を自動的に起動したい場合は、次のコマンドを実行します。
    </para>
<screen><prompt role="root">root # </prompt><command>systemctl</command> enable hawk</screen>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="sec-conf-hawk2-login">
  <title>ログイン</title>

  <para>
   Hawk2 Webインタフェースは、HTTPSプロトコルとポート<literal>7630</literal>を使用します。
  </para>

  <para>
   Hawk2を使用して個々のクラスタノードにログインする代わりに、浮動、仮想IPアドレス(<literal>IPaddr</literal>または<literal>IPaddr2</literal>)をクラスタリソースとして設定できます。そのための特別な設定は不要です。サービスがどの物理ノードで実行されていても、クライアントはHawkサービスに接続できます。
  </para>

  <para>
   クラスタをcrmシェルで提供されているブートストラップスクリプトを使用して設定する際には、クラスタ管理用に仮想IPを設定するかどうかを尋ねられます。
  </para>

  <procedure xml:id="pro-ha-hawk2-login">
   <title>Hawk2 Webインタフェースへのログイン</title>
   <step>
    <para>
     いずれかのマシンでWebブラウザを起動し、次のURLを入力します。
    </para>
<screen>https://<replaceable>HAWKSERVER</replaceable>:7630/</screen>
    <para>
     <replaceable>HAWKSERVER</replaceable>の部分は、Hawk Webサービスを実行するクラスタノードのIPアドレスまたはホスト名で置き換えます。Hawk2でクラスタ管理用に仮想IPアドレスを設定した場合、その仮想IPアドレスで<replaceable>HAWKSERVER</replaceable>を置き換えます。
    </para>
    <note>
     <title>証明書の警告</title>
     <para>
      初めてURLにアクセスしようとするときに証明書の警告が表示される場合は、自己署名証明書が使用されています。自己署名証明書は、デフォルトでは信頼されません。
     </para>
     <para>
      証明書を検証するには、クラスタオペレータに証明書の詳細を求めます。
     </para>
     <para>
      続行するには、ブラウザに例外を追加して警告をバイパスします。
     </para>
     <para>
      自己署名証明書を公式認証局によって署名された証明書で置き換える方法の詳細については、<xref linkend="vle-trouble-hawk2-cert"/>を参照してください。
     </para>
    </note>
   </step>
   <step>
    <para>
     Hawk2ログイン画面で、<systemitem class="username">hacluster</systemitem>ユーザ(または、<systemitem class="groupname">haclient</systemitem>グループのメンバーである他の任意のユーザ)の<guimenu>ユーザ名</guimenu>と<guimenu>パスワード</guimenu>を入力します。
    </para>
   </step>
   <step>
    <para>
     <guimenu>ログイン</guimenu>をクリックします。
    </para>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="sec-conf-hawk2-overview">
  <title>Hawk2の概要: 主な構成要素</title>

  <para>
   Hawk2にログインすると、左側にはナビゲーションバー、右側には複数のリンクが含まれる最上位の行が表示されます。
  </para>

  <note>
   <title>Hawk2で利用できる機能</title>
   <para>
    デフォルトでは、<systemitem class="username">root</systemitem>または<systemitem class="username">hacluster</systemitem>としてログインしたユーザは、すべてのクラスタ設定作業への、完全な読み込み/書き込みのアクセス権を持ちます。ただし、<xref linkend="cha-ha-acl" xrefstyle="select:title"/>(ACL)を使用すれば、より詳細なアクセス権限を定義することができます。
   </para>
   <para>
    CRMでACLが有効になっている場合、Hawk2で利用できる機能は、ユーザ役割と割り当てられたアクセスパーミッションごとに異なります。Hawk2の<guimenu>履歴エクスプローラ</guimenu>は、ユーザ<systemitem class="username">hacluster</systemitem>のみが実行できます。
   </para>
  </note>

  <sect2 xml:id="sec-conf-hawk2-overview-leftnav">
   <title>左のナビゲーションバー</title>
   <variablelist>
    <varlistentry>
     <term><guimenu>監視</guimenu>
     </term>
     <listitem>
      <itemizedlist>
       <listitem>
        <para>
         <guimenu>状態</guimenu>: クラスタの現在の状態の概要が表示されます(crmshの<command>crm status</command>と同様です)。詳細については、<xref linkend="sec-conf-hawk2-manage-monitor-status"/>を参照してください。クラスタに<literal>guest nodes</literal> (<literal>pacemaker_remote</literal>デーモンが実行されているノード)が含まれる場合、それらのノードも表示されます。
         <remark>taroth 2018-10-30: check and probably mention in more detail in
         'sec.conf.hawk2.manage.monitor.status' for next revision</remark>
         この画面はほぼリアルタイムで更新され、ノードまたはリソースの状態に変化があった場合、ほとんど瞬時に表示されます。
        </para>
       </listitem>
       <listitem>
        <para>
         <guimenu>ダッシュボード</guimenu>: 複数のクラスタを監視できます(Geoクラスタがセットアップされている場合は、別のサイトにあるクラスタも監視できます)。詳細については、<xref linkend="sec-conf-hawk2-manage-monitor-dash"/>を参照してください。クラスタに<literal>guest nodes</literal> (<literal>pacemaker_remote</literal>デーモンが実行されているノード)が含まれる場合、それらのノードも表示されます。
         <remark>taroth 2018-10-30: check and probably mention in more detail in
         'sec.conf.hawk2.manage.monitor.status' for next revision</remark>この画面はほぼリアルタイムで更新され、ノードまたはリソースの状態に変化があった場合、ほとんど瞬時に表示されます。
        </para>
       </listitem>
      </itemizedlist>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><guimenu>トラブルシューティング</guimenu>
     </term>
     <listitem>
      <itemizedlist>
       <listitem>
        <para>
         <guimenu>履歴</guimenu>: <guimenu>履歴エクスプローラー</guimenu>を開いてクラスタレポートを生成できます。詳細については、<xref linkend="sec-conf-hawk2-history"/>を参照してください。
        </para>
       </listitem>
       <listitem>
        <para>
         <guimenu>Command Log (コマンドログ)</guimenu>: Hawk2によって最近実行されたcrmshコマンドのリストを表示します。
        </para>
       </listitem>
      </itemizedlist>
     </listitem>
    </varlistentry>
     <varlistentry>
      <term>設定</term>
     <listitem>
      <itemizedlist>
       <listitem>
        <para>
         <guimenu>リソースの追加</guimenu>: リソース設定画を開きます。詳細については、<xref linkend="sec-conf-hawk2-rsc"/>を参照してください。 </para>
       </listitem>
       <listitem>
        <para>
         <guimenu>制約の追加</guimenu>: 制約設定画面を開きます。詳細については、<xref linkend="sec-conf-hawk2-cons"/>を参照してください。 </para>
       </listitem>
       <listitem>
        <para>
         <guimenu>ウィザード</guimenu>: さまざまなウィザードを選択できます。これにより、DRBDブロックデバイスなどの特定のワークロード用のリソースをウィザードに従って作成できます。詳細については、<xref linkend="sec-conf-hawk2-rsc-wizard"/>を参照してください。 </para>
       </listitem>
       <listitem>
        <para>
         <guimenu>設定の編集</guimenu>: リソース、制約、ノード名と属性、タグ、<link xlink:href="http://crmsh.github.io/man/#cmdhelp_configure_alert">アラート</link>、<link xlink:href="http://crmsh.github.io/man/#cmdhelp_configure_fencing_topology">フェンシングトポロジ</link>などを編集できます。
         </para>
       </listitem>
       <listitem>
        <para>
         <guimenu>クラスタ設定</guimenu>: グローバルクラスタオプション、およびリソースと操作のデフォルトを変更できます。詳細については、<xref linkend="sec-conf-hawk2-cluster-config"/>を参照してください。 </para>
       </listitem>
       <listitem>
        <para>
         <menuchoice>
          <guimenu>アクセス制御</guimenu>
          <guimenu>Roles (役割)</guimenu>
         </menuchoice>: アクセス制御リスト(CIBへのアクセス権を記述した一連のルール)に対して役割を作成できる画面を開きます。詳細については、<xref linkend="pro-ha-acl-hawk2-role"/>を参照してください。 </para>
       </listitem>
       <listitem>
        <para>
         <menuchoice>
          <guimenu>アクセス制御</guimenu>
          <guimenu>Targets (ターゲット)</guimenu>
         </menuchoice>: アクセス制御リストのターゲット(システムユーザ)を作成して、そのターゲットに役割を割り当てることができる画面を開きます。詳細については、<xref linkend="pro-ha-acl-hawk2-target"/>を参照してください。 </para>
       </listitem>
      </itemizedlist>
     </listitem>
    </varlistentry>
   </variablelist>
  </sect2>

  <sect2 xml:id="sec-conf-hawk2-overview-toprow">
   <title>最上位の行</title>
   <para>
    Hawk2の最上位の行には、次のエントリが表示されます。
   </para>
   <itemizedlist>
    <listitem>
     <para>
      <guimenu>バッチ</guimenu>: クリックすると、バッチモードに切り替わります。これにより、変更をシミュレートしてステージングし、それらの変更を単一のトランザクションとして適用できます。詳細については、<xref linkend="sec-conf-hawk2-batch"/>を参照してください。
     </para>
    </listitem>
    <listitem>
     <para>
      <guimenu><replaceable>ユーザ名</replaceable></guimenu>: Hawk2用の設定ができます(たとえば、Webインタフェースの言語の設定やSTONITHを無効にした場合に警告を表示するかなどの設定)。
     </para>
    </listitem>
    <listitem>
     <para>
      <guimenu>Help (ヘルプ)</guimenu>: <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise High Availability Extension</phrase></phrase>ドキュメントにアクセスしたり、リリースノートを参照したり、バグを報告したりします。
     </para>
    </listitem>
    <listitem>
     <para>
      <guimenu>ログアウト</guimenu>: クリックするとログアウトします。
     </para>
    </listitem>
   </itemizedlist>
  </sect2>
 </sect1>
 <sect1 xml:id="sec-conf-hawk2-cluster-config">
  <title>グローバルクラスタオプションの設定</title>

  <para>
   グローバルクラスタオプションは、一定の状況下でのクラスタの動作を制御します。これらは、セットにグループ化され、Hawk2、crmshなどのクラスタ管理ツールで表示し、変更することができます。事前に定義されている値は、通常は、そのまま保持できます。ただし、クラスタの主要機能を正しく機能させるには、クラスタの基本的なセットアップ後に、次のパラメータを調整する必要があります。
  </para>

  <itemizedlist>
   <listitem>
    <para>
     <xref linkend="sec-ha-config-basics-global-quorum" xrefstyle="select:title"/>
    </para>
   </listitem>
   <listitem>
    <para>
     <xref linkend="sec-ha-config-basics-global-stonith" xrefstyle="select:title"/>
    </para>
   </listitem>
  </itemizedlist>

  <procedure xml:id="pro-conf-hawk2-global">
   <title>グローバルクラスタオプションの変更</title>
   <step>
    <para>
     Hawk2にログインします。
    </para>
<screen>https://<replaceable>HAWKSERVER</replaceable>:7630/</screen>
   </step>
   <step>
    <para>
     左のナビゲーションバーから、<menuchoice>
     <guimenu>環境設定</guimenu><guimenu>クラスタ設定</guimenu>
     </menuchoice>を選択します。
    </para>
    <para>
     <guimenu>クラスタ設定</guimenu>画面が開きます。グローバルクラスタオプションとその現在の値が表示されます。
    </para>
    <para>
     画面の右側にパラメータの簡単な説明を表示するには、マウスポインタをパラメータに合わせます。
     <remark>taroth 2017-08-10: this does no longer seem to be the case
      @ayoub: are those descriptions gone on purpose?</remark>
    </para>
    <figure pgwide="0">
     <title>Hawk2 - クラスタの設定</title>
     <mediaobject>
      <imageobject role="fo">
       <imagedata fileref="hawk2-cluster-config.png" width="100%"/>
      </imageobject>
      <imageobject role="html">
       <imagedata fileref="hawk2-cluster-config.png" width="100%"/>
      </imageobject>
     </mediaobject>
    </figure>
   </step>
   <step>
    <para>
     <guimenu>no-quorum-policy</guimenu>および<guimenu>stonith-enabled</guimenu>の値を確認し、必要に応じて調整します。
    </para>
    <substeps performance="required">
     <step>
      <para>
       <guimenu>no-quorum-policy</guimenu>を適切な値に設定します。詳しくは「<xref linkend="sec-ha-config-basics-global-quorum"/>」を参照してください。
      </para>
     </step>
     <step>
      <para>
       何らかの理由でフェンシングを無効にする必要がある場合は、<guimenu>stonith-enabled</guimenu>を<literal>no</literal>に設定します。通常のクラスタ操作にはSTONITHデバイスの使用が必要なため、デフォルトでは、<literal>true</literal>に設定されています。デフォルト値では、クラスタは、STONITHリソースが設定されていない場合にはリソースの開始を拒否します。
      </para>
        <important>
      <title>STONITHがない場合はサポートなし</title>
      <itemizedlist>
       <listitem>
        <para>クラスタにはノードフェンシングメカニズムが必要です。</para>
       </listitem>
       <listitem>
        <para>グローバルクラスタオプション<systemitem>stonith-enabled</systemitem>および<systemitem>startup-fencing</systemitem>を<literal>true</literal>に設定する必要があります。これらを変更するとサポートされなくなります。</para>
       </listitem>
      </itemizedlist>
      </important>
      </step>
     <step>
      <para>
       クラスタ設定からパラメータを削除するには、パラメータの横の<guimenu>マイナス</guimenu>アイコンをクリックします。パラメータを削除すると、クラスタはそのパラメータがデフォルト値に設定されている場合と同様に動作します。
      </para>
     </step>
     <step>
      <para>
       クラスタ設定に新たなパラメータを追加するには、ドロップダウンボックスから選択します。
      </para>
     </step>
    </substeps>
   </step>

   <step>
    <para>
     <guimenu>リソースのデフォルト</guimenu>または<guimenu>操作のデフォルト</guimenu>を変更する必要がある場合は、次のような処理を実行します。
    </para>
    <substeps performance="required">
     <step>
      <para>
       値を調整するには、ドロップダウンボックスから別の値を選択するか、値を直接編集します。
      </para>
     </step>
     <step>
      <para>
       新しいリソースのデフォルトまたは操作のデフォルトを追加するには、空のドロップダウンボックスから1つ選択し、値を入力します。デフォルト値が存在する場合は、Hawk2から自動的に提示されます。
      </para>
     </step>
     <step>
      <para>
       パラメータを削除するには、その横の<guimenu>マイナス</guimenu>アイコンをクリックします。<guimenu>リソースのデフォルト</guimenu>と<guimenu>操作のデフォルト</guimenu>に値が指定されていない場合、クラスタは<xref linkend="sec-ha-config-basics-meta-attr"/>および<xref linkend="sec-ha-config-basics-operations"/>にドキュメントされているデフォルト値を使用します。
      </para>
     </step>
    </substeps>
   </step>
   <step>
    <para>
     変更内容を確認します。
    </para>
   </step>
  </procedure>
 </sect1>
 <xi:include href="ha_hawk2_rsc_i.xml"/>
 <xi:include href="ha_hawk2_cons_i.xml"/>
 <xi:include href="ha_hawk2_manage_i.xml"/>

 <xi:include href="ha_hawk2_monitor_i.xml"/>
 <xi:include href="ha_hawk2_batch_i.xml"/>
 <xi:include href="ha_hawk2_history_i.xml"/>
 <xi:include href="ha_hawk2_health_i.xml"/>
</chapter>
