<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="ha_acl.xml" version="5.0" xml:id="cha-ha-acl">
 <title>アクセス制御リスト</title>
 <info>
      <abstract>
        <para>
    crmシェル(crmsh)またはHawk2などのクラスタ管理ツールは、<systemitem class="username">root</systemitem>ユーザまたは<systemitem class="groupname">haclient</systemitem>グループ内のユーザが使用できます。デフォルトで、これらのユーザは完全な読み込み/書き込みのアクセス権を持ちます。アクセスを制限するか、または詳細なアクセス権を割り当てるには、<emphasis></emphasis>「アクセス制御リスト」(ACL)を使用できます。
   </para>
        <para>
    アクセス制御リストは、順序付けされたアクセスルールセットで構成されています。各ルールにより、クラスタ設定の一部への読み込みまたは書き込みアクセスの許可、またはアクセスの拒否が行われます。ルールは通常、組み合わせて特定の役割を生成し、ユーザを自分のタスクに一致する役割に割り当てることができます。
   </para>
      </abstract>
      <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
        <dm:maintainer/>
        <dm:status>editing</dm:status>
        <dm:deadline/>
        <dm:priority/>
        <dm:translation>yes</dm:translation>
        <dm:languages/>
        <dm:release/>
        <dm:repository/>
      </dm:docmanager>
    </info>
    <para>

 </para>
 <note>
  <title>CIB構文検証バージョンとACLとの違い</title>
  <para>
   このACLマニュアルは、<literal>pacemaker-2.0</literal>以上のCIB構文バージョンでCIBを検証する場合にのみ適用します。この検証方法およびCIBバージョンのアップグレード方法の詳細については、<xref linkend="note-ha-cib-upgrade"/>を参照してください。
  </para>
  
   
 </note>
 <sect1 xml:id="sec-ha-acl-require">
  <title>要件と前提条件</title>

  <para>
   クラスタでACLの使用を開始する前に、次の条件が満たされていることを確認します。
  </para>

  <itemizedlist>
   <listitem>
    <para>
     NIS、Active Directoryを使用するか、またはすべてのノードに同じユーザを手動で追加して、クラスタ内のすべてのノード上に同じユーザがいることを確認します。
    </para>
   </listitem>
   <listitem>
    <para>
     ACLでアクセス権を変更したいすべてのユーザが<systemitem class="groupname">haclient</systemitem>グループに属している必要があります。
    </para>
   </listitem>
   <listitem>
    <para>
     すべてのユーザが絶対パス<filename>/usr/sbin/crm</filename>でcrmshを実行する必要があります。
    </para>
   </listitem>
   <listitem>
    <para>
     権限のないユーザがcrmshを実行する場合は、<filename>/usr/sbin</filename>を使用して、<envar>PATH</envar>変数を展開する必要があります。
    </para>
   </listitem>
  </itemizedlist>

  <important>
   <title>デフォルトのアクセス権</title>
   <itemizedlist>
    <listitem>
     <para>
      ACLはオプションの機能です。デフォルトでは、ACLの使用は無効になっています。
     </para>
    </listitem>
    <listitem>
     <para>
      ACL機能が無効化された場合、<systemitem class="username">root</systemitem>および<systemitem class="groupname">haclient</systemitem>グループに属するすべてのユーザは、クラスタ設定への完全な読み込み/書き込みアクセス権を持ちます。
     </para>
    </listitem>
    <listitem>
     <para>
      ACLが有効化され、設定される場合でも、<systemitem class="username">root</systemitem>およびデフォルトのCRM所有者は両方とも、「常に」<systemitem class="username">hacluster</systemitem>
      <emphasis></emphasis>クラスタ設定への完全なアクセス権を持ちます。
     </para>
    </listitem>
   </itemizedlist>
  </important>

 </sect1>

 <sect1 xml:id="sec-ha-acl-basics">
  <title>概念の概要</title>

  <para>
   アクセス制御リストは、順序付けされたアクセスルールセットで構成されています。各ルールにより、クラスタ設定の一部への読み込みまたは書き込みアクセスの許可、またはアクセスの拒否が行われます。ルールは通常、組み合わせて特定の役割を生成し、ユーザを自分のタスクに一致する役割に割り当てることができます。ACLの役割はCIBへのアクセス権を表すルールのセットです。ルールは次の要素で構成されています。
  </para>

  <itemizedlist>
   <listitem>
    <para>
     <literal>read</literal>、<literal>write</literal>、または<literal>deny</literal>のようなアクセス権。
    </para>
   </listitem>
   <listitem>
    <para>
     ルールを適用する場所の指定。種類、ID参照、またはXPath式を使用して指定できます。XPathはXMLドキュメントでノードを選択するための言語です。<link xlink:href="http://en.wikipedia.org/wiki/XPath"/>を参照してください。
    </para>
   </listitem>
  </itemizedlist>

  <para>
   通常、ACLを役割にバンドルし、システムユーザ(ACLターゲット)に特定の役割を割り当てると便利です。ACLルールを作成するためには、次の方法があります。
  </para>

  <itemizedlist>
   <listitem>
    <para>
     <xref linkend="sec-ha-acl-config-xpath"/>をクリックします。ACLルールを作成するためには、その記述言語であるXMLの構造を理解している必要があります。
    </para>
   </listitem>
   <listitem>
    <para>
     <xref linkend="sec-ha-acl-config-tag"/>をクリックします。簡略構文を作成し、ACLルールが一致するオブジェクトに適用します。
    </para>
   </listitem>
  </itemizedlist>
 </sect1>

 <sect1 xml:id="sec-ha-acl-enable">
  <title>クラスタでのACLの使用の有効化</title>

  <para>
   ACLの設定を開始する前に、ACLの使用を<emphasis></emphasis>「有効にする」必要があります。有効にするには、crmshで次のコマンドを使用します。
  </para>

  <screen><prompt role="root">root # </prompt><command>crm</command> configure property enable-acl=true</screen>
  <para>
   または、<xref linkend="pro-ha-acl-enable-hawk2"/>で説明するように、Hawk2を使用します。
  </para>

  <procedure xml:id="pro-ha-acl-enable-hawk2">
   <title>Hawk2でのACLの使用の有効化</title>
   <step>
    <para>
     Hawk2にログインします。
    </para>
    <screen>https://<replaceable>HAWKSERVER</replaceable>:7630/</screen>
   </step>
   <step>
    <para>
     左のナビゲーションバーで、<guimenu>クラスタ設定</guimenu>を選択して、グローバルクラスタオプションとそれらの現在の値を表示します。
    </para>
   </step>
   <step>
    <para>
     <guimenu>クラスタ設定</guimenu>の下にある空のドロップダウンボックスをクリックし、<guimenu>enable-acl</guimenu>を選択してパラメータを追加します。デフォルト値<literal>No</literal>で追加されます。
    </para>
   </step>
   <step>
    <para>
     値を<literal>Yes</literal>に設定して変更を適用します。
    </para>
   </step>
  </procedure>

 </sect1>

 <sect1 xml:id="sec-ha-acl-create-ro-monitor-role">
  <title>読み込み専用monitor役割の作成</title>
  <para>
   次のサブセクションでは、Hawk2またはcrmシェルのいずれかで<systemitem>monitor</systemitem>役割を定義することにより、読み込み専用アクセスを設定する方法について説明します。
  </para>

  <sect2 xml:id="sec-ha-acl-config-hawk2">
   <title>Hawk2による読み込み専用monitor役割の作成</title>
   <para>
    次の手順は、<systemitem>monitor</systemitem>役割を定義し、それをユーザに割り当てることで、クラスタ設定への読み込み専用アクセスを設定する方法を示しています。または、<xref linkend="pro-ha-acl-crm"/>で説明されているように、crmshを使用してこの操作を実行することもできます。
   </para>
   <procedure xml:id="pro-ha-acl-hawk2-role">
    <title>Hawk2によるmonitor役割の追加</title>
    <step>
     <para>
      Hawk2にログインします。 </para>
     <screen>https://<replaceable>HAWKSERVER</replaceable>:7630/</screen>
    </step>
    <step>
     <para>
      左のナビゲーションバーで、<guimenu>役割</guimenu>を選択します。
     </para>
    </step>
    <step>
     <para>
      <guimenu>作成</guimenu>をクリックします。
     </para>
    </step>
    <step>
     <para>
      固有な「<guimenu>役割ID</guimenu>」として、<literal>monitor</literal>などを入力します。
     </para>
    </step>
    <step>
     <para>
      アクセス<guimenu>権利</guimenu>として、<literal>Read</literal>を選択します。
     </para>
    </step>
    <step>
     <para>
      <guimenu>Xpath</guimenu>として、XPath式<literal>/cib</literal>を入力します。
     </para>
     <informalfigure>
      <mediaobject>
       <imageobject role="fo">
        <imagedata fileref="hawk2-acl-role.png" width="100%" format="PNG"/>
       </imageobject>
       <imageobject role="html">
        <imagedata fileref="hawk2-acl-role.png" width="100%" format="PNG"/>
       </imageobject>
      </mediaobject>
     </informalfigure>
    </step>
    <step>
     <para>
      <guimenu>作成</guimenu>をクリックします。
     </para>
     <para>
      この操作は、<literal>monitor</literal>の名前を持つ新しい役割を作成して、<literal>read</literal>の権利を設定し、XPath式<literal>/cib</literal>を使用してCIB内のすべての要素に適用します。
     </para>
    </step>
    <step>
     <para>
      必要に応じてプラスアイコンをクリックしてルールを追加し、個別のパラメータを指定します。
     </para>
    </step>
    <step>
     <para>
      上矢印や下矢印のボタンを使用して、個別のルールをソートできます。
     </para>
    </step>
   </procedure>

   <procedure xml:id="pro-ha-acl-hawk2-target">
    <title>Hawk2によるターゲットへの役割割り当て</title>
    <para>
     <xref linkend="pro-ha-acl-hawk2-role" xrefstyle="select:label"/>で作成した役割をシステムユーザ(ターゲット)に割り当てるには、次の手順に従います。
    </para>
    <step>
     <para>
      Hawk2にログインします。 </para>
     <screen>https://<replaceable>HAWKSERVER</replaceable>:7630/</screen>
    </step>
    <step>
     <para>
      左のナビゲーションバーで、<guimenu>ターゲット</guimenu>を選択します。
     </para>
    </step>
    <step>
     <para>
      システムユーザ(ACLターゲット)を作成するには、<guimenu>作成</guimenu>をクリックして、固有の<guimenu>ターゲットID</guimenu>を入力します(例：<literal>tux</literal>)。このユーザが<systemitem class="groupname">haclient</systemitem>グループに属することを確認します。
     </para>
    </step>
    <step>
     <para>
      ターゲットに役割を割り当てるには、1つ以上の<guimenu>役割</guimenu>を選択します。
     </para>
     <para>
      例では、<xref linkend="pro-ha-acl-hawk2-role" xrefstyle="select:label"/>で作成した<literal>monitor</literal>役割を選択します。
     </para>
     <informalfigure>
      <mediaobject>
       <imageobject role="fo">
        <imagedata fileref="hawk2-acl-user-assign.png" width="100%" format="PNG"/>
       </imageobject>
       <imageobject role="html">
        <imagedata fileref="hawk2-acl-user-assign.png" width="80%" format="PNG"/>
       </imageobject>
      </mediaobject>
     </informalfigure>
    </step>
    <step>
     <para>
      選択内容を確認します。
     </para>
    </step>
   </procedure>
   <para>
    リソースや制約に対するアクセス権を設定するには、<xref linkend="sec-ha-acl-config-tag"/>で説明したように、短縮構文も使用できます。
   </para>
  </sect2>

  <sect2 xml:id="sec-ha-acl-config-crm">
   <title>crmshによる読み込み専用monitor役割の作成</title>
   <para>
    次の手順は、<literal>monitor</literal>役割を定義し、それをユーザに割り当てることで、クラスタ設定への読み込み専用アクセスを設定する方法を示しています。
   </para>

   <procedure xml:id="pro-ha-acl-crm">
    <title>monitor役割を追加して、crmshを持つユーザに割り当てる</title>
    <step>
     <para>
      <systemitem class="username">root</systemitem>としてログインします。
     </para>
    </step>
    <step>
     <para>
      crmshの対話モードを開始します。
     </para>
     <screen><prompt role="root">root # </prompt><command>crm</command> configure
<prompt role="custom">crm(live)configure# </prompt></screen>
    </step>
    <step>
     <para>
      ACLの役割を次のとおり定義します。
     </para>
     <substeps performance="required">
      <step>
       <para>
        <command>role</command>コマンドを使用して、新しい役割を定義します。
       </para>
       <screen><prompt role="custom">crm(live)configure# </prompt><command>role</command> monitor read xpath:"/cib"</screen>
       <para>
        前のコマンドは、<literal>monitor</literal>の名前を持つ新しい役割を作成して、<literal>read</literal>の権利を設定し、XPath式<literal>/cib</literal>を使用してCIB内のすべての要素に適用します。必要な場合は、アクセス権およびXPath引数をさらに追加できます。
       </para>
      </step>
      <step>
       <para>
        必要に応じてさらに役割を追加します。
       </para>
      </step>
     </substeps>
    </step>
    <step>
     <para>
      役割を1つ以上のACLターゲットに割り当てます。このACLターゲットは、該当のシステムユーザです。これらのシステムユーザが<systemitem class="groupname">haclient</systemitem>グループに属していることを確認します。
     </para>
     <screen><prompt role="custom">crm(live)configure# </prompt><command>acl_target</command> tux monitor</screen>
    </step>
    <step>
     <para>
      変更を確認します:。
     </para>
     <screen><prompt role="custom">crm(live)configure# </prompt><command>show</command></screen>
    </step>
    <step>
     <para>
      変更をコミットします。:
     </para>
     <screen><prompt role="custom">crm(live)configure# </prompt><command>commit</command></screen>
    </step>
   </procedure>

   <para>
    リソースや制約に対するアクセス権を設定するには、<xref linkend="sec-ha-acl-config-tag"/>で説明したように、短縮構文も使用できます。
   </para>
   
  </sect2>
 </sect1>

  <sect1 xml:id="sec-ha-acl-rm-user">
   <title>ユーザの削除</title>
   <para>
    次のサブセクションでは、Hawk2またはcrmshのいずれかで、ACLから既存のユーザを削除する方法について説明します。
   </para>
   <sect2 xml:id="sec-ha-acl-rm-user-hawk2">
    <title>Hawk2によるユーザの削除</title>
    <para>ACLからユーザを削除するには、次の手順に従います。</para>
    <procedure>
     <step>
      <para>
       Hawk2にログインします。 </para>
      <screen>https://<replaceable>HAWKSERVER</replaceable>:7630/</screen>
     </step>
     <step>
      <para>
       左のナビゲーションバーで、<guimenu>ターゲット</guimenu>を選択します。
      </para>
     </step>
     <step>
      <para>
       システムユーザ(ACLターゲット)を削除するには、<guimenu>操作</guimenu>列の下にあるごみ箱アイコンをクリックします。
      </para>
     </step>
     <step>
      <para>
       ダイアログボックスを確認します。
      </para>
     </step>
    </procedure>
   </sect2>
   <sect2 xml:id="sec-ha-acl-rm-user-crmsh">
     <title>crmshによるユーザの削除</title>
     <para> ACLからユーザを削除するには、プレースホルダ<replaceable>USER</replaceable>をユーザの名前で置き換えます置換します。 </para>
    <screen><prompt role="root">root # </prompt><command>crm</command> configure delete <replaceable>USERNAME</replaceable></screen>
    <para>
     別の方法として、<command>edit</command>サブコマンドを使用できます。
    </para>
    <screen><prompt role="root">root # </prompt><command>crm</command> configure edit <replaceable>USERNAME</replaceable></screen>
   </sect2>
  </sect1>

  <sect1 xml:id="sec-ha-acl-rm-role">
   <title>既存の役割の削除</title>
   <para>
    次のサブセクションでは、Hawk2またはcrmshのいずれかで、既存の役割を削除する方法について説明します。
   </para>
   <note>
    <title>参照されているユーザを含む役割の削除</title>
    <para>
     この役割にユーザを含めないでください。役割内にユーザへの参照がまだある場合、役割を削除できません。まず、ユーザへの参照を削除してから、役割を削除してください。
    </para>
   </note>

   <sect2 xml:id="sec-ha-acl-rm-role-hawk2">
    <title>Hawk2による既存の役割の削除</title>
    <para>役割を削除するには、次の手順に従います。</para>
    <procedure>
     <step>
      <para>
       Hawk2にログインします。 </para>
      <screen>https://<replaceable>HAWKSERVER</replaceable>:7630/</screen>
     </step>
     <step>
      <para>
       左のナビゲーションバーで、<guimenu>役割</guimenu>を選択します。
      </para>
     </step>
     <step>
      <para>
       役割を削除するには、<guimenu>操作</guimenu>列の下にあるごみ箱アイコンをクリックします。
      </para>
     </step>
     <step>
      <para>
       ダイアログボックスを確認します。エラーメッセージが表示される場合は、役割が<quote>空</quote>であり、ユーザを参照していないことを確認してください。
      </para>
     </step>
    </procedure>
   </sect2>
   <sect2 xml:id="sec-ha-acl-rm-role-crmsh">
    <title>crmshによる既存の役割の削除</title>
    <para>
    既存の役割を削除するには、プレースホルダ<replaceable>ROLE</replaceable>を役割の名前で置き換えます。
   </para>
   <screen><prompt role="root">root # </prompt><command>crm</command> configure delete <replaceable>ROLE</replaceable></screen>
   </sect2>
  </sect1>

 <sect1 xml:id="sec-ha-acl-config-xpath">
  <title>XPath式によるACLルールの設定</title>
  <para>
   XPathによってACLルールを管理するには、その記述言語であるXMLの構造を理解している必要があります。XMLでクラスタ設定を表示する次のコマンドで構造を取得します(<xref linkend="ex-ha-acl-excerpt" xrefstyle="select:label nopage"/>を参照)。
  </para>
  <screen><prompt role="root">root # </prompt><command>crm</command> configure show xml</screen>
  <remark>taroth 2014-08-13: filed https://bugzilla.novell.com/show_bug.cgi?id=891695 for a future "Show CIB"
   option in Hawk</remark>
  <example xml:id="ex-ha-acl-excerpt">
   <title>XML内のクラスタ設定の例</title>
   <screen>&lt;cib&gt;
  &lt;!-- ... --&gt;
  &lt;configuration&gt;
    &lt;crm_config&gt;
       &lt;cluster_property_set id="cib-bootstrap-options"&gt;
        &lt;nvpair name="stonith-enabled" value="true" id="cib-bootstrap-options-stonith-enabled"/&gt;
       [...]
      &lt;/cluster_property_set&gt;
    &lt;/crm_config&gt;
    &lt;nodes&gt;
      &lt;node id="175704363" uname="alice"/&gt;
      &lt;node id="175704619" uname="bob"/&gt;
    &lt;/nodes&gt;
    &lt;resources&gt; [...]  &lt;/resources&gt;
    &lt;constraints/&gt;
    &lt;rsc_defaults&gt; [...] &lt;/rsc_defaults&gt;
    &lt;op_defaults&gt; [...] &lt;/op_defaults&gt;
  &lt;configuration&gt;
&lt;/cib&gt;</screen>
  </example>
  <para>
   XPath言語を使用して、このXMLドキュメント内のノードを見つけることができます。たとえば、ルートノード(<literal>cib</literal>)を選択するには、XPath式<literal>/cib</literal>を使用します。グローバルクラスタ設定を見つけるには、XPath式<literal>/cib/configuration/crm_config</literal>を使用します。
  </para>
  <para>
   一例として、<xref linkend="tab-ha-acl-operator"/>は、<quote>オペレータ</quote>の役割を作成するためのパラメータ(アクセスタイプおよびXPath式)を示しています。この役割を持つユーザは、2番目の列で説明されるタスクのみ実行することができ、リソースを再構成することはできません(たとえば、パラメータや操作の変更など)。また、コロケーションや順序の制約の設定を変更することもできません。
  </para>
  <table xml:id="tab-ha-acl-operator">
   <title>オペレータ役割 - アクセスタイプおよびXPath式</title>
   <tgroup cols="2">
    <thead>
     <row>
      <entry>
       <para>
        タイプ
       </para>
      </entry>
      <entry>
       <para>
        XPath/説明
       </para>
      </entry>
     </row>
    </thead>
    <tbody>
     <row>
      <entry>
       <para>
        書き込み
       </para>
      </entry>
      <entry>
       <screen>//crm_config//nvpair[@name='maintenance-mode']</screen>
       <para>
        クラスタ保守モードをオンまたはオフにします。
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        書き込み
       </para>
      </entry>
      <entry>
       <screen>//op_defaults//nvpair[@name='record-pending']</screen>
       <para>
         保留中の操作を記録するかを選択します。
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        書き込み
       </para>
      </entry>
      <entry>
       <screen>//nodes/node//nvpair[@name='standby']</screen>
       <para>
        ノードをオンラインまたはスタンバイモードで設定します。
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        書き込み
       </para>
      </entry>
      <entry>
       <screen>//resources//nvpair[@name='target-role']</screen>
       <para>
        リソースを開始、停止、昇格または降格します。
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        書き込み
       </para>
      </entry>
      <entry>
       <screen>//resources//nvpair[@name='maintenance']</screen>
       <para>
        リソースを保守モードにするかどうかを選択します。
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        書き込み
       </para>
      </entry>
      <entry>
       <screen>//constraints/rsc_location</screen>
       <para>
        リソースをノードから別のノードにマイグレート/移動します。
       </para>
      </entry>
     </row>
     <row>
      <entry>
       <para>
        読み込み
       </para>
      </entry>
      <entry>
       <screen>/cib</screen>
       <para>
        クラスタのステータスを表示します。
       </para>
      </entry>
     </row>
    </tbody>
   </tgroup>
  </table>
 </sect1>

 <sect1 xml:id="sec-ha-acl-config-tag">
  <title>短縮によるACLルールの設定</title>
  <para>
   XML構造を扱いたくないユーザ向けには、より簡単な方法があります。
   
  </para>
  <para>
   たとえば、次のXPathを検討します。
  </para>
  <screen>//*[@id="rsc1"]</screen>
  <para>
   このXPathは、IDが<literal>rsc1</literal>であるXMLノードをすべて探し出します。
  </para>
  <para>
   短縮構文はこのように書かれます。
  </para>
  <screen>ref:"rsc1"</screen>
  <para>
   これは制約にも使用できます。これが冗長なXPathです。
  </para>
  <screen>//constraints/rsc_location</screen>
  <para>
   短縮構文はこのように書かれます。
  </para>
  <screen>type:"rsc_location"</screen>
  <para>
   短縮構文はcrmshおよびHawk2で使用できます。CIBデーモンは一致するオブジェクトにACLルールを適用する方法を認識しています。
  </para>
 </sect1>
</chapter>
