<?xml version="1.0" encoding="UTF-8"?>
<?xml-stylesheet href="urn:x-suse:xslt:profiling:docbook51-profile.xsl"
 type="text/xml"
 title="Profiling step"?>
<appendix xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="ha_iscsi_for_sbd.xml" xml:id="ha-iscsi-for-sbd" xml:lang="pt-br" version="5.1">
 <title>Armazenamento iSCSI básico para SBD</title>
 <info>
  <abstract>
   <para>
    Siga os procedimentos abaixo para configurar o armazenamento iSCSI básico que será usado com o SBD. Esses procedimentos são recomendados apenas para fins de teste. Antes de usar o iSCSI em um ambiente de produção, consulte o <link xlink:href="https://documentation.suse.com/sles/html/SLES-all/cha-iscsi.html">
    Storage Administration Guide for SUSE Linux Enterprise Server</link>.
   </para>
  </abstract>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
 </info>

 <itemizedlist>
  <title>Requisitos</title>
  <listitem>
   <para>
    Uma máquina virtual do SUSE Linux Enterprise Server para atuar como o destino iSCSI. Essa VM não faz parte do cluster.
   </para>
  </listitem>
  <listitem>
   <para>
    Dois dispositivos de armazenamento virtual na VM: um de 20 GB para o sistema e um de 1 GB para o SBD.
   </para>
  </listitem>
  <listitem>
   <para>
    Dois nós do SUSE Linux Enterprise Server que ainda não foram adicionados a um cluster de Alta Disponibilidade.
   </para>
  </listitem>
 </itemizedlist>

 <para>
  Primeiro, configure um destino iSCSI na máquina virtual:
 </para>

 <procedure xml:id="pro-iscsi-for-sbd-target">
  <title>Configurando um destino iSCSI</title>
  <step>
   <para>
    Instale o pacote <package>yast2-iscsi-lio-server</package>:
   </para>
<screen><prompt role="root"># </prompt><command>zypper install yast2-iscsi-lio-server</command></screen>
  </step>
  <step>
   <para>
    Inicie o módulo <literal>iscsi-lio-server</literal> no YaST:
   </para>
<screen><prompt role="root"># </prompt><command>yast2 iscsi-lio-server</command></screen>
  </step>
  <step>
   <para>
    Na guia <guimenu>Serviço</guimenu>, em <guimenu>Após reinicialização</guimenu>, selecione <guimenu>Iniciar na inicialização</guimenu>.
   </para>
  </step>
  <step>
   <para>
    Ative <guimenu>Abrir Porta no Firewall</guimenu>.
   </para>
  </step>
  <step>
   <para>
    Na guia <guimenu>Descoberta</guimenu>, ative <guimenu>Autenticação por descoberta</guimenu>.
    </para>
   </step>
  <step>
   <para>
    Em <guimenu>Autenticação por destinos</guimenu>, insira um <guimenu>Nome de usuário</guimenu> e uma <guimenu>Senha</guimenu>.
   </para>
  </step>
  <step>
   <para>
    Em <guimenu>Autenticação por Iniciadores</guimenu>, insira um <guimenu>Nome de usuário mútuo</guimenu> e uma <guimenu>Senha Mútua</guimenu>. Essa senha deve ser diferente da senha de <guimenu>Autenticação por destinos</guimenu>.
   </para>
  </step>
  <step>
   <para>
    Na guia <guimenu>Destino</guimenu>, selecione <guimenu>Adicionar</guimenu>.
   </para>
  </step>
  <step>
   <para>
    Mude o nome do <guimenu>Destino</guimenu> substituindo <literal>.com.example</literal>.
   </para>
  </step>
  <step>
   <para>
    Adicione o <guimenu>Endereço IP</guimenu> do servidor.
   </para>
  </step>
  <step>
   <para>
    Selecione <guimenu>Adicionar</guimenu>.
   </para>
  </step>
  <step>
   <para>
    Na janela <guimenu>Detalhes do LUN</guimenu>, insira o <guimenu>Caminho do LUN</guimenu> para o dispositivo de armazenamento de 1 GB (por exemplo, <filename>/dev/vbd</filename>).
   </para>
  </step>
  <step>
   <para>
    Selecione <guimenu>OK</guimenu>.
   </para>
  </step>
  <step>
   <para>
    Selecione <guimenu>Avançar</guimenu>.
   </para>
  </step>
  <step>
   <para>
    Selecione <guimenu>Concluir</guimenu> para fechar o YaST.
   </para>
  </step>
  <step>
   <para>
    Para verificar a configuração do destino, alterne para a CLI de destino:
   </para>
<screen><prompt role="root"># </prompt><command>targetcli</command></screen>
   <para>
    Mostre a configuração:
   </para>
<screen><prompt>/&gt; </prompt><command>ls</command></screen>
  </step>
 </procedure>

 <para>
  Em seguida, configure os iniciadores iSCSI nos nós. Repita esse procedimento nos dois nós:
 </para>

 <procedure xml:id="pro-iscsi-for-sbd-clients">
  <title>Configurando um iniciador iSCSI</title>
  <step>
   <para>
    Instale o pacote <package>yast2-iscsi-client</package>:
   </para>
<screen><prompt role="root"># </prompt><command>zypper install yast2-iscsi-client</command></screen>
  </step>
  <step>
   <para>
    Inicie o serviço <literal>iscsid</literal>:
   </para>
<screen><prompt role="root"># </prompt><command>systemctl start iscsid</command></screen>
  </step>
  <step>
   <para>
    Abra o módulo <literal>iscsi-client</literal> no YaST:
   </para>
<screen><prompt role="root"># </prompt><command>yast2 iscsi-client</command></screen>
  </step>
  <step>
   <para>
    Na guia <guimenu>Destinos descobertos</guimenu>, selecione <guimenu>Descoberta</guimenu>.
   </para>
  </step>
  <step>
   <para>
    Digite o endereço IP do destino iSCSI.
   </para>
  </step>
  <step>
   <para>
    Desmarque <guimenu>Sem autenticação por descoberta</guimenu>.
   </para>
  </step>
  <step>
   <para>
    Em <guimenu>Autenticação por iniciador</guimenu>, insira um <guimenu>Nome de usuário</guimenu> e uma <guimenu>Senha</guimenu>.
   </para>
  </step>
  <step>
   <para>
    Em <guimenu>Autenticação por destinos</guimenu>, insira um <guimenu>Nome de usuário</guimenu> e uma <guimenu>Senha</guimenu> de destino.
   </para>
  </step>
  <step>
   <para>
    Selecione <guimenu>Avançar</guimenu>.
   </para>
  </step>
  <step>
   <para>
    Depois que o YaST descobrir o destino iSCSI, selecione <guimenu>Conectar</guimenu>.
   </para>
  </step>
  <step>
   <para>
    Em <guimenu>Inicialização</guimenu>, selecione <guimenu>na inicialização</guimenu>.
   </para>
  </step>
  <step>
   <para>
    Selecione <guimenu>Avançar</guimenu>.
   </para>
  </step>
  <step>
   <para>
    Selecione <guimenu>OK</guimenu> para fechar o YaST.
   </para>
  </step>
  <step>
   <para>
    Verifique o iniciador iSCSI:
   </para>
<screen><prompt role="root"># </prompt><command>lsscsi</command>
[0:0:1:0] cd/dvd QEMU QEMU DVD-ROM 2.5+ /dev/sr0
[2:0:0:0] disk LIO-ORG IBLOCK 4.0 /dev/sda</screen>
   <para>
    Procure uma linha com <literal>IBLOCK</literal>. Neste exemplo, o dispositivo iSCSI é <literal>/dev/sda</literal>.
   </para>
  </step>
  <step>
   <para>
    Verifique o status do serviço <literal>iscsid</literal>:
   </para>
<screen><prompt role="root"># </prompt><command>systemctl status iscsid</command></screen>
  </step>
 </procedure>

 <para>
  Você pode encontrar o nome do dispositivo estável em <filename>/dev/disk/by-id/</filename>. Normalmente, um dispositivo iSCSI começa com <literal>scsi-SLIO-ORG_IBLOCK</literal>.
 </para>
 <para>
  Se você tem vários discos, pode executar o comando <command>lsblk -o name,serial</command> para confirmar qual nome de dispositivo estável corresponde a qual nome abreviado (por exemplo, <filename>/dev/sda</filename>).
 </para>
 <para>
  Ao configurar o cluster, especifique o nome do dispositivo estável usando um destes métodos:
 </para>
 <itemizedlist>
  <listitem>
   <para>
    Ao executar <command>crm cluster init</command>, digite o nome do dispositivo estável quando solicitado.
   </para>
  </listitem>
  <listitem>
   <para>
    Antes de executar <command>crm cluster init</command>, adicione o nome do dispositivo estável ao <filename>/etc/sysconfig/sbd</filename>:
   </para>
<screen>SBD_DEVICE=/dev/disk/by-id/scsi-SLIO-ORG_IBLOCK_<replaceable>DEVICE_ID_STRING</replaceable></screen>
   <para>
    Ao executar <command>crm cluster init</command>, responda à seguinte pergunta com <literal>n</literal>:
   </para>
<screen>SBD is already configured to use /dev/disk/by-id/scsi-SLIO-ORG_IBLOCK_... - overwrite (y/n)?</screen>
  </listitem>
 </itemizedlist>
</appendix>
