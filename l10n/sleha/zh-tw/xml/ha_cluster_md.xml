<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="ha_cluster_md.xml" xml:id="cha-ha-cluster-md" version="5.0">
 <title>叢集多裝置 (叢集 MD)</title>
 <info>
      <abstract>
        <para>叢集多裝置 (叢集 MD) 是一項基於軟體的叢集 RAID 儲存解決方案。目前，叢集 MD 為叢集提供了 RAID1 鏡像的備援。在 SUSE Linux Enterprise High Availability Extension15 SP5 中，隨附了 RAID10 做為技術預覽。如果您想嘗試 RAID，請在相關的 <literal>mirror</literal> 指令中使用 <literal>10</literal>10 取代 <command>mdadm</command>。本章介紹如何建立和使用叢集 MD。
   </para>
      </abstract>
      <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
        <dm:maintainer/>
        <dm:status>editing</dm:status>
        <dm:deadline/>
        <dm:priority/>
        <dm:translation>yes</dm:translation>
        <dm:languages/>
        <dm:release/>
        <dm:repository/>
      </dm:docmanager>
    </info>
    <sect1 xml:id="sec-ha-cluster-md-overview">
  <title>概念綜覽</title>
  <para>叢集 MD 提供了在叢集環境中使用 RAID1 的支援。每個節點都會存取叢集 MD 使用的磁碟或裝置。如果叢集 MD 的一部裝置失敗，則在執行時期可以由另一部裝置取代它，並且系統會對其進行重新同步以提供相同量的備援。叢集 MD 需要使用 Corosync 和分散式鎖定管理員 (DLM) 進行協調和通訊。
  </para>
  <para>
   叢集 MD 裝置不會如同其他常規 MD 裝置一般在開機時自動啟動。需要使用資源代理程式來啟動叢集裝置，以便確定 DLM 資源已啟動。
  </para>
  
 </sect1>
 <sect1 xml:id="sec-ha-cluster-md-create">
  <title>建立叢集化 MD RAID 裝置</title>
  <itemizedlist>
   <title>要求</title>
   <listitem>
    <para>一個安裝了 Pacemaker 的執行中叢集。</para>
   </listitem>
   <listitem>
    <para>DLM 的資源代理程式 (請參閱<xref linkend="sec-ha-storage-generic-dlm-config"/>)。</para>
   </listitem>
   <listitem>
    <para>至少兩個共用磁碟裝置。您可以使用另外一部裝置做為備用裝置，以便在裝置發生故障時自動進行容錯移轉。</para>
   </listitem>
   <listitem>
    <para>安裝的套件 <package>cluster-md-kmp-default</package>。</para>
   </listitem>
  </itemizedlist>

  <para>
   此程序使用 <literal>/dev/sd<replaceable>X</replaceable></literal> 裝置名稱做為範例。為了提高穩定性，請使用永久的裝置名稱，例如 <literal>/dev/disk/by-id/<replaceable>DEVICE_ID</replaceable></literal>。
  </para>

  <procedure>
   <step>
    <para>
     請確認 DLM 資源在叢集的每個節點上都正常執行，並使用以下指令檢查資源狀態：
    </para>
    <screen><prompt role="root"># </prompt><command>crm_resource -r dlm -W</command></screen>
   </step>
   <step>
    <para>建立叢集 MD 裝置：</para>
    <itemizedlist>
     <listitem>
      <para>
       如果您沒有現有的常規 RAID 裝置，請使用以下指令在執行 DLM 資源的節點上建立叢集 MD 裝置：
      </para>
      <screen><prompt role="root"># </prompt><command>mdadm --create /dev/md0 --bitmap=clustered \
   --metadata=1.2 --raid-devices=2 --level=mirror /dev/sda /dev/sdb</command></screen>
      <para>
       由於叢集 MD 只能與 1.2 版的中繼資料配合使用，因此建議使用 <option>--metadata</option> 選項來指定版本。如需其他有用選項的資訊，請參閱 <command>mdadm</command> 手冊頁。在 <filename>/proc/mdstat</filename> 中監控重新同步進度。 </para>
     </listitem>
     <listitem>
      <para>
       如果您有現有的常規 RAID，請先清除現有點陣圖，然後再建立叢集點陣圖：
      </para>
<screen><prompt role="root"># </prompt><command>mdadm --grow /dev/md<replaceable>X</replaceable> --bitmap=none</command>
<prompt role="root"># </prompt><command>mdadm --grow /dev/md<replaceable>X</replaceable> --bitmap=clustered</command></screen>
     </listitem>
     <listitem>
      <para>(選擇性) 若要建立帶有備用裝置 (用於自動容錯移轉) 的叢集 MD 裝置，請在一個叢集節點上執行以下指令：
      </para>
     <screen><prompt role="root"># </prompt><command>mdadm --create /dev/md0 --bitmap=clustered --raid-devices=2 \
      --level=mirror --spare-devices=1 /dev/sda /dev/sdb /dev/sdc --metadata=1.2</command></screen>
     </listitem>
    </itemizedlist>
   </step>
   <step>
     <para>獲取 UUID 以及相關的 MD 路徑：</para>
     <screen><prompt role="root"># </prompt><command>mdadm --detail --scan</command></screen>
     <para>該 UUID 必須與超級區塊中儲存的 UUID 相符。如需 UUID 的詳細資料，請參閱 <command>mdadm.conf</command> 手冊頁。
     </para>
   </step>
   <step>
    <para>開啟 <filename>/etc/mdadm.conf</filename>，然後新增 MD 裝置名稱及與其關聯的裝置。使用上一步中獲得的 UUID： </para>
<screen>DEVICE /dev/sda /dev/sdb
ARRAY /dev/md0 UUID=1d70f103:49740ef1:af2afce5:fcf6a489</screen>
   </step>
   <step>
    <para>開啟 Csync2 的組態檔案 <filename>/etc/csync2/csync2.cfg</filename>，並新增 <filename>/etc/mdadm.conf</filename>：</para>
    <screen>group ha_group
{
   # ... list of files pruned ...
   include /etc/mdadm.conf
}</screen>
   </step>
  </procedure>
 </sect1>

 <sect1 xml:id="sec-ha-cluster-md-ra">
  <title>設定資源代理程式</title>
  <para>依如下所示設定 CRM 資源：</para>
  <procedure>
   <step>
    <para>建立 <systemitem>Raid1</systemitem> 基本資源：</para>
    <screen><prompt role="custom">crm(live)configure# </prompt><command>primitive raider Raid1 \
  params raidconf="/etc/mdadm.conf" raiddev=/dev/md0 \
  force_clones=true \
  op monitor timeout=20s interval=10 \
  op start timeout=20s interval=0 \
  op stop timeout=20s interval=0</command></screen>
   </step>
   <step>
    <para>將 <systemitem>raider</systemitem> 資源新增至您為 DLM 建立的儲存基礎群組：</para>
    <screen><prompt role="custom">crm(live)configure# </prompt><command>modgroup g-storage add raider</command></screen>
    <para><command>add</command> 子指令預設會附加新的群組成員。 </para>
   <para>
    如果尚未複製 <literal>g-storage</literal> 群組，請執行該操作，以使其在所有節點上執行：
   </para>
   <screen><prompt role="custom">crm(live)configure# </prompt><command>clone cl-storage g-storage \
    meta interleave=true target-role=Started</command></screen>
    </step>
   <step>
    <para>使用 <command>show</command> 檢視變更。</para>
   </step>
   <step>
    <para>如果所有設定均正確無誤，請使用 <command>commit</command> 提交您的變更。</para>
   </step>
  </procedure>
 </sect1>

 <sect1 xml:id="sec-ha-cluster-md-dev-add">
  <title>新增裝置</title>
  <para>若要將某部裝置新增到現有的使用中叢集 MD 裝置，請先使用指令 <quote> 確認該裝置在每個節點上均</quote>可見<command>cat /proc/mdstat</command>。如果裝置不可見，指令將會失敗。
  </para>
  <para>
   在一個叢集節點上使用以下指令：
  </para>
  <screen><prompt role="root"># </prompt><command>mdadm --manage /dev/md0 --add /dev/sdc</command></screen>

  <para>新增的新裝置的行為取決於叢集 MD 裝置的狀態：</para>
  <itemizedlist>
   <listitem>
    <para>如果只有一個鏡像裝置處於使用中狀態，則新裝置將會成為鏡像裝置中的第二部裝置，並且會啟動復原程序。</para>
   </listitem>
   <listitem>
    <para>如果叢集 MD 裝置的兩部裝置都處於使用中狀態，則新增的裝置將會成為備用裝置。</para>
   </listitem>
  </itemizedlist>
 </sect1>

 <sect1 xml:id="sec-ha-cluster-md-dev-readd">
  <title>重新新增暫時失敗的裝置</title>
  <para>故障往往只發生於一時，並且僅限於一個節點。如果在執行 I/O 操作期間有任何節點發生了故障，則會在整個叢集中將相應裝置標示為失敗。
  </para>
  <para> 例如，其中一個節點發生纜線故障，可能就會出現這種情況。修正此問題後，您可以重新新增該裝置。與新增新裝置會同步整部裝置不同，這樣只會同步過時的組件。
  </para>
  <para>
   若要重新新增裝置，請在一個叢集節點上執行以下指令： </para>
  <screen><prompt role="root"># </prompt><command>mdadm --manage /dev/md0 --re-add /dev/sdb</command></screen>
 </sect1>


 <sect1 xml:id="sec-ha-cluster-md-dev-remove">
  <title>移除裝置</title>
  <para>在執行時期移除裝置以將其取代之前，請執行以下操作：</para>

  <procedure>
   <step>
    <para>檢查 <filename>/proc/mdstat</filename> 以確定裝置處於失敗狀態。查看裝置前面有無 <literal>(F)</literal>。</para>
   </step>
   <step>
    <para>在一個叢集節點上執行以下指令，以使裝置失敗：</para>
    <screen><prompt role="root"># </prompt><command>mdadm --manage /dev/md0 --fail /dev/sda</command></screen>
   </step>
   <step>
    <para>在一個叢集節點上使用以下指令移除失敗的裝置：</para>
    <screen><prompt role="root"># </prompt><command>mdadm --manage /dev/md0 --remove /dev/sda</command></screen>
   </step>
  </procedure>
 </sect1>

 <sect1 xml:id="sec-ha-cluster-md-convert-raid">
  <title>在災難備援站點將叢集 MD 組合成一般 RAID</title>
  <para>
   進行災難備援時，您可能會遇到下面的情況：災難備援站點的基礎架構中沒有 Pacemaker 叢集堆疊，但應用程式仍需存取現有叢集 MD 磁碟上或備份中的資料。
  </para>
  <para>
   您可以將叢集 MD RAID 轉換為一般 RAID，方法是使用 <option>--assemble</option> 操作和 <option>-U no-bitmap</option> 選項相應地變更 RAID 磁碟的中繼資料。
   </para>
   <para>
    下面的範例介紹了如何組合資料復原站點上的所有陣列：
   </para>
  <screen>while read i; do
   NAME=`echo $i | sed 's/.*name=//'|awk '{print $1}'|sed 's/.*://'`
   UUID=`echo $i | sed 's/.*UUID=//'|awk '{print $1}'`
   mdadm -AR "/dev/md/$NAME" -u $UUID -U no-bitmap
   echo "NAME =" $NAME ", UUID =" $UUID ", assembled."
done &lt; &lt;(mdadm -Es)</screen>
 </sect1>
</chapter>
