<?xml version="1.0" encoding="UTF-8"?>
<sect1 xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="ha_hawk2_history_i.xml" version="5.0" xml:id="sec-conf-hawk2-history">
 <title>檢視叢集歷程</title>

 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:maintainer/>
   <dm:status>editing</dm:status>
   <dm:deadline/>
   <dm:priority/>
   <dm:translation>yes</dm:translation>
   <dm:languages/>
   <dm:release/>
   <dm:repository/>
  </dm:docmanager>
 </info>

 <para>
  Hawk2 提供了以下用於檢視叢集過往事件 (依不同的層級和不同的詳細程度) 的功能：
 </para>

 <itemizedlist>
  <listitem>
   <para>
    <xref linkend="sec-conf-hawk2-history-recent"/>
   </para>
  </listitem>
  <listitem>
   <para>
    <xref linkend="sec-conf-hawk2-history-explorer"/>
   </para>
  </listitem>
  <listitem>
   <para>
    <xref linkend="sec-conf-hawk2-history-transitions"/>
   </para>
  </listitem>
 </itemizedlist>

 <para>
  您也可以使用 crmsh 檢視叢集歷程資訊：
 </para>
 <itemizedlist>
  <listitem>
   <para>
    <xref linkend="sec-ha-config-crm-history"/>
   </para>
  </listitem>
 </itemizedlist>

 <sect2 xml:id="sec-conf-hawk2-history-recent">
  <title>檢視節點或資源的最近事件</title>
  <procedure>
   <step>
    <para>
     登入 Hawk2：
    </para>
<screen>https://<replaceable>HAWKSERVER</replaceable>:7630/</screen>
   </step>
   <step>
    <para>
     從左側導覽列中，選取<menuchoice><guimenu>監控</guimenu>
     <guimenu>狀態</guimenu></menuchoice>。它會列出<guimenu>資源</guimenu>和<guimenu>節點</guimenu>。
    </para>
   </step>
   <step>
    <para>
     若要檢視資源的最近事件：
    </para>
    <substeps>
     <step>
      <para>
       按一下<guimenu>資源</guimenu>並選取相應的資源。
      </para>
     </step>
     <step>
      <para>
       在資源的<guimenu>操作</guimenu>欄中按一下向下箭頭按鈕，然後選取<guimenu>最近的事件</guimenu>。
      </para>
      <para>
       Hawk2 會開啟一個新視窗，並顯示最近事件的表格檢視窗。
      </para>
     </step>
    </substeps>
   </step>
   <step>
    <para>
     若要檢視節點的最近事件：
    </para>
    <substeps>
     <step>
      <para>
       按一下<guimenu>節點</guimenu>並選取相應的節點。
      </para>
     </step>
     <step>
      <para>
       在節點的<guimenu>操作</guimenu>欄中，選取<guimenu>最近的事件</guimenu>。
      </para>
      <para>
       Hawk2 會開啟一個新視窗，並顯示最近事件的表格檢視窗。
      </para>
      <informalfigure>
       <mediaobject>
        <imageobject role="fo">
         <imagedata fileref="hawk2-node-events.png" width="100%"/>
        </imageobject>
        <imageobject role="html">
         <imagedata fileref="hawk2-node-events.png" width="90%"/>
        </imageobject>
       </mediaobject>
      </informalfigure>
     </step>
    </substeps>
   </step>
  </procedure>
 </sect2>

 <sect2 xml:id="sec-conf-hawk2-history-explorer">
  <title>使用歷程總管產生叢集報告</title>
  <para>
   從左側導覽列中，選取<menuchoice><guimenu>疑難排解</guimenu>
   <guimenu>歷程</guimenu></menuchoice>，以存取<guimenu>歷程總管</guimenu>。<guimenu>歷程總管</guimenu>可讓您建立詳細的叢集報告並檢視轉換資訊。它提供以下選項：
  </para>
  <variablelist>
   <varlistentry>
    <term><guimenu>產生</guimenu>
    </term>
    <listitem>
     <para>
      建立特定時間內的叢集報告。Hawk2 會呼叫 <command>crm report</command> 指令來產生報告。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><guimenu>上傳</guimenu>
    </term>
    <listitem>
     <para>
      可讓您上傳直接使用 crm 外圍程序建立的或位於不同叢集上的 <literal>crm report</literal> 歸檔。
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
  <para>
   產生或上傳報告後，它們會顯示在<guimenu>報告</guimenu>下方。在報告清單中，您可以顯示報告的詳細資料，或者下載或刪除報告。
  </para>
  <figure>
   <title>Hawk2 - 歷程總管主要檢視</title>
   <mediaobject>
    <imageobject role="fo">
     <imagedata fileref="hawk2-history-explorer-main.png" width="100%"/>
    </imageobject>
    <imageobject role="html">
     <imagedata fileref="hawk2-history-explorer-main.png" width="90%"/>
    </imageobject>
   </mediaobject>
  </figure>
  <procedure xml:id="pro-hawk2-history-report">
   <title>產生或上傳叢集報告</title>
   <step>
    <para>
     登入 Hawk2：
    </para>
<screen>https://<replaceable>HAWKSERVER</replaceable>:7630/</screen>
   </step>
   <step>
    <para>
     從左側導覽列中，選取<menuchoice><guimenu>疑難排解</guimenu>
     <guimenu>歷程</guimenu></menuchoice>。
    </para>
    <para>
     <guimenu>歷程總管</guimenu>螢幕會在<guimenu>產生</guimenu>檢視窗中開啟。依預設，報告的建議時間範圍為過去 1 小時。
    </para>
   </step>
   <step>
    <para>
     若要建立叢集報告：
    </para>
    <substeps>
     <step>
      <para>
       若要立即啟動報告，請按一下<guimenu>產生</guimenu>。
      </para>
     </step>
     <step>
      <para>
       若要修改報告的時間範圍，請按一下建議時間範圍的任意位置並從下拉方塊中選取另一個選項。您還可以分別輸入<guimenu>自訂</guimenu>的開始日期、結束日期及小時。若要啟動報告，請按一下<guimenu>產生</guimenu>。
      </para>
      <para>
       報告產生後會顯示在<guimenu>報告</guimenu>下方。
      </para>
     </step>
    </substeps>
   </step>
   <step>
    <para>
     若要上傳叢集報告，<command>crm report</command> 歸檔必須位於您可透過 Hawk2 存取的檔案系統中。請執行下列步驟：
    </para>
    <substeps>
     <step>
      <para>
       切換到<guimenu>上傳</guimenu>索引標籤。
      </para>
     </step>
     <step>
      <para>
       <guimenu>瀏覽</guimenu>叢集報告歸檔並按一下<guimenu>上傳</guimenu>。
      </para>
      <para>
       報告上傳後會顯示在<guimenu>報告</guimenu>下方。
      </para>
     </step>
    </substeps>
   </step>
   <step>
    <para>
     若要下載或刪除報告，請在<guimenu>操作</guimenu>欄中按一下報告旁邊的相應圖示。
    </para>
   </step>
   <step>
    <para>
     若要檢視<xref linkend="il-hawk2-history-report-details" xrefstyle="select:title"/>，請按一下報告的名稱，或從<guimenu>操作</guimenu>欄中選取<guimenu>顯示</guimenu>。
    </para>
    <informalfigure>
     <mediaobject>
      <imageobject role="fo">
       <imagedata fileref="hawk2-history-report-details.png" width="100%"/>
      </imageobject>
      <imageobject role="html">
       <imagedata fileref="hawk2-history-report-details.png" width="90%"/>
      </imageobject>
     </mediaobject>
    </informalfigure>
   </step>
   <step>
    <para>
     按一下<guimenu>報告</guimenu>按鈕返回到報告清單。
    </para>
   </step>
  </procedure>
  <itemizedlist xml:id="il-hawk2-history-report-details">
   <title>歷程總管中的報告詳細資料</title>
   <listitem>
    <para>
     報告的名稱。
    </para>
   </listitem>
   <listitem>
    <para>
     報告的開始時間。
    </para>
   </listitem>
   <listitem>
    <para>
     報告的結束時間。
    </para>
   </listitem>
   <listitem>
    <para>
     報告所涵蓋的叢集中的轉換次數以及所有轉換的時間線。若要瞭解如何檢視轉換的更多詳細資料，請參閱<xref linkend="sec-conf-hawk2-history-transitions" xrefstyle="select:label"/>。
    </para>
   </listitem>
   <listitem>
    <para>
     節點事件。
    </para>
   </listitem>
   <listitem>
    <para>
     資源事件。
    </para>
   </listitem>
  </itemizedlist>
 </sect2>

 <sect2 xml:id="sec-conf-hawk2-history-transitions">
  <title>在歷程總管中檢視轉換詳細資料</title>
  <para>
   對於每個轉換，叢集都會儲存其所提供的狀態副本，做為對 <systemitem class="daemon">pacemaker-schedulerd</systemitem> 的輸入。系統會記錄此歸檔的路徑。所有 <filename>pe-*</filename> 檔案都在指定協調器 (DC) 上產生。由於叢集中的 DC 可能會更換，因此可能存在來自多個節點的 <filename>pe-*</filename> 檔案。所有 <filename>pe-*</filename> 檔案都是儲存的 CIB 快照，<systemitem class="daemon">pacemaker-schedulerd</systemitem> 在執行計算時會將其用做輸入。
  </para>
  <para>
   在 Hawk2 中，您可以顯示每個 <filename>pe-*</filename> 檔案的名稱、建立時間以及每個檔案是在哪個節點上建立的。<guimenu>歷程總管</guimenu>可以根據相應的 <filename>pe-*</filename> 檔案直觀顯示以下詳細資料：
  </para>
  <variablelist xml:id="vl-hawk2-history-transition-details">
   <title>歷程總管中的轉換詳細資料</title>
   <varlistentry>
    <term><guimenu>詳細資料</guimenu>
    </term>
    <listitem>
     <para>
      顯示屬於轉換的記錄資料片段。顯示以下指令的輸出 (包括資源代理程式的記錄訊息)：
     </para>
<screen>crm history transition <replaceable>peinput</replaceable></screen>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><guimenu>組態</guimenu>
    </term>
    <listitem>
     <para>
      顯示建立 <filename>pe-*</filename> 檔案時的叢集組態。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><guimenu>差異</guimenu>
    </term>
    <listitem>
     <para>
      顯示所選 <filename>pe-*</filename> 檔案與下一個檔案之間的組態和狀態差異。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><guimenu>記錄</guimenu>
    </term>
    <listitem>
     <para>
      顯示屬於轉換的記錄資料片段。顯示以下指令的輸出：
     </para>
<screen>crm history transition log <replaceable>peinput</replaceable></screen>
     <para>
      這包括來自以下精靈的詳細資料：<systemitem class="daemon">pacemaker-controld</systemitem>、<systemitem class="daemon">pacemaker-schedulerd</systemitem> 和 <systemitem class="daemon">pacemaker-execd</systemitem>。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><guimenu>圖形</guimenu>
    </term>
    <listitem>
     <para>
      顯示轉換的圖形表示。如果您按一下<guimenu>圖形</guimenu>，則會模擬計算 (與 <systemitem class="daemon">pacemaker-schedulerd</systemitem> 執行的計算完全一樣)，並產生圖形視覺效果。
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
  <procedure xml:id="pro-hawk2-history-transitions">
   <title>檢視轉換詳細資料</title>
   <step>
    <para>
     登入 Hawk2：
    </para>
<screen>https://<replaceable>HAWKSERVER</replaceable>:7630/</screen>
   </step>
   <step>
    <para>
     從左側導覽列中，選取<menuchoice><guimenu>疑難排解</guimenu>
     <guimenu>歷程</guimenu></menuchoice>。
    </para>
    <para>
     如果報告已產生或上傳，它們會顯示在<guimenu>報告</guimenu>清單中。否則，請依<xref linkend="pro-hawk2-history-report" xrefstyle="select:label"/> 所述產生或上傳報告。
    </para>
   </step>
   <step>
    <para>
     按一下報告的名稱或從<guimenu>操作</guimenu>欄中選取<guimenu>顯示</guimenu>以開啟<xref linkend="il-hawk2-history-report-details"/>。
    </para>
   </step>
   <step>
    <para>
     若要存取轉換詳細資料，您需要在下面顯示的轉換時間線中選取一個轉換點。使用<guimenu>上一個</guimenu>和<guimenu>下一個</guimenu>以及<guimenu>放大</guimenu>和<guimenu>縮小</guimenu>圖示尋找您感興趣的轉換。
    </para>
   </step>
   <step>
    <para>
     若要顯示 <filename>pe-input*</filename> 的名稱、建立時間以及檔案是在哪個節點是建立的，請將滑鼠指標懸停在時間線的轉換點上。
    </para>
   </step>
   <step>
    <para>
     若要檢視<xref linkend="vl-hawk2-history-transition-details"/>，請按一下要瞭解其詳細資訊的轉換點。
    </para>
   </step>
   <step>
    <para>
     若要顯示<guimenu>詳細資料</guimenu>、<guimenu>組態</guimenu>、<guimenu>差異</guimenu>、<guimenu>記錄</guimenu>或<guimenu>圖形</guimenu>，請按一下相應的按鈕以顯示<xref linkend="vl-hawk2-history-transition-details"/>中所述的內容。
    </para>
   </step>
   <step>
    <para>
     若要返回報告清單，請按一下<guimenu>報告</guimenu>按鈕。
    </para>
   </step>
  </procedure>
 </sect2>

 <sect2 xml:id="sec-ha-config-crm-history">
  <title>使用 crmsh 擷取歷程資訊</title>
  <para>
   調查叢集歷程是一項複雜的任務。為了簡化此項任務，crmsh 提供了 <command>history</command> 指令及其子指令。假設 SSH 已正確設定。
  </para>
  <para>
   每個叢集會移動狀態、移轉資源或啟動重要的程序。所有這些動作的相關資訊都可透過 <command>history</command> 子指令擷取。
  </para>
  <para>
   依預設，所有 <command>history</command> 指令顯示的都是最近一小時內發生的事件。若要變更此時間範圍，請使用 <command>limit</command> 子指令。語法是：
  </para>
<screen><prompt role="root"># </prompt><command>crm history</command>
<prompt role="custom">crm(live)history# </prompt><command>limit <replaceable>FROM_TIME</replaceable> [<replaceable>TO_TIME</replaceable>]</command></screen>
  <para>
   以下是一些有效的範例：
  </para>
  <variablelist>
   <varlistentry>
    <term><command>limit 4:00pm</command>
    </term>
    <term><command>limit 16:00</command>
    </term>
    <listitem>
     <para>
      這兩個指令的含意相同，都是指當天下午 4:00。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><command>limit 2012/01/12 6pm</command>
    </term>
    <listitem>
     <para>
      2012 年 1 月 12 日下午 6:00
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><command>limit "Sun 5 20:46"</command>
    </term>
    <listitem>
     <para>
      本年本月第 5 個週日下午 8:46
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
  <para>
   如需更多範例以及如何建立時間範圍的資訊，請參閱 <link xlink:href="http://labix.org/python-dateutil"/>。
  </para>
  <para>
   <command>info</command> 子指令可顯示 <command>crm report</command> 涉及的所有參數︰
  </para>
<screen><prompt role="custom">crm(live)history# </prompt><command>info</command>
Source: live
Period: 2012-01-12 14:10:56 - end
Nodes: alice
Groups:
Resources:</screen>
  <para>
   若要只對 <command>crm report</command> 使用特定參數，請透過 <command>help</command> 子指令檢視可用的選項。
  </para>
  <para>
   若要限定詳細程度，請使用 <command>detail</command> 子指令，同時指定一個層級：
  </para>
<screen><prompt role="custom">crm(live)history# </prompt><command>detail 1</command></screen>
  <para>
   數字越大，報告就越詳細。預設值為 <literal>0</literal> (零)。
  </para>
  <para>
   設定上述參數後，請使用 <command>log</command> 顯示記錄訊息。
  </para>
  <para>
   若要顯示上次轉換，請使用以下指令：
  </para>
<screen><prompt role="custom">crm(live)history# </prompt><command>transition -1</command>
INFO: fetching new logs, please wait ...</screen>
  <para>
   此指令會擷取記錄，並執行 <command>dotty</command> (從 <package>graphviz</package> 套件) 以顯示轉換圖表。該外圍程序會開啟您使用 <keycap function="down"/> 和 <keycap function="up"/> 游標鍵瀏覽的記錄檔案。
  </para>
  <para>
   如果您不想要開啟轉換圖表，請使用 <option>nograph</option> 選項：
  </para>
<screen><prompt role="custom">crm(live)history# </prompt><command>transition -1 nograph</command></screen>
 </sect2>
</sect1>
