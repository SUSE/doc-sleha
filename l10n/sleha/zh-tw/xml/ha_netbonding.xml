<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="ha_netbonding.xml" version="5.0" xml:id="cha-ha-netbonding">


 <title>網路裝置結合</title>
 <info>
  <abstract>
   <para>
   對於許多系統而言，實作的網路連接除了需要符合一般乙太網路裝置的標準資料安全性或可用性要求之外，還需要符合其他要求。在這些情況下，數個乙太網路裝置可以結集成單個結合裝置。
   </para>
  </abstract>
      <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
        <dm:maintainer/>
        <dm:status>editing</dm:status>
        <dm:deadline/>
        <dm:priority/>
        <dm:translation>yes</dm:translation>
        <dm:languages/>
        <dm:release/>
        <dm:repository/>
      </dm:docmanager>
    </info>
 <para>
  結合裝置的組態是透過結合模組選項來設定，而其行為由結合裝置的模式決定。該模式預設為 <systemitem>mode=active-backup</systemitem>，這表示如果主要裝置發生故障，另一部裝置將會變成主動裝置。
 </para>
 <para>
  使用 Corosync 時，結合裝置無法透過叢集軟體管理。因此，必須在可能需要存取結合裝置的每個叢集節點上設定該裝置。
 </para>

 <sect1 xml:id="sec-ha-netbond-yast">
  <title>使用 YaST 設定結合裝置</title>

  <para>
   若要設定結合裝置，您需要有多個可結集至單個結合裝置的乙太網路裝置。請執行下列步驟：
  </para>

  <procedure>
   <step>
    <para>
     以 <systemitem class="username">root</systemitem> 身分啟動 YaST，然後選取<menuchoice>
     <guimenu>系統</guimenu> <guimenu>網路設定</guimenu>
     </menuchoice>。
    </para>
   </step>
   <step>
    <para>
     在<guimenu>網路設定</guimenu>中，切換至<guimenu>綜覽</guimenu>索引標籤，其中會顯示可用的裝置。
    </para>
   </step>
   <step>
    <para>
     檢查要結集至結合裝置的乙太網路裝置是否已經指定了 IP 位址。如果已指定，請加以變更：
    </para>
    <substeps performance="required">
     <step>
      <para>
       選取要變更的裝置，然後按一下<guimenu>編輯</guimenu>。
      </para>
     </step>
     <step xml:id="step-bond-slave">
      <para>
       在開啟的<guimenu>網路卡設定</guimenu>對話方塊的<guimenu>位址</guimenu>索引標籤中，選取<guimenu>無連結和 IP 設定 (結合連接埠)</guimenu> 選項。
      </para>
     </step>
     <step>
      <para>
       按<guimenu>下一步</guimenu>回到<guimenu>網路設定</guimenu>對話方塊中的<guimenu>綜覽</guimenu>索引標籤。
      </para>
     </step>
    </substeps>
   </step>
   <step>
    <para>
     若要新增新的結合裝置：
    </para>
    <substeps performance="required">
     <step>
      <para>
       按一下<guimenu>新增</guimenu>，然後將<guimenu>裝置類型</guimenu>設為<guimenu>Bond</guimenu>。按<guimenu>繼續</guimenu>以繼續。
      </para>
     </step>
     <step>
      <para>
       選取為結合裝置指定 IP 位址的方法。有三種方法可供您選擇：
      </para>
      <itemizedlist>
       <listitem>
        <para>
         無連結和 IP 設定 (結合連接埠)
        </para>
       </listitem>
       <listitem>
        <para>
         動態位址 (透過 DHCP 或 Zeroconf)
        </para>
       </listitem>
       <listitem>
        <para>
         靜態指定的 IP 位址
        </para>
       </listitem>
      </itemizedlist>
      <para>
       請使用適合您環境的方法。如果是由 Corosync 管理虛擬 IP 位址，請選取<guimenu>靜態指定的 IP 位址</guimenu>，然後為介面指定一個 IP 位址。
      </para>
     </step>
     <step>
      <para>
       切換到<guimenu>結合連接埠</guimenu>索引標籤。
      </para>
     </step>
     <step>
      <para>
       若要選取需要加入結合的乙太網路裝置，請選取相應裝置前面的核取方塊。
      </para>
     </step>
     <step>
      <para>
       編輯「<guimenu>Bond 驅動程式選項</guimenu>」。可用模式如下：
      </para>
      <variablelist>
       <varlistentry>
        <term><literal>balance-rr</literal>
        </term>
        <listitem>
         <para>
          提供負載平衡和容錯，但會使封包傳輸變得混亂無序。這可能會導致 TCP 重新組合等操作出現延遲。
         </para>
        </listitem>
       </varlistentry>
       <varlistentry>
        <term><literal>active-backup</literal>
        </term>
        <listitem>
         <para>
          提供容錯。
         </para>
        </listitem>
       </varlistentry>
       <varlistentry>
        <term><literal>balance-xor</literal>
        </term>
        <listitem>
         <para>
          提供負載平衡和容錯。
         </para>
        </listitem>
       </varlistentry>
       <varlistentry>
        <term><literal>broadcast</literal>
        </term>
        <listitem>
         <para>
          提供容錯。
         </para>
        </listitem>
       </varlistentry>
       <varlistentry>
        <term><literal>802.3ad</literal>
        </term>
        <listitem>
         <para>
          提供動態連結聚總 (若連接的交換器支援)。
         </para>
        </listitem>
       </varlistentry>
       <varlistentry>
        <term><literal>balance-tlb</literal>
        </term>
        <listitem>
         <para>
          提供外送流量的負載平衡。
         </para>
        </listitem>
       </varlistentry>
       <varlistentry>
        <term><literal>balance-alb</literal>
        </term>
        <listitem>
         <para>
          提供內送和外送流量的負載平衡 (若所用的網路裝置允許修改使用中網路裝置的硬體位址)。
         </para>
        </listitem>
       </varlistentry>
      </variablelist>
     </step>
     <step>
      <para>
       請務必將參數 <literal>miimon=100</literal> 新增至<guimenu>Bond 驅動程式選項</guimenu>。如果不指定此參數，則不會定期檢查連結，因此，結合驅動程式可能會持續在有故障的連結上遺失封包。
      </para>
     </step>
    </substeps>
   </step>
   <step>
    <para>
     按<guimenu>下一步</guimenu>，然後按<guimenu>確定</guimenu>離開 YaST，以完成結合裝置設定。YaST 會將組態寫入 <filename>/etc/sysconfig/network/ifcfg-bond<replaceable>裝置編號</replaceable></filename>。
    </para>
   </step>
  </procedure>
 </sect1>

 <sect1 xml:id="sec-ha-netbond-hotpug-yast">
  <title>將裝置熱插拔到結合中</title>

  <para>
   有時，需要以另一個介面來取代結合中的某個介面 (例如，當相應的網路裝置持續發生故障時)。解決方案是設定熱插拔。此外，還需要變更 <systemitem>udev</systemitem> 規則，以便依匯流排 ID 而不是 MAC 位址比對裝置。這樣，如果有缺陷的硬體 (位於相同插槽中但是具有不同 MAC 位址的網路卡) 允許更換的話，您便可以更換該硬體。
  </para>

  <procedure>
   <title>使用 YaST 將裝置熱插拔到結合中</title>

   <para>
    如果您偏好手動設定，請參閱《SUSE Linux Enterprise Server 管理指南》「<citetitle>基本網路</citetitle>」一章中的「<citetitle>結合連接埠的熱插拔</citetitle>」一節。
   </para>
   <step>
    <para>
     以 <systemitem class="username">root</systemitem> 身分啟動 YaST，然後選取<menuchoice>
     <guimenu>系統</guimenu> <guimenu>網路設定</guimenu>
     </menuchoice>。
    </para>
   </step>
   <step>
    <para>
     在<guimenu>網路設定</guimenu>中，切換至<guimenu>綜覽</guimenu>索引標籤，其中會顯示已設定的裝置。如果已在結合中設定裝置，<guimenu>備註</guimenu>欄中將會指明。
    </para>
   </step>
   <step>
    <para>
     針對已結集到結合從屬的每個乙太網路裝置，執行以下步驟：
    </para>
    <substeps performance="required">
     <step>
      <para>
       選取要變更的裝置，然後按一下<guimenu>編輯</guimenu>。<guimenu>網路卡設定</guimenu>對話方塊即會開啟。
      </para>
     </step>
     <step>
      <para>
       切換至<guimenu>一般</guimenu>索引標籤，並確定<guimenu>啟動裝置</guimenu>設為<literal>熱插拔時</literal>。
      </para>
     </step>
     <step>
      <para>
       切換至<guimenu>硬體</guimenu>索引標籤。
      </para>
     </step>
     <step>
      <para>
       針對<guimenu>Udev 規則</guimenu>按一下<guimenu>變更</guimenu>，然後選取<guimenu>匯流排 ID</guimenu>選項。
      </para>
     </step>
     <step>
      <para>
       按一下<guimenu>確定</guimenu>和<guimenu>下一步</guimenu>，回到<guimenu>網路設定</guimenu>對話方塊中的<guimenu>綜覽</guimenu>索引標籤。如果您現在按一下乙太網路裝置項目，下方窗格將會顯示裝置的詳細資料，其中包括匯流排 ID。
      </para>
     </step>
    </substeps>
   </step>
   <step>
    <para>
     按一下<guimenu>確定</guimenu>確認您的變更並離開網路設定。
    </para>
   </step>
  </procedure>

  <para>
   開機時，網路設定不會等待熱插拔裝置就緒，而是等待結合就緒，後者至少需要有一部裝置可用。當從系統中移除一個介面 (從 NIC 驅動程式解除結合、執行 NIC 驅動程式的 <command>rmmod</command> 指令或真正移除 PCI 熱插拔) 時，核心會自動從結合中將其移除。當將新卡新增至系統 (更換插槽中的硬體) 時，<systemitem>udev</systemitem> 會套用基於匯流排的永久命名規則將其重新命名，然後為它呼叫 <command>ifup</command>。呼叫 <command>ifup</command> 會自動將新卡加入結合。
  </para>
 </sect1>
 <sect1 xml:id="sec-ha-netbonding-more">
  <title>更多資訊</title>

  <para>
   《<guimenu>Linux Ethernet Bonding Driver HOWTO</guimenu>》(Linux 乙太網路結合驅動程式 HOWTO) 中詳細說明了所有模式及眾多選項。安裝 <filename> 套件後，便可在 </filename>/usr/src/linux/Documentation/networking/bonding.txt<systemitem>kernel-source</systemitem> 下找到該檔案。
  </para>

  <para>
   對於高可用性設定，本指南所述的以下選項特別重要：<option>miimon</option> 和 <option>use_carrier</option>。
  </para>


 </sect1>
</chapter>
