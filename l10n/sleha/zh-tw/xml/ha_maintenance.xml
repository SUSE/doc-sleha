<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE chapter
[
  <!ENTITY % entities SYSTEM "generic-entities.ent">
    %entities;
]>
<chapter xmlns="http://docbook.org/ns/docbook"
 xmlns:xi="http://www.w3.org/2001/XInclude"
 xmlns:xlink="http://www.w3.org/1999/xlink" version="5.0"
 xml:id="cha-ha-maintenance">
 <title>執行維護任務</title>
 <info>
  <abstract>
   <para>
    若要在叢集節點上執行維護任務，您可能需要停止該節點上執行的資源、移動這些資源，或者將該節點關閉或重新開機。此外，可能還需要暫時接管叢集中資源的控制權，甚至需要在資源仍在執行時停止叢集服務。
   </para>
   <para>
    本章介紹如何在不產生負面影響的情況下手動關閉叢集節點。此外，本章將會概述叢集堆疊提供的用於執行維護任務的不同選項。
   </para>
  </abstract>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:maintainer/>
   <dm:status>editing</dm:status>
   <dm:deadline/>
   <dm:priority/>
   <dm:translation>yes</dm:translation>
   <dm:languages/>
   <dm:release/>
   <dm:repository/>
  </dm:docmanager>
 </info>

 <sect1 xml:id="sec-ha-maint-outline">
  <title>準備和完成維護工作</title>
  <para>
   使用以下指令可啟動、停止叢集或檢視叢集狀態：
  </para>
  <variablelist>
   <varlistentry>
    <term><command>crm cluster start [--all]</command></term>
    <listitem>
     <para>在一個或所有節點上啟動叢集服務</para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><command>crm cluster stop [--all]</command></term>
    <listitem>
     <para>在一個或所有節點上停止叢集服務</para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><command>crm cluster restart [--all]</command></term>
    <listitem>
     <para>在一個或所有節點上重新啟動叢集服務</para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><command>crm cluster status</command></term>
    <listitem>
     <para>檢視叢集堆疊的狀態</para>
    </listitem>
   </varlistentry>
  </variablelist>
  <para>
   請以 &rootuser; 使用者身分或擁有所需權限的使用者身分執行上述指令。
  </para>
  <para>
   將某個叢集節點關閉或重新開機 (或停止節點上的叢集服務) 時，會觸發以下程序：
  </para>
  <itemizedlist>
   <listitem>
    <para>
     該節點上執行的資源會停止，或移出該節點。
    </para>
   </listitem>
   <listitem>
    <para>
     如果停止資源的操作失敗或逾時，&stonith; 機制會圍籬區隔該節點並將其關閉。
    </para>
   </listitem>
  </itemizedlist>
  <warning>
   <title>資料遺失風險</title>
   <para>
    如果您需要執行測試或維護工作，請執行下面的一般步驟。
   </para>
   <para>
    如果不執行，有可能會產生不利的負面影響，例如，資源不循序啟動、CIB 在叢集節點之間不同步，甚至遺失資料。
   </para>
   <procedure>
   <step>
    <para>
     開始前，請選擇<xref linkend="sec-ha-maint-overview"/>中所述的適當選項。
    </para>
   </step>
   <step>
    <para>
     請使用 &hawk2; 或 &crmsh; 套用此選項。
    </para>
   </step>
   <step>
    <para>
     執行維護任務或測試。
    </para>
   </step>
   <step>
    <para>
     完成後，請將資源、節點或叢集恢復<quote>正常</quote>運作。
    </para>
   </step>
  </procedure>
 </warning>
 </sect1>

 <sect1 xml:id="sec-ha-maint-overview">
  <title>用於維護任務的不同選項</title>

  <para>
   &pace; 提供了以下用於執行系統維護的選項：
  </para>

  <variablelist>
   <varlistentry xml:id="vle-ha-maint-mode-cluster">
    <!--<term>Putting the cluster in maintenance mode</term>-->
    <term><xref linkend="sec-ha-maint-mode-cluster" xrefstyle="select:title"/></term>
    <listitem>
     <para>
      使用全域叢集內容 <literal>maintenance-mode</literal> 可以一次性將所有資源置於維護狀態。叢集會停止監控這些資源，因此不知道它們的狀態。<emphasis>只有</emphasis> &pace; 的資源管理功能會處於停用狀態。&corosync; 和 SBD 仍會正常運作。請對涉及叢集資源的所有任務都使用維護模式。對於涉及基礎架構 (例如儲存或網路) 的任何任務，最安全的方法是完全停止叢集服務。請參閱 <xref linkend="vle-ha-maint-cluster-stop"/>。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry xml:id="vle-ha-maint-cluster-stop">
    <!--<term>Stopping the cluster services for the whole cluster</term>-->
    <term><xref linkend="sec-ha-maint-cluster-stop" xrefstyle="select:title"/></term>
    <listitem>
     <para>
      一次性停止所有節點上的叢集服務可以關閉叢集，同時避免逐個關閉各個節點將會發生的大量資源移轉。由於不存在需要將資源移轉至的節點，因此所有資源都會停止。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry xml:id="vle-ha-maint-mode-node">
    <!--<term>Putting a node in maintenance mode</term>-->
    <term><xref linkend="sec-ha-maint-mode-node" xrefstyle="select:title"/></term>
    <listitem>
     <para>
      此選項可以一次性將特定節點上執行的所有資源置於維護狀態。叢集會停止監控這些資源，因此不知道它們的狀態。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry xml:id="vle-ha-maint-node-standby">
    <!--<term>Putting a node in standby mode</term>-->
    <term><xref linkend="sec-ha-maint-node-standby" xrefstyle="select:title"/></term>
    <listitem>
     <para>
      處於待命模式的節點不再能夠執行資源。該節點上執行的所有資源都會移出或停止 (如果沒有其他節點可用於執行資源)。另外，該節點上的所有監控操作都會停止 (設定了 <literal>role="Stopped"</literal> 的操作除外)。
     </para>
     <para>
      如果您需要停止叢集中的某個節點，同時繼續提供另一個節點上執行的服務，則可以使用此選項。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry xml:id="vle-ha-maint-shutdown-node">
    <!--<term>Stopping the cluster services on a node</term>-->
    <term><xref linkend="sec-ha-maint-shutdown-node" xrefstyle="select:title"/></term>
    <listitem>
     <para>
      此選項可停止單個節點上的所有叢集服務。該節點上執行的所有資源都會移出或停止 (如果沒有其他節點可用於執行資源)。如果停止資源的操作失敗或逾時，將會圍籬區隔該節點。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry xml:id="vle-ha-maint-mode-rsc">
    <!--<term>Putting a resource in maintenance mode</term>-->
    <term><xref linkend="sec-ha-maint-mode-rsc" xrefstyle="select:title"/></term>
    <listitem>
     <para>
      為某個資源啟用此模式後，便不會針對該資源觸發監控操作。
     </para>
     <para>
      如果您需要手動調整此資源所管理的服務，並且不希望叢集在此期間對該資源執行任何監控操作，則可以使用此選項。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry xml:id="vle-ha-maint-rsc-unmanaged">
    <!--<term>Putting a resource into unmanaged mode</term>-->
    <term><xref linkend="sec-ha-maint-rsc-unmanaged" xrefstyle="select:title"/></term>
     <listitem>
     <para>
      使用 <option>is-managed</option> 中繼屬性可以暫時<quote>釋放</quote>某個資源，使其不受叢集堆疊的管理。這表示您可以手動調整此資源管理的服務 (例如，調整任何元件)。不過，叢集會繼續<emphasis>監控</emphasis>該資源，並繼續報告任何失敗情況。
     </para>
     <para>
      如果您希望叢集同時停止<emphasis>監控</emphasis>該資源，請改為使用依資源維護模式 (請參閱<xref
      linkend="vle-ha-maint-mode-rsc"/>)。
     </para>
    </listitem>
   </varlistentry>

  </variablelist>
 </sect1>

 <sect1 xml:id="sec-ha-maint-mode-cluster">
  <title>將叢集置於維護模式</title>
  <warning>
   <title>維護模式只會停用 &pace;</title>
   <para>
    將叢集置於維護模式時，只有 &pace; 的資源管理功能會停用。&corosync; 和 SBD 仍會正常運作。這可能會引發圍籬區隔操作，具體取決於您的維護任務。
   </para>
   <para>
    請對涉及叢集資源的所有任務都使用維護模式。對於涉及基礎架構 (例如儲存或網路) 的任何任務，最安全的方法是完全停止叢集服務。請參閱 <xref linkend="sec-ha-maint-cluster-stop"/>。
   </para>
  </warning>
   <para>
    若要在 &crmshell; 中將叢集置於維護模式，請使用以下指令：
   </para>
<screen>&prompt.root;<command>crm maintenance on</command></screen>
   <para>
    若要在完成維護工作後將叢集恢復正常模式，請使用以下指令：
   </para>
<screen>&prompt.root;<command>crm maintenance off</command></screen>

<procedure xml:id="pro-ha-maint-mode-cluster-hawk2">
   <title>使用 &hawk2; 將叢集置於維護模式</title>
   <step>
    <para>
     啟動網頁瀏覽器並依<xref linkend="sec-conf-hawk2-login"/> 所述登入叢集。
    </para>
   </step>
   <step>
    <para>
     從左側導覽列中，選取<menuchoice><guimenu>組態</guimenu>
     <guimenu>叢集組態</guimenu></menuchoice>。
    </para>
   </step>
   <step>
    <para>
     從空白下拉式方塊中選取 <guimenu>maintenance-mode</guimenu> 屬性。
    </para>
   </step>
   <step>
    <para>
     從 <literal>maintenance-mode</literal> 下拉式方塊中選取<guimenu>是</guimenu>。
    </para>
   </step>
   <step>
     <para>
       按一下<guimenu>「套用」</guimenu>。
     </para>
   </step>
   <step>
    <para>
     完成整個叢集的維護任務後，從 <literal>maintenance-mode</literal> 下拉式方塊中選取<guimenu>否</guimenu>，然後按一下<guimenu>套用</guimenu>。
    </para>
    <para>
     從此刻起，&ha; 會再次接管叢集管理工作。
    </para>
   </step>
  </procedure>
</sect1>

<sect1 xml:id="sec-ha-maint-cluster-stop">
 <title>停止整個叢集的叢集服務</title>
 <para>
  若要一次性停止所有節點上的叢集服務，請使用以下指令：
 </para>
<screen>&prompt.root;<command>crm cluster stop --all</command></screen>
 <para>
  若要在完成維護工作後再次啟動叢集服務，請使用以下指令：
 </para>
<screen>&prompt.root;<command>crm cluster start --all</command></screen>
 <warning>
  <title>不保證能正常關閉</title>
  <para>
   單獨使用 <option>--all</option> 選項不能保證可將叢集正常關閉，因為應用程式層級的資源停止失敗可能會觸發非預期的圍籬區隔。如果應用程式是關鍵型應用程式，請考慮先停止這些應用程式，然後再停止整個叢集的叢集服務。
  </para>
 </warning>
</sect1>

 <sect1 xml:id="sec-ha-maint-mode-node">
  <title>將節點置於維護模式</title>
   <para>
    若要在 &crmshell; 中將節點置於維護模式，請使用以下指令：
   </para>
<screen>&prompt.root;<command>crm node maintenance <replaceable>NODENAME</replaceable></command></screen>
   <para>
    若要在完成維護工作後將節點恢復正常模式，請使用以下指令：
   </para>
<screen>&prompt.root;<command>crm node ready <replaceable>NODENAME</replaceable></command></screen>

  <procedure xml:id="pro-ha-maint-mode-nodes-hawk2">
   <title>使用 &hawk2; 將節點置於維護模式</title>
   <step>
    <para>
     啟動網頁瀏覽器並依<xref linkend="sec-conf-hawk2-login"/> 所述登入叢集。
    </para>
   </step>
   <step>
    <para>
     在左側導覽列中選取「<guimenu>叢集狀態</guimenu>」。
    </para>
   </step>
   <step>
    <para>
     在其中一個節點檢視窗中，按一下節點旁邊的扳手圖示，然後選取<guimenu>維護</guimenu>。
    </para>
   </step>
   <step>
    <para>
      完成維護任務後，按一下節點旁邊的扳手圖示，然後選取<guimenu>就緒</guimenu>。
    </para>
   </step>
  </procedure>
 </sect1>

 <sect1 xml:id="sec-ha-maint-node-standby">
  <title>將節點置於待命模式</title>
   <para>
    若要在 &crmshell; 中將節點置於待命模式，請使用以下指令：
   </para>
<screen>&prompt.root;<command>crm node standby <replaceable>NODENAME</replaceable></command></screen>
   <para>
    若要在完成維護工作後將節點恢復線上狀態，請使用以下指令：
   </para>
<screen>&prompt.root;<command>crm node online <replaceable>NODENAME</replaceable></command></screen>

<procedure xml:id="pro-ha-maint-node-standby-hawk2">
  <title>使用 &hawk2; 將節點置於待命模式</title>
   <step>
    <para>
     啟動網頁瀏覽器並依<xref linkend="sec-conf-hawk2-login"/> 所述登入叢集。
    </para>
   </step>
   <step>
    <para>
     在左側導覽列中選取「<guimenu>叢集狀態</guimenu>」。
    </para>
   </step>
   <step>
    <para>
     在其中一個節點的檢視中，按一下節點旁邊的扳手圖示，然後選取<guimenu>待命</guimenu>。
    </para>
   </step>
   <step>
    <para>
     完成節點的維護任務。
    </para>
   </step>
   <step>
    <para>
     若要停用待命模式，請按一下節點旁邊的扳手圖示，然後選取<guimenu>就緒</guimenu>。
    </para>
   </step>
  </procedure>
</sect1>

<sect1 xml:id="sec-ha-maint-shutdown-node">
 <title>停止節點上的叢集服務</title>
 <para>
  您可以循序將服務移出節點後，再將節點關閉或重新開機。這樣可將服務移轉出節點，而不會受限於叢集服務的關閉逾時。
 </para>
 <procedure xml:id="pro-ha-maint-shutdown-node">
  <title>手動將叢集節點重新開機</title>
  <step>
   <para>
    在要重新開機或關閉的節點上，以 &rootuser; 或同等身分登入。
   </para>
  </step>
  <step>
   <para>
    將節點置於 <literal>standby</literal> 模式：
   </para>
<screen>&prompt.root;<command>crm node standby</command></screen>
   <para>
    依預設，節點在重新開機後將保持 <literal>standby</literal> 模式。您也可以使用 <command>crm node standby reboot</command> 將節點設定為自動恢復線上狀態。
   </para>
  </step>
  <step>
   <para>
    檢查叢集狀態：
   </para>
<screen>&prompt.root;<command>crm status</command></screen>
   <para>
    此指令顯示相關節點處於 <literal>standby</literal> 模式：
   </para>
<screen>[...]
Node <replaceable>&node2;</replaceable>: standby
[...]</screen>
  </step>
  <step>
   <para>
    停止該節點上的叢集服務：
   </para>
<screen>&prompt.root;<command>crm cluster stop</command></screen>
  </step>
  <step>
   <para>
    將節點重新開機。
   </para>
  </step>
 </procedure>

 <para>
  若要再次檢查節點是否已加入叢集，請執行以下步驟：
 </para>

 <procedure>
  <step>
   <para>
    節點重新開機後，請再次登入該節點。
   </para>
  </step>
  <step>
   <para>
    檢查叢集服務是否已啟動：
   </para>
<screen>&prompt.root;<command>crm cluster status</command></screen>
   <para>
     這可能需要一些時間。如果叢集服務無法自行重新開機，請手動啟動它們：
   </para>
<screen>&prompt.root;<command>crm cluster start</command></screen>
  </step>
  <step>
   <para>
    檢查叢集狀態：
   </para>
<screen>&prompt.root;<command>crm status</command></screen>
  </step>
  <step>
    <para>
      如果節點仍處於 <literal>standby</literal> 模式，請將其恢復線上狀態：
    </para>
<screen>&prompt.root;<command>crm node online</command></screen>
  </step>
 </procedure>
</sect1>

 <sect1 xml:id="sec-ha-maint-mode-rsc">
  <title>將資源置於維護模式</title>
   <para>
    若要在 &crmshell; 中將資源置於維護模式，請使用以下指令：</para>
<screen>&prompt.root;<command>crm resource maintenance <replaceable>RESOURCE_ID</replaceable> true</command></screen>
   <para>
    若要在完成維護工作後將資源恢復正常模式，請使用以下指令：
   </para>
<screen>&prompt.root;<command>crm resource maintenance <replaceable>RESOURCE_ID</replaceable> false</command></screen>

<procedure xml:id="pro-ha-maint-mode-rsc-hawk2">
   <title>使用 &hawk2; 將資源置於維護模式</title>
   <step>
    <para>
     啟動網頁瀏覽器並依<xref linkend="sec-conf-hawk2-login"/> 所述登入叢集。
    </para>
   </step>
   <step>
    <para>
     在左側導覽列中，選取「<guimenu>資源</guimenu>」。
    </para>
   </step>
   <step>
    <para>
     選取要將其置於維護模式或不受管理模式的資源，然後按一下資源旁邊的扳手圖示並選取<guimenu>編輯資源</guimenu>。
    </para>
   </step>
   <step>
    <para>
     開啟<guimenu>中繼屬性</guimenu>類別。
    </para>
   </step>
   <step>
    <para>
     從空白下拉式清單中，選取 <guimenu>maintenance</guimenu> 屬性並按一下加號圖示新增該屬性。
    </para>
   </step>
   <step>
    <para>
     啟用 <literal>maintenance</literal> 旁邊的核取方塊，將 maintenance 屬性設定為 <literal>yes</literal>。
    </para>
   </step>
   <step>
    <para>
     確認您的變更。
    </para>
   </step>
   <step>
    <para>
     完成針對該資源的維護任務後，停用該資源 <literal>maintenance</literal> 屬性旁邊的核取方塊。
    </para>
    <para>
     從此刻起，資源再次由 &ha; 軟體管理。
    </para>
   </step>
  </procedure>
</sect1>

<sect1 xml:id="sec-ha-maint-rsc-unmanaged">
  <title>將資源置於不受管理模式</title>
   <para>
    若要在 &crmshell; 中將資源置於不受管理模式，請使用以下指令：</para>
<screen>&prompt.root;<command>crm resource unmanage <replaceable>RESOURCE_ID</replaceable></command></screen>
   <para>
    若要在完成維護工作後再次將資源置於受管理模式，請使用以下指令：
   </para>
<screen>&prompt.root;<command>crm resource manage <replaceable>RESOURCE_ID</replaceable></command></screen>

 <procedure xml:id="pro-ha-maint-rsc-unmanaged-hawk2">
   <title>使用 &hawk2; 將資源置於不受管理模式</title>
   <step>
    <para>
     啟動網頁瀏覽器並依<xref
      linkend="sec-conf-hawk2-login"/> 所述登入叢集。
    </para>
   </step>
   <step>
    <para>
     在左側導覽列中選取<guimenu>狀態</guimenu>，然後移至<guimenu>資源</guimenu>清單。
    </para>
   </step>
   <step>
    <para>
     在<guimenu>操作</guimenu>欄中，按一下要修改的資源旁邊的向下箭頭圖示，然後選取<guimenu>編輯</guimenu>。
    </para>
    <para>
     資源組態螢幕隨即開啟。
    </para>
   </step>
   <step>
    <para>
     在<guimenu>中繼屬性</guimenu>下方，從空白下拉式方塊中選取 <guimenu>is-managed</guimenu> 項目。
    </para>
   </step>
   <step>
    <para>
     將其值設定為 <literal>No</literal>，然後按一下<guimenu>套用</guimenu>。
    </para>
   </step>
   <step>
    <para>
     完成維護任務後，將 <guimenu>is-managed</guimenu> 設定為 <literal>Yes</literal> (即預設值) 並套用變更。
    </para>
    <para>
     從此刻起，資源再次由 &ha; 軟體管理。
    </para>
   </step>
  </procedure>
 </sect1>

<sect1 xml:id="sec-ha-maint-shutdown-node-maint-mode">
 <title>在維護模式下將叢集節點重新開機</title>
    <note>
      <title>隱含式</title>
      <para>
       如果叢集或某個節點處於維護模式，您可以使用叢集堆疊外部的工具 (例如 <command>systemctl</command>)，以手動方式將叢集所管理的元件做為資源進行操作。&ha; 軟體不會監控這些元件或嘗試重新啟動它們。
      </para>
      <para>
       如果您停止節點上的叢集服務，所有精靈和程序 (最初做為 &pace; 管理的叢集資源啟動) 都會繼續執行。
      </para>
      <para>
       當叢集或某個節點處於維護模式時，如果您嘗試啟動該節點上的叢集服務，&pace; 會針對每個資源啟動一次性的監控操作 (<quote>查探</quote>)，以確定哪些資源目前正在該節點上執行。不過，它只會確定資源的狀態，而不執行其他動作。
      </para>
     </note>

   <procedure xml:id="pro-ha-maint-reboot-node">
    <title>在叢集或節點處於維護模式的情況下將叢集節點重新開機</title>
    <step>
    <para>
     在要重新開機或關閉的節點上，以 &rootuser; 或同等身分登入。
    </para>
   </step>
   <step>
    <para>
     如果您使用 DLM 資源 (或相依於 DLM 的其他資源)，請務必在停止叢集服務之前明確停止這些資源：
    </para>
<screen>&prompt.crm.res;<command>stop <replaceable>RESOURCE_ID</replaceable></command></screen>
    <para>
     這是因為停止 &pace; 也會停止 &corosync; 服務，而 DLM 相依於後者的成員資格和訊息傳送服務。如果 &corosync; 停止，DLM 資源會表現為某種電腦分裂情況，並觸發圍籬區隔操作。
    </para>
   </step>
   <step>
    <para>
     停止該節點上的叢集服務：
    </para>
<screen>&prompt.root;<command>crm cluster stop</command></screen>
   </step>
   <step>
    <para>
     將節點關閉或重新開機。
    </para>
   </step>
  </procedure>
 </sect1>
</chapter>
