<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="ha_agents.xml" version="5.0" xml:id="cha-ha-agents">
 <title>新增或修改資源代理程式</title>
 <info>
      <abstract>
        <para>
    需由叢集管理的所有任務都必須當成資源使用。其中，有兩個主要群組需要注意，即資源代辦和 STONITH 代辦。對於這兩種類別，您都可以新增自己的代辦，以延伸叢集的功能來滿足自己的需要。
   </para>
      </abstract>
      <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
        <dm:maintainer/>
        <dm:status>editing</dm:status>
        <dm:deadline/>
        <dm:priority/>
        <dm:translation>yes</dm:translation>
        <dm:languages/>
        <dm:release/>
        <dm:repository/>
      </dm:docmanager>
    </info>
    <sect1 xml:id="sec-ha-stonithagents">
  <title>STONITH 代理程式</title>

  <para>
   叢集有時會偵測到其中一個節點行為異常，需要將其移除。這稱為「<emphasis>圍籬區隔</emphasis>」，通常透過 STONITH 資源來執行。 
  </para>

  <warning>
   <title>不支援外部 SSH/STONITH</title>
   <para>
    我們無法得知 SSH 對其他系統問題會做出什麼反應。因此，線上環境不支援外部 SSH/STONITH 代辦 (例如 <literal>stonith:external/ssh</literal>)。如果您仍要使用此類代辦來進行測試，請安裝 <package>libglue-devel</package> 套件。
   </para>
  </warning>

  <para>
   若要取得目前所有可用 STONITH 裝置 (從軟體角度) 的清單，請使用 <command>crm ra list stonith</command> 指令。如果您找不到偏好的代理程式，請安裝 <package>-devel</package> 套件。如需 STONITH 裝置與資源代辦的詳細資訊，請參閱<xref linkend="cha-ha-fencing"/>。
  </para>

  <para>
   到目前為止，尚沒有關於如何撰寫 STONITH 代辦的文件。若要撰寫新的 STONITH 代辦，請參閱 <package>cluster-glue</package> 套件原始碼中提供的範例。
  </para>
 </sect1>
 <sect1 xml:id="sec-ha-writingresourceagents">
  <title>撰寫 OCF 資源代理程式</title>

  <para>
   所有 OCF 資源代辦 (RA) 皆存放於 <filename>/usr/lib/ocf/resource.d/</filename> 中；如需詳細資訊，請參閱<xref linkend="sec-ha-config-basics-raclasses"/>。每個資源代辦必須支援以下操作以便您對其進行控制：
  </para>

  <variablelist>
   <varlistentry>
    <term><command>start</command>
    </term>
    <listitem>
     <para>
      啟動或啟用資源
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><command>stop</command>
    </term>
    <listitem>
     <para>
      停止或停用資源
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><command>status</command>
    </term>
    <listitem>
     <para>
      傳回資源的狀態
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><command>monitor</command>
    </term>
    <listitem>
     <para>
      與 <command>status</command> 指令類似，但它還會檢查未預期狀態
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><command>validate</command>
    </term>
    <listitem>
     <para>
      驗證資源的組態
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><command>meta-data</command>
    </term>
    <listitem>
     <para>
      以 XML 格式傳回資源代辦的相關資訊
     </para>
    </listitem>
   </varlistentry>
  </variablelist>

  <para>
   建立 OCF RA 的一般程序如下所示：
  </para>

  <procedure>
   <step>
    <para>
     將 <filename>/usr/lib/ocf/resource.d/pacemaker/Dummy</filename> 檔案做為範本載入。
    </para>
   </step>
   <step>
    <para>
     為每個新的資源代辦新建子目錄，以避免命名衝突。例如，若您擁有資源群組 <systemitem>kitchen</systemitem> (內含資源 <systemitem>coffee_machine</systemitem>)，請將此資源新增至 <filename>/usr/lib/ocf/resource.d/kitchen/</filename> 目錄。若要存取此資源代辦，請執行 <command>crm</command> 指令：
    </para>
<screen><prompt role="root">root # </prompt><command>crm</command> configure primitive coffee_1 ocf:coffee_machine:kitchen ...</screen>
   </step>
   <step>
    <para>
     執行不同的外圍程序函數，並以不同的名稱儲存檔案。
    </para>
   </step>
  </procedure>

  <para>
   如需關於撰寫 OCF 資源代辦的更多詳細資料，請造訪 <link xlink:href="http://www.linux-ha.org/wiki/Resource_Agents"/>。有關幾個概念的特殊資訊，請參閱<xref linkend="cha-ha-concepts"/>。
  </para>
 </sect1>
 <xi:include href="ha_error_codes.xml"/>
</chapter>
