<?xml version="1.0" encoding="UTF-8"?>
<?xml-stylesheet href="urn:x-suse:xslt:profiling:docbook51-profile.xsl"
 type="text/xml"
 title="Profiling step"?>
<appendix xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="ha_iscsi_for_sbd.xml" xml:id="ha-iscsi-for-sbd" xml:lang="zh-tw" version="5.1">
 <title>SBD 的基本 iSCSI 儲存</title>
 <info>
  <abstract>
   <para>
    使用以下程序可設定用於 SBD 的基本 iSCSI 儲存。建議僅將這些程序用於測試目的。在生產環境中使用 iSCSI 之前，請參閱 <link xlink:href="https://documentation.suse.com/sles/html/SLES-all/cha-iscsi.html">
    <citetitle>Storage Administration Guide</citetitle> for SUSE Linux Enterprise Server</link>。
   </para>
  </abstract>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
 </info>

 <itemizedlist>
  <title>要求</title>
  <listitem>
   <para>
    做為 iSCSI 目標的 SUSE Linux Enterprise Server 虛擬機器。此虛擬機器不是叢集的一部分。
   </para>
  </listitem>
  <listitem>
   <para>
    虛擬機器上的兩個虛擬儲存裝置：一部 20 GB 裝置 (用於系統)，一部 1 GB 裝置 (用於 SBD)。
   </para>
  </listitem>
  <listitem>
   <para>
    兩個尚未新增至高可用性叢集的 SUSE Linux Enterprise Server 節點。
   </para>
  </listitem>
 </itemizedlist>

 <para>
  首先，在虛擬機器上設定 iSCSI 目標：
 </para>

 <procedure xml:id="pro-iscsi-for-sbd-target">
  <title>設定 iSCSI 目標</title>
  <step>
   <para>
    安裝套件 <package>yast2-iscsi-lio-server</package>:
   </para>
<screen><prompt role="root"># </prompt><command>zypper install yast2-iscsi-lio-server</command></screen>
  </step>
  <step>
   <para>
    在 YaST 中啟動 <literal>iscsi-lio-server</literal> 模組：
   </para>
<screen><prompt role="root"># </prompt><command>yast2 iscsi-lio-server</command></screen>
  </step>
  <step>
   <para>
    在<guimenu>服務</guimenu>索引標籤中的<guimenu>重新啟動後</guimenu>下，選取<guimenu>開機時啟動</guimenu>。
   </para>
  </step>
  <step>
   <para>
    啟用<guimenu>在防火牆中開啟埠</guimenu>。
   </para>
  </step>
  <step>
   <para>
    在<guimenu>探查</guimenu>索引標籤中，啟用<guimenu>探查驗證</guimenu>。
    </para>
   </step>
  <step>
   <para>
    在<guimenu>由目標驗證</guimenu>下，輸入<guimenu>使用者名稱</guimenu>和<guimenu>密碼</guimenu>。
   </para>
  </step>
  <step>
   <para>
    在<guimenu>由啟動器驗證</guimenu>下，輸入<guimenu>雙向使用者名稱</guimenu>和<guimenu>雙向密碼</guimenu>。此密碼不得與<guimenu>由目標驗證</guimenu>的密碼相同。
   </para>
  </step>
  <step>
   <para>
    在<guimenu>目標</guimenu>索引標籤中選取<guimenu>新增</guimenu>。
   </para>
  </step>
  <step>
   <para>
    取代 <literal>.com.example</literal> 以變更<guimenu>目標</guimenu>名稱。
   </para>
  </step>
  <step>
   <para>
    新增伺服器的 <guimenu>IP 位址</guimenu>。
   </para>
  </step>
  <step>
   <para>
    選取<guimenu>新增</guimenu>。
   </para>
  </step>
  <step>
   <para>
    在 <guimenu>LUN 詳細資料</guimenu>視窗中，輸入 1 GB 儲存裝置的 <guimenu>LUN 路徑</guimenu> (例如 <filename>/dev/vbd</filename>)。
   </para>
  </step>
  <step>
   <para>
    選取<guimenu>確定</guimenu>。
   </para>
  </step>
  <step>
   <para>
    選取<guimenu>下一步</guimenu>。
   </para>
  </step>
  <step>
   <para>
    選取<guimenu>完成</guimenu>以關閉 YaST。
   </para>
  </step>
  <step>
   <para>
    若要檢查目標設定，請切換到目標 CLI：
   </para>
<screen><prompt role="root"># </prompt><command>targetcli</command></screen>
   <para>
    顯示組態：
   </para>
<screen><prompt>/&gt; </prompt><command>ls</command></screen>
  </step>
 </procedure>

 <para>
  接下來在節點上設定 iSCSI 啟動器。在兩個節點上重複以下程序：
 </para>

 <procedure xml:id="pro-iscsi-for-sbd-clients">
  <title>設定 iSCSI 啟動器</title>
  <step>
   <para>
    安裝套件 <package>yast2-iscsi-client</package>:
   </para>
<screen><prompt role="root"># </prompt><command>zypper install yast2-iscsi-client</command></screen>
  </step>
  <step>
   <para>
    啟動 <literal>iscsid</literal> 服務：
   </para>
<screen><prompt role="root"># </prompt><command>systemctl start iscsid</command></screen>
  </step>
  <step>
   <para>
    在 YaST 中開啟 <literal>iscsi-client</literal> 模組：
   </para>
<screen><prompt role="root"># </prompt><command>yast2 iscsi-client</command></screen>
  </step>
  <step>
   <para>
    在<guimenu>探查的目標</guimenu>索引標籤中，選取<guimenu>探查</guimenu>。
   </para>
  </step>
  <step>
   <para>
    輸入 iSCSI 目標的 IP 位址。
   </para>
  </step>
  <step>
   <para>
    清除<guimenu>不進行探查驗證</guimenu>。
   </para>
  </step>
  <step>
   <para>
    在<guimenu>由啟動器驗證</guimenu>下，輸入啟動器<guimenu>使用者名稱</guimenu>和<guimenu>密碼</guimenu>。
   </para>
  </step>
  <step>
   <para>
    在<guimenu>由目標驗證</guimenu>下，輸入目標<guimenu>使用者名稱</guimenu>和<guimenu>密碼</guimenu>。
   </para>
  </step>
  <step>
   <para>
    選取<guimenu>下一步</guimenu>。
   </para>
  </step>
  <step>
   <para>
    當 YaST 探查到 iSCSI 目標後，選取<guimenu>連接</guimenu>。
   </para>
  </step>
  <step>
   <para>
    在<guimenu>啟動</guimenu>下，選取<guimenu>開機時</guimenu>。
   </para>
  </step>
  <step>
   <para>
    選取<guimenu>下一步</guimenu>。
   </para>
  </step>
  <step>
   <para>
    選取<guimenu>確定</guimenu>以關閉 YaST。
   </para>
  </step>
  <step>
   <para>
    檢查 iSCSI 啟動器：
   </para>
<screen><prompt role="root"># </prompt><command>lsscsi</command>
[0:0:1:0] cd/dvd QEMU QEMU DVD-ROM 2.5+ /dev/sr0
[2:0:0:0] disk LIO-ORG IBLOCK 4.0 /dev/sda</screen>
   <para>
    尋找包含 <literal>IBLOCK</literal> 的行。在此範例中，iSCSI 裝置為 <literal>/dev/sda</literal>。
   </para>
  </step>
  <step>
   <para>
    檢查 <literal>iscsid</literal> 服務的狀態：
   </para>
<screen><prompt role="root"># </prompt><command>systemctl status iscsid</command></screen>
  </step>
 </procedure>

 <para>
  您可以在 <filename>/dev/disk/by-id/</filename> 中尋找穩定的裝置名稱。iSCSI 裝置的名稱通常以 <literal>scsi-SLIO-ORG_IBLOCK</literal> 開頭。
 </para>
 <para>
  設定叢集時，請使用以下其中一種方法來指定穩定的裝置名稱：
 </para>
 <itemizedlist>
  <listitem>
   <para>
    執行 <command>crm cluster init</command> 時，依提示輸入穩定的裝置名稱。
   </para>
  </listitem>
  <listitem>
   <para>
    執行 <command>crm cluster init</command> 前，將穩定的裝置名稱新增至 <filename>/etc/sysconfig/sbd</filename> 中：
   </para>
<screen>SBD_DEVICE=/dev/disk/by-id/scsi-SLIO-ORG_IBLOCK_<replaceable>DEVICE_ID_STRING</replaceable></screen>
   <para>
    執行 <command>crm cluster init</command> 時，對下面的問題回應 <literal>n</literal>：
   </para>
<screen>SBD is already configured to use /dev/disk/by-id/scsi-SLIO-ORG_IBLOCK_... - overwrite (y/n)?</screen>
  </listitem>
 </itemizedlist>
</appendix>
