<?xml version="1.0" encoding="UTF-8"?>
<?xml-stylesheet href="urn:x-suse:xslt:profiling:docbook51-profile.xsl"
 type="text/xml"
 title="Profiling step"?>
<appendix xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="ha_iscsi_for_sbd.xml" xml:id="ha-iscsi-for-sbd" xml:lang="fr" version="5.1">
 <title>Stockage iSCSI de base pour SBD</title>
 <info>
  <abstract>
   <para>
    Utilisez les procédures suivantes pour configurer le stockage iSCSI de base à employer avec SBD. Ces procédures ne sont recommandées qu'à des fins de test. Avant d'utiliser iSCSI dans un environnement de production, reportez-vous au manuel <link xlink:href="https://documentation.suse.com/sles/html/SLES-all/cha-iscsi.html">Storage Administration Guide for SUSE Linux Enterprise Server</link> (Guide d'administration du stockage pour SUSE Linux Enterprise Server).
   </para>
  </abstract>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
 </info>

 <itemizedlist>
  <title>Configuration requise</title>
  <listitem>
   <para>
    Une machine virtuelle SUSE Linux Enterprise Server faisant office de cible iSCSI. Cette machine virtuelle ne fait pas partie de la grappe.
   </para>
  </listitem>
  <listitem>
   <para>
    Deux périphériques de stockage virtuels sur la machine virtuelle : un périphérique de 20 Go pour le système et un périphérique de 1 Go pour SBD.
   </para>
  </listitem>
  <listitem>
   <para>
    Deux noeuds SUSE Linux Enterprise Server qui n'ont pas encore été ajoutés à une grappe Haute disponibilité.
   </para>
  </listitem>
 </itemizedlist>

 <para>
  Commencez par configurer une cible iSCSI sur la machine virtuelle :
 </para>

 <procedure xml:id="pro-iscsi-for-sbd-target">
  <title>Configuration d'une cible iSCSI</title>
  <step>
   <para>
    Installez le paquet <package>yast2-iscsi-lio-server</package> :
   </para>
<screen><prompt role="root"># </prompt><command>zypper install yast2-iscsi-lio-server</command></screen>
  </step>
  <step>
   <para>
    Démarrez le module <literal>iscsi-lio-server</literal> dans YaST :
   </para>
<screen><prompt role="root"># </prompt><command>yast2 iscsi-lio-server</command></screen>
  </step>
  <step>
   <para>
    Dans l'onglet <guimenu>Service</guimenu>, sous <guimenu>Après redémarrage</guimenu>, sélectionnez <guimenu>Démarrer au démarrage du système</guimenu>.
   </para>
  </step>
  <step>
   <para>
    Activez l'option <guimenu>Ouvrir le port dans le pare-feu</guimenu>.
   </para>
  </step>
  <step>
   <para>
    Sous l'onglet <guimenu>Global</guimenu>, activez l'option <guimenu>Authentification de la découverte</guimenu>.
    </para>
   </step>
  <step>
   <para>
    Sous <guimenu>Authentification par les cibles</guimenu>, entrez un <guimenu>Nom d'utilisateur</guimenu> et un <guimenu>Mot de passe</guimenu>.
   </para>
  </step>
  <step>
   <para>
    Sous <guimenu>Authentification par les initiateurs</guimenu>, entrez un <guimenu>Nom d'utilisateur commun</guimenu> et un <guimenu>Mot de passe commun</guimenu>. Ce mot de passe doit être différent du mot de passe <guimenu>Authentification par cibles</guimenu>.
   </para>
  </step>
  <step>
   <para>
    Sous l'onglet <guimenu>Cible</guimenu>, sélectionnez <guimenu>Ajouter</guimenu>.
   </para>
  </step>
  <step>
   <para>
    Modifiez le nom de la <guimenu>Cible</guimenu> en remplaçant <literal>.com.example</literal>.
   </para>
  </step>
  <step>
   <para>
    L'<guimenu>Adresse IP</guimenu> de ce serveur doit se renseigner automatiquement. Si ce n'est pas le cas, ajoutez-la maintenant.
   </para>
  </step>
  <step>
   <para>
    Sélectionnez <guimenu>Ajouter</guimenu>.
   </para>
  </step>
  <step>
   <para>
    Dans la fenêtre <guimenu>Détails de LUN</guimenu>, entrez le <guimenu>Chemin de LUN</guimenu> vers le périphérique de stockage de 1 Go (par exemple, <filename>/dev/vbd</filename>).
   </para>
  </step>
  <step>
   <para>
    Sélectionnez <guimenu>OK</guimenu>.
   </para>
  </step>
  <step>
   <para>
    Sélectionnez <guimenu>Suivant</guimenu>.
   </para>
  </step>
  <step>
   <para>
    Sélectionnez <guimenu>Terminer</guimenu> pour fermer YaST.
   </para>
  </step>
  <step>
   <para>
    Pour vérifier la configuration cible, basculez vers la CLI cible :
   </para>
<screen><prompt role="root"># </prompt><command>targetcli</command></screen>
   <para>
    Affichez la configuration :
   </para>
<screen><prompt>/&gt; </prompt><command>ls</command></screen>
  </step>
 </procedure>

 <para>
  Ensuite, configurez les initiateurs iSCSI sur les noeuds. Répétez cette procédure sur les deux noeuds :
 </para>

 <procedure xml:id="pro-iscsi-for-sbd-clients">
  <title>configuration d'un initiateur iSCSI</title>
  <step>
   <para>
    Installez les paquets requis :
   </para>
<screen><prompt role="root"># </prompt><command>zypper install open-iscsi yast2-iscsi-client</command></screen>
  </step>
  <step>
   <para>
    Démarrez le service <literal>iscsid</literal> :
   </para>
<screen><prompt role="root"># </prompt><command>systemctl start iscsid</command></screen>
  </step>
  <step>
   <para>
    Ouvrez le module <literal>iscsi-client</literal> dans YaST :
   </para>
<screen><prompt role="root"># </prompt><command>yast2 iscsi-client</command></screen>
  </step>
  <step>
   <para>
    Sous l'onglet <guimenu>Cibles découvertes</guimenu>, sélectionnez <guimenu>Découverte</guimenu>.
   </para>
  </step>
  <step>
   <para>
    Entrez l'adresse IP de la cible iSCSI.
   </para>
  </step>
  <step>
   <para>
    Désélectionnez l'option <guimenu>Pas d'authentification de la découverte</guimenu>.
   </para>
  </step>
  <step>
   <para>
    Sous <guimenu>Authentification par l'initiateur</guimenu>, entrez le <guimenu>Nom d'utilisateur</guimenu> et le <guimenu>Mot de passe</guimenu> de l'initiateur.
   </para>
  </step>
  <step>
   <para>
    Sous <guimenu>Authentification par les cibles</guimenu>, entrez le <guimenu>Nom d'utilisateur</guimenu> et le <guimenu>Mot de passe</guimenu> de la cible.
   </para>
  </step>
  <step>
   <para>
    Sélectionnez <guimenu>Suivant</guimenu>.
   </para>
  </step>
  <step>
   <para>
    Une fois que YaST a découvert la cible iSCSI, sélectionnez <guimenu>Connecter</guimenu>.
   </para>
  </step>
  <step>
   <para>
    Sous <guimenu>Démarrage</guimenu>, sélectionnez <guimenu>au démarrage</guimenu>.
   </para>
  </step>
  <step>
   <para>
    Sélectionnez <guimenu>Suivant</guimenu>.
   </para>
  </step>
  <step>
   <para>
    Sélectionnez <guimenu>OK</guimenu> pour fermer YaST.
   </para>
  </step>
  <step>
   <para>
    Vérifiez l'initiateur iSCSI :
   </para>
<screen><prompt role="root"># </prompt><command>lsscsi</command>
[0:0:1:0] cd/dvd QEMU QEMU DVD-ROM 2.5+ /dev/sr0
[2:0:0:0] disk LIO-ORG IBLOCK 4.0 /dev/sda</screen>
   <para>
    Recherchez une ligne contenant <literal>IBLOCK</literal>. Dans cet exemple, le périphérique iSCSI est <literal>/dev/sda</literal>.
   </para>
  </step>
  <step>
   <para>
    Vérifiez l'état du service <literal>iscsid</literal> :
   </para>
<screen><prompt role="root"># </prompt><command>systemctl status iscsid</command></screen>
  </step>
 </procedure>

 <para>
  Vous pouvez trouver le nom du périphérique stable dans <filename>/dev/disk/by-id/</filename>. Généralement, un périphérique iSCSI commence par <literal>scsi-SLIO-ORG_IBLOCK</literal>.
 </para>
 <para>
  Si vous avez plusieurs disques, vous pouvez exécuter la commande <command>lsblk -o name,serial</command> pour vérifier quel nom de périphérique stable correspond à quel nom abrégé (par exemple, <filename>/dev/sda</filename>).
 </para>
 <para>
  Lorsque vous configurez la grappe, spécifiez le nom du périphérique stable à l'aide de l'une des méthodes suivantes :
 </para>
 <itemizedlist>
  <listitem>
   <para>
    Lorsque vous exécutez <command>crm cluster init</command>, entrez le nom du périphérique stable quand vous y êtes invité.
   </para>
  </listitem>
  <listitem>
   <para>
    Avant d'exécuter <command>crm cluster init</command>, ajoutez le nom du périphérique stable à <filename>/etc/sysconfig/sbd</filename> :
   </para>
<screen>SBD_DEVICE=/dev/disk/by-id/scsi-SLIO-ORG_IBLOCK_<replaceable>DEVICE_ID_STRING</replaceable></screen>
   <para>
    Lorsque vous exécutez <command>crm cluster init</command>, répondez <literal>n</literal> à cette question :
   </para>
<screen>SBD is already configured to use /dev/disk/by-id/scsi-SLIO-ORG_IBLOCK_... - overwrite (y/n)?</screen>
  </listitem>
 </itemizedlist>
</appendix>
