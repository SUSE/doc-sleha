<?xml version="1.0" encoding="UTF-8"?>
<sect1 xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="geo_manage_i.xml" version="5.0" xml:id="sec.ha.geo.manage">
 <title>Gestion des grappes géographiques</title>

 <info>
      <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
        <dm:maintainer/>
        <dm:status>modification</dm:status>
        <dm:deadline/>
        <dm:priority/>
        <dm:translation>oui</dm:translation>
        <dm:languages/>
        <dm:release/>
        <dm:repository/>
      </dm:docmanager>
    </info>
    <para>
  Avant que le booth puisse gérer un certain ticket au sein de la grappe géographique, vous devez d'abord l'attribuer à un site manuellement.
 </para>

 <sect2 xml:id="sec.ha.geo.manage.cli">
  <title>À partir de la ligne de commande</title>
  <para>
   Utilisez l'outil de ligne de commande du <command>client booth</command> pour accorder, lister ou révoquer des tickets comme décrit à la section <xref linkend="vl.ha.booth.client.cmds"/>. Les commandes du <command>client booth</command> peuvent être exécutées sur n'importe quelle machine de la grappe, pas uniquement celles sur lesquelles s'exécutent le <systemitem class="daemon">boothd</systemitem>. Ces commandes du <command>client booth</command> tentent de trouver la grappe <quote>locale</quote> en consultant le fichier de configuration de booth et les adresses IP définies localement. Si vous ne spécifiez pas le site auquel le client booth doit se connecter (à l'aide de l'option <option>-s</option>), il se connectera toujours au site local.
  </para>
  <note>
   <title>modifications de syntaxe</title>
   <para>
    La syntaxe des commandes du client booth est simplifiée depuis <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise High Availability Extension</phrase></phrase> 11. Par exemple, le mot clé <literal>client</literal> peut être omis pour les opérations <option>list</option>, <option>grant</option> ou <option>revoke</option> : <command>booth list</command>. En outre, l'option <option>-t</option> peut être omise lors de la spécification d'un ticket.
   </para>
   <para>
    La syntaxe précédente est toujours prise en charge. Pour plus d'informations, reportez-vous à la section <literal>Synopsis</literal> (Résumé) de la page du manuel de booth. Les exemples dans ce manuel utilisent cependant la syntaxe simplifiée.
   </para>
  </note>

  <variablelist xml:id="vl.ha.booth.client.cmds">
   <title>Présentation des commandes du <command>client booth</command></title>
   <varlistentry>
    <term>Listage de tous les tickets</term>
    <listitem>
<screen><prompt role="root">root # </prompt><command>booth</command> list
ticket: ticketA, leader: none
ticket: ticketB, leader: 10.2.12.101, expires: 2014-08-13 10:28:57</screen>
     <para>
      Si vous ne spécifiez pas un certain site à l'aide de l'option <option>-s</option>, les informations concernant les tickets seront demandées auprès de l'instance de booth locale.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Octroi d'un ticket à un site</term>
    <listitem>
<screen><prompt role="root">root # </prompt><command>booth</command> grant -s 192.168.201.151 ticketA
booth[27891]: 2014/08/13_10:21:23 info: grant request sent, waiting for the result ...
booth[27891]: 2014/08/13_10:21:23 info: grant succeeded!</screen>
     <para>
      Dans ce cas, <literal>ticketA</literal> sera accordé au site <literal>192.168.201.151</literal>. Si vous omettez l'option <option>-s</option>, le booth se connectera automatiquement au site actuel (celui sur lequel vous exécutez le client booth) et fera appel à l'opération <command>grant</command>.
     </para>
     <para>
      Avant d'accorder un ticket, la commande exécute un contrôle d'intégrité. Si le même ticket est déjà accordé à un autre site, vous en serez averti et serez invité à révoquer tout d'abord le ticket du site actuel.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Révocation d'un ticket d'un site</term>
    <listitem>
<screen><prompt role="root">root # </prompt><command>booth</command> revoke ticketA
booth[27900]: 2014/08/13_10:21:23 info: revoke succeeded!</screen>
     <para>
      Le booth vérifie à quel site le ticket est actuellement accordé et demande une opération <command>revoke</command> pour <literal>ticketA</literal>. L'opération de révocation est exécutée immédiatement.
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
  <para>
   Les opérations <command>grant</command> et, dans certaines circonstances, <command>revoke</command> peuvent prendre un certain temps pour renvoyer le résultat d'une opération précise. Le client attend le résultat jusqu'à la valeur de <varname>timeout</varname> du ticket, puis abandonne, sauf si l'option <option>-w</option> a été utilisée, auquel cas le client attend indéfiniment. Pour connaître l'état exact, consultez les fichiers journaux ou utilisez la commande <command>crm_ticket -L</command>.
  </para>
  <warning>
   <title><command>crm_ticket</command> et <command>crm site ticket</command></title>
   <para>
    Si, pour une quelconque raison, le service de booth ne s'exécute pas, vous pouvez également gérer les tickets manuellement avec les commandes <command>crm_ticket</command> ou <command>crm site ticket</command>. Celles-ci sont uniquement disponibles sur les noeuds de grappe. En cas d'intervention, utilisez-les avec précaution car ces commandes ne peuvent <emphasis>pas</emphasis> vérifier si le même ticket est déjà accordé ailleurs. Pour plus d'informations, reportez-vous aux pages de manuel.
   </para>
   <para>
    Tant que le booth est en cours d'exécution, utilisez uniquement le <command>client booth</command> pour les interventions manuelles.
   </para>
  </warning>
  <para>
   Une fois que vous avez accordé un ticket à un site, le mécanisme de booth prend le relais et gère automatiquement le ticket. Si le site qui détient un ticket se retrouve hors service, ce dernier est automatiquement révoqué après le délai d'expiration et accordé à un autre site. Les ressources qui dépendent de ce ticket basculent alors vers le nouveau site possédant le ticket. Les noeuds qui exécutaient les ressources avant sont traités conformément à la définition du paramètre <literal>loss-policy</literal> que vous définissez dans la contrainte.
  </para>

  <procedure xml:id="pro.ha.geo.manage.tickets">
   <title>Gestion manuelle des tickets</title>
   <para>
    Supposons que vous souhaitiez déplacer manuellement <literal>ticket-nfs</literal> du site <literal>amsterdam</literal> (avec l'adresse IP virtuelle <literal>192.168.201.151</literal>) vers le site <literal>berlin</literal> (avec l'adresse IP virtuelle <literal>192.168.202.151</literal>). Procédez comme suit :
   </para>
   <step>
    <para>
     Mettez <literal>ticket-nfs</literal> en veille avec la commande suivante :
    </para>
<screen><prompt role="root">root # </prompt><command>crm_ticket</command> -t ticket-nfs -s</screen>
   </step>
   <step>
    <para>
     Attendez que toutes les ressources dépendant de <literal>ticket-nfs</literal> soient arrêtées ou rétrogradées correctement.
    </para>
   </step>
   <step>
    <para>
     Révoquez <literal>ticket-nfs</literal> du site <literal>amsterdam</literal> avec la commande suivante :
    </para>
<screen><prompt role="root">root # </prompt><command>booth</command> revoke -s 192.168.201.151 ticket-nfs</screen>
   </step>
   <step>
    <para>
     Une fois le ticket révoqué de son site initial, attribuez-le au site <literal>berlin</literal> avec la commande suivante :
    </para>
<screen><prompt role="root">root # </prompt><command>booth</command> grant -s 192.168.202.151 ticket-nfs</screen>
   </step>
  </procedure>
  <remark>phil 2013-12: Will/Should get a cleaner, more integrated workflow - "booth client move -t ticket -s new-site"
     or something similar. - dmuhamedagic 2014-08-13: N/A</remark>
 </sect2>

 
 <xi:include href="geo_manage_hawk2_i.xml"/>
</sect1>
